name: CI

on:
  push:
    branches:
      - main
  pull_request:
  repository_dispatch:
    types: [deploy-after-translate]
  workflow_dispatch:

jobs:
  # =================================================================================================
  # QUICK TESTS - Run on all PRs (no build required, ~5 seconds)
  # =================================================================================================
  quick-tests:
    runs-on: ubuntu-latest
    # Skip for repository_dispatch (deploy-only) and workflow_dispatch
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Test Dependencies
        run: pip install -r tests/requirements.txt

      - name: Run Quick Tests
        run: pytest tests/test_quick.py -v --tb=short

  # =================================================================================================
  # BUILD JOB
  # =================================================================================================
  build:
    needs: quick-tests
    runs-on: ubuntu-latest
    # Skip for repository_dispatch (deploy-only) and workflow_dispatch
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.8'
          extended: true

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y webp
          sudo npm install -g svgo

      - name: Build with Hugo
        run: hugo --minify --gc

      - name: Optimize Images (SVG & WebP Conversion)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Optimizing SVG files..."
          find public -name "*.svg" -type f -exec svgo --multipass --quiet {} \;
          
          echo "Converting PNG to WebP..."
          find public -name "*.png" -type f | while read png; do 
            webp="${png%.png}.webp"
            cwebp -q 82 "$png" -o "$webp" && rm "$png"
          done
          
          echo "Converting JPG/JPEG to WebP..."
          find public \( -name "*.jpg" -o -name "*.jpeg" \) -type f | while read jpg; do 
            webp="${jpg%.*}.webp"
            cwebp -q 82 "$jpg" -o "$webp" && rm "$jpg"
          done
          
          echo "Updating HTML references to WebP..."
          find public -name "*.html" -type f -exec sed -i -e 's/\.png/\.webp/g' -e 's/\.jpg/\.webp/g' -e 's/\.jpeg/\.webp/g' {} +

      - name: Upload Build Artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: public-site
          path: public/
          retention-days: 1

  # =================================================================================================
  # FULL TESTS - Run on main branch only (after build, validates HTML output)
  # =================================================================================================
  # Temporarily disabled - broken links test needs fix for multilingual fallback
  # full-tests:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   # Only run on main branch push (not PRs, not dispatch events)
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive

  #     - name: Setup Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'

  #     - name: Download Build Artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: public-site
  #         path: public

  #     - name: Install Test Dependencies
  #       run: pip install -r tests/requirements.txt

  #     - name: Run Full Test Suite
  #       run: |
  #         pytest tests/test_links.py tests/test_html_output.py tests/test_accessibility.py tests/test_build_performance.py -v --tb=short
  #       env:
  #         HUGO_BUILD_DIR: public


# =================================================================================================
  # TRANSLATION JOB - Runs after tests pass, commits translated files, triggers deploy
  # =================================================================================================
  # translate:
  #   needs: full-tests
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   permissions:
  #     contents: write
  #   outputs:
  #     translations_committed: ${{ steps.translate.outputs.committed }}
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0 # Needed for git diff to detect changed files
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #     - name: Install dependencies
  #       run: pip install anthropic
  #     - name: Run Translation Script
  #       id: translate
  #       env:
  #         ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  #         CI_COMMIT_BEFORE_SHA: ${{ github.event.before }}
  #         CI_COMMIT_SHA: ${{ github.sha }}
  #         CI_COMMIT_REF_NAME: ${{ github.ref_name }}
  #       run: |
  #         bash scripts/translate/ci_translate.sh
  #         # Check if translations were committed by looking at git log
  #         if git log -1 --pretty=%B | grep -q "Auto-translate:"; then
  #           echo "committed=true" >> $GITHUB_OUTPUT
  #         else
  #           echo "committed=false" >> $GITHUB_OUTPUT
  #         fi
  #     - name: Trigger Deploy Workflow
  #       if: steps.translate.outputs.committed == 'true'
  #       env:
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         echo "Translations committed, triggering deployment..."
  #         gh api repos/${{ github.repository }}/dispatches \
  #           -f event_type=deploy-after-translate            -f event_type=deploy-after-translate

  # =================================================================================================
  # DEPLOYMENT JOBS
  # Runs after build/tests on regular push, OR triggered by translate after committing translations
  # =================================================================================================

  deploy-cloudflare:
    needs: [build]
    runs-on: ubuntu-latest
    # Run on main branch push (after build), OR when triggered by dispatch (skips needs)
    # always() allows this job to run even if needed jobs were skipped
    if: |
      always() && (
        (github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build.result == 'success') ||
        github.event_name == 'repository_dispatch' ||
        github.event_name == 'workflow_dispatch'
      )
    environment:
      name: production
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      # For dispatch events, we need to rebuild since there's no artifact
      - name: Setup Hugo
        if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.8'
          extended: true

      - name: Build Site (for dispatch)
        if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
        run: hugo --minify --gc

      - name: Download Build Artifact
        if: github.event_name == 'push'
        uses: actions/download-artifact@v4
        with:
          name: public-site
          path: public

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT }}
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  deploy-ssh-primary:
    needs: [build]
    runs-on: ubuntu-latest
    # Run on main branch push (after build), OR when triggered by dispatch (skips needs)
    # always() allows this job to run even if needed jobs were skipped
    if: |
      always() && (
        (github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build.result == 'success') ||
        github.event_name == 'repository_dispatch' ||
        github.event_name == 'workflow_dispatch'
      )
    steps:
      - uses: actions/checkout@v4
        if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'

      # For dispatch events, we need to rebuild since there's no artifact
      - name: Setup Hugo
        if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.8'
          extended: true

      - name: Build Site (for dispatch)
        if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
        run: hugo --minify --gc

      - name: Download Build Artifact
        if: github.event_name == 'push'
        uses: actions/download-artifact@v4
        with:
          name: public-site
          path: public

      - name: Deploy via Rsync
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H -p "$DEPLOY_PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts

          # Fix permissions (ownership) - requires sudo NOPASSWD on remote
          ssh -i ~/.ssh/deploy_key -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" "sudo chown -R $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH || true"

          # Sync files
          rsync -avz --delete --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r -e "ssh -i ~/.ssh/deploy_key -p $DEPLOY_PORT -o StrictHostKeyChecking=no" public/ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH"

          # Fix permissions (www-data)
          ssh -i ~/.ssh/deploy_key -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" "sudo chown -R www-data:www-data $DEPLOY_PATH || true"

  # deploy-ssh-secondary:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: public-site
  #         path: public
  #     - name: Install SSHPass
  #       run: sudo apt-get install -y sshpass
  #     - name: Deploy via Rsync (Password)
  #       env:
  #         DEPLOY_PASS: ${{ secrets.DEPLOY_SSH_KEY2 }} # Mapped from password secret
  #         DEPLOY_HOST: ${{ secrets.DEPLOY_HOST2 }}
  #         DEPLOY_PORT: ${{ secrets.DEPLOY_SSH_PORT2 }}
  #         DEPLOY_USER: ${{ secrets.DEPLOY_USER2 }}
  #         DEPLOY_PATH: ${{ secrets.DEPLOY_PATH2 }}
  #       run: |
  #         mkdir -p ~/.ssh
  #         ssh-keyscan -p $DEPLOY_PORT -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  #         
  #         sshpass -p "$DEPLOY_PASS" ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "sudo chown -R $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH || true"
  #         sshpass -p "$DEPLOY_PASS" rsync -avz --delete --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r -e "ssh -p $DEPLOY_PORT -o StrictHostKeyChecking=no" public/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
  #         sshpass -p "$DEPLOY_PASS" ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "sudo chown -R www-data:www-data $DEPLOY_PATH || true"

  # =================================================================================================
  # SECURITY SCANNING
  # =================================================================================================
 
