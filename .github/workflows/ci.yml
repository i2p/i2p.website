name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # =================================================================================================
  # TRANSLATION JOB (Commented out as requested)
  # =================================================================================================
  # translate:
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' # Only on push to main
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0 # Needed for git log checks if we were doing them, but script might need history
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #     - name: Install dependencies
  #       run: pip install openai
  #     - name: Run Translation Script
  #       env:
  #         OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }} # Assuming this would be needed if enabled
  #       run: bash scripts/ci_translate.sh

  # =================================================================================================
  # BUILD JOB
  # =================================================================================================
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.8'
          extended: true

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y webp
          sudo npm install -g svgo

      - name: Build with Hugo
        run: hugo --minify --gc

      - name: Optimize Images (SVG & WebP Conversion)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Optimizing SVG files..."
          find public -name "*.svg" -type f -exec svgo --multipass --quiet {} \;
          
          echo "Converting PNG to WebP..."
          find public -name "*.png" -type f | while read png; do 
            webp="${png%.png}.webp"
            cwebp -q 82 "$png" -o "$webp" && rm "$png"
          done
          
          echo "Converting JPG/JPEG to WebP..."
          find public \( -name "*.jpg" -o -name "*.jpeg" \) -type f | while read jpg; do 
            webp="${jpg%.*}.webp"
            cwebp -q 82 "$jpg" -o "$webp" && rm "$jpg"
          done
          
          echo "Updating HTML references to WebP..."
          find public -name "*.html" -type f -exec sed -i -e 's/\.png/\.webp/g' -e 's/\.jpg/\.webp/g' -e 's/\.jpeg/\.webp/g' {} +

      - name: Upload Build Artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: public-site
          path: public/
          retention-days: 1

  # =================================================================================================
  # TEST JOB (Temporarily disabled - needs fixes)
  # =================================================================================================
  # test:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive

  #     - name: Setup Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'

  #     - name: Setup Hugo
  #       uses: peaceiris/actions-hugo@v3
  #       with:
  #         hugo-version: '0.147.8'
  #         extended: true

  #     - name: Install Dependencies
  #       run: |
  #         pip install -r tests/requirements.txt

  #     - name: Run Unit Tests
  #       run: |
  #         pytest tests/

  # =================================================================================================
  # DEPLOYMENT JOBS
  # =================================================================================================
  
  deploy-cloudflare:
    needs: [build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: public-site
          path: public

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT }}
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  deploy-ssh-primary:
    needs: [build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: public-site
          path: public
      - name: Deploy via Rsync
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H -p "$DEPLOY_PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts

          # Fix permissions (ownership) - requires sudo NOPASSWD on remote
          ssh -i ~/.ssh/deploy_key -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" "sudo chown -R $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH || true"

          # Sync files
          rsync -avz --delete --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r -e "ssh -i ~/.ssh/deploy_key -p $DEPLOY_PORT -o StrictHostKeyChecking=no" public/ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH"

          # Fix permissions (www-data)
          ssh -i ~/.ssh/deploy_key -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" "sudo chown -R www-data:www-data $DEPLOY_PATH || true"

  # deploy-ssh-secondary:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: public-site
  #         path: public
  #     - name: Install SSHPass
  #       run: sudo apt-get install -y sshpass
  #     - name: Deploy via Rsync (Password)
  #       env:
  #         DEPLOY_PASS: ${{ secrets.DEPLOY_SSH_KEY2 }} # Mapped from password secret
  #         DEPLOY_HOST: ${{ secrets.DEPLOY_HOST2 }}
  #         DEPLOY_PORT: ${{ secrets.DEPLOY_SSH_PORT2 }}
  #         DEPLOY_USER: ${{ secrets.DEPLOY_USER2 }}
  #         DEPLOY_PATH: ${{ secrets.DEPLOY_PATH2 }}
  #       run: |
  #         mkdir -p ~/.ssh
  #         ssh-keyscan -p $DEPLOY_PORT -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  #         
  #         sshpass -p "$DEPLOY_PASS" ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "sudo chown -R $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH || true"
  #         sshpass -p "$DEPLOY_PASS" rsync -avz --delete --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r -e "ssh -p $DEPLOY_PORT -o StrictHostKeyChecking=no" public/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
  #         sshpass -p "$DEPLOY_PASS" ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "sudo chown -R www-data:www-data $DEPLOY_PATH || true"

  # =================================================================================================
  # SECURITY SCANNING
  # =================================================================================================
 
