stages:
  - translate
  - build
  - deploy
  - secret-detection

variables:
  SECRET_DETECTION_ENABLED: 'true'
  HUGO_VERSION: '0.147.8'

translate:
  stage: translate
  image: python:3.11-alpine
  before_script:
    - apk add --no-cache git openssh-client bash coreutils
    - pip install --no-cache-dir openai
    - git config --global user.name "GitLab CI"
    - git config --global user.email "ci@i2p.www"
  script:
    # Skip if last commit was made by GitLab CI (prevents infinite loops)
    - |
      LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
      if [ "$LAST_AUTHOR" = "GitLab CI" ]; then
        echo "Last commit was made by GitLab CI, skipping translation to prevent loops"
        exit 0
      fi
    - bash scripts/ci_translate.sh
  only:
    changes:
      - content/en/**/*.md
    refs:
      - main
  timeout: 1h 30m

build:
  stage: build
  image: golang:1.23-alpine
  before_script:
    - apk add --no-cache wget git libc6-compat libstdc++ libwebp-tools
    - wget -q https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz
    - tar -xzf hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz
    - chmod +x hugo
    - mv hugo /usr/local/bin/hugo
    - /usr/local/bin/hugo version
  script:
    - /usr/local/bin/hugo --minify --gc
    - echo "Converting PNG images to WebP..."
    - find public -name "*.png" -type f | while read png; do webp="${png%.png}.webp"; cwebp -q 90 "$png" -o "$webp" && rm "$png"; done
    - echo "Updating HTML references from .png to .webp..."
    - find public -name "*.html" -type f -exec sed -i 's/\.png/\.webp/g' {} +
  artifacts:
    paths:
      - public/
    expire_in: 1 hour
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
    - mkdir -p ~/.ssh
    - echo "$DEPLOY_SSH_KEY" | base64 -d > ~/.ssh/deploy_key
    - chmod 600 ~/.ssh/deploy_key
    - ssh-keyscan -p $DEPLOY_SSH_PORT -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - ssh -i ~/.ssh/deploy_key -p $DEPLOY_SSH_PORT $DEPLOY_USER@$DEPLOY_HOST "sudo chown -R $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH || true"
    - rsync -avz --delete --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r -e "ssh -i ~/.ssh/deploy_key -p $DEPLOY_SSH_PORT -o StrictHostKeyChecking=no" public/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - ssh -i ~/.ssh/deploy_key -p $DEPLOY_SSH_PORT $DEPLOY_USER@$DEPLOY_HOST "sudo chown -R www-data:www-data $DEPLOY_PATH || true"
  after_script:
    - rm -f ~/.ssh/deploy_key
  dependencies:
    - build
  only:
    - main

secret_detection:
  stage: secret-detection

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
