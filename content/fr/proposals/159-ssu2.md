---
title: "SSU2"
number: "159"
author: "eyedeekay, orignal, zlatinb, zzz"
created: "2021-09-12"
lastupdated: "2025-03-05"
status: "Closed"
thread: "http://zzz.i2p/topics/2612"
target: "0.9.56"
---

## Statut

Plan de déploiement :


| Fonctionnalité | Test (pas par défaut) | Activé par défaut |
|----------------|-----------------------|-------------------|
| Code de test local | 2022-02 |
| Code de test conjoint | 2022-03 |
| Test conjoint dans le réseau | 0.9.54 | 2022-05 |
| Gel du protocole de base | 0.9.54 | 2022-05 |
| Session de base | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Validation d'adresse (retry) | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| RI fragmenté lors de la poignée de main 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Nouveau Token | 0.9.55 | 2022-08 | 0.9.57 | 2022-11 |
| Gel du protocole étendu | 0.9.55 | 2022-08 |
| Relais | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Test de pair | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Activer pour 2% au hasard | 0.9.55 | 2022-08 |
| Validation de chemin | 0.9.55+ dev | 0.9.56 | 2022-11 |
| Migration de connexion | 0.9.55+ dev | 0.9.56 | 2022-11 |
| Drapeau ACK immédiat | 0.9.55+ dev | 0.9.56 | 2022-11 |
| Rotation de clé | 0.9.57 | 2023-02 | 0.9.58 | 2023-05 |
| Désactiver SSU 1 (i2pd) | 0.9.56 | 2022-11 |
| Désactiver SSU 1 (Java I2P) | 0.9.58 | 2023-05 | 0.9.61 | 2023-12 |

La session de base inclut la phase de poignée de main et la phase de données.
Le protocole étendu inclut le relais et le test de pair.



## Vue d'ensemble

Cette proposition décrit un protocole d'accord de clé authentifié pour améliorer
la résistance de [SSU](/en/docs/transport/ssu/) à diverses formes d'identification automatisée et d'attaques.

La proposition est organisée comme suit : les objectifs de sécurité sont présentés,
suivis d'une discussion sur le protocole de base. Ensuite, une spécification complète
de tous les messages de protocole est donnée. Enfin, les adresses de routeur et
l'identification de version sont discutées.

Comme pour les autres transports I2P, SSU2 est défini pour le transport point à point (routeur-à-routeur) des messages I2NP. Ce n'est pas un tuyau de données à usage général. Comme [SSU](/en/docs/transport/ssu/), il fournit également deux services supplémentaires : le relais pour le contournement NAT et le test de pair pour déterminer la disponibilité en entrée. Il offre également un troisième service, inédit dans SSU, pour la migration de connexion lorsqu'un pair change d'adresse IP ou de port.


## Motivation

SSU est la seule couche de protocole restante qui nécessite ElGamal, qui est très lente. Le contrôle de flux pour SSU est complexe et ne fonctionne pas bien. Des parties de SSU sont vulnérables aux attaques d'usurpation d'adresse. La poignée de main n'utilise pas Noise.



## Objectifs de conception

- Réduire l'utilisation du CPU en éliminant ElGamal. Utiliser X25519 pour le DH.

- Maintenir les fonctions de test de pair et de relais, et augmenter leur sécurité.

- Faciliter l'implémentation en permettant des algorithmes de contrôle de flux standard.

- Réduire la latence d'installation. Le temps d'installation médian est actuellement d'environ 135 ms pour NTCP2 et 187 ms pour SSU, même si NTCP2 a un aller-retour supplémentaire ; remplacer ElGamal dans SSU2 devrait le réduire, mais d'autres changements pourraient également aider.

- Maintenir ou augmenter le débit maximal par rapport à SSU 1, tel que mesuré sur une gamme de latences simulées et de pourcentages de perte de paquets sur un testnet.

- Empêcher les attaques d'amplification de trafic et de routage incorrect à partir d'adresses sources usurpées via la "validation d'adresse".

- Faciliter l'identification des paquets, pour réduire la dépendance aux solutions de secours et aux heuristiques qui rendent le code inutilement complexe.

- Formaliser et améliorer la migration de connexion lorsque l'adresse IP ou le port du pair change. Ne pas migrer les connexions tant que la validation de l'adresse n'est pas terminée, pour éviter les attaques. Certaines implémentations de SSU 1 utilisent des heuristiques coûteuses pour gérer les changements de port dus au rebinding NAT. Aucune implémentation connue de SSU 1 ne peut gérer les changements d'IP.

- Prendre en charge SSU 1 et 2 sur un seul port, détecter automatiquement, et être publié comme un seul "transport" (c'est-à-dire [RouterAddress](/en/docs/spec/common-structures/#routeraddress/)) dans le [NetDB](/en/docs/how/network-database/).

- Publier le support pour la version 1 uniquement, 2 uniquement, ou 1+2 dans le NetDB dans un champ séparé, et par défaut à la version 1 seulement (ne pas lier le support de version à une version particulière de routeur).

- S'assurer que toutes les implémentations (Java/i2pd/Go) peuvent ajouter le support de la version 2 (ou non) selon leurs propres calendriers.

- Ajouter un remplissage aléatoire à tous les messages, y compris les messages de poignée de main et de données. Tout le remplissage doit être couvert par le MAC, contrairement au remplissage de fin de paquet dans SSU 1. Fournir un mécanisme d'options pour que les deux parties puissent demander un remplissage minimum et maximum et/ou une distribution de remplissage. Les spécificités de la distribution de remplissage dépendent de l'implémentation et peuvent ou non être spécifiées dans le protocole lui-même.

- Obscurcir les en-têtes et le contenu des messages qui ne sont pas complètement chiffrés de manière suffisante pour que les boîtes DPI et les signatures AV ne puissent pas facilement les classer. S'assurer également que les messages envoyés à un seul pair ou un ensemble de pairs n'ont pas un modèle similaire de bits.

- Corriger la perte de bits dans le DH due au format Java [Ticket1112](http://{{ i2pconv('trac.i2p2.i2p') }}/ticket/1112), et accélérer le DH en passant à X25519.

- Passer à une véritable fonction de dérivation de clé (KDF) plutôt que d'utiliser directement le résultat du DH.

- Ajouter une "résistance aux sondages" (comme Tor l'appelle) ; cela inclut la résistance à la relecture.

- Maintenir un échange de clé authentifié bidirectionnel (2W-AKE). 1W-AKE n'est pas suffisant pour notre application.

- S'appuyer sur la clé publique statique publiée dans le RouterInfo en tant qu'une autre partie de l'authentification.

- Ajouter des options/versions dans la poignée de main pour une extensibilité future.

- Ne pas augmenter significativement les besoins en CPU pour l'installation de connexion ; si possible, les réduire considérablement.

- Supprimer l'exigence de remplissage à un multiple de 16 octets imposée par le chiffrement AES dans SSU 1.

- Utiliser ChaCha/Poly1305 standard pour le chiffrement et le MAC, remplaçant le chiffrement AES et le MAC HMAC-MD5-128 non standard utilisé dans SSU 1.

- Utiliser des clés de chiffrement distinctes pour l'envoi et la réception, au lieu des clés communes pour les deux directions utilisées dans SSU 1.

- Utiliser une poignée de main en 3 messages, un aller-retour, comme dans [NTCP2](/en/proposals/111-ntcp-2/). Retirer le délai d'attente des messages de données qui rend [SSU](/en/docs/transport/ssu/) effectivement une poignée de main à deux allers-retours.

- Améliorer considérablement l'efficacité des ACK et NACK, qui est horrible dans SSU 1. Réduire la bande passante requise pour les ACK et NACK, et augmenter la taille des paquets disponible pour les données. Encoder efficacement les NACK pour une rafale de messages manquants, ce qui est courant sur WiFi.

- Réduire la complexité requise pour implémenter la fragmentation des messages I2NP. Contourner les mécanismes de fragmentation et de codage pour les messages I2NP complets.

- Minimiser la surcharge de protocole avant le remplissage, notamment pour les ACK. Bien que le remplissage soit ajouté, la surcharge avant le remplissage reste une surcharge. Les nœuds à faible bande passante doivent être capables d'utiliser SSU2.

- Maintenir les horodatages pour la détection de relecture et de décalage.

- Éviter tout problème de l'année 2038 dans les horodatages, doit fonctionner jusqu'à au moins 2106.

- Augmenter la MTU minimale de 620 à 1280 pour l'efficacité, la facilité d'implémentation, et l'augmentation de la taille maximale des messages I2NP. La fragmentation et le réassemblage sont assez coûteux. En laissant suffisamment de place pour les messages tunnel de 1028 octets, une grande majorité des messages I2NP n'auront pas besoin de fragmentation.

- Augmenter la MTU maximale de 1488 (1484 pour IPv6) à 1500 pour l'efficacité. Retirer l'exigence que la MTU soit un multiple de 16.

- Augmenter la taille maximale des messages I2NP d'environ 32K dans SSU 1 à environ 64 KB comme dans NTCP2.

- Retirer la signature des champs IP et port de la poignée de main, afin que les routeurs qui ne connaissent pas leur IP externe et leur port puissent se connecter.

- Conserver le mécanisme de découverte IP/port de SSU 1 dans la poignée de main, afin que les routeurs puissent découvrir leur IP et leur port externes.

- Inclure des représentants des développeurs de routeur Java, C++, et Go dans la conception.



### Non-objectifs

- Résistance à la DPI à toute épreuve... ce seraient des transports branchables, [Prop109](/en/proposals/109-hashcash/).

- Un transport basé sur TLS (ou ressemblant à HTTPS)... ce serait [Prop104](/en/proposals/104-new-protocol/).

- Résistance à la DPI basée sur le chronométrage (le chronométrage inter-messages/les délais peuvent dépendre de l'implémentation ; des délais intra-messages peuvent être introduits à tout moment, y compris avant l'envoi du remplissage aléatoire, par exemple). Les délais artificiels (ce que obfs4 appelle IAT ou inter-arrival time) sont indépendants du protocole lui-même.

- Négabilité de la participation à une session (il y a des signatures là-dedans).

Non-objectifs qui peuvent être partiellement reconsidérés ou discutés :

- Le degré de protection contre l'inspection approfondie des paquets (DPI)

- Sécurité Post-Quantu
