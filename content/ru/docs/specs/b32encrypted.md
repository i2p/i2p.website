---
title: "B32 для зашифрованных LeaseSets (наборы входящих туннелей назначения)"
description: "Формат адреса Base 32 для зашифрованных LS2 (второй версии) leaseSets"
slug: "b32encrypted"
lastUpdated: "2025-10"
accurateFor: "2.10.0"
status: "Реализовано"
---

## Обзор

Стандартные адреса Base 32 ("b32") содержат хэш назначения. Это не будет работать для зашифрованных LS2 (обновлённый формат LeaseSet) (proposal 123).

Мы не можем использовать традиционный адрес base 32 для зашифрованного LS2 (предложение 123), поскольку он содержит только хэш назначения. Он не предоставляет неослепленный открытый ключ. Клиентам необходимо знать открытый ключ назначения, тип подписи, тип ослепленной подписи, а также, при необходимости, секрет или закрытый ключ, чтобы получить и расшифровать leaseset. Следовательно, одного адреса base 32 недостаточно. Клиенту нужен либо полное назначение (которое содержит открытый ключ), либо сам открытый ключ. Если у клиента есть полное назначение в адресной книге, и адресная книга поддерживает обратный поиск по хэшу, то открытый ключ может быть получен.

В этом формате в base32-адрес вместо хэша помещается открытый ключ. Этот формат также должен содержать тип подписи открытого ключа и тип подписи схемы ослепления.

В этом документе определяется формат b32 для этих адресов. Хотя в ходе обсуждений мы называли этот новый формат «адресом b33», фактический новый формат сохраняет обычный суффикс «.b32.i2p».

## Статус реализации

Предложение 123 (Новые записи netDB) было полностью реализовано в версии 0.9.43 (октябрь 2019 года). Набор функций зашифрованного LS2 (второе поколение leaseSet) оставался стабильным вплоть до версии 2.10.0 (сентябрь 2025 года), без изменений, нарушающих совместимость, в формате адресации или криптографических спецификациях.

Ключевые этапы реализации: - 0.9.38: поддержка Floodfill для стандартного LS2 с офлайн-ключами - 0.9.39: тип подписи RedDSA 11 и базовое шифрование/дешифрование - 0.9.40: полная поддержка адресации B32 (Proposal 149) - 0.9.41: поклиентская аутентификация на основе X25519 - 0.9.42: все возможности ослепления задействованы - 0.9.43: объявлено о завершении реализации (октябрь 2019)

## Проектирование

- Новый формат содержит неослеплённый открытый ключ, неослеплённый тип подписи и ослеплённый тип подписи.
- При необходимости указывает требования к секретному и/или закрытому ключу для приватных ссылок.
- Использует существующий суффикс ".b32.i2p", но с большей длиной.
- Включает контрольную сумму для обнаружения ошибок.
- Адреса для зашифрованных leasesets распознаются по 56 или более закодированным символам (35 или более декодированных байтов) по сравнению с 52 символами (32 байта) у традиционных адресов Base32.

## Спецификация

### Создание и кодирование

Сформируйте имя хоста вида {56+ chars}.b32.i2p (35+ символов в двоичном виде) следующим образом:

```
flag (1 byte)
  bit 0: 0 for one-byte sigtypes, 1 for two-byte sigtypes
  bit 1: 0 for no secret, 1 if secret is required
  bit 2: 0 for no per-client auth,
         1 if client private key is required
  bits 7-3: Unused, set to 0

public key sigtype (1 or 2 bytes as indicated in flags)
  If 1 byte, the upper byte is assumed zero

blinded key sigtype (1 or 2 bytes as indicated in flags)
  If 1 byte, the upper byte is assumed zero

public key
  Number of bytes as implied by sigtype
```
Постобработка и контрольная сумма:

```
Construct the binary data as above.
Treat checksum as little-endian.
Calculate checksum = CRC-32(data[3:end])
data[0] ^= (byte) checksum
data[1] ^= (byte) (checksum >> 8)
data[2] ^= (byte) (checksum >> 16)

hostname = Base32.encode(data) || ".b32.i2p"
```
Любые неиспользованные биты в конце b32 (адрес в кодировке base32) должны быть равны 0. Для стандартного 56-символьного (35-байтного) адреса неиспользованных битов нет.

### Декодирование и проверка

```
strip the ".b32.i2p" from the hostname
data = Base32.decode(hostname)
Calculate checksum = CRC-32(data[3:end])
Treat checksum as little-endian.
flags = data[0] ^ (byte) checksum
if 1 byte sigtypes:
  pubkey sigtype = data[1] ^ (byte) (checksum >> 8)
  blinded sigtype = data[2] ^ (byte) (checksum >> 16)
else (2 byte sigtypes):
  pubkey sigtype = data[1] ^ ((byte) (checksum >> 8)) || data[2] ^ ((byte) (checksum >> 16))
  blinded sigtype = data[3] || data[4]
parse the remainder based on the flags to get the public key
```
### Длина в битах секретных и закрытых ключей

Биты «секрета» и «закрытого ключа» используются для указания клиентам, прокси или другому клиентскому коду, что для расшифрования leaseset (набор lease-записей) потребуется секрет и/или закрытый ключ. Отдельные реализации могут предложить пользователю ввести необходимые данные или отклонить попытки подключения, если требуемые данные отсутствуют.

Эти биты служат лишь индикаторами. Секретный или закрытый ключ ни при каких обстоятельствах не должен включаться в сам B32-адрес, так как это поставило бы под угрозу безопасность.

## Детали криптографии

### Схема ослепления

В схеме ослепления используется RedDSA (схема цифровой подписи), основанная на Ed25519 и дизайне ZCash, формируя подписи Red25519 на кривой Ed25519 с использованием SHA-512. Такой подход гарантирует, что ослеплённые открытые ключи остаются в подгруппе простого порядка, избегая проблем безопасности, присущих некоторым альтернативным конструкциям.

Ослеплённые ключи подвергаются ежедневной ротации на основе даты UTC по следующей формуле:

```
blinded_key = BLIND(unblinded_key, date, optional_secret)
```
Место хранения в DHT (распределённой хеш-таблице) вычисляется следующим образом:

```
SHA256(type_byte || blinded_public_key)
```
### Шифрование

Зашифрованный leaseSet использует потоковый шифр ChaCha20 для шифрования, выбранный за высокую производительность на устройствах без аппаратного ускорения AES. В спецификации применяется HKDF для деривации ключей и X25519 — для операций Диффи‑Хеллмана.

Зашифрованные leaseSet имеют трёхслойную структуру: - Внешний слой: незашифрованные метаданные - Средний слой: аутентификация клиента (методы DH (Диффи — Хеллман) или PSK (предварительно разделённый ключ)) - Внутренний слой: собственно данные LS2 с информацией о lease

### Методы аутентификации

Аутентификация для отдельных клиентов поддерживает два метода:

**Аутентификация DH**: Использует согласование ключей X25519. Каждый авторизованный клиент предоставляет серверу свой открытый ключ, а сервер шифрует средний слой, используя общий секрет, полученный из ECDH.

**Аутентификация PSK**: Использует предварительно распределённые ключи непосредственно для шифрования.

В B32 address (адресе в формате Base32) второй флаговый бит указывает, требуется ли аутентификация для каждого клиента.

## Кэширование

Хотя это выходит за рамки данной спецификации, routers и клиенты должны запоминать и кэшировать (рекомендуется постоянное хранение) соответствие между открытым ключом и назначением, и наоборот.

Служба именования blockfile (служба именования на основе блочного файла), стандартная система адресных книг I2P с версии 0.9.8, поддерживает несколько адресных книг со специальной таблицей обратного поиска, обеспечивающей быстрый поиск по хэшу. Эта функциональность критически важна для разрешения зашифрованных leaseSet, когда изначально известен только хэш.

## Типы подписей

Начиная с I2P версии 2.10.0, определены типы подписи с 0 по 11. Однобайтовое кодирование остаётся стандартным; двухбайтовое кодирование доступно, но на практике не используется.

**Часто используемые типы:** - Тип 0 (DSA_SHA1): Устарел для router, поддерживается для назначений - Тип 7 (EdDSA_SHA512_Ed25519): Текущий стандарт для идентификаторов router и назначений - Тип 11 (RedDSA_SHA512_Ed25519): Исключительно для зашифрованных LS2 leasesets с поддержкой blinding (ослепления)

**Важное примечание**: Только Ed25519 (тип 7) и Red25519 (тип 11) поддерживают ослепление, необходимое для зашифрованных leaseSet. Другие типы подписей не могут использоваться с этой функцией.

Типы 9-10 (алгоритмы ГОСТ) остаются зарезервированными, но не реализованными. Типы 4-6 и 8 помечены как "только офлайн" для ключей подписи, используемых офлайн.

## Примечания


## Совместимость версий

Данная спецификация актуальна для I2P версии 0.9.47 (август 2020 года) по версию 2.10.0 (сентябрь 2025 года) включительно. За этот период не произошло изменений, нарушающих совместимость, в формате адресации B32 (адреса в base32), структуре зашифрованного LS2 (LeaseSet версии 2) или криптографических реализациях. Все адреса, созданные в версии 0.9.47, остаются полностью совместимыми с текущими версиями.

## Ссылки

**CRC-32** - [CRC-32 (Википедия)](https://en.wikipedia.org/wiki/CRC-32) - [RFC 3309: контрольная сумма протокола управления передачей потоков (Stream Control Transmission Protocol, SCTP)](https://tools.ietf.org/html/rfc3309)

**Спецификации I2P** - [Спецификация зашифрованного LeaseSet](/docs/specs/encryptedleaseset/) - [Предложение 123: Новые записи netDB](/proposals/123-new-netdb-entries/) - [Предложение 149: B32 для зашифрованного LS2 (LeaseSet 2 — формат LeaseSet версии 2)](/proposals/149-b32-encrypted-ls2/) - [Спецификация общих структур](/docs/specs/common-structures/) - [Именование и адресная книга](/docs/overview/naming/)

**Сравнение Tor** - [ветка обсуждения Tor (контекст проектирования)](https://lists.torproject.org/pipermail/tor-dev/2017-January/011816.html)

**Дополнительные ресурсы** - [Проект I2P](/) - [Форум I2P](https://i2pforum.net) - [Документация по Java API](http://docs.i2p-projekt.de/javadoc/)
