---
title: "UDP-анонсы BitTorrent"
description: "Спецификация протокола для announce-запросов (запросов клиента к трекеру) UDP-трекера BitTorrent в I2P"
slug: "udp-bittorrent-announces"
lastUpdated: "2025-10"
accurateFor: "2.10.0"
---

## Обзор

Данная спецификация описывает протокол UDP announce-запросов BitTorrent в I2P (запросов к трекеру). Общую спецификацию BitTorrent в I2P см. в [BitTorrent over I2P documentation](/docs/applications/bittorrent/). Для справочной информации и дополнительных сведений о разработке этой спецификации см. [Proposal 160](/proposals/160-udp-trackers/).

Этот протокол был официально утверждён 24 июня 2025 года и реализован в I2P версии 2.10.0 (API 0.9.67), выпущенной 8 сентября 2025 года. Поддержка UDP‑трекеров в настоящее время работает в сети I2P с несколькими продакшен‑трекерами и полной поддержкой в клиенте i2psnark.

## Проектирование

В этой спецификации используются отвечаемые датаграммы формата Datagram2, отвечаемые датаграммы формата Datagram3 и сырые датаграммы, как определено в [Спецификации датаграмм I2P](/docs/api/datagrams/). Datagram2 и Datagram3 — это варианты отвечаемых датаграмм, определённые в [Предложении 163](/proposals/163-datagram2/). Datagram2 добавляет защиту от атак повторного воспроизведения (replay) и поддержку офлайн-подписей. Datagram3 меньше, чем старый формат датаграмм, но без аутентификации.

### BEP 15

Для справки, последовательность сообщений, определённая в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), выглядит следующим образом:

```
Client                        Tracker
  Connect Req. ------------->
    <-------------- Connect Resp.
  Announce Req. ------------->
    <-------------- Announce Resp.
  Announce Req. ------------->
    <-------------- Announce Resp.
```
Фаза подключения необходима для предотвращения подмены IP-адреса. Трекер возвращает идентификатор соединения, который клиент использует в последующих announce-запросах (запросах announce к трекеру). Этот идентификатор соединения по умолчанию истекает через одну минуту на стороне клиента и через две минуты на стороне трекера.

I2P использует ту же схему обмена сообщениями, что и BEP 15, для удобства внедрения в существующие клиентские кодовые базы с поддержкой UDP, для повышения эффективности, а также по соображениям безопасности, обсуждаемым ниже:

```
Client                        Tracker
  Connect Req. ------------->       (Repliable Datagram2)
    <-------------- Connect Resp.   (Raw)
  Announce Req. ------------->      (Repliable Datagram3)
    <-------------- Announce Resp.  (Raw)
  Announce Req. ------------->      (Repliable Datagram3)
    <-------------- Announce Resp.  (Raw)
           ...
```
Это потенциально обеспечивает значительную экономию пропускной способности по сравнению с announce-запросами через streaming (TCP). Хотя Datagram2 примерно того же размера, что и streaming SYN, сырой ответ значительно меньше, чем streaming SYN ACK. Последующие запросы используют Datagram3, а последующие ответы передаются в сыром виде.

Announce-запросы передаются в формате Datagram3 (тип датаграммы третьей версии), чтобы трекеру не приходилось поддерживать большую таблицу соответствия идентификаторов соединений назначению announce или его хешу. Вместо этого трекер может криптографически генерировать идентификаторы соединений из хеша отправителя, текущей метки времени (привязанной к некоторому интервалу) и секретного значения. Когда поступает announce-запрос, трекер валидирует идентификатор соединения, а затем использует хеш отправителя Datagram3 в качестве цели отправки.

### Время жизни соединения

[BEP 15](http://www.bittorrent.org/beps/bep_0015.html) указывает, что идентификатор соединения (connection ID) истекает через одну минуту на стороне клиента и через две минуты на стороне трекера. Это не настраивается. Это ограничивает потенциальный выигрыш в эффективности, если только клиенты не будут группировать announce-запросы (запросы анонса к трекеру), выполняя их все в пределах одноминутного окна. i2psnark в настоящее время не группирует announce-запросы; он распределяет их по времени, чтобы избежать всплесков трафика. Сообщается, что продвинутые пользователи запускают одновременно тысячи торрентов, и отправка такого количества announce-запросов в течение одной минуты нереалистична.

Здесь предлагается расширить ответ на connect, добавив необязательное поле времени жизни соединения. Если поле отсутствует, значение по умолчанию — одна минута. В противном случае указанное в секундах время жизни должно использоваться клиентом, а трекер будет сохранять идентификатор соединения действительным еще на одну минуту сверх этого.

### Совместимость с BEP 15

Этот дизайн максимально сохраняет совместимость с [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), чтобы минимизировать изменения, необходимые в существующих клиентах и трекерах.

Единственное обязательное изменение — формат информации о пирах в ответе на announce. Добавление поля lifetime в ответ на connect не является обязательным, но настоятельно рекомендуется для повышения эффективности, как объяснено выше.

### Анализ безопасности

Важной целью протокола анонса по UDP является предотвращение подмены адресов. Клиент должен реально существовать и включать реальный leaseSet. У него должны быть входящие tunnels, чтобы получить Connect Response (ответ на соединение). Эти tunnels могли бы быть zero-hop (с нулевым числом хопов) и строиться мгновенно, но это раскрыло бы создателя. Этот протокол достигает этой цели.

### Проблемы

Этот протокол не поддерживает blinded destinations (ослеплённые назначения), но может быть расширен для их поддержки. См. ниже.

## Спецификация

### Протоколы и порты

Дейтаграммы с возможностью ответа Datagram2 используют протокол I2CP 19; дейтаграммы с возможностью ответа Datagram3 используют протокол I2CP 20; сырые дейтаграммы используют протокол I2CP 18. Запросы могут быть в формате Datagram2 или Datagram3. Ответы всегда в виде сырых дейтаграмм. Более старый формат отвечаемой дейтаграммы ("Datagram1"), использующий протокол I2CP 17, НЕ должен использоваться для запросов или ответов; такие сообщения должны быть отброшены, если они получены на портах запросов/ответов. Учтите, что формат Datagram1 с протоколом 17 всё ещё используется для протокола DHT (распределённая хеш-таблица).

Запросы используют значение I2CP "to port", указанное в URL анонса; см. ниже. Параметр запроса "from port" выбирается клиентом, но должен быть ненулевым и отличаться от портов, используемых DHT, чтобы ответы можно было легко классифицировать. Трекеры должны отклонять запросы, полученные на неверном порту.

Ответы используют I2CP "to port" (порт назначения) из запроса. Поле "from port" (порт источника) в ответе равно значению "to port" из запроса.

### URL-адрес анонса

Формат URL анонса не определён в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), но, как в clearnet (обычный Интернет), UDP-URL анонса имеют вид "udp://host:port/path". Путь игнорируется и может быть пустым, но в clearnet обычно используется "/announce". Часть :port всегда должна присутствовать; однако, если часть ":port" опущена, используйте порт I2CP по умолчанию 6969, так как это распространённый порт в clearnet. Также могут быть добавлены параметры CGI &a=b&c=d; их можно обработать и передать в запросе announce, см. [BEP 41](http://www.bittorrent.org/beps/bep_0041.html). Если нет параметров или пути, завершающую / также можно опустить, как подразумевается в [BEP 41](http://www.bittorrent.org/beps/bep_0041.html).

### Форматы датаграмм

Все значения передаются в сетевом порядке байтов (big-endian). Не следует ожидать, что пакеты будут точно определённого размера. Будущие расширения могут увеличить размер пакетов.

#### Запрос на подключение

От клиента к трекеру. 16 байт. Должен быть Datagram2 (датаграмма версии 2) с возможностью ответа. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html). Без изменений.

```
Offset  Size            Name            Value
0       64-bit integer  protocol_id     0x41727101980 // magic constant
8       32-bit integer  action          0 // connect
12      32-bit integer  transaction_id
```
#### Ответ на подключение

От трекера к клиенту. 16 или 18 байт. Должно быть в «сыром» виде. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), за исключением указанных ниже отличий.

```
Offset  Size            Name            Value
0       32-bit integer  action          0 // connect
4       32-bit integer  transaction_id
8       64-bit integer  connection_id
16      16-bit integer  lifetime        optional  // Change from BEP 15
```
Ответ ДОЛЖЕН быть отправлен на I2CP «to port», который был получен как «from port» в запросе.

Поле lifetime является необязательным и указывает время жизни connection_id на стороне клиента в секундах. Значение по умолчанию — 60, минимальное (если задано) — 60. Максимум — 65535, то есть примерно 18 часов. Трекер должен сохранять connection_id на 60 секунд дольше, чем время жизни, указанное клиентом.

#### Запрос анонса

От клиента к трекеру. Минимум 98 байт. Должен быть Datagram3 с возможностью ответа. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), за исключением оговоренных ниже отличий.

connection_id соответствует значению, полученному в ответе на connect.

```
Offset  Size            Name            Value
0       64-bit integer  connection_id
8       32-bit integer  action          1     // announce
12      32-bit integer  transaction_id
16      20-byte string  info_hash
36      20-byte string  peer_id
56      64-bit integer  downloaded
64      64-bit integer  left
72      64-bit integer  uploaded
80      32-bit integer  event           0     // 0: none; 1: completed; 2: started; 3: stopped
84      32-bit integer  IP address      0     // default, unused in I2P
88      32-bit integer  key
92      32-bit integer  num_want        -1    // default
96      16-bit integer  port                  // must be same as I2CP from port
98      varies          options     optional  // As specified in BEP 41
```
Изменения по сравнению с [BEP 15](http://www.bittorrent.org/beps/bep_0015.html):

- ключ игнорируется
- IP-адрес не используется
- порт, вероятно, игнорируется, но должен совпадать с I2CP from port
- Раздел options, если он присутствует, определяется в [BEP 41](http://www.bittorrent.org/beps/bep_0041.html)

Ответ ДОЛЖЕН быть отправлен на I2CP "to port", который был получен в запросе в качестве "from port". Не используйте порт из announce request (запроса announce).

#### Ответ на announce

От трекера к клиенту. Минимум 20 байт. Должно быть raw (без кодирования). То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), за исключением отмеченного ниже.

```
Offset  Size            Name            Value
0           32-bit integer  action          1 // announce
4           32-bit integer  transaction_id
8           32-bit integer  interval
12          32-bit integer  leechers
16          32-bit integer  seeders
20   32 * n 32-byte hash    binary hashes     // Change from BEP 15
...                                           // Change from BEP 15
```
Изменения по сравнению с [BEP 15](http://www.bittorrent.org/beps/bep_0015.html):

- Вместо 6-байтового формата IPv4+порт или 18-байтового формата IPv6+порт мы возвращаем последовательность 32-байтовых "compact responses" (компактные ответы) с бинарными хэшами пиров SHA-256. Как и в случае с TCP compact responses, мы не включаем порт.

Ответ ДОЛЖЕН быть отправлен на I2CP "to port", который был получен как "from port" запроса. Не используйте порт из announce-запроса.

I2P датаграммы имеют очень большой максимальный размер — около 64 КБ; однако для надежной доставки следует избегать датаграмм больше 4 КБ. Для эффективного использования пропускной способности трекерам, вероятно, следует ограничить максимальное число пиров примерно до 50, что соответствует приблизительно 1600-байтному пакету до накладных расходов на различных уровнях и после фрагментации должно укладываться в лимит полезной нагрузки сообщения, проходящего через два tunnel.

Как и в BEP 15, количество следующих адресов пиров (для BEP 15 — IP/port, здесь — хэши) не указывается. Хотя это не предусмотрено в BEP 15, можно определить маркер конца списка пиров, состоящий из одних нулей, который будет указывать на то, что информация о пирах завершена и далее следуют данные расширения.

Чтобы в будущем было возможно расширение, клиентам следует игнорировать 32-байтовый хеш, состоящий из одних нулей, а также любые следующие за ним данные. Трекеры должны отклонять announce-запросы (запросы объявления на трекер) с хешем, состоящим из одних нулей, хотя такой хеш уже запрещён в Java routers.

#### Скрейпинг

Запрос/ответ scrape (операция запроса статистики у трекера) из [BEP 15](http://www.bittorrent.org/beps/bep_0015.html) не требуется этой спецификацией, но может быть реализован при желании, без каких-либо изменений. Клиент должен сначала получить идентификатор соединения. Запрос scrape всегда является repliable Datagram3 (тип Datagram3 с возможностью ответа). Ответ scrape всегда raw (тип без возможности ответа).

#### Ответ об ошибке

От трекера к клиенту. Минимум 8 байт (если сообщение пустое). Должно быть в виде сырых данных. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html). Без изменений.

```
Offset  Size            Name            Value
0       32-bit integer  action          3 // error
4       32-bit integer  transaction_id
8       string          message
```
## Расширения

Биты расширений или поле версии не предусмотрены. Клиентам и трекерам не следует предполагать, что пакеты имеют определённый размер. Таким образом, можно добавлять дополнительные поля, не нарушая совместимость. При необходимости рекомендуется формат расширений, определённый в [BEP 41](http://www.bittorrent.org/beps/bep_0041.html).

Ответ на подключение изменён, чтобы добавить необязательный параметр времени жизни идентификатора соединения.

Если требуется поддержка blinded destination (замаскированного адреса назначения), мы можем либо добавить blinded 35-байтный адрес в конец запроса announce, либо запрашивать blinded хэши в ответах, используя формат [BEP 41](http://www.bittorrent.org/beps/bep_0041.html) (параметры будут определены).

Набор blinded 35-байтных адресов пиров может быть добавлен в конец ответа announce, после 32-байтного хеша из одних нулей.

## Рекомендации по реализации

См. раздел о проектировании выше, где обсуждаются проблемы, с которыми сталкиваются неинтегрированные клиенты и трекеры, не использующие I2CP.

### Клиенты

Для данного имени хоста трекера клиенту следует предпочитать UDP‑URL вместо HTTP‑URL и не следует анонсироваться по обоим протоколам.

Клиентам, уже поддерживающим BEP 15, потребуются лишь небольшие изменения.

Если клиент поддерживает DHT или другие датаграммные протоколы, ему, вероятно, следует выбрать другой порт в качестве "from port" запроса, чтобы ответы возвращались на этот порт и не смешивались с сообщениями DHT. Клиент получает в качестве ответов только необработанные датаграммы. Трекеры никогда не отправят клиенту датаграмму с возможностью ответа2.

Клиентам, использующим список opentrackers (открытые трекеры) по умолчанию, следует обновить этот список, добавив UDP URL-адреса после того, как будет подтверждено, что известные opentrackers поддерживают UDP.

Клиенты могут как реализовывать, так и не реализовывать повторную отправку запросов. При наличии повторных отправок следует использовать начальный таймаут не менее 15 секунд и удваивать таймаут при каждой повторной отправке (экспоненциальная задержка).

Клиенты должны выполнить back off (увеличить задержку перед повторной попыткой) после получения ответа с ошибкой.

### Трекеры

Трекерам с уже реализованной поддержкой BEP 15 потребуются лишь небольшие изменения. Эта спецификация отличается от предложения 2014 года тем, что трекер должен поддерживать приём repliable (с возможностью ответа) datagram2 и datagram3 на одном и том же порту.

Чтобы минимизировать требования к ресурсам трекера, этот протокол разработан так, чтобы устранить необходимость в хранении трекером соответствий между хэшами клиентов и идентификаторами соединений для последующей проверки. Это возможно, поскольку пакет запроса announce (запрос к трекеру для регистрации клиента) является пакетом Datagram3 (тип датаграммы в I2P), на который можно ответить, поэтому он содержит хэш отправителя.

Рекомендуемая реализация следующая:

- Определите текущую эпоху как текущее время с шагом, равным времени жизни соединения, `epoch = now / lifetime`.
- Определите криптографическую хэш‑функцию `H(secret, clienthash, epoch)`, которая генерирует значение длиной 8 байт.
- Сгенерируйте случайный постоянный секрет, используемый для всех соединений.
- Для ответов на подключение сгенерируйте `connection_id = H(secret, clienthash, epoch)`
- Для запросов announce проверьте полученный идентификатор соединения в текущей эпохе, проверив, что `connection_id == H(secret, clienthash, epoch) || connection_id == H(secret, clienthash, epoch - 1)`

## Статус развертывания

Этот протокол был утверждён 24 июня 2025 года и полностью функционирует в сети I2P по состоянию на сентябрь 2025 года.

### Текущие реализации

**i2psnark**: Полная поддержка UDP‑трекеров включена в I2P версии 2.10.0 (API 0.9.67), выпущенной 8 сентября 2025 года. Начиная с этой версии, все установки I2P по умолчанию включают поддержку UDP‑трекеров.

**zzzot tracker**: Начиная с версии 0.20.0-beta2 поддерживаются UDP-анонсы. По состоянию на октябрь 2025 года в продакшене работают следующие трекеры: - opentracker.dg2.i2p - opentracker.simp.i2p - opentracker.skank.i2p

### Примечания по совместимости клиента

**Ограничения SAM v3.3**: Внешние BitTorrent-клиенты, использующие SAM (Simple Anonymous Messaging), требуют поддержки Datagram2/3 (режимов датаграммной передачи без установления соединения) в SAM v3.3. Это доступно в Java I2P, но в настоящее время не поддерживается i2pd (реализация I2P на C++), что может ограничивать распространение среди клиентов на базе libtorrent, таких как qBittorrent.

**Клиенты I2CP**: Клиенты, использующие I2CP напрямую (например, BiglyBT), могут реализовать поддержку UDP-трекеров без ограничений SAM.

## Ссылки

- **[BEP15]**: [Протокол UDP-трекера BitTorrent](http://www.bittorrent.org/beps/bep_0015.html)
- **[BEP41]**: [Расширения протокола UDP-трекера](http://www.bittorrent.org/beps/bep_0041.html)
- **[DATAGRAMS]**: [Спецификация датаграмм I2P](/docs/api/datagrams/)
- **[Prop160]**: [Предложение по UDP-трекерам](/proposals/160-udp-trackers/)
- **[Prop163]**: [Предложение Datagram2](/proposals/163-datagram2/)
- **[SPEC]**: [BitTorrent поверх I2P](/docs/applications/bittorrent/)
