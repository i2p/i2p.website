---
title: "Маршрутизация туннелей"
description: "Обзор терминологии I2P туннелей, их построения и жизненного цикла"
slug: "tunnel-routing"
lastUpdated: "2025-10"
accurateFor: "2.10.0"
---

## Обзор

I2P строит временные, однонаправленные tunnel — упорядоченные последовательности router, которые пересылают зашифрованный трафик. Tunnel классифицируются как **inbound** (сообщения движутся к создателю) или **outbound** (сообщения движутся от создателя).

Типичный обмен направляет сообщение Алисы через один из её исходящих туннелей, инструктирует конечную точку исходящего туннеля переслать его к шлюзу одного из входящих туннелей Боба, после чего Боб получает его на своей входящей конечной точке.

![Alice соединяется через свой исходящий tunnel с Bob через его входящий tunnel](/images/tunnelSending.png)

- **A**: Outbound Gateway (Алиса)
- **B**: Outbound Participant
- **C**: Outbound Endpoint
- **D**: Inbound Gateway
- **E**: Inbound Participant
- **F**: Inbound Endpoint (Боб)

Туннели имеют фиксированное время жизни 10 минут и передают сообщения фиксированного размера 1024 байта (1028 байт включая заголовок туннеля), чтобы предотвратить анализ трафика на основе размера сообщений или временных паттернов.

## Словарь терминов Tunnel

- **Tunnel gateway:** Первый router в туннеле. Для входящих туннелей идентификатор этого router'а появляется в опубликованном [LeaseSet](/docs/specs/common-structures/). Для исходящих туннелей gateway является исходным router'ом (A и D выше).
- **Tunnel endpoint:** Последний router в туннеле (C и F выше).
- **Tunnel participant:** Промежуточный router в туннеле (B и E выше). Участники не могут определить свою позицию или направление туннеля.
- **n-hop tunnel:** Количество межроутерных переходов.
  - **0-hop:** Gateway и endpoint являются одним и тем же router'ом – минимальная анонимность.
  - **1-hop:** Gateway подключается напрямую к endpoint – низкая задержка, низкая анонимность.
  - **2-hop:** По умолчанию для исследовательских туннелей; баланс между безопасностью и производительностью.
  - **3-hop:** Рекомендуется для приложений, требующих сильной анонимности.
- **Tunnel ID:** 4-байтовое целое число, уникальное для каждого router'а и каждого перехода, случайно выбираемое создателем. Каждый переход получает и перенаправляет с разными ID.

## Информация о построении туннелей

Роутеры, выполняющие роли gateway, participant и endpoint, получают различные записи в сообщении Tunnel Build Message. Современный I2P поддерживает два метода:

- **ElGamal** (устаревший, записи размером 528 байт)
- **ECIES-X25519** (текущий, записи размером 218 байт через Short Tunnel Build Message – STBM)

### Information Distributed to Participants

**Gateway получает:** - Ключ туннельного слоя (ключ AES-256 или ChaCha20 в зависимости от типа tunnel) - Ключ туннельного IV (для шифрования векторов инициализации) - Ключ ответа и IV ответа (для шифрования ответа на построение) - ID туннеля (только для входящих gateway) - Хеш идентификатора следующего узла и ID туннеля (если не конечный)

**Промежуточные участники получают:** - Ключ tunnel layer и ключ IV для своего hop - Tunnel ID и информацию о следующем hop - Ключ ответа и IV для шифрования build response

**Конечные точки получают:** - Ключи уровня tunnel и IV - Ответный router и идентификатор tunnel (только для исходящих конечных точек) - Ключ ответа и IV (только для исходящих конечных точек)

Для получения полной информации см. [Спецификацию создания туннелей](/docs/specs/implementation/) и [Спецификацию создания туннелей ECIES](/docs/specs/implementation/).

## Tunnel Pooling

Роутеры объединяют туннели в **пулы туннелей** для обеспечения избыточности и распределения нагрузки. Каждый пул поддерживает несколько параллельных туннелей, обеспечивая переключение при отказе одного из них. Пулы, используемые внутри системы, называются **exploratory tunnels** (исследовательские туннели), в то время как специфичные для приложений пулы — это **client tunnels** (клиентские туннели).

Каждое назначение поддерживает отдельные входящие и исходящие пулы, настраиваемые через параметры I2CP (количество туннелей, количество резервных, длина и параметры QoS). Роутеры отслеживают состояние туннелей, проводят периодические тесты и автоматически перестраивают отказавшие туннели для поддержания размера пула.

## Пулирование туннелей

**0-hop Tunnels**: Обеспечивают только правдоподобное отрицание. Трафик всегда исходит и завершается на одном и том же router — не рекомендуется для анонимного использования.

**Туннели с 1 hop** : Обеспечивают базовую анонимность против пассивных наблюдателей, но уязвимы, если противник контролирует этот единственный hop.

**2-хоповые туннели**: Включают два удаленных роутера и существенно увеличивают стоимость атаки. По умолчанию для исследовательских пулов.

**3-hop Tunnels**: Рекомендуется для приложений, требующих надежной защиты анонимности. Дополнительные хопы увеличивают задержку без существенного улучшения безопасности.

**По умолчанию**: Роутеры используют **2-хоповые** исследовательские tunnels и специфичные для приложений **2- или 3-хоповые** клиентские tunnels, обеспечивая баланс между производительностью и анонимностью.

## Длина туннеля

Роутеры периодически тестируют туннели, отправляя `DeliveryStatusMessage` через исходящий туннель во входящий туннель. Если тест не проходит, оба туннеля получают отрицательный вес профиля. Последовательные сбои помечают туннель как неработоспособный; после этого роутер создает замену и публикует новый LeaseSet. Результаты используются в метриках пропускной способности узлов, применяемых [системой выбора узлов](/docs/overview/tunnel-routing/).

## Тестирование туннелей

Роутеры строят туннели используя неинтерактивный **телескопический** метод: одно сообщение Tunnel Build Message распространяется от узла к узлу. Каждый узел расшифровывает свою запись, добавляет свой ответ и пересылает сообщение дальше. Конечный узел возвращает совокупный ответ о построении по другому пути, предотвращая корреляцию. Современные реализации используют **Short Tunnel Build Messages (STBM)** для ECIES и **Variable Tunnel Build Messages (VTBM)** для устаревших путей. Каждая запись шифруется для каждого узла с использованием ElGamal или ECIES-X25519.

## Создание туннеля

Трафик туннеля использует многослойное шифрование. Каждый hop (промежуточный узел) добавляет или удаляет слой шифрования по мере прохождения сообщений через туннель.

- **ElGamal tunnels:** AES-256/CBC для полезной нагрузки с дополнением PKCS#5.
- **ECIES tunnels:** ChaCha20 или ChaCha20-Poly1305 для аутентифицированного шифрования.

Каждый hop имеет два ключа: **layer key** и **IV key**. Роутеры расшифровывают IV, используют его для обработки полезной нагрузки, затем повторно шифруют IV перед пересылкой. Эта схема двойного IV предотвращает маркировку сообщений.

Исходящие шлюзы предварительно расшифровывают все слои, чтобы конечные точки получали открытый текст после того, как все участники добавили шифрование. Входящие туннели шифруют в обратном направлении. Участники не могут определить направление или длину туннеля.

## Шифрование туннелей

- Динамическое время жизни туннелей и адаптивный размер пула для балансировки сетевой нагрузки
- Альтернативные стратегии тестирования туннелей и диагностика отдельных переходов (hop)
- Опциональная проверка proof-of-work или сертификатов пропускной способности (реализовано в API 0.9.65+)
- Исследование формирования трафика и вставки шума (chaff) для смешивания конечных точек
- Продолжение вывода из эксплуатации ElGamal и миграция на ECIES-X25519

## Текущая разработка

- [Спецификация реализации туннелей](/docs/specs/implementation/)
- [Спецификация создания туннелей (ElGamal)](/docs/specs/implementation/)
- [Спецификация создания туннелей (ECIES-X25519)](/docs/specs/implementation/)
- [Спецификация туннельных сообщений](/docs/specs/implementation/)
- [Garlic-маршрутизация](/docs/overview/garlic-routing/)
- [Сетевая база данных I2P](/docs/specs/common-structures/)
- [Профилирование и выбор узлов](/docs/overview/tunnel-routing/)
- [Модель угроз I2P](/docs/overview/threat-model/)
- [Шифрование ElGamal/AES + SessionTag](/docs/legacy/elgamal-aes/)
- [Параметры I2CP](/docs/specs/i2cp/)
