```markdown
---
title: "Протоколы криптографии после квантовых вычислений"
number: "169"
author: "zzz, orignal, drzed, eyedeekay"
created: "2025-01-21"
lastupdated: "2025-06-12"
status: "Open"
thread: "http://zzz.i2p/topics/3294"
target: "0.9.80"
---

## Обзор

Исследования и конкуренция подходящих криптографических алгоритмов после квантовых вычислений (PQ) ведутся уже десять лет, и лишь недавно выбор стал очевиден.

Мы начали изучать последствия PQ криптографии в 2022 [FORUM](http://zzz.i2p/topics/3294).

Стандарты TLS добавили поддержку гибридного шифрования за последние два года, и оно теперь используется значительной частью шифрованного трафика в интернете благодаря поддержке в Chrome и Firefox [CLOUDFLARE](https://blog.cloudflare.com/pq-2024/).

NIST недавно завершил и опубликовал рекомендуемые алгоритмы для пост-квантовой криптографии [NIST-PQ](https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards). Несколько популярных криптографических библиотек теперь поддерживают стандарты NIST или выпустят поддержку в ближайшем будущем.

Оба [CLOUDFLARE](https://blog.cloudflare.com/pq-2024/) и [NIST-PQ](https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards) рекомендуют начинать миграцию немедленно. См. также FAQ NSA PQ 2022 года [NSA-PQ](https://media.defense.gov/2022/Sep/07/2003071836/-1/-1/0/CSI_CNSA_2.0_FAQ_.PDF). I2P должен быть лидером в области безопасности и криптографии. Пора внедрять рекомендуемые алгоритмы. Используя нашу гибкую систему типов криптографии и типов подписи, мы добавим типы для гибридной криптографии и для PQ и гибридных подписей.


## Цели

- Вибрать резистентные к PQ алгоритмы
- Добавить PQ-единственные и гибридные алгоритмы в протоколы I2P, где это уместно
- Определить несколько вариантов
- Вибрать лучшие варианты после внедрения, тестирования, анализа и исследований
- Добавить поддержку постепенно и с обратной совместимостью


## Не цели

- Не изменять однонаправленные (Noise N) протоколы шифрования
- Не отходить от SHA256, не угрожаемого в ближайшем будущем PQ
- Не выбирать окончательные предпочитаемые варианты на данный момент


## Модель угроз

- Роутеры на OBEP или IBGW, возможно, сговорчивые, сохраняющие чесночные сообщения для последующей дешифровки (прямая секретность)
- Наблюдатели сети, сохраняющие транспортные сообщения для последующей дешифровки (прямая секретность)
- Участники сети подделывающие подписи для RI, LS, потоков, датаграмм или других структур


## Затронутые протоколы

Мы изменим следующие протоколы, приблизительно в порядке разработки. Общий выпуск, вероятно, продлится с конца 2025 года до середины 2027 года. См. раздел Приоритеты и выпуск ниже для получения подробностей.

| Протокол / Функция | Статус |
| ------------------ | ------ |
| Гибридный MLKEM Ratchet и LS | Одобре |
| Гибридный MLKEM NTCP2 | Некото |
| Гибридный MLKEM SSU2 | Некото |
| MLDSA SigTypes 12–14 | Предло |
| MLDSA Dests | Протес |
| Гибридные SigTypes 15–17 | Предва |
| Гибридные Dests |  |




## Дизайн

Мы поддержим стандарты NIST FIPS 203 и 204 [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf) [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf), которые основаны на, но НЕ совместимы с,
CRYSTALS-Kyber и CRYSTALS-Dilithium (версии 3.1, 3 и старше).



### Обмен ключами

Мы поддержим гибридный обмен ключами в следующих протоколах:

| Прото | Тип Noise | Поддержка только | Q?  Поддержка г |
| ----- | --------- | ---------------- | --------------- |
| NTCP2 | XK | нет | да |
| SSU2 | XK | нет | да |
| Ratchet | IK | нет | да |
| TBM | N | нет | нет |
| NetDB | N | нет | нет |


PQ KEM предоставляет только эфемерные ключи и не поддерживает напрямую статические рукопожатия, такие как Noise XK и IK.

Noise N не использует двусторонний обмен ключами, и поэтому он не подходит для гибридного шифрования.

Таким образом, мы будем поддерживать только гибридное шифрование для NTCP2, SSU2 и Ratchet. Мы определим три варианта ML-KEM, как указано в [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf), всего для 3 новых типов шифрования. Гибридные типы будут определены только в сочетании с X25519.

Новые типы шифрования:

| Тип | од |
| --- | --- |
| MLKEM512_X25519 | 5 |
| MLKEM768_X25519 | 6 |
| MLKEM1024_X25519 | 7 |


Накладные расходы будут значительными. Типичные размеры сообщений 1 и 2 (для XK и IK) в настоящее время составляют около 100 байт (до любого дополнительного полезного груза). Это увеличится в 8-15 раз в зависимости от алгоритма.


### Подписи

Мы поддержим PQ и гибридные подписи в следующих структурах:

| Тип | оддержка только | ?  Поддержка ги |
| --- | --------------- | --------------- |
| RouterInfo | да | а |
| LeaseSet | да | а |
| Потоковые SYN/SYNACK/Close | да | а |
| Repliable Datagrams | да | а |
| Datagram2 (предложение. 16 | да | а |
| I2CP создание сессии msg | да | а |
| SU3 файлы | да | а |
| X.509 сертификаты | да | а |
| Java хранилища ключей | да | а |



Таким образом, мы будем поддерживать как только PQ, так и гибридные подписи. Мы определим три варианта ML-DSA, как указано в [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf), три гибридных варианта с Ed25519 и три только PQ варианта с предварительным хешем только для файлов SU3, всего давая 9 новых типов подписей. Гибридные типы будут определены только в сочетании с Ed25519. Мы будем использовать стандартный ML-DSA, а НЕ варианты с предварительным хешем (HashML-DSA), за исключением файлов SU3.

Мы будем использовать "ежедневный" или случайный вариант подписания, а не "детерминистичный" вариант, как указано в [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf) раздел 3.4. Это гарантирует, что каждая подпись будет различна, даже если она над одними и теми же данными, и обеспечивает дополнительную защиту от атак через боковые каналы. См. раздел примечаний к реализации ниже для получения дополнительных деталей о выборе алгоритмов, включая кодирование и контекст.


Новые типы подписей:

| Тип | од |
| --- | --- |
| MLDSA44 | 12 |
| MLDSA65 | 13 |
| MLDSA87 | 14 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 |
| MLDSA44ph | 18 |
| MLDSA65ph | 19 |
| MLDSA87ph | 20 |


X.509 сертификаты и другие кодировки DER будут использовать композитные структуры и OID, определенные в [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/).

Накладные расходы будут значительными. Типичные размеры назначения и идентификации роутера Ed25519 составляют 391 байт.
Эти размера увеличатся в 3.5-6.8 раз в зависимости от алгоритма. Подписи Ed25519 составляют 64 байта.
Эти размера увеличатся в 38-76 раз в зависимости от алгоритма. Типичные подписанные RouterInfo, LeaseSet, реликвийные датаграммы и подписанные потоковые сообщения составляют около 1 КБ. Эти размера увеличатся в 3-8 раз в зависимости от алгоритма.

Поскольку новые типы назначения и идентификации роутера не содержат наполнения, они не будут сжимаемы. Размеры мест назначения и идентификаций роутеров, которые сжаты в пути, увеличатся в 12-38 раз в зависимости от алгоритма.



### Легальные комбинации

Для Назначений новые типы подписей поддерживаются со всеми типами шифрования в наборе проката. Установите тип шифрования в сертификате ключа на NONE (255).

Для Идентификаций Роутера, тип шифрования ElGamal устарел.
Новые типы подписей поддерживаются с типом шифрования X25519 (тип 4) только.
Новые типы шифрования будут указаны в Адресах Роутера.
Тип шифрования в сертификате ключа будет продолжать быть типом 4.



### Требуемая новая криптография

- ML-KEM (ранее CRYSTALS-Kyber) [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf)
- ML-DSA (ранее CRYSTALS-Dilithium) [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf)
- SHA3-128 (ранее Keccak-256) [FIPS202]_ Используется только для SHAKE128
- SHA3-256 (ранее Keccak-512) [FIPS202]_
- SHAKE128 и SHAKE256 (расширения XOF для SHA3-128 и SHA3-256) [FIPS202]_

Тестовые векторы для SHA3-256, SHAKE128 и SHAKE256 находятся на [NIST-VECTORS]_.

Обратите внимание, что библиотека bouncycastle Java поддерживает все вышеперечисленное.
Поддержка библиотеки C++ находится в OpenSSL 3.5 [OPENSSL]_.


### Альтернативы

Мы не будем поддерживать [FIPS205]_ (Sphincs+), он значительно медленнее и больше, чем ML-DSA.
Мы не будем поддерживать предстоящий FIPS206 (Falcon), он еще не стандартизирован.
Мы не будем поддерживать NTRU или других кандидатов на PQ, которые не были стандартизированы NIST.


Rosenpass
`````````

Есть некоторые исследования [PQ-WIREGUARD]_ по адаптации Wireguard (IK) для чистой PQ криптографии, но в этой статье есть несколько открытых вопросов. Позже этот подход был реализован как Rosenpass [Rosenpass]_ [Rosenpass-Whitepaper]_ для PQ Wireguard.

Rosenpass использует рукопожатие, похожее на Noise KK, с предварительно общими статическими ключами Classic McEliece 460896 (по 500 КБ каждый) и эфемерными ключами Kyber-512 (по сути, MLKEM-512).
Поскольку шифротексты Classic McEliece составляют всего 188 байт, а открытые ключи и шифротексты Kyber-512 разумных размеров, оба сообщения рукопожатия помещаются в стандартный MTU UDP.
Выходной общий ключ (osk) из PQ KK-рукопожатия используется в качестве входного предварительно общего ключа (psk) для стандартного рукопожатия Wireguard IK.
Таким образом, всего два полных рукопожатия, одно чистое PQ и одно чистое X25519.

Мы не можем сделать ничего из этого, чтобы заменить наши рукопожатия XK и IK, потому что:

- Мы не можем сделать KK, у Боба нет статического ключа Алисы
- 500КБ статические ключи слишком большие
- Мы не хотим дополнительную поездку

В технической записке много полезной информации, и мы рассмотрим ее для идей и вдохновения. TODO.



## Спецификация

### Общие структуры

Обновите разделы и таблицы в документе общих структур [COMMON](https://geti2p.net/spec/common-structures) следующим образом:


Общественный ключ
````````````````

Новые типы Общественного ключа:

| Тип | лина общественног | ключа |  |
| --- | ----------------- | ----- | --- |
| MLKEM512_X25519 | 32 | 0.9.xx | См. п |
| MLKEM768_X25519 | 32 | 0.9.xx | См. п |
| MLKEM1024_X25519 | 32 | 0.9.xx | См. п |
| MLKEM512 | 800 | 0.9.xx | См. п |
| MLKEM768 | 1184 | 0.9.xx | См. п |
| MLKEM1024 | 1568 | 0.9.xx | См. п |
| MLKEM512_CT | 768 | 0.9.xx | См. п |
| MLKEM768_CT | 1088 | 0.9.xx | См. п |
| MLKEM1024_CT | 1568 | 0.9.xx | См. п |
| NONE | 0 | 0.9.xx | См. п |


Гибридные общественные ключи – это ключ X25519.
KEM общественные ключи – это эфемерный PQ-ключ, отправленный от Алисы к Бобу.
Кодирование и порядок байт определены в [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf).

Ключи MLKEM*_CT не являются по-настоящему общественными ключами, это "шифротекст", отправленный от Боба к Алисе в рукопожатии Noise.
Они перечислены здесь для полноты.



Личный ключ
````````````````

Новые типы Личного ключа:

| Тип | лина личного ключа | С | польз |
| --- | ------------------ | --- | ----- |
| MLKEM512_X25519 | 32 | 0.9.xx | См. п |
| MLKEM768_X25519 | 32 | 0.9.xx | См. п |
| MLKEM1024_X25519 | 32 | 0.9.xx | См. п |
| MLKEM512 | 1632 | 0.9.xx | См. п |
| MLKEM768 | 2400 | 0.9.xx | См. п |
| MLKEM1024 | 3168 | 0.9.xx | См. п |


Гибридные частные ключи – это ключи X25519.
KEM частные ключи – только для Алисы.
Кодирование и порядок байт для KEM определены в [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf).




OpenKey
````````````````

Новые Типы OpenKey:

| Тип | лина (байты) | Ис | льзов |
| --- | ------------ | --- | ----- |
| MLDSA44 | 1312 | 0.9.xx | См. п |
| MLDSA65 | 1952 | 0.9.xx | См. п |
| MLDSA87 | 2592 | 0.9.xx | См. п |
| MLDSA44_EdDSA_SHA512_Ed25519 | 1344 | 0.9.xx | См. п |
| MLDSA65_EdDSA_SHA512_Ed25519 | 1984 | 0.9.xx | См. п |
| MLDSA87_EdDSA_SHA512_Ed25519 | 2624 | 0.9.xx | См. п |
| MLDSA44ph | 1344 | 0.9.xx | Тольк |
| MLDSA65ph | 1984 | 0.9.xx | Тольк |
| MLDSA87ph | 2624 | 0.9.xx | Тольк |


Гибридные открытые ключи подписания – это ключ Ed25519, за которым следует PQ-ключ, как в [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/). Кодирование и порядок байт определены в [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf).


KeyOpenPrivate
```````````````

Новые Типы KeyOpenPrivate:

| Тип | лина (байты) | Ис | льзов |
| --- | ------------ | --- | ----- |
| MLDSA44 | 2560 | 0.9.xx | См. п |
| MLDSA65 | 4032 | 0.9.xx | См. п |
| MLDSA87 | 4896 | 0.9.xx | См. п |
| MLDSA44_EdDSA_SHA512_Ed25519 | 2592 | 0.9.xx | См. п |
| MLDSA65_EdDSA_SHA512_Ed25519 | 4064 | 0.9.xx | См. п |
| MLDSA87_EdDSA_SHA512_Ed25519 | 4928 | 0.9.xx | См. п |
| MLDSA44ph | 2592 | 0.9.xx | Тольк |
| MLDSA65ph | 4064 | 0.9.xx | Тольк |
| MLDSA87ph | 4928 | 0.9.xx | Тольк |


Гибридные частные ключи подписания – это ключ Ed25519, за которым следует PQ-ключ, как в [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/). Кодирование и порядок байт определены в [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf).


Подпись
````````

Новые Типы Подписи:

| Тип | лина (байты) | Ис | льзов |
| --- | ------------ | --- | ----- |
| MLDSA44 | 2420 | 0.9.xx | См. п |
| MLDSA65 | 3309 | 0.9.xx | См. п |
| MLDSA87 | 4627 | 0.9.xx | См. п |
| MLDSA44_EdDSA_SHA512_Ed25519 | 2484 | 0.9.xx | См. п |
| MLDSA65_EdDSA_SHA512_Ed25519 | 3373 | 0.9.xx | См. п |
| MLDSA87_EdDSA_SHA512_Ed25519 | 4691 | 0.9.xx | См. п |
| MLDSA44ph | 2484 | 0.9.xx | Тольк |
| MLDSA65ph | 3373 | 0.9.xx | Тольк |
| MLDSA87ph | 4691 | 0.9.xx | Тольк |


Гибридные подписи – это подпись Ed25519, за которой следует подпись PQ, как в [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/).
Гибридные подписи проверяются путем проверки обеих подписей и отказа
если хотя бы одна не проходит.
Кодирование и порядок байт определены в [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf).



Сертификаты ключей
``````````````````

Новые Типы Подписи открытого ключа:

| Тип | од Типа | щая длина открытого клю | С | Испол |
| --- | ------- | ----------------------- | --- | ----- |
| MLDSA44 | 12 | 1312 | 0.9.xx | См. п |
| MLDSA65 | 13 | 1952 | 0.9.xx | См. п |
| MLDSA87 | 14 | 2592 | 0.9.xx | См. п |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 0.9.xx | См. п |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 0.9.xx | См. п |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 0.9.xx | См. п |
| MLDSA44ph | 18 | n/a | 0.9.xx | Тольк |
| MLDSA65ph | 19 | n/a | 0.9.xx | Тольк |
| MLDSA87ph | 20 | n/a | 0.9.xx | Тольк |




Новые Типы Crypto Публичных Ключей:

| Тип | од Типа | щая длина открытого клю | а С | Испол |
| --- | ------- | ----------------------- | --- | ----- |
| MLKEM512_X25519 | 5 | 32 | 0.9.xx | См. п |
| MLKEM768_X25519 | 6 | 32 | 0.9.xx | См. п |
| MLKEM1024_X25519 | 7 | 32 | 0.9.xx | См. п |
| NONE | 255 | 0 | 0.9.xx | См. п |



Гибридные типы ключей НИКОГДА не включаются в сертификаты ключей; только в leasesets.

Для назначений с Гибридными или PQ типами подписей,
используйте NONE (тип 255) для типа шифрования,
но там нет крипто ключа, и
вся 384-байтная основная секция используется для подписания ключа.


Размеры назначений
``````````````````

Здесь приведены длины для новых типов назначений.
Тип enc для всех – NONE (тип 255) и длина ключа шифрования рассматривается как 0.
Вся 384-байтная секция используется для первой части подписывающего открытого ключа.
ПРИМЕЧАНИЕ: Это отличается от спецификации для типов подписей ECDSA_SHA512_P521 и RSA, где мы сохранили 256-байтный ключ ElGamal в назначении, даже если он не использовался.

Нет наполнения.
Общая длина равна 7 + общей длине ключа.
Длина сертификата ключа равна 4 + избыточная длина ключа.

Пример байтового потока назначения длиной 1319 байт для MLDSA44:

skey[0:383] 5 (932 >> 8) (932 & 0xff) 00 12 00 255 skey[384:1311]



| Тип | од Типа | щая длина открытого клю | Осно | ая | быточ |
| --- | ------- | ----------------------- | ---- | --- | ----- |
| MLDSA44 | 12 | 1312 | 384 | 928 | 1319 |
| MLDSA65 | 13 | 1952 | 384 | 1568 | 1959 |
| MLDSA87 | 14 | 2592 | 384 | 2208 | 2599 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 384 | 960 | 1351 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 384 | 1600 | 1991 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 384 | 2240 | 2631 |




Размеры RouterIdent
``````````````````

Здесь приведены длины для новых типов назначений.
Тип enc для всех – X25519 (тип 4).
Вся 352-байтная секция после публичного ключа X28819 используется для первой части подписывающего открытого ключа.
Нет наполнения.
Общая длина равна 39 + общей длине ключа.
Длина сертификата ключа равна 4 + избыточная длина ключа.

Пример байтового потока идентификации роутера длиной 1351 байт для MLDSA44:

enckey[0:31] skey[0:351] 5 (960 >> 8) (960 & 0xff) 00 12 00 4 skey[352:1311]



| Тип | од Типа | щая длина открытого клю | Осно | ая | быточ |
| --- | ------- | ----------------------- | ---- | --- | ----- |
| MLDSA44 | 12 | 1312 | 352 | 960 | 1351 |
| MLDSA65 | 13 | 1952 | 352 | 1600 | 1991 |
| MLDSA87 | 14 | 2592 | 352 | 2240 | 2631 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 352 | 992 | 1383 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 352 | 1632 | 2023 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 352 | 2272 | 2663 |




### Шаблоны рукопожатия

Рукопожатия используют [Noise]_ шаблоны рукопожатий.

Следующее сопоставление букв используется:

- e = одноразовый эфемерный ключ
- s = статический ключ
- p = полезная нагрузка сообщения
- e1 = одноразовый эфемерный PQ ключ, отправленный от Алисы к Бобу
- ekem1 = текст KEM, отправленный от Боба к Алисе

Следующие изменения в XK и IK для гибридной прямой секретности (hfs) выполнены как указано в [Noise-Hybrid]_ раздел 5:

```dataspec

XK:                       XKhfs:
  <- s                      <- s
  ...                       ...
  -> e, es, p               -> e, es, e1, p
  <- e, ee, p               <- e, ee, ekem1, p
  -> s, se                  -> s, se
  <- p                      <- p
  p ->                      p ->


  IK:                       IKhfs:
  <- s                      <- s
  ...                       ...
  -> e, es, s, ss, p       -> e, es, e1, s, ss, p
  <- tag, e, ee, se, p     <- tag, e, ee, ekem1, se, p
  <- p                     <- p
  p ->                     p ->

  e1 и ekem1 зашифрованы. См. определения шаблонов ниже.
  ПРИМЕЧАНИЕ: e1 и ekem1 разных размеров (в отличие от X25519)

```

Шаблон e1 определяется следующим образом, как указано в [Noise-Hybrid]_ раздел 4:

```dataspec

Для Алисы:
  (encap_key, decap_key) = PQ_KEYGEN()

  // EncryptAndHash(encap_key)
  ciphertext = ENCRYPT(k, n, encap_key, ad)
  n++
  MixHash(ciphertext)

  Для Боба:

  // DecryptAndHash(ciphertext)
  encap_key = DECRYPT(k, n, ciphertext, ad)
  n++
  MixHash(ciphertext)


```


Шаблон ekem1 определяется следующим образом, как указано в [Noise-Hybrid]_ раздел 4:

```dataspec

Для Боба:

  (kem_ciphertext, kem_shared_key) = ENCAPS(encap_key)

  // EncryptAndHash(kem_ciphertext)
  ciphertext = ENCRYPT(k, n, kem_ciphertext, ad)
  MixHash(ciphertext)

  // MixKey
  MixKey(kem_shared_key)


  Для Алисы:

  // DecryptAndHash(ciphertext)
  kem_ciphertext = DECRYPT(k, n, ciphertext, ad)
  MixHash(ciphertext)

  // MixKey
  kem_shared_key = DECAPS(kem_ciphertext, decap_key)
  MixKey(kem_shared_key)


```




### Функция завершения рукопожатия

Вопросы
``````

- Стоит ли нам изменить хэш-функцию рукопожатия? См. [Choosing-Hash]_.
  SHA256 не уязвим для PQ, но если мы все же хотим обновить
  нашу хэш-функцию, то сейчас самое время, пока мы меняем другие вещи.
  Текущий IETF SSH предлагает [SSH-HYBRID]_ использовать MLKEM768
  с SHA256 и MLKEM1024 с SHA384. В этом предложении обсуждены
  соображения безопасности.
- Следует ли нам прекратить отправку 0-RTT данных с трещоткой (кроме LS)?
- Стоит ли перейти от IK к XK, если мы не отправляем 0-RTT данные?


Обзор
````````

Этот раздел относится к обоим протоколам IK и XK.

Гибридное рукопожатие определено в [Noise-Hybrid]_.
Первое сообщение, от Алисы к Бобу, содержит e1, ключ капсуляции, перед полезной нагрузкой сообщения.
Это рассматривается как дополнительный статический ключ; вызовите EncryptAndHash() на нем (как Алиса) или DecryptAndHash() (как Боб).
Затем обработайте полезную нагрузку сообщения как обычно.

Второе сообщение, от Боба к Алисе, содержит ekem1, текст, перед полезной нагрузкой сообщения.
Это рассматривается как дополнительный статический ключ; вызовите EncryptAndHash() на нем (как Боб)
или DecryptAndHash() (как Алиса).
Затем вычислите kem_shared_key и вызовите MixKey(kem_shared_key).
Затем обработайте полезную нагрузку сообщения как обычно.


Определённые операции ML-KEM
```````````````````````````

Мы определяем следующие функции, соответствующие применяемым криптографическим строительным блокам,
определённым в [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf).

(encap_key, decap_key) = PQ_KEYGEN()
    Алиса создает ключи капсуляции и деккапсуляции
    Ключ капсуляции отправляется в сообщении 1.
    Размеры encap_key и decap_key зависят от варианта ML-KEM.

(ciphertext, kem_shared_key) = ENCAPS(encap_key)
    Боб рассчитывает шифртекст и общий ключ,
    используя шифртекст, полученный в сообщении 1.
    Шифртекст отправляется в сообщении 2.
    Размер шифртекста зависит от варианта ML-KEM.
    Общий ключ kem_shared_key всегда 32 байта.

kem_shared_key = DECAPS(ciphertext, decap_key)
    Алиса рассчитывает общий ключ,
    используя шифртекст, полученный в сообщении 2.
    Общий ключ kem_shared_key всегда 32 байта.

Учтите, что оба, encap_key и шифртекст, зашифрованы внутри ChaCha/Poly
блоков в сообщениях рукопожатия Noise 1 и 2.
Они будут расшифрованы как часть процесса рукопожатия.

Shared_key kem смешивается в трансляционный ключ с MixHash().
Подробности см. ниже.


KDF для Сообщения 1 (для Алисы)
``````````````````````````

Для XK: После сообщения паттерна 'es' и до полезной нагрузки, добавьте:

ИЛИ

Для IK: После сообщения паттерна 'es' и до паттерна 's', добавьте:

```text
Это "e1" шаблон сообщения:
  (encap_key, decap_key) = PQ_KEYGEN()

  // EncryptAndHash(encap_key)
  // AEAD параметры
  k = keydata[32:63]
  n = 0
  ad = h
  текст = ENCRYPT(k, n, encap_key, ad)
  n++

  // MixHash(ciphertext)
  h = SHA256(h || ciphertext)


  Конец паттерна сообщения "e1".

  ПРИМЕЧАНИЕ: Для следующего раздела (полезная нагрузка для XK или статический ключ для IK),
  keydata и chain key остаются неизменными,
  и n теперь равно 1 (вместо 0 для нехибридного).

```


KDF для Сообщения 1 (для Боба)
`````````````````````````

Для XK: После сообщения паттерна 'es' и до полезной нагрузки, добавьте:

ИЛИ

Для IK: После сообщения паттерна 'es' и до паттерна 's', добавьте:

```text
Это "e1" шаблон сообщения:

  // DecryptAndHash(encap_key_section)
  // AEAD параметры
  k = keydata[32:63]
  n = 0
  ad = h
  encap_key = DECRYPT(k, n, encap_key_section, ad)
  n++

  // MixHash(encap_key_section)
  h = SHA256(h || encap_key_section)

  Конец паттерна сообщения "e1".

  ПРИМЕЧАНИЕ: Для следующего раздела (полезная нагрузка для XK или статический ключ для IK),
  keydata и chain key остаются неизменными,
  и n теперь равно 1 (вместо 0 для нехибридного).

```


KDF для Сообщения 2 (для Боба)
`````````````````````````

Для XK: После сообщения паттерна 'ee' и до полезной нагрузки, добавьте:

ИЛИ

Для IK: После сообщения паттерна 'ee' и до паттерна 'se', добавьте:

```text
Это "ekem1" шаблон сообщения:

  (kem_ciphertext, kem_shared_key) = ENCAPS(encap_key)

  // EncryptAndHash(kem_ciphertext)
  // AEAD параметры
  k = keydata[32:63]
  n = 0
  ad = h
  ciphertext = ENCRYPT(k, n, kem_ciphertext, ad)

  // MixHash(ciphertext)
  h = SHA256(h || ciphertext)

  // MixKey(kem_shared_key)
  keydata = HKDF(chainKey, kem_shared_key, "", 64)
  chainKey = keydata[0:31]

  Конец паттерна сообщения "ekem1".

```


KDF для Сообщения 2 (для Алисы)
`````````````````````````

После сообщения паттерна 'ee' (и до паттерна 'ss' для IK), добавьте:

```text
Это "ekem1" шаблон сообщения:

  // DecryptAndHash(kem_ciphertext_section)
  // AEAD параметры
  k = keydata[32:63]
  n = 0
  ad = h
  kem_ciphertext = DECRYPT(k, n, kem_ciphertext_section, ad)

  // MixHash(kem_ciphertext_section)
  h = SHA256(h || kem_ciphertext_section)

  // MixKey(kem_shared_key)
  kem_shared_key = DECAPS(kem_ciphertext, decap_key)
  keydata = HKDF(chainKey, kem_shared_key, "", 64)
  chainKey = keydata[0:31]

  Конец паттерна сообщения "ekem1".

```


KDF для Сообщения 3 (только XK)
````````````````````````````
без изменений


KDF для split()
```````````````
без изменений



### Ratchet

Обновите спецификацию ECIES-Ratchet [ECIES](https://geti2p.net/spec/ecies) следующим образом:


Идентификаторы Noise
`````````````````

- "Noise_IKhfselg2_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_IKhfselg2_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_IKhfselg2_25519+MLKEM1024_ChaChaPoly_SHA256"



1b) Новый формат сессии (с привязкой)
`````````````````````````````````````

Изменения: Текущая ратчет содержала статический ключ в первом разделе ChaCha,
а полезная нагрузка во втором разделе.
С ML-KEM теперь есть три раздела.
Первый раздел содержит зашифрованный PQ открытый ключ.
Второй раздел содержит статический ключ.
Третий раздел содержит полезную нагрузку.


Зашифрованный формат:

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   Новый Сессионный Эфемерный Открытый Ключ    |
  +             32 байта                  +
  |     Закодировано с Elligator2           |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           ML-KEM encap_key            +
  |       Данные, зашифрованные ChaCha20         |
  +      (см. таблицу ниже для длины)     +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Полисе 1305 КОД для Секции encap_key |
  +    (MAC)                           |
  |             16 байт                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           X25519 Статический Ключ           +
  |       Данные, зашифрованные ChaCha20         |
  +             32 байта                  +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Полисе 1305 КОД для Секции Статического Ключа |
  +    (MAC)                           |
  |             16 байт                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            Секция Полезной нагрузки            +
  |       Данные, зашифрованные ChaCha20         |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Полисе 1305 КОД                       |
  +         (MAC) для Секции Полезной нагрузки     +
  |             16 байт                  |
  +----+----+----+----+----+----+----+----+


```

Расшифрованный формат:

```dataspec
Первая часть полезной нагрузки:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       ML-KEM encap_key                +
  |                                       |
  +      (см. таблицу ниже для длины)     +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  Вторая часть полезной нагрузки:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       X25519 Статический Ключ               +
  |                                       |
  +      (32 байта)                       +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

  Третья часть полезной нагрузки:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +            Секция Полезной нагрузки            +
  |                                       |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

```

Размеры:

| Тип | од Типа | дл. | общение 1 | л.  Сообщение | Закрытая дл. | Сообщение | Открыта |
| --- | ------- | --- | --------- | ------------- | ------------ | --------- | ------- |
| X25519 | 4 | 32 | 96+pl | 64+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 912+pl | 880+pl | 800+pl | 800 | pl |
| MLKEM768_X25519 | 6 | 32 | 1296+pl | 1360+pl | 1184+pl | 1184 | pl |
| MLKEM1024_X25519 | 7 | 32 | 1680+pl | 1648+pl | 1568+pl | 1568 | pl |


Учтите, что полезная нагрузка должна содержать блок DateTime, поэтому минимальный размер полезной нагрузки равен 7.
Минимальные размеры сообщения 1 могут быть рассчитаны соответственно.



1g) Новый формат ответа сессии
``````````````````````````````

Изменения: Текущая ратчет имеет пустую полезную нагрузку для первого раздела ChaCha,
а полезная нагрузка находится во втором разделе.
С ML-KEM теперь есть три раздела.
Первый раздел содержит зашифрованный PQ текст.
Второй раздел имеет пустую полезную нагрузку.
Третий раздел содержит полезную нагрузку.


Зашифрованный формат:

```dataspec
+----+----+----+----+----+----+----+----+
  |       Метка сессии   8 байт           |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        Эфемерный Открытый Ключ           +
  |                                       |
  +            32 байта                   +
  |     Закодировано с Elligator2           |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  | ChaCha20 зашифрованный ML-KEM шифртекст  |
  +      (см. таблицу ниже для длины)     +
  ~                                       ~
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Полисе 1305 КОД                       |
  +  (MAC) для Секции шифртекста         +
  |             16 байт                  |
  +----+----+----+----+----+----+----+----+
  |  Полисе 1305 КОД                       |
  +  (MAC) для Секции ключа (без данных)      +
  |             16 байт                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            Секция Полезной нагрузки            +
  |       Данные, зашифрованные ChaCha20         |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Полисе 1305 КОД                       |
  +         (MAC) для Секции Полезной нагрузки     +
  |             16 байт                  |
  +----+----+----+----+----+----+----+----+


```

Расшифрованный формат:

```dataspec
Первая часть полезной нагрузки:


  +----+----+----+----+----+----+----+----+
  |                                       |
  +       ML-KEM шифртекст                +
  |                                       |
  +      (см. таблицу ниже для длины)     +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  Вторая часть полезной нагрузки:

  пусто

  Третья часть полезной нагрузки:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +            Секция Полезной нагрузки            +
  |                                       |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

```

Размеры:

| Тип | од Типа | длина | Длина соо | ения 2  Длина | одового сообщ | ия 2  Длин | кодируе |
| --- | ------- | ----- | --------- | ------------- | ------------- | ---------- | ------- |
| X25519 | 4 | 32 | 72+pl | 32+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 856+pl | 816+pl | 768+pl | 768 | pl |
| MLKEM768_X25519 | 6 | 32 | 1176+pl | 1136+pl | 1088+pl | 1088 | pl |
| MLKEM1024_X25519 | 7 | 32 | 1656+pl | 1616+pl | 1568+pl | 1568 | pl |


Учтите, что хотя сообщение 2 обычно имеет ненулевую полезную нагрузку,
спецификация ратчета [ECIES](https://geti2p.net/spec/ecies) этого не требует, поэтому минимальный размер полезной нагрузки равен 0.
Минимальные размеры сообщения 2 можно рассчитать соответствующим образом.



### NTCP2

Обновите спецификацию NTCP2 [NTCP2](https://geti2p.net/spec/ntcp2) следующим образом:


Идентификаторы Noise
`````````````````

- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM1024_ChaChaPoly_SHA256"


1) ЗапросСессии
``````````````````

Изменения: Текущие NTCP2 содержат только параметры в ChaCha секции.
С ML-KEM, ChaCha секция также будет содержать зашифрованный PQ открытый ключ.


Сырой контент:

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +        изменено с помощью RH_B           +
  |       AES-CBC-256 зашифрованное X         |
  +             (32 байта)                +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly фрейм (MLKEM)            |
  +      (см. таблицу ниже для длины)     +
  |   k определен в KDF для сообщения 1      |
  +   n = 0                               +
  |   см. KDF для связанных данных          |
  ~   n = 0                               ~
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   ChaChaPoly фрейм (параметры)          |
  +         32 байта                      +
  |   k определен в KDF для сообщения 1      |
  +   n = 0                               +
  |   см. KDF для связанных данных          |
  +----+----+----+----+----+----+----+----+
  |     нешифрованный аутентифицированный         |
  ~         подкладка (необязательно)            ~
  |     длина определена в блоке параметров   |
  +----+----+----+----+----+----+----+----+

  Остается, как и прежде, кроме добавления второго ChaChaPoly фрейма


```

Нешифрованные данные (Poly1305 аутентификационный тег не показан):

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                   X                   |
  +              (32 байта)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM encap_key            |
  +      (см. таблицу ниже для длины)     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |               параметры                 |
  +              (16 байтов)               +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     нешифрованный аутентифицированный         |
  +         подкладка (необязательно)            +
  |     длина определена в блоке параметров   |
  ~               .   .   .               ~
  |                                       |
  +----+----+----+----+----+----+----+----+

```

Размеры:

| Тип | од Типа | длина | Длина соо | ения 1  Закры | я длина сообщ | ия 1  Откр | ая длин |
| --- | ------- | ----- | --------- | ------------- | ------------- | ---------- | ------- |
| X25519 | 4 | 32 | 64+pad | 32 | 16 | -- | 16 |
| MLKEM512_X25519 | 5 | 32 | 880+pad | 848 | 816 | 800 | 16 |
| MLKEM768_X25519 | 6 | 32 | 1264+pad | 1232 | 1200 | 1184 | 16 |
| MLKEM1024_X25519 | 7 | 32 | 1648+pad | 1616 | 1584 | 1568 | 16 |


Примечание: Типы кодов используются только для внутреннего использования. Роутеры останутся типом 4,
и поддержка будет указана в адресах роутера.


2) СозданнаяСессия
``````````````````

Изменения: Текущие NTCP2 содержат только параметры в ChaCha секции.
С ML-KEM, ChaCha секция также будет содержать зашифрованный PQ открытый ключ.


Сырой контент:

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +        изменено с помощью RH_B           +
  |       AES-CBC-256 зашифрованное Y         |
  +              (32 байта)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly фрейм (MLKEM)            |
  +   Зашифрованные и аутентифицированные данные    +
  -      (см. таблицу ниже для длины)     -
  +   k определен в KDF для сообщения 2      +
  |   n = 0; см. KDF для связанных данных  |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly фрейм (параметры)          |
  +   Зашифрованные и аутентифицированные данные    +
  -           32 байта                    -
  +   k определен в KDF для сообщения 2      +
  |   n = 0; см. KDF для связанных данных  |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     нешифрованный аутентифицированный         |
  +         подкладка (необязательно)            +
  |     длина определена в блоке параметров   |
  ~               .   .   .               ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  Остается, как и прежде, кроме добавления второго ChaChaPoly фрейма

```

Нешифрованные данные (Poly1305 аутентификацион

ный тег не показан):

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                  Y                    |
  +              (32 байта)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+윤 clearUr잉나
  |           ML-KEM шифртекст           |
  +      (см. таблицу ниже для длины)     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |               параметры                 |
  +              (16 байтов)               +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     нешифрованный аутентифицированный         |
  +         подкладка (необязательно)            +
  |     длина определена в блоке параметров   |
  ~               .   .   .               ~
  |                                       |
  +----+----+----+----+----+----+----+----+

```

Размеры:

| Тип | од Типа | длина | Длина соо | ения 2  Закры | я длина сообщ | ия 2  Откр | ая длин |
| --- | ------- | ----- | --------- | ------------- | ------------- | ---------- | ------- |
| X25519 | 4 | 32 | 64+pad | 32 | 16 | -- | 16 |
| MLKEM512_X25519 | 5 | 32 | 848+pad | 816 | 784 | 768 | 16 |
| MLKEM768_X25519 | 6 | 32 | 1136+pad | 1104 | 1104 | 1088 | 16 |
| MLKEM1024_X25519 | 7 | 32 | 1616+pad | 1584 | 1584 | 1568 | 16 |


Примечание: Типы кодов используются только для внутреннего использования. Роутеры останутся типом 4,
и поддержка будет указана в адресах роутера.



3) ПодтвержденнаяСессия
```````````````````

без изменений


Функция завершения ключа (KDF) (для фазы данных)
```````````````````````````````````````````````

без изменений




### SSU2

Обновите спецификацию SSU2 [SSU2](https://geti2p.net/spec/ssu2) следующим образом:


Идентификаторы Noise
`````````````````

- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM1024_ChaChaPoly_SHA256"


Длинный заголовок
``````````````````
Длинный заголовок - 32 байта. Он используется до установки сессии, при Заявке на Токен, ЗапросеСессии, СозданнойСессии и Повторной попытке.
Он также используется для сообщений Теста партнера и Пробивания дыр вне сессии.

TODO: Мы могли бы внутренне использовать поле версии и использовать 3 для MLKEM512 и 4 для MLKEM768.
Делаем ли мы это только для типов 0 и 1 или для всех 6 типов?


Перед шифрованием заголовка:

```dataspec

+----+----+----+----+----+----+----+----+
  |      Назначение ID Соединения        |
  +----+----+----+----+----+----+----+----+
  |   Номер Пакета   |тип| вер| id |флаг|
  +----+----+----+----+----+----+----+----+
  |        Источник ID Соединения           |
  +----+----+----+----+----+----+----+----+
  |                 Токен                 |
  +----+----+----+----+----+----+----+----+

  Назначение ID Соединения :: 8 байт, беззнаковое целое с большим порядком байтов

  Номер Пакета :: 4 байта, беззнаковое целое с большим порядком байтов

  тип :: Тип сообщения = 0, 1, 7, 9, 10, или 11

  вер :: Версия протокола, равная 2
         TODO Мы могли бы внутренне использовать поле версии и использовать 3 для MLKEM512 и 4 для MLKEM768.

  id :: 1 байт, ID сети (в настоящее время 2, за исключением тестовых сетей)

  флаг :: 1 байт, не используется, устанавливается на 0 для будущей совместимости

  Источник ID Соединения :: 8 байт, беззнаковое целое с большим порядком байтов

  Токен :: 8 байт, беззнаковое целое с большим порядком байтов

```


Короткий заголовок
`````````````````
без изменений


Подключение сессии (Тип 0)
`````````````````````````

Изменения: Текущие SSU2 содержат только данные блока в ChaCha секции.
С ML-KEM, ChaCha секция также будет содержать зашифрованный PQ открытый ключ.


Сырой контент:

```dataspec
+----+----+----+----+----+----+----+----+
  |  Длинный Заголовок байты 0-15, зашифрованные ChaCha20     |
  +  зашифрованы с помощью Введения Боба        |
  |    См. KDF для шифрования заголовка          |
  +----+----+----+----+----+----+----+----+
  |  Длинный Заголовок байты 16-31, зашифрованные ChaCha20    |
  +  зашифрованы с помощью Введения Боба n=0     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +       X, зашифрованный ChaCha20           +
  |       с помощью Введения Боба n=0          |
  +              (32 байта)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   Данные, зашифрованные ChaCha20 (MLKEM)   |
  +          (длина варьируется)              +
  |  k определен в KDF для Подключения сессии |
  +  n = 0                                +
  |  см. KDF для связанных данных          |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   Данные, зашифрованные ChaCha20 (полезная нагрузка)   |
  +          (длина варьируется)              +
  |  k определен в KDF для Подключения сессии |
  +  n = 0                                +
  |  см. KDF для связанных данных          |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                        +
  |        Полисе MAC (16 байт)                         |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+


```

Нешифрованные данные (Poly1305 аутентификационный тег не показан):

```dataspec
+----+----+----+----+----+----+----+----+
  |      Назначение ID Соединения        |
  +----+----+----+----+----+----+----+----+
  |   Номер Пакета   |тип| вер| id |флаг|
  +----+----+----+----+----+----+----+----+
  |        Источник ID Соединения           |
  +----+----+----+----+----+----+----+----+
  |                 Токен                 |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                   X                   |
  +              (32 байта)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM encap_key            |
  +      (см. таблицу ниже для длины)     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     Полезная нагрузка Noise (данные блока)        |
  +          (длина варьируется)              +
  |     см. ниже для разрешенных блоков      |
  +----+----+----+----+----+----+----+----+


```

Размеры, не включая IP накладные расходы:

| Тип | од Типа | длина | Длина соо | ения 1  Закры | я длина сообщ | ия 1  Откр | ая длин |
| --- | ------- | ----- | --------- | ------------- | ------------- | ---------- | ------- |
| X25519 | 4 | 32 | 80+pl | 16+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 896+pl | 832+pl | 800+pl | 800 | pl |
| MLKEM768_X25519 | 6 | 32 | 1280+pl | 1216+pl | 1184+pl | 1184 | pl |
| MLKEM1024_X25519 | 7 | n/a | слишком б | ьшой |  |  |  |


Примечание: Типы кодов используются только для внутреннего использования. Роутеры останутся типом 4,
и поддержка будет указана в адресах роутера.

Минимальный MTU для MLKEM768_X25519:
Около 1316 для IPv4 и 1336 для IPv6.



СозданнаяСессия (Тип 1)
``````````````````````````
Изменения: Текущие SSU2 содержат только данные блока в ChaCha секции.
С ML-KEM, ChaCha секция также будет содержать зашифрованный PQ открытый ключ.


Сырой контент:

```dataspec
+----+----+----+----+----+----+----+----+
  |  Длинный Заголовок байты 0-15, зашифрованные ChaCha20     |
  +  зашифрованы с помощью Введения Боба и     +
  | производного ключа, см. KDF для шифрования заголовка |
  +----+----+----+----+----+----+----+----+
  |  Длинный Заголовок байты 16-31, зашифрованные ChaCha20    |
  +  зашифрованы с помощью производного ключа n=0       +
  |  См. KDF для шифрования заголовка            |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +       Y, зашифрованный ChaCha20           +
  |       с помощью производного ключа n=0            |
  +              (32 байта)               +
  |       См. KDF для шифрования заголовка       +
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   Данные ChaCha20 (MLKEM)               |
  +   Зашифрованные и аутентифицированные данные    +
  |  длина варьируется                        |
  +  k определен в KDF для СозданнойСессии +
  |  n = 0; см. KDF для связанных данных   |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   Данные ChaCha20 (полезная нагрузка)             |
  +   Зашифрованные и аутентифицированные данные    +
  |  длина варьируется                        |
  +  k определен в KDF для СозданнойСессии +
  |  n = 0; см. KDF для связанных данных   |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        Полисе MAC (16 байт)        +
  |                                       |
  +----+----+----+----+----+----+----+----+


```

Нешифрованные данные (Poly1305 аутентификационный тег не показан):

```dataspec
+----+----+----+----+----+----+----+----+
  |      Назначение ID Соединения        |
  +----+----+----+----+----+----+----+----+
  |   Номер Пакета   |тип| вер| id |флаг|
  +----+----+----+----+----+----+----+----
