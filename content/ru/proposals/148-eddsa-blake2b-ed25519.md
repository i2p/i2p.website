---
title: "RedDSA-BLAKE2b-Ed25519"
number: "148"
author: "zzz"
created: "2019-03-12"
lastupdated: "2019-04-11"
status: "Open"
thread: "http://zzz.i2p/topics/2689"
---

## Обзор

Эта пропозиция добавляет новый тип подписи с использованием BLAKE2b-512 с
строками персонализации и солью, чтобы заменить SHA-512.
Это устранит три класса возможных атак.

## Мотивация

Во время обсуждений и проектирования NTCP2 (пропозиция 111) и LS2 (пропозиция 123),
мы кратко рассмотрели различные возможные атаки и способы их
предотвращения. Три из этих атак - это атаки с расширением длины,
межпротокольные атаки, а также идентификация дублируемых сообщений.

Для NTCP2 и LS2 мы решили, что
эти атаки не имеют прямого отношения к рассматриваемым предложениям,
и любые решения противоречили бы цели минимизации новых примитивов.
Также мы определили, что скорость хэш-функций в этих протоколах
не была важным фактором в наших решениях.
Поэтому мы в основном отложили решение на отдельное предложение.
Хотя мы добавили некоторые функции персонализации в спецификацию LS2,
мы не требовали новых хэш-функций.

Многие проекты, такие как ZCash [ZCASH]_, используют хэш-функции и
алгоритмы подписи, основанные на новых алгоритмах, которые не уязвимы к
следующим атакам.

### Атаки с расширением длины

SHA-256 и SHA-512 уязвимы к атакам с расширением длины (LEA) [LEA]_.
Это происходит, когда подписываются реальные данные, а не их хэш.
В большинстве протоколов I2P (потоковых, датаграмм, netdb и других) подписываются реальные
данные. Исключение составляют файлы SU3, где подписывается хэш.
Другое исключение - подписанные датаграммы для DSA (тип подписи 0) только,
где подписывается хэш.
Для других типов подписанных датаграмм подписываются данные.

### Межпротокольные атаки

Подписанные данные в протоколах I2P могут быть уязвимы к
межпротокольным атакам (CPA) из-за отсутствия разделения доменов.
Это позволяет злоумышленнику использовать данные, полученные в одном контексте
(например, подписанную датаграмму), и представить их как действительные подписанные данные
в другом контексте (например, потоковая передача или база данных сети).
Хотя маловероятно, что подписанные данные из одного контекста будут
распознаны как действительные данные в другом контексте, сложно или невозможно
проанализировать все ситуации, чтобы точно знать это.
Кроме того, в некоторых контекстах злоумышленник может
вынудить жертву подписать специально подготовленные данные, которые могут быть
действительными данными в другом контексте.
Снова, сложно или невозможно проанализировать все ситуации, чтобы точно знать это.

### Идентификация дублируемых сообщений

Протоколы I2P могут быть уязвимы к идентификации дублируемых сообщений (DMI).
Это может позволить злоумышленнику идентифицировать, что два подписанных сообщения имеют одинаковое
содержание, даже если эти сообщения и их подписи зашифрованы.
Хотя это маловероятно из-за методов шифрования, используемых в I2P,
сложно или невозможно проанализировать все ситуации, чтобы точно знать это.
Использование хэш-функции, которая предоставляет метод добавления случайной соли,
все подписи будут разными, даже при подписании одних и тех же данных.
Хотя Red25519, как определено в пропозиции 123, добавляет случайную соль к хэш-функции,
это не решает проблему для незашифрованных наборов аренды.

### Скорость

Хотя это не является основной мотивацией для этого предложения,
SHA-512 относительно медленный, и существуют более быстрые хэш-функции.

## Цели

- Предотвращение вышеупомянутых атак
- Минимизация использования новых криптографических примитивов
- Использование проверенных, стандартных криптографических примитивов
- Использование стандартных кривых
- Использование более быстрых примитивов, если они доступны

## Дизайн

Модификация существующего типа подписи RedDSA_SHA512_Ed25519 с использованием BLAKE2b-512
вместо SHA-512. Добавление уникальных строк персонализации для каждого случая использования.
Новый тип подписи может использоваться как для неослепленных, так и для ослепленных наборов аренды.

## Обоснование

- BLAKE2b не уязвим для LEA [BLAKE2]_.
- BLAKE2b предоставляет стандартный способ добавления строк персонализации для разделения доменов
- BLAKE2b предоставляет стандартный способ добавления случайной соли для предотвращения DMI.
- BLAKE2b быстрее SHA-256 и SHA-512 (и MD5) на современном оборудовании,
  согласно [BLAKE2]_.
- Ed25519 остается нашим самым быстрым типом подписи, гораздо быстрее чем ECDSA, по крайней мере в Java.
- Ed25519 [ED25519-REFS]_ требует 512-битную криптографическую хэш-функцию.
  Он не специфицирует SHA-512. BLAKE2b так же подходит для хэш-функции.
- BLAKE2b широко доступен в библиотеках для многих языков программирования, таких как Noise.

## Спецификация

Использование неклассифицированного BLAKE2b-512 как в [BLAKE2]_ с солью и персонализацией.
Все использования подписей BLAKE2b будут использовать 16-символьную строку персонализации.

Когда используется в RedDSA_BLAKE2b_Ed25519 подписании,
разрешена случайная соль, однако это не обязательно, так как алгоритм подписи
добавляет 80 байтов случайных данных (см. пропозицию 123).
При необходимости, при хешировании данных для вычисления r,
установите новую случайную соль BLAKE2b в 16 байт для каждой подписи.
При расчете S сбросьте соль до значения по умолчанию всех нулей.

Когда используется в RedDSA_BLAKE2b_Ed25519 верификации,
не используйте случайную соль, используйте значение по умолчанию всех нулей.

Функции соли и персонализации не специфицированы в [RFC-7693]_;
используйте эти функции, как специфицировано в [BLAKE2]_.

### Тип подписи

Для RedDSA_BLAKE2b_Ed25519 замените хэш-функцию SHA-512
в RedDSA_SHA512_Ed25519 (тип подписи 11, как определено в пропозиции 123)
на BLAKE2b-512. Без других изменений.

Нам не нужно замена для
EdDSA_SHA512_Ed25519ph (тип подписи 8) для файлов su3,
потому что предварительно хешированная версия EdDSA не уязвима для LEA.
EdDSA_SHA512_Ed25519 (тип подписи 7) не поддерживается для файлов su3.

=======================  ===========  ======  =====
        Тип              Код типа     С тех пор Использование
=======================  ===========  ======  =====
RedDSA_BLAKE2b_Ed25519       12        TBD    Только для идентификаторов маршрутизаторов, мест назначения и зашифрованных наборов аренды; никогда не используется для идентификаторов маршрутизаторов
=======================  ===========  ======  =====

### Общие структуры данных и их длины

Следующее относится к новому типу подписи.

==================================  =============
            Тип данных                Длина    
==================================  =============
Хэш                                     64      
Закрытый ключ                           32      
Открытый ключ                           32      
Подпись                                 64      
==================================  =============

### Персонализация

Для обеспечения разделения доменов для различных использований подписей
мы будем использовать функцию персонализации BLAKE2b.

Все использования подписей BLAKE2b будут использовать 16-символьную строку персонализации.
Любые новые использования должны быть добавлены в таблицу здесь, с уникальной персонализацией.

Использования рукопожатий NTCP 1 и SSU, приведенные ниже, относятся к подписанным данным, определенным в
самом рукопожатии.
Подписанные RouterInfos в сообщениях DatabaseStore будут использовать персонализацию NetDb Entry,
как если бы они хранились в NetDB.

==================================  ==========================
         Использование              16-байтовая персонализация
==================================  ==========================
I2CP SessionConfig                  "I2CP_SessionConf"
NetDB Entries (RI, LS, LS2)         "network_database"
NTCP 1 handshake                    "NTCP_1_handshake"
Signed Datagrams                    "sign_datagramI2P"
Streaming                           "streaming_i2psig"
SSU handshake                       "SSUHandshakeSign"
SU3 Files                           n/a, не поддерживается
Unit tests                          "test1234test5678"
==================================  ==========================

## Заметки

## Проблемы

- Альтернатива 1: Пропозиция 146;
  Обеспечивает защиту от LEA
- Альтернатива 2: Ed25519ctx в RFC 8032;
  Обеспечивает защиту от LEA и персонализацию.
  Стандартизировано, но кто это использует?
  См. [RFC-8032]_ и [ED25519CTX]_.
- Полезен ли нам "классифицированный" хеш?

## Миграция

То же, что и при развертывании предыдущих типов подписей.

Мы планируем изменить новые маршрутизаторы с типа 7 на тип 12 по умолчанию.
Мы планируем в конечном итоге мигрировать существующие маршрутизаторы с типа 7 на тип 12,
используя процесс "перекодирования", который использовался после введения типа 7.
Мы планируем изменить новые места назначения с типа 7 на тип 12 по умолчанию.
Мы планируем изменить новые зашифрованные места назначения с типа 11 на тип 13 по умолчанию.

Мы будем поддерживать ослепление с типов 7, 11 и 12 в тип 12.
Мы не будем поддерживать ослепление типа 12 в тип 11.

Новые маршрутизаторы могут начать использовать новый тип подписи по умолчанию через несколько месяцев.
Новые места назначения могут начать использовать новый тип подписи по умолчанию возможно через год.

Для минимальной версии маршрутизатора 0.9.TBD маршрутизаторы должны обеспечить:

- Не храните (или не распространяйте) RI или LS с новым типом подписи маршрутизаторам версии менее 0.9.TBD.
- При проверке netdb-store не получайте RI или LS с новым типом подписи от маршрутизаторов версии менее 0.9.TBD.
- Маршрутизаторы с новым типом подписи в их RI не могут подключаться к маршрутизаторам версии менее 0.9.TBD,
  ни с помощью NTCP, NTCP2, ни SSU.
- Потоковые соединения и подписанные датаграммы не будут работать с маршрутизаторами версии менее 0.9.TBD,
  но нет способа это узнать, так что новый тип подписи не должен использоваться по умолчанию в течение нескольких
  месяцев или лет после выпуска 0.9.TBD.

## Ссылки

.. [BLAKE2]
   https://blake2.net/blake2.pdf

.. [ED25519CTX]
   https://moderncrypto.org/mail-archive/curves/2017/000925.html

.. [ED25519-REFS]
    "Высокоскоростные высокозащитные подписи" Дэниела
    Дж. Бернштейна, Нильса Дуифа, Тани Ланге, Петера Швабе и
    Бо-Ин Янга. http://cr.yp.to/papers.html#ed25519

.. [EDDSA-FAULTS]
   https://news.ycombinator.com/item?id=15414760

.. [LEA]
   https://ru.wikipedia.org/wiki/Атака_с_расширением_длины

.. [RFC-7693]
   https://tools.ietf.org/html/rfc7693

.. [RFC-8032]
   https://tools.ietf.org/html/rfc8032

.. [ZCASH]
   https://github.com/zcash/zips/tree/master/protocol/protocol.pdf
