---
title: "UDP трекеры"
number: "160"
author: "zzz"
created: "2022-01-03"
lastupdated: "2025-06-25"
status: "Closed"
thread: "http://zzz.i2p/topics/1634"
target: "0.9.67"
---

## Статус

Одобрено на обзоре 2025-06-24.
Спецификация находится в [UDP specification](/en/docs/spec/udp-bittorrent-announces/).
Реализовано в zzzot 0.20.0-beta2.
Реализовано в i2psnark с API 0.9.67.
Проверьте документацию других реализаций для статуса.

## Обзор

Это предложение для реализации UDP трекеров в I2P.

### История изменений

Предварительное предложение для UDP трекеров в I2P было размещено на нашей странице спецификации bittorrent [/en/docs/applications/bittorrent/](/en/docs/applications/bittorrent/)
в мае 2014 года; это было до нашего формального процесса предложения, и оно так и не было реализовано.
Это предложение было создано в начале 2022 года и упрощает версию 2014 года.

Так как это предложение зависит от реплицируемых дейтаграмм, оно было отложено, как только мы начали работать над предложением Datagram2 [/en/proposals/163-datagram2/](/en/proposals/163-datagram2/) в начале 2023 года.
То предложение было одобрено в апреле 2025 года.

Версия 2023 года этого предложения предусматривала два режима, "совместимости" и "быстрый".
Дальнейший анализ показал, что быстрый режим был бы небезопасным и также неэффективным для клиентов с большим количеством торрентов.
Кроме того, BiglyBT указал предпочтение для режима совместимости.
Этот режим будет легче реализовать для любого трекера или клиента, поддерживающего стандарт [BEP 15](http://www.bittorrent.org/beps/bep_0015.html).

Хотя режим совместимости более сложен для реализации с нуля на стороне клиента, у нас есть предварительный код для него, начатый в 2023 году.

Поэтому текущая версия здесь еще больше упрощается, чтобы убрать быстрый режим и термин "совместимость". Текущая версия переключается на новый формат Datagram2 и добавляет ссылки на протокол расширения UDP announce [BEP 41](http://www.bittorrent.org/beps/bep_0041.html).

Также в ответ на подключение добавлено поле времени жизни ID соединения для увеличения эффективности этого протокола.

## Мотивация

По мере роста пользовательской базы в целом и числа пользователей bittorrent в частности, нам необходимо сделать трекеры и сообщения более эффективными, чтобы трекеры не были перегружены.

Bittorrent предложил UDP трекеры в BEP 15 [BEP 15](http://www.bittorrent.org/beps/bep_0015.html) в 2008 году, и подавляющее большинство трекеров в clearnet теперь работают только через UDP.

Трудно рассчитать экономию пропускной способности дейтаграмм по сравнению с потоковым протоколом.
Запрос с возможностью реплики имеет примерно тот же размер, что и синхронизация потокового протокола, но полезная нагрузка примерно на 500 байт меньше, так как в HTTP GET есть большая 600-байтная строка параметров URL.
Чистый ответ значительно меньше, чем ACK синхронизации потоков, что обеспечивает значительное снижение для исходящего трафика трекера.

Кроме того, должны быть специфические для реализации сокращения памяти, так как дейтаграммы требуют гораздо меньше состояния в памяти, чем потоковое соединение.

Шифрование и подписи после квантового перехода, как это предусмотрено в [/en/proposals/169-pq-crypto/](/en/proposals/169-pq-crypto/), существенно увеличат накладные расходы на зашифрованные и подписанные структуры, включая адреса назначения, наборы аренды, синхронизацию потоков и ACK. Важно минимизировать эти накладные расходы, где это возможно, до принятия PQ криптографии в I2P.

## Дизайн

Это предложение использует реплицируемые дейтаграммы2, реплицируемые дейтаграммы3 и необработанные дейтаграммы, как это определено в [/en/docs/spec/datagrams/](/en/docs/spec/datagrams/).
Datagram2 и Datagram3 — новые варианты реплицируемых дейтаграмм, определенные в предложении 163 [/en/proposals/163-datagram2/](/en/proposals/163-datagram2/).
Datagram2 добавляет устойчивость к повтору и поддержку оффлайн подписей.
Datagram3 меньше старого формата дейтаграмм, но без аутентификации.

### BEP 15

Для справки, поток сообщений, определенный в [BEP15], выглядит следующим образом:

```
Client                        Tracker
    Connect Req. ------------->
      <-------------- Connect Resp.
    Announce Req. ------------->
      <-------------- Announce Resp.
    Announce Req. ------------->
      <-------------- Announce Resp.
```

Фаза подключения необходима для предотвращения подделки IP-адресов.
Трекер возвращает ID подключения, который клиент использует в последующих объявлениях.
Этот ID подключения истекает по умолчанию через минуту на клиенте и через две минуты на трекере.

I2P будет использовать тот же поток сообщений, что и BEP 15,
для легкости внедрения в существующие базы клиентского кода, поддерживающие UDP:
для эффективности и по причинам безопасности, обсуждаемым ниже:

```
Client                        Tracker
    Connect Req. ------------->       (Repliable Datagram2)
      <-------------- Connect Resp.   (Raw)
    Announce Req. ------------->      (Repliable Datagram3)
      <-------------- Announce Resp.  (Raw)
    Announce Req. ------------->      (Repliable Datagram3)
      <-------------- Announce Resp.  (Raw)
             ...
```

Это потенциально обеспечивает большую экономию пропускной способности по сравнению с потоковыми (TCP) объявлениями.
Хотя Datagram2 приблизительно такого же размера, как и потоковая синхронизация, ответ в необработанном виде намного меньше, чем ACK потоковой синхронизации.
Последующие запросы используют Datagram3, а последующие ответы — необработанные.

Запросы объявления являются Datagram3, чтобы трекеру не нужно было поддерживать большую таблицу отображений ID соединений к адресатам или хешам объявлений.
Вместо этого трекер может генерировать ID соединений криптографически из хеша отправителя, текущей временной метки (на основе некоторого интервала) и секретного значения.
Когда запрашивается объявление, трекер проверяет ID соединения, а затем использует хеш отправителя Datagram3 как цель отправки.

### Поддержка трекера/клиента

Для интегрированного приложения (маршрутизатор и клиент в одном процессе, например i2psnark и Java плагин ZzzOT),
или для приложения на основе I2CP (например BiglyBT),
должно быть просто реализовать и маршрутизировать потоковый и дейтаграммный трафик отдельно.
Ожидается, что ZzzOT и i2psnark станут первым трекером и клиентом, реализующими это предложение.

Неинтегрированные трекеры и клиенты обсуждаются ниже.

Трекеры
````````

Существует четыре известных реализации трекеров I2P:

- zzzot, интегрированный Java плагин маршрутизатора, работающий на opentracker.dg2.i2p и нескольких других
- tracker2.postman.i2p, предположительно работающий за Java маршрутизатором и туннелем HTTP Server
- Старый C opentracker, портированный zzz, с комментариями об отключенной поддержке UDP
- Новый C opentracker, портированный r4sas, работающий на opentracker.r4sas.i2p и, возможно, других,
  предположительно работающих за i2pd маршрутизатором и туннелем HTTP Server

Для внешнего приложения-трекера, которое в настоящее время использует туннель HTTP Server для получения
запросов объявлений, реализация может быть довольно сложной.
Может быть разработан специализированный туннель, который переводит дейтаграммы в локальные HTTP-запросы/ответы.
Или может быть разработан специализированный туннель, который обрабатывает как HTTP-запросы, так и дейтаграммы, и пересылает дейтаграммы во внешний процесс.
Эти решения по проектированию сильно зависят от конкретных реализаций маршрутизатора и трекера,
и находятся вне сферы действия данного предложения.

Клиенты
```````
Внешним торрент-клиентам на базе SAM, таким как qbittorrent и другие клиенты на основе libtorrent,
потребуется SAM v3.3 [/en/docs/api/samv3/](/en/docs/api/samv3/), который не поддерживается i2pd.
Это также требуется для поддержки DHT, и является достаточно сложным, чтобы ни один известный
клиент на базе SAM не реализовал это.
Не ожидается, что реализации этого предложения на базе SAM будут вскоре.

### Время жизни соединения

[BEP 15](http://www.bittorrent.org/beps/bep_0015.html) указывает, что ID соединения истекает через одну минуту на клиенте и через две минуты на трекере.
Это не настраивается.
Это ограничивает потенциальные выгоды в эффективности, если только
клиенты не объединяют объявления, чтобы делать их все в течение одно

й минуты.
i2psnark в настоящее время не объединяет объявления; он распределяет их, чтобы избежать всплесков трафика.
Сообщается, что мощные пользователи запускают одновременно тысячи торрентов,
и такое количество объявлений в одну минуту не является реалистичным.

Здесь мы предлагаем расширить ответ подключения, добавив поле времени жизни соединения.
По умолчанию, если поле не указано, это одна минута. В противном случае, время жизни, указанное
в секундах, будет использоваться клиентом, а трекер будет поддерживать
ID соединения еще одну минуту дополнительно.

### Совместимость с BEP 15

Этот дизайн сохраняет совместимость с [BEP 15](http://www.bittorrent.org/beps/bep_0015.html) по максимуму
для ограничения изменений, необходимых в существующих клиентах и трекерах.

Единственное обязательное изменение — это формат информации о пирах в ответе объявления.
Добавление поля времени жизни в ответ подключения необязательно,
но настоятельно рекомендуется для повышения эффективности, как объяснено выше.

### Анализ безопасности

Важная цель протокола UDP-объявлений — предотвращение подделки адресов.
Клиент должен фактически существовать и включать настоящий набор аренды (leaseset).
Он должен иметь входящие туннели для получения ответа подключения.
Эти туннели могут быть нуль-хоповыми и строиться мгновенно, но это
разоблачило бы создателя.
Этот протокол достигает этой цели.

### Проблемы

- Данное предложение не поддерживает ослепленные назначения,
  но его можно расширить, чтобы сделать это. См. ниже.

## Спецификация

### Протоколы и порты

Repliable Datagram2 использует протокол I2CP 19;
repliable Datagram3 использует протокол I2CP 20;
необработанные дейтаграммы используют протокол I2CP 18.
Запросы могут быть Datagram2 или Datagram3. Ответы всегда необработанные.
Старый формат реплицируемой дейтаграммы ("Datagram1") использующий протокол I2CP 17
НЕ ДОЛЖЕН использоваться для запросов или ответов; их следует отбрасывать, если они получены
на порты запросов/ответов. Обратите внимание, что Datagram1 протокол 17
все еще используется для протокола DHT.

Запросы используют I2CP "to port" из URL анонса; см. ниже.
Порт "from port" запроса выбирается клиентом, но он должен быть ненулевым
и отличаться от тех, которые используются для DHT, чтобы ответы могли быть легко классифицированы.
Трекеры должны отклонять запросы, полученные на неправильном порте.

Ответы используют I2CP "to port" из запроса.
Порт "from port" запроса — это "to port" из запроса.

### URL анонса

Формат URL анонса не указан в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html),
но, как и в clearnet, URL анонсов UDP имеют форму "udp://host:port/path".
Путь игнорируется и может быть пустым, но в clearnet он обычно "/announce".
Часть :port всегда должна присутствовать, однако,
если часть ":port" опущена, используйте порт I2CP по умолчанию 6969,
так как это общий порт в clearnet.
Может быть также добавлены параметры cgi &a=b&c=d,
они могут быть обработаны и предоставлены в запросе анонса, как указано в [BEP 41](http://www.bittorrent.org/beps/bep_0041.html).
Если нет параметров или пути, завершающий / также может быть опущен,
как подразумевается в [BEP 41](http://www.bittorrent.org/beps/bep_0041.html).

### Форматы дейтаграмм

Все значения отправляются в сетевом порядке байтов (big endian).
Не ожидайте, что пакеты будут строго определенного размера.
Будущие расширения могут увеличить размер пакетов.

Запрос подключения
`````````````````

Клиент для трекера.
16 байт. Должен быть реплицируемым Datagram2. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html). Без изменений.

```
Offset  Size            Name            Value
  0       64-bit integer  protocol_id     0x41727101980 // магическая константа
  8       32-bit integer  action          0 // подключение
  12      32-bit integer  transaction_id
```

Ответ подключения
`````````````````

Трекер для клиента.
16 или 18 байт. Должен быть необработанным. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), за исключением отмеченного ниже.

```
Offset  Size            Name            Value
  0       32-bit integer  action          0 // подключение
  4       32-bit integer  transaction_id
  8       64-bit integer  connection_id
  16      16-bit integer  lifetime        опционально  // Изменение из BEP 15
```

Ответ ДОЛЖЕН быть отправлен на "to port" I2CP, который был получен как "from port" запроса.

Поле lifetime опционально и указывает время жизни connection_id клиента в секундах.
По умолчанию — 60, и минимальное значение, если указано — 60.
Максимум — 65535 или около 18 часов.
Трекер должен поддерживать connection_id еще на 60 секунд больше времени жизни клиента.

Запрос анонса
`````````````

Клиент для трекера.
Минимум 98 байт. Должен быть реплицируемым Datagram3. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), за исключением отмеченного ниже.

connection_id такой же, как получен в ответе подключения.

```
Offset  Size            Name            Value
  0       64-bit integer  connection_id
  8       32-bit integer  action          1     // анонс
  12      32-bit integer  transaction_id
  16      20-byte string  info_hash
  36      20-byte string  peer_id
  56      64-bit integer  downloaded
  64      64-bit integer  left
  72      64-bit integer  uploaded
  80      32-bit integer  event           0     // 0: ничего; 1: завершено; 2: начато; 3: остановлено
  84      32-bit integer  IP address      0     // по умолчанию
  88      32-bit integer  key
  92      32-bit integer  num_want        -1    // по умолчанию
  96      16-bit integer  port
  98      varies          options     опционально  // Как указано в BEP 41
```

Изменения из [BEP 15](http://www.bittorrent.org/beps/bep_0015.html):

- ключ игнорируется
- порт вероятно игнорируется
- Секция опций, если присутствует, как определено в [BEP 41](http://www.bittorrent.org/beps/bep_0041.html)

Ответ ДОЛЖЕН быть отправлен на "to port" I2CP, который был получен как "from port" запроса.
Не используйте порт из запроса анонса.

Ответ анонса
`````````````

Трекер для клиента.
Минимум 20 байт. Должен быть необработанным. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html), за исключением отмеченного ниже.

```
Offset  Size            Name            Value
  0           32-bit integer  action          1 // анонс
  4           32-bit integer  transaction_id
  8           32-bit integer  interval
  12          32-bit integer  leechers
  16          32-bit integer  seeders
  20   32 * n 32-byte hash    binary hashes     // Изменение из BEP 15
  ...                                           // Изменение из BEP 15
```

Изменения из [BEP 15](http://www.bittorrent.org/beps/bep_0015.html):

- Вместо 6-байтного IPv4+порт или 18-байтного IPv6+порт, мы возвращаем
  кратное 32-байтовым "компактным ответам" с бинарными хешами SHA-256 пиров.
  Как и в TCP компактных ответах, мы не включаем порт.

Ответ ДОЛЖЕН быть отправлен на "to port" I2CP, который был получен как "from port" запроса.
Не используйте порт из запроса анонса.

Дейтаграммы I2P имеют очень большой максимальный размер около 64 КБ;
однако, для надежной доставки, следует избегать дейтаграмм больше 4 КБ.
Для повышения эффективности пропускной способности, трекеры вероятно должны ограничить максимальное количество пиров до около 50, что соответствует примерно 1600 байтам пакета до накладных расходов на различных уровнях, и должно быть в пределах нагрузки туннеля после фрагментации.

Как в BEP 15, в ответ не включено количество адресов пиров
(IP/port для BEP 15, здесь — хеши).
Хотя не предусмотрено в BEP 15, маркер конца пиров
из всех нулей может быть определен, чтобы указать, что информация о пире завершена
и некоторые расширенные данные следуют.

Таким образом, чтобы расширение было возможным в будущем, клиенты должны игнорировать
32-байтовый хеш из всех нулей и любые данные, которые следуют после него.
Трекеры должны отклонять объявления от хеша из всех нулей,
хотя этот хеш уже запрещен Java-маршрутизаторами.

Скрап
``````

Запрос/ответ скрапа из [BEP 15](http://www.bittorrent.org/beps/bep_0015.html) не требуется данным предложением,
но может быть реализован при желании, без изменений.
Клиент должен сначала получить ID соединения.
Запрос скрапа всегда является реплицируемым Datagram3.
Ответ на скрап всегда необработан.

Ошибка ответа
`````````````

Трекер для клиента.
Минимум 8 байт (если сообщение пусто).
Должен быть необработанным. То же, что в [BEP 15](http://www.bittorrent.org/beps/bep_0015.html). Без изменений.

```

Offset  Size            Name            Value
  0       32-bit integer  action          3 // ошибка
  4       32-bit integer  transaction_id
  8       string          message

```

## Расширения

Биты расширения или поле версии не включены.
Клиенты и трекеры не должны предполагать, что пакеты должны быть строго определенного размера.
Таким образом, дополнительные поля могут быть добавлены без нарушения совместимости.
Формат расширений, определенный в [BEP 41](http://www.bittorrent.org/beps/bep_0041.html), рекомендуется, если требуется.

Ответ подключения модифицирован для добавления опционального поля времени жизни ID подключения.

Если требуется поддержка ослепленных назначений, мы можем либо добавить
ослепленный 35-байтовый адрес в конец запроса анонса,
либо запросить ослепленные хеши в ответах,
используя формат [BEP 41](http://www.bittorrent.org/beps/bep_0041.html) (параметры TBD).
Набор ослепленных 35-байтовых адресов пиров может быть добавлен в конец ответа анонса,
после 32-байтового хеша из всех нулей.

## Руководство по реализации

См. раздел проектирования выше для обсуждения трудностей для
неинтегрированных клиентов и трекеров, не использующих I2CP.

### Клиенты

Для данного хоста трекера, клиент должен предпочитать URL анонсов UDP над HTTP,
и не должен объявлять обоих.

Клиенты с существующей поддержкой BEP 15 должны требовать только незначительных модификаций.

Если клиент поддерживает DHT или другие дейтаграммные протоколы, вероятно, он должен
выбрать другой порт, как "from port" запроса, чтобы ответы
возвращались на этот порт и не путались с сообщениями DHT.
Клиент получает только необработанные дейтаграммы как ответы.
Трекеры никогда не отправят реплицируемую дейтаграмму2 клиенту.

Клиенты с использованием стандартного списка опентрекеров должны обновить список, чтобы
добавить URL UDP после того, как станет известно, что опентрекеры поддерживают UDP.

Клиенты могут или не могут реализовывать повторную передачу запросов.
Повторные передачи, если они реализованы, должны использовать начальный таймаут
не менее 15 секунд и удваивать таймаут для каждой повторной передачи
(экспоненциальный откат).

Клиенты должны замедлять работу после получения ошибочного ответа.

### Трекеры

Трекеры с существующей поддержкой BEP 15 должны требовать только незначительных модификаций.
Это предложение отличается от предложения 2014 года тем, что трекер
должен поддерживать прием реплицируемой дейтаграммы2 и дейтаграммы3 на одном порте.

Чтобы минимизировать требования к ресурсам трекера,
этот протокол разработан так, чтобы исключить любую необходимость в том, чтобы трекер
хранил отображения клиентских хешей на ID соединения для последующей проверки.
Это возможно, потому что пакет запроса анонса является реплицируемым
пакетом Datagram3, так что он содержит хеш отправителя.

Рекомендуемая реализация:

- Определите текущую эпоху как текущее время с разрешением времени жизни соединения,
  ``epoch = now / lifetime``.
- Определите криптографическую хеш-функцию ``H(secret, clienthash, epoch)``, которая генерирует
  8-байтовый вывод.
- Сгенерируйте случайную постоянную secret, используемую для всех соединений.
- Для ответов на подключение генерируйте ``connection_id = H(secret,  clienthash, epoch)``
- Для запросов анонсов проверьте полученный ID соединения в текущей эпохе, проверяя
  ``connection_id == H(secret, clienthash, epoch) || connection_id == H(secret, clienthash, epoch - 1)``

## Миграция

Существующие клиенты не поддерживают URL анонсов UDP и игнорируют их.

Существующие трекеры не поддерживают прием реплицируемых или необработанных дейтаграмм, они будут отброшены.

Это предложение абсолютно необязательно. Ни клиенты, ни трекеры не обязаны его реализовывать в любое время.

## Внедрение

Первые реализации ожидаются в ZzzOT и i2psnark.
Они будут использованы для тестирования и проверки данного предложения.

Другие реализации последуют по желанию после завершения тестирования и проверки.

