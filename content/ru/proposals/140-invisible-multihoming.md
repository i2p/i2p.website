---
title: "Невидимый мультихоминг"
number: "140"
author: "str4d"
created: "2017-05-22"
lastupdated: "2017-07-04"
status: "Open"
thread: "http://zzz.i2p/topics/2335"
---

## Обзор

Это предложение описывает проект протокола, позволяющего I2P-клиенту, сервису
или внешнему процессу балансировки управлять несколькими роутерами, прозрачно
хостящими единственное [Назначение](http://localhost:63465/en/docs/specs/common-structures/#destination).

В данный момент предложение не указывает конкретную реализацию. Это может быть
осуществимо как расширение [I2CP](/en/docs/specs/i2cp/) или как новый протокол.

## Мотивация

Мультихоминг - это использование нескольких роутеров для хостинга одного и того же Назначения.
Текущий способ мультихоминга с I2P заключается в запуске одного и того же Назначения на каждом
роутере независимо; роутер, используемый клиентами в данный момент времени, - тот, который последним опубликовал [НаборЛиз](http://localhost:63465/en/docs/specs/common-structures/#leaseset).

Это своеобразный обход и, вероятно, не подойдет для крупных веб-сайтов. Допустим, у нас есть
100 роутеров для мультихоминга, каждый с 16 туннелями. Это 1600 публикаций НаборовЛиз каждые 10 минут или почти 3 в секунду. Заполнения будут перегружены, и скорость будет автоматически снижена. И это еще до упоминания трафика поиска.

[Proposal 123](/en/proposals/123-new-netdb-entries/) решает эту проблему с помощью мета-НабораЛиз, который перечисляет 100 настоящих хэшей НабораЛиз. Поиск становится процессом в два этапа: сначала поиск мета-НабораЛиз, а затем одного из указанных в нем НаборовЛиз. Это хорошее решение для проблемы трафика поиска, но само по себе оно создает значительную утечку конфиденциальности: возможно определить, какие роутеры для мультихома находятся в сети, контролируя опубликованный мета-НаборЛиз, поскольку каждый настоящий НаборЛиз соответствует одному роутеру.

Нам нужен способ для клиента или сервиса I2P распространить одно Назначение на несколько роутеров, которое бы выглядело как использование одного роутера (с точки зрения самого НабораЛиз).

## Дизайн

### Определения

    Пользователь
        Лицо или организация, желающая организовать мультихоминг для своих Назначений. Рассматривается одно Назначение без потери общности (WLOG).

    Клиент
        Приложение или служба, работающая за Назначением. Оно может быть клиентским, серверным или одноранговым приложением; мы называем это клиентом в том смысле, что оно подключается к роутерам I2P.

        Клиент состоит из трех частей, которые могут находиться в одном и том же процессе или быть разделены между процессами или машинами (в многоклиентской настройке):

        Балансировщик
            Часть клиента, которая управляет выбором пирсов и построением туннелей. В любой момент времени существует один балансировщик, который общается со всеми роутерами I2P. Могут быть балансировщики для резервирования.

        Фронтенд
            Часть клиента, которая может работать параллельно. Каждый фронтенд общается с одним роутером I2P.

        Бэкенд
            Часть клиента, которая делится между всеми фронтендами. Он не имеет прямого общения ни с одним роутером I2P.

    Роутер
        Роутер I2P, управляемый пользователем, который находится на границе между сетью I2P и сетью пользователя (подобно граничному устройству в корпоративных сетях). Он строит туннели под управлением балансировщика и передает пакеты для клиента или фронтенда.

### Высокоуровневый обзор

Представьте себе следующую желаемую конфигурацию:

- Клиентское приложение с одним Назначением.
- Четыре роутера, каждый из которых управляет тремя входящими туннелями.
- Все двенадцать туннелей должны быть опубликованы в одном НабореЛиз.

Одиночный клиент

```
                -{ [Туннель 1]===\
                 |-{ [Туннель 2]====[Роутер 1]-----
                 |-{ [Туннель 3]===/               \
                 |                                 \
                 |-{ [Туннель 4]===\                 \
  [Назначение]  |-{ [Туннель 5]====[Роутер 2]-----   \
    \            |-{ [Туннель 6]===/               \   \
     [НаборЛиз]--|                               [Клиент]
                 |-{ [Туннель 7]===\               /   /
                 |-{ [Туннель 8]====[Роутер 3]-----   /
                 |-{ [Туннель 9]===/                 /
                 |                                 /
                 |-{ [Туннель 10]==\               /
                 |-{ [Туннель 11]===[Роутер 4]-----
                  -{ [Туннель 12]==/

Мульти-клиент

```
                -{ [Туннель 1]===\
                 |-{ [Туннель 2]====[Роутер 1]---------[Фронтенд 1]
                 |-{ [Туннель 3]===/          \                    \
                 |                            \                    \
                 |-{ [Туннель 4]===\            \                    \
  [Назначение]  |-{ [Туннель 5]====[Роутер 2]---\-----[Фронтенд 2]   \
    \            |-{ [Туннель 6]===/          \   \                \   \
     [НаборЛиз]--|                         [Балансировщик]            [Бэкенд]
                 |-{ [Туннель 7]===\          /   /                /   /
                 |-{ [Туннель 8]====[Роутер 3]---/-----[Фронтенд 3]   /
                 |-{ [Туннель 9]===/            /                    /
                 |                            /                    /
                 |-{ [Туннель 10]==\          /                    /
                 |-{ [Туннель 11]===[Роутер 4]---------[Фронтенд 4]
                  -{ [Туннель 12]==/

### Общий процесс клиента
- Загрузить или сгенерировать Назначение.

- Открыть сессию с каждым роутером, связанную с Назначением.

- Периодически (примерно каждые десять минут, но больше или меньше в зависимости от активности туннелей):

  - Получить быстрый уровень от каждого роутера.

  - Использовать объединенные пиры для построения туннелей к/от каждого роутера.

    - По умолчанию туннели к/от определенного роутера будут использовать пиры из быстрого уровня этого роутера, но это не является обязательным согласно протоколу.

  - Собрать набор активных входящих туннелей от всех активных роутеров и создать НаборЛиз.

  - Опубликовать НаборЛиз через один или несколько роутеров.

### Отличия от I2CP
Для создания и управления этой конфигурацией клиенту нужна следующая новая функциональность, выходящая за рамки того, что в настоящее время предоставляется [I2CP](/en/docs/specs/i2cp/):

- Сообщить роутеру о построении туннелей без создания для них НабораЛиз.
- Получить список текущих туннелей в входящем пуле.

Кроме того, следующая функциональность позволит значительно увеличить гибкость в управлении туннелями клиента:

- Получить содержимое быстрого уровня роутера.
- Сообщить роутеру о построении входящего или исходящего туннеля с использованием заданного списка пиров.

### Описание протокола

```
         Клиент                           Роутер

                    --------------------->  Создать сессию
   Статус сессии  <---------------------
                    --------------------->  Получить быстрый уровень
        Список пиров  <---------------------
                    --------------------->  Создать туннель
    Статус туннеля  <---------------------
                    --------------------->  Получить пул туннелей
      Список туннелей  <---------------------
                    --------------------->  Опубликовать НаборЛиз
                    --------------------->  Отправить пакет
      Статус отправки  <---------------------
  Пакет получен  <---------------------

### Сообщения
    Создать сессию
        Создать сессию для данного Назначения.

    Статус сессии
        Подтверждение, что сессия настроена, и клиент теперь может начинать строить туннели.

    Получить быстрый уровень
        Запрос списка пиров, через которые роутер в настоящее время готов строить туннели.

    Список пиров
        Список известных роутеру пиров.

    Создать туннель
        Запрос роутеру построить новый туннель через указанные пиры.

    Статус туннеля
        Результат конкретного построения туннеля, когда он доступен.

    Получить пул туннелей
        Запрос списка текущих туннелей в входящем или исходящем пуле для Назначения.

    Список туннелей
        Список туннелей для запрашиваемого пула.

    Опубликовать НаборЛиз
        Запрос роутеру опубликовать предоставленный НаборЛиз через один из исходящих туннелей для Назначения. Ответа о статусе не требуется; роутер должен продолжать повторные попытки, пока не будет удовлетворен, что НаборЛиз опубликован.

    Отправить пакет
        Исходящий пакет от клиента. Опционально указывает исходящий туннель, через который должен (может?) быть отправлен пакет.

    Статус отправки
        Информирует клиента об успехе или неудаче отправки пакета.

    Пакет получен
        Входящий пакет для клиента. Опционально указывает входящий туннель, через который был получен пакет(?)

## Импликации безопасности

С точки зрения роутеров, этот дизайн функционально эквивалентен статусу-кво. Роутер по-прежнему строит все туннели, поддерживает собственные профили пиров и обеспечивает разделение между операциями роутера и клиента. В конфигурации по умолчанию все полностью идентично, так как туннели для данного роутера строятся из его быстрого уровня.

С точки зрения netDB, один НаборЛиз, созданный с помощью этого протокола, идентичен текущей ситуации, так как он использует существующий функционал. Однако для больших НаборовЛиз, приближающихся к 16 Лиз, возможно наблюдателю определить, что НаборЛиз мультихомирован:

- Максимальный текущий размер быстрого уровня - 75 пиров. Входной шлюз (IBGW, узел, опубликованный в Лизе) выбирается из части уровня (случайно разделенного на туннельные пулы по хэшу, не числу):

      1 переход
          Весь быстрый уровень

      2 перехода
          Половина быстрого уровня
          (по умолчанию до середины 2014 года)

      3+ перехода
          Четверть быстрого уровня
          (3 является текущим значением по умолчанию)

  Это означает, что в среднем IBGWs будут из набора из 20-30 пиров.

- В одном мультихомированном наборе из 16 туннелей будет 16 IBGWs, случайно выбранных из набора из, скажем, 20 пиров.

- В конфигурации с 4 роутерами, использующей настройку по умолчанию, Nабор из 16 туннелей будет иметь 16 IBGWs, случайно выбранных из набора из, в крайнем случае, 80 пиров, хотя вероятно наличие общей части пиров между роутерами.

Таким образом, с конфигурацией по умолчанию, возможно статистически определить, что НаборЛиз сгенерирован с помощью этого протокола. Также потенциально возможно определить количество роутеров, хотя эффект от обновлений может снизить эффективность этого анализа.

Пока клиент имеет полный контроль над выбором пиров, эту утечку информации можно уменьшить или устранить, выбрав IBGWs из уменьшенного набора пиров.

## Совместимость

Этот дизайн полностью совместим с сетью, поскольку изменений в формате [НабораЛиз](http://localhost:63465/en/docs/specs/common-structures/#leaseset) нет. Все роутеры должны будут знать о новом протоколе, но это не представляет беспокойства, поскольку они все будут управляться одним и тем же субъектом.

## Заметки по производительности и масштабируемости

Верхний предел в 16 [Лизов](http://localhost:63465/en/docs/specs/common-structures/#lease) на НаборЛиз остается неизменным согласно этому предложению. Для Назначений, нуждающихся в большем количестве туннелей, можно предложить два изменения сети:

- Увеличение верхнего предела размера НаборовЛиз. Это было бы проще всего реализовать (хотя все же потребует широкой поддержки сети до того, как будет возможно широкое использование), но может привести к более медленному поиску из-за больших размеров пакетов. Максимальный возможный размер НабораЛиз определяется MTU транспортных уровней и, соответственно, примерно 16кБ.

- Реализовать [Proposal 123](/en/proposals/123-new-netdb-entries/) для многоуровневых НаборовЛиз. В сочетании с этим предложением Назначения для под-НаборовЛиз можно распределить по нескольким роутерам, фактически выполняя роль нескольких IP-адресов для услуги в открытой сети.

## Благодарности

Спасибо psi за обсуждение, приведшее к этому предложению.
