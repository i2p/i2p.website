---
title: "旧版 Tunnel 实现（遗留）"
description: "I2P 0.6.1.10 之前使用的 tunnel 设计的归档说明。"
slug: "old-implementation"
lastUpdated: "2005-06"
accurateFor: "0.6.1"
reviewStatus: "needs-review"
---

> **遗留状态：** 此内容仅保留用于历史参考。它记录了 I2P&nbsp;0.6.1.10 之前发布的 tunnel 系统，不应在现代开发中使用。有关生产环境的指导，请参阅[当前实现](/docs/specs/implementation/)。

最初的 tunnel 子系统也使用单向的 tunnels，但在消息布局、重复检测和构建策略上有所不同。下文的许多章节为便于比较，沿用了该已弃用文档的结构。

## 1. Tunnel 概述

- Tunnels 是由创建者选择的有序节点序列构建而成。
- Tunnel 的长度范围为 0–7 跳，并提供若干可调选项，用于填充、限速和干扰数据生成。
- 入站 tunnels 将消息从不受信任的网关传递到创建者（端点）；出站 tunnels 将数据从创建者向外推送。
- Tunnel 的生命周期为 10 分钟，之后会构建新的 tunnels（通常使用相同的节点，但采用不同的 tunnel ID）。

## 2. 遗留设计中的运作

### 2.1 消息预处理

网关累积了≤32&nbsp;KB 的 I2NP 负载，选择了填充，并生成了一个包含以下内容的负载：

- 一个两字节的填充长度字段，以及对应数量的随机字节
- 一系列 `{instructions, I2NP message}` 对，用于描述投递目标、分片以及可选延迟
- 完整的 I2NP 消息，填充至 16 字节边界

投递指令将路由信息打包为位字段（投递类型、延迟标志位、分片标志位，以及可选扩展）。被分片的消息携带一个 4 字节的消息 ID，外加一个索引/是否为最后一片的标志位。

### 2.2 网关加密

遗留设计在加密阶段将 tunnel 长度固定为八跳。网关以分层方式叠加 AES-256/CBC 和校验和块，使每一跳都能在不缩减负载的情况下验证完整性。校验和本身是由 SHA-256 派生的块，嵌入在消息中。

### 2.3 参与者行为

参与方会跟踪入站的 tunnel ID，及早进行完整性校验，并在转发前丢弃重复消息。由于嵌入了填充与验证块，消息大小无论跳数多少都保持不变。

### 2.4 端点处理

各端点按顺序解密分层块，验证校验和，并将载荷拆分回编码的指令和 I2NP 消息，以便进一步传递。

## 3. Tunnel 构建（已弃用的过程）

1. **对等节点选择：** 对等节点从本地维护的档案（探索型 vs. 客户端型）中选择。原始文档已强调，通过在每个 tunnel 池内复用有序的对等节点列表来缓解[前任者攻击](https://en.wikipedia.org/wiki/Predecessor_attack)。
2. **请求传递：** 构建消息以逐跳方式转发，并为每个对等节点包含各自的加密段。诸如 telescopic extension（伸缩式扩展）、midstream rerouting（中途改路由）或移除校验和块等替代思路曾作为实验被讨论，但从未采纳。
3. **池化：** 本地每个目标地址各自维护独立的入站与出站池。设置包括期望数量、备用 tunnel、长度随机偏差、限速以及填充策略。

## 4. 限速与混合的概念

这份早期文稿提出了若干策略，为后续版本提供了参考：

- 用于拥塞控制的加权随机早期丢弃 (WRED)
- 基于最近使用情况的移动平均值的每个 tunnel 限流
- 可选的 chaff（填充流量）和批处理控制（尚未完全实现）

## 5. 已归档的替代方案

原始文档中的一些章节探讨了从未部署过的构想：

- 移除校验和块以降低逐跳处理开销
- 在中途对 tunnels 进行伸缩式调整，以改变对等节点构成
- 改用双向 tunnels（最终被否决）
- 使用更短的哈希或不同的填充策略

这些想法作为历史背景仍然具有价值，但并不反映现代的代码库。

## 参考资料

- 原始遗留文档存档（0.6.1.10 之前）
- [Tunnel 概览](/docs/overview/tunnel-routing/) 以了解当前术语
- [对等节点画像与选择](/docs/overview/tunnel-routing#peer-selection/) 以了解现代启发式方法
