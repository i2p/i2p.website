---
title: "后量子加密协议"
number: "169"
author: "zzz, orignal, drzed, eyedeekay"
created: "2025-01-21"
lastupdated: "2025-06-12"
status: "Open"
thread: "http://zzz.i2p/topics/3294"
target: "0.9.80"
---

## 概述

虽然对适合的后量子（PQ）密码学研究和竞争已经进行了十年，但直到最近选择才变得清晰。

我们在2022年开始研究PQ密码学的影响 [FORUM](http://zzz.i2p/topics/3294)。

TLS标准在过去两年中增加了对混合集成加密的支持，现在由于Chrome和Firefox的支持，它已用于互联网上相当一部分加密流量 [CLOUDFLARE](https://blog.cloudflare.com/pq-2024/)。

NIST最近最终确定并发布了后量子密码学的推荐算法 [NIST-PQ](https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards)。
几个常见的密码学库现在支持NIST标准或将在不久的将来发布支持。

[CLOUDFLARE](https://blog.cloudflare.com/pq-2024/) 和 [NIST-PQ](https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards) 都建议立即开始迁移。
另见2022年NSA PQ FAQ [NSA-PQ](https://media.defense.gov/2022/Sep/07/2003071836/-1/-1/0/CSI_CNSA_2.0_FAQ_.PDF)。
I2P应该成为安全和密码学的领导者。
现在是实施推荐算法的时候了。
利用我们灵活的加密类型和签名类型系统，我们将为混合集成加密和PQ及混合签名添加类型。

## 目标

- 选择对PQ具有抗性的算法
- 在适当的情况下将PQ专用和混合算法添加到I2P协议中
- 定义多种变体
- 在实施、测试、分析和研究后选择最佳变体
- 逐步添加支持并向后兼容

## 非目标

- 不要更改单向（Noise N）加密协议
- 不要离开SHA256，短期内不受PQ威胁
- 暂时不选择最终优选变体

## 威胁模型

- OBEP或IBGW的路由器，可能串通，存储大蒜消息以便稍后解密（前向安全性）
- 网络观察者
  存储传输消息以便稍后解密（前向安全性）
- 网络参与者伪造RI、LS、流、报文或其他结构的签名

## 受影响的协议

我们将修改以下协议，按开发顺序。整体部署可能从2025年底到2027年中。
有关详情，请参见下方的优先事项和部署部分。

| 协议 / 功能                       状态 |  |
| -------------------------------- | --- |
| 混合MLKEM棘轮和LS                 已批准20 | -06; b |
| 混合MLKEM NTCP2                   细节 |  |
| 混合MLKEM SSU2                   细节待 |  |
| MLDSA SigTypes 12-14             提 | 定但可能不会 |
| MLDSA Dests                      经 | 场测试，要求 |
| 混合签名类型 15-17                初步 |  |
| 混合目的 |  |


## 设计

我们将支持基于、但不兼容于CRYSTALS-Kyber和CRYSTALS-Dilithium（版本3.1, 3及更早版本）的NIST FIPS 203和204标准 [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf) [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf) 。

### 密钥交换

我们将在以下协议中支持混合密钥交换：

| 协议    噪 | 型    支持仅PQ | 支持混合? |  |
| ------- | ---------- | ----- | --- |
| NTCP2 | XK | 否 |  |
| SSU2 | XK | 否 |  |
| Ratchet | IK | 否 |  |
| TBM | N | 否 |  |
| NetDB | N | 否 |  |


PQ KEM仅提供临时密钥，不直接支持如Noise XK和IK的静态密钥握手。

噪音N不使用双向密钥交换，因此不适合混合加密。

因此，我们将仅支持NTCP2、SSU2和Ratchet的混合加密。
我们将定义三个ML-KEM变体 [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf)，共计三种新加密类型。
混合类型仅在与X25519结合时定义。

新加密类型为：

| 类型 |  |
| --- | --- |
| MLKEM512_X25519 | 5 |
| MLKEM768_X25519 | 6 |
| MLKEM1024_X25519 | 7 |


开销将是巨大的。典型消息1和2的大小（对于XK和IK）目前大约为100字节（在任何额外负载之前）。
这将根据算法增加8倍到15倍。

### 签名

我们将在以下结构中支持PQ和混合签名：

| 类型 | 仅PQ?          支持 | ? |
| --- | ---------------- | --- |
| RouterInfo | 是 |  |
| LeaseSet | 是 |  |
| Streaming SYN/SYNACK/Close | 是 |  |
| Repliable Datagrams | 是 |  |
| Datagram2 (prop. 163) | 是 |  |
| I2CP create session msg | 是 |  |
| SU3文件 | 是 |  |
| X.509证书 | 是 |  |
| Java密钥库                  是 | 是 |  |


因此，我们将支持PQ专用和混合签名。
我们将定义三个ML-DSA变体 [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf)，
三个混合变体与Ed25519组合，
以及三个PQ专用变体仅用于SU3文件的预散列，
总共有9种新签名类型。
混合类型仅在与Ed25519结合时定义。
我们将使用标准的ML-DSA，而不是预散列变体（HashML-DSA），除非用于SU3文件。

我们将使用“防护”或随机签名变体，
而不是“确定性”变体，如 [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf) 第3.4节中定义。
这确保即使在同一数据上，每个签名也会有所不同，
并提供额外的抗侧信道攻击保护。
请参阅下方实现注意事项部分以获取有关算法选择的更多细节，包括编码和上下文。

新签名类型为：

| 类型 | 码 |
| --- | --- |
| MLDSA44 | 12 |
| MLDSA65 | 13 |
| MLDSA87 | 14 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 |
| MLDSA44ph | 18 |
| MLDSA65ph | 19 |
| MLDSA87ph | 20 |


X.509证书和其他DER编码将使用 [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/) 中定义的组合结构和OID。

开销将是巨大的。典型Ed25519目的和路由器标识大小是391字节。
这些将根据算法增加3.5倍到6.8倍。
Ed25519签名是64字节。
这些将根据算法增加38倍到76倍。
典型签名的RouterInfo、LeaseSet、可回复的报文及签名流消息大约为1KB。
这些将根据算法增加3倍到8倍。

由于新目的和路由器标识类型不包含填充项，它们将不可压缩。
在传输中被gzip压缩的目的和路由器标识的大小将根据算法增加12倍 - 38倍。

### 合法组合

对于目的，新签名类型在租约集中与所有加密类型兼容。将密钥证书中的加密类型设为NONE（255）。

对于路由器标识，ElGamal加密类型已弃用。
新签名类型仅支持X25519（类型4）加密。
路由器地址中将指明新加密类型。
密钥证书中的加密类型将继续为类型4。

### 新增所需加密

- ML-KEM（前称CRYSTALS-Kyber）[FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf)
- ML-DSA（前称CRYSTALS-Dilithium）[FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf)
- SHA3-128（前称Keccak-256）[FIPS202]_
- SHA3-256（前称Keccak-512）[FIPS202]_
- SHAKE128和SHAKE256（SHA3-128和SHA3-256的XOF扩展）[FIPS202]_

SHA3-256、SHAKE128和SHAKE256的测试向量见 [NIST-VECTORS]_。

注意，Java bouncycastle库支持上述所有。
C++库支持在OpenSSL 3.5版本 [OPENSSL]_ 中。

### 备选方案

我们不支持 [FIPS205]_ （Sphincs+），它比ML-DSA慢得多也大得多。
我们不支持未标准化的即将推出的FIPS206（Falcon）。
我们也不支持NTRU或其他未被NIST标准化的PQ候选者。

Rosenpass
`````````

对适用于纯PQ加密的Wireguard (IK) 的一些研究 [PQ-WIREGUARD]_ ，但该论文中有几个未解决的问题。
稍后，此方法被实现为Rosenpass [Rosenpass]_ [Rosenpass-Whitepaper]_ 用于PQ Wireguard。

Rosenpass使用带有预共享Classic McEliece 460896静态密钥（每个500 KB）和Kyber-512（本质上是MLKEM-512）临时密钥的噪声KK样式握手。
由于Classic McEliece密文仅为188字节，并且Kyber-512公钥和密文合理，所以两个握手消息都适合标准UDP MTU。
来自PQ KK握手的输出共享密钥（osk）用作标准Wireguard IK握手的输入预共享密钥（psk）。
因此，总共有两个完整的握手，一个纯PQ，一个纯X25519。

我们不能做到这一点以取代我们的XK和IK握手，因为：

- 我们不能执行KK，Bob没有Alice的静态密钥
- 500KB的静态密钥太大
- 我们不想要额外的往返

白皮书中有很多有用的信息，我们会查看以获取灵感和想法。待办事项。

## 规范

### 常见结构

更新通用结构文档 [COMMON](https://geti2p.net/spec/common-structures) 中的章节和表格如下：

公钥
````````````````

新的公钥类型为：

| 类型 | 长度          起始 | 用途 |  |
| --- | -------------- | --- | --- |
| MLKEM512_X25519 | 32 | 0.9.xx | 仅用于租约 |
| MLKEM768_X25519 | 32 | 0.9.xx | 仅用于租约 |
| MLKEM1024_X25519 | 32 | 0.9.xx | 仅用于租约 |
| MLKEM512 | 800 | 0.9.xx | 仅用于握手 |
| MLKEM768 | 1184 | 0.9.xx | 仅用于握手 |
| MLKEM1024 | 1568 | 0.9.xx | 仅用于握手 |
| MLKEM512_CT | 768 | 0.9.xx | 仅用于握手 |
| MLKEM768_CT | 1088 | 0.9.xx | 仅用于握手 |
| MLKEM1024_CT | 1568 | 0.9.xx | 仅用于握手 |
| NONE | 0 | 0.9.xx | 仅用于具有 |


混合公钥是X25519密钥。
KEM公钥是从Alice发送到Bob的临时PQ密钥。
编码和字节顺序在 [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf) 中定义。

MLKEM*_CT密钥实际上不是公钥，它们是从Bob到Alice在Noise握手中发送的“密文”。
这里完整列出以便完整性。

私钥
````````````````

新增私钥类型为：

| 类型 | 长度            起始 | 用途 |  |
| --- | ---------------- | --- | --- |
| MLKEM512_X25519 | 32 | 0.9.xx | 仅用于租约 |
| MLKEM768_X25519 | 32 | 0.9.xx | 仅用于租约 |
| MLKEM1024_X25519 | 32 | 0.9.xx | 仅用于租约 |
| MLKEM512 | 1632 | 0.9.xx | 仅用于握手 |
| MLKEM768 | 2400 | 0.9.xx | 仅用于握手 |
| MLKEM1024 | 3168 | 0.9.xx | 仅用于握手 |


混合私钥是X25519密钥。
KEM私钥仅供Alice使用。
KEM编码和字节顺序在 [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf) 中定义。

签名公钥
````````````````

新的签名公钥类型为：

| 类型 | （字节）     起始 | 途 |  |
| --- | ----------- | --- | --- |
| MLDSA44 | 1312 | 0.9.xx | 查看提案1 |
| MLDSA65 | 1952 | 0.9.xx | 查看提案1 |
| MLDSA87 | 2592 | 0.9.xx | 查看提案1 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 1344 | 0.9.xx | 查看提案1 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 1984 | 0.9.xx | 查看提案1 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 2624 | 0.9.xx | 查看提案1 |
| MLDSA44ph | 1344 | 0.9.xx | 仅用于SU |
| MLDSA65ph | 1984 | 0.9.xx | 仅用于SU |
| MLDSA87ph | 2624 | 0.9.xx | 仅用于SU |


混合签名公钥是Ed25519密钥后接PQ密钥，如 [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/) 所述。
编码和字节顺序在 [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf) 中定义。

签名私钥
`````````````````

新的签名私钥类型为：

| 类型 | （字节）     起始 | 途 |  |
| --- | ----------- | --- | --- |
| MLDSA44 | 2560 | 0.9.xx | 查看提案1 |
| MLDSA65 | 4032 | 0.9.xx | 查看提案1 |
| MLDSA87 | 4896 | 0.9.xx | 查看提案1 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 2592 | 0.9.xx | 查看提案1 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 4064 | 0.9.xx | 查看提案1 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 4928 | 0.9.xx | 查看提案1 |
| MLDSA44ph | 2592 | 0.9.xx | 仅用于SU |
| MLDSA65ph | 4064 | 0.9.xx | 仅用于SU |
| MLDSA87ph | 4928 | 0.9.xx | 仅用于SU |


混合签名私钥是Ed25519密钥后接PQ密钥，如 [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/) 所述。
编码和字节顺序在 [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf) 中定义。

签名
``````````

新的签名类型为：

| 类型 | （字节）     起始 | 途 |  |
| --- | ----------- | --- | --- |
| MLDSA44 | 2420 | 0.9.xx | 查看提案1 |
| MLDSA65 | 3309 | 0.9.xx | 查看提案1 |
| MLDSA87 | 4627 | 0.9.xx | 查看提案1 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 2484 | 0.9.xx | 查看提案1 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 3373 | 0.9.xx | 查看提案1 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 4691 | 0.9.xx | 查看提案1 |
| MLDSA44ph | 2484 | 0.9.xx | 仅用于SU |
| MLDSA65ph | 3373 | 0.9.xx | 仅用于SU |
| MLDSA87ph | 4691 | 0.9.xx | 仅用于SU |


混合签名是Ed25519签名后接PQ签名，如 [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/) 所述。
通过验证两个签名来验证混合签名，如果任一失败则失败。
编码和字节顺序在 [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf) 中定义。

密钥证书
````````````````

新的签名公钥类型为：

| 类型 | 型代码    总公钥长 | 起始    用途 |  |  |
| --- | ----------- | -------- | --- | --- |
| MLDSA44 | 12 | 1312 | 0.9.xx | 查看提案1 |
| MLDSA65 | 13 | 1952 | 0.9.xx | 查看提案1 |
| MLDSA87 | 14 | 2592 | 0.9.xx | 查看提案1 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 0.9.xx | 查看提案1 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 0.9.xx | 查看提案1 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 0.9.xx | 查看提案1 |
| MLDSA44ph | 18 | n/a | 0.9.xx | 仅用于SU |
| MLDSA65ph | 19 | n/a | 0.9.xx | 仅用于SU |
| MLDSA87ph | 20 | n/a | 0.9.xx | 仅用于SU |


新的加密公钥类型为：

| 类型 | 码      总公钥长 | 起始    用途 |  |  |
| --- | ----------- | -------- | --- | --- |
| MLKEM512_X25519 | 5 | 32 | 0.9.xx | 仅用于租约 |
| MLKEM768_X25519 | 6 | 32 | 0.9.xx | 仅用于租约 |
| MLKEM1024_X25519 | 7 | 32 | 0.9.xx | 仅用于租约 |
| NONE | 255 | 0 | 0.9.xx | 查看提案1 |


混合密钥类型决不可包含在钥证书中；仅在租约集中包含。

对于具有混合或PQ签名类型的目的，
使用NONE（类型255）作为加密类型，
但没有加密密钥，
整个384字节的主段用于签名密钥。

目的尺寸
``````````````````

以下是新目的类型的长度。
所有加密类型为NONE（类型255），加密密钥长度视为0。
整个384字节用于签名公钥的第一部分。
注意：这与ECDSA_SHA512_P521和RSA签名类型的规范不同，
在这些类型中，我们维护了256字节的ElGamal密钥，
即使它未被使用。

无填充。
总长度为7 + 公钥总长度。
钥证书长度为4 + 多余密钥长度。

MLDSA44 的例子1319字节目的字节流：

skey[0:383] 5 (932 >> 8) (932 & 0xff) 00 12 00 255 skey[384:1311]

| 类型 | 型代码    总公钥长 | 主段   多余段 | 总目的长度 |  |  |
| --- | ----------- | -------- | ----- | --- | --- |
| MLDSA44 | 12 | 1312 | 384 | 928 | 1319 |
| MLDSA65 | 13 | 1952 | 384 | 1568 | 1959 |
| MLDSA87 | 14 | 2592 | 384 | 2208 | 2599 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 384 | 960 | 1351 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 384 | 1600 | 1991 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 384 | 2240 | 2631 |


路由器标识尺寸
``````````````````

以下是新目的类型的长度。
所有加密类型为X25519（类型4）。
整个352字节部分在X28819公钥后用于签名公钥的第一部分。
无填充。
总长度为39 + 公钥总长度。
钥证书长度为4 + 多余密钥长度。

MLDSA44的例子1351字节路由器标识字节流：

enckey[0:31] skey[0:351] 5 (960 >> 8) (960 & 0xff) 00 12 00 4 skey[352:1311]

| 类型 | 型代码    总公钥长 | 主段   多余段 | 总路由器标识 |  |  |
| --- | ----------- | -------- | ------ | --- | --- |
| MLDSA44 | 12 | 1312 | 352 | 960 | 1351 |
| MLDSA65 | 13 | 1952 | 352 | 1600 | 1991 |
| MLDSA87 | 14 | 2592 | 352 | 2240 | 2631 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 352 | 992 | 1383 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 352 | 1632 | 2023 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 352 | 2272 | 2663 |


### 握手模式

握手使用 [Noise]_ 握手模式。

以下字母映射用于：

- e = 一次性临时密钥
- s = 静态密钥
- p = 消息载荷
- e1 = 一次性临时PQ密钥，从Alice发送给Bob
- ekem1 = KEM密文，从Bob发送给Alice

如下对XK和IK的混合前向安全性（hfs）的修改在 [Noise-Hybrid]_ 第5节中说明：

```dataspec

XK:                       XKhfs:
  <- s                      <- s
  ...                       ...
  -> e, es, p               -> e, es, e1, p
  <- e, ee, p               <- e, ee, ekem1, p
  -> s, se                  -> s, se
  <- p                      <- p
  p ->                      p ->

  IK:                       IKhfs:
  <- s                      <- s
  ...                       ...
  -> e, es, s, ss, p       -> e, es, e1, s, ss, p
  <- tag, e, ee, se, p     <- tag, e, ee, ekem1, se, p
  <- p                     <- p
  p ->                     p ->

  e1和ekem1是加密的。 参见下方的模式定义。
  注意： e1和 ekem1 尺寸不同（不像X25519）

```

e1模式定义如下，在 [Noise-Hybrid]_ 第4节中说明：

```dataspec

对于Alice：
  (encap_key, decap_key) = PQ_KEYGEN()

  // EncryptAndHash(encap_key)
  ciphertext = ENCRYPT(k, n, encap_key, ad)
  n++
  MixHash(ciphertext)

  对于Bob：

  // DecryptAndHash(ciphertext)
  encap_key = DECRYPT(k, n, ciphertext, ad)
  n++
  MixHash(ciphertext)

```

ekem1模式定义如下，在 [Noise-Hybrid]_ 第4节中说明：

```dataspec

对Bob：

  (kem_ciphertext, kem_shared_key) = ENCAPS(encap_key)

  // EncryptAndHash(kem_ciphertext)
  ciphertext = ENCRYPT(k, n, kem_ciphertext, ad)
  MixHash(ciphertext)

  // MixKey
  MixKey(kem_shared_key)

对Alice：

  // DecryptAndHash(ciphertext)
  kem_ciphertext = DECRYPT(k, n, ciphertext, ad)
  MixHash(ciphertext)

  // MixKey
  kem_shared_key = DECAPS(kem_ciphertext, decap_key)
  MixKey(kem_shared_key)

```

### 噪声握手KDF

问题
``````

- 我们是否应该更改握手哈希函数？ 请参见 [Choosing-Hash]_。
  SHA256对PQ无漏洞，但如果我们确实想升级我们的哈希函数，趁我们正在更改其他东西，现在也不失为一个好时机。
  当前IETF SSH提案 [SSH-HYBRID]_ 是将MLKEM768与SHA256一起使用，将MLKEM1024与SHA384一起使用。 该提案包括一个关于安全考量的讨论。
- 我们是否应停止发送0-RTT棘轮数据（除LS外）？
- 如果我们不发送0-RTT数据，是否应将棘轮从IK切换到XK？

概述
````````

本节适用于IK和XK协议。

混合握手在 [Noise-Hybrid]_ 中定义。
第一个消息，从Alice到Bob，包含e1，加密密钥，在消息载荷之前。
这被视为另一个静态密钥；在其上调用EncryptAndHash()（作为Alice）或DecryptAndHash()（作为Bob）。
然后像往常一样处理消息载荷。

第二个消息，从Bob到Alice，包含ekem1，密文，在消息载荷之前。
这被视为另一个静态密钥；在其上调用EncryptAndHash()（作为Bob）或DecryptAndHash()（作为Alice）。
然后，计算kem_shared_key并调用MixKey(kem_shared_key)。
然后像往常一样处理消息载荷。

定义的ML-KEM操作
`````````````````````````

我们定义如下函数对应于使用的加密基本构建块，如 [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf) 定义。

(encap_key, decap_key) = PQ_KEYGEN()
    Alice创建加密和解密密钥
    加密密钥在消息1中发送。
    encap_key和decap_key的大小取决于ML-KEM变体。

(ciphertext, kem_shared_key) = ENCAPS(encap_key)
    Bob计算密文和共享密钥，
    使用消息1中接收到的密文。
    密文在消息2中发送。
    密文大小取决于ML-KEM变体。
    kem_shared_key始终为32字节。

kem_shared_key = DECAPS(ciphertext, decap_key)
    Alice计算共享密钥，
    使用消息2中接收到的密文。
    kem_shared_key始终为32字节。

注意，加密密钥和密文都在消息1和2的Noise握手消息中的ChaCha/Poly块内加密。
它们将在握手过程中被解密。

kem_shared_key通过MixHash()混合到链中的密钥中。
详情见下方。

Alice的消息1 KDF
```````````````````

对于XK：在'es'消息模式之后和载荷之前，添加：

或者

对于IK：在'es'消息模式之后和在's'消息模式之前，添加：

```text
这是“e1”消息模式：
  (encap_key, decap_key) = PQ_KEYGEN()

  // EncryptAndHash(encap_key)
  // AEAD参数
  k = keydata[32:63]
  n = 0
  ad = h
  ciphertext = ENCRYPT(k, n, encap_key, ad)
  n++

  // MixHash(ciphertext)
  h = SHA256(h || ciphertext)

  “e1”消息模式结束。

  注意：对于下一个部分（用于XK的载荷或用于IK的静态密钥）,
  keydata和链密钥保持不变,
  且n现在等于1（而不是非混合中为0）。

```

Bob的消息1 KDF
```````````````````

对于XK：在'es'消息模式之后和载荷之前，添加：

或者

对于IK：在'es'消息模式之后和在's'消息模式之前，添加：

```text
这是“e1”消息模式：

  // DecryptAndHash(encap_key_section)
  // AEAD参数
  k = keydata[32:63]
  n = 0
  ad = h
  encap_key = DECRYPT(k, n, encap_key_section, ad)
  n++

  // MixHash(encap_key_section)
  h = SHA256(h || encap_key_section)

  “e1”消息模式结束。

  注意：对于下一个部分（用于XK的载荷或用于IK的静态密钥）,
  keydata和链密钥保持不变,
  且n现在等于1（而不是非混合中为0）。

```

Bob的消息2 KDF
```````````````````

对于XK：在'ee'消息模式之后和载荷之前，添加：

或者

对于IK：在'ee'消息模式之后和在'se'消息模式之前，添加：

```text
这是“ekem1”消息模式：

  (kem_ciphertext, kem_shared_key) = ENCAPS(encap_key)

  // EncryptAndHash(kem_ciphertext)
  // AEAD参数
  k = keydata[32:63]
  n = 0
  ad = h
  ciphertext = ENCRYPT(k, n, kem_ciphertext, ad)

  // MixHash(ciphertext)
  h = SHA256(h || ciphertext)

  // MixKey(kem_shared_key)
  keydata = HKDF(chainKey, kem_shared_key, "", 64)
  chainKey = keydata[0:31]

  “ekem1”消息模式结束。

```

Alice的消息2 KDF
```````````````````

在'ee'消息模式之后（和在'ss'消息模式之前用于IK），添加：

```text
这是“ekem1”消息模式：

  // DecryptAndHash(kem_ciphertext_section)
  // AEAD参数
  k = keydata[32:63]
  n = 0
  ad = h
  kem_ciphertext = DECRYPT(k, n, kem_ciphertext_section, ad)

  // MixHash(kem_ciphertext_section)
  h = SHA256(h || kem_ciphertext_section)

  // MixKey(kem_shared_key)
  kem_shared_key = DECAPS(kem_ciphertext, decap_key)
  keydata = HKDF(chainKey, kem_shared_key, "", 64)
  chainKey = keydata[0:31]

  “ekem1”消息模式结束。

```


消息3的KDF（仅XK适用）
```````````````````````````
保持不变

split() 的KDF
```````````````
保持不变

### 棘轮

按如下更新ECIES棘轮规范 [ECIES](https://geti2p.net/spec/ecies)：

噪声标识符
`````````````````

- "Noise_IKhfselg2_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_IKhfselg2_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_IKhfselg2_25519+MLKEM1024_ChaChaPoly_SHA256"

1b) 新会话格式（含绑定）
```````````````````````````

更改：当前棘轮在第一个ChaCha段中包含静态密钥，在第二个段中包含载荷。
对于ML-KEM，现在有三个段。
第一个段包含加密PQ公钥。
第二个段包含静态密钥。
第三个段包含载荷。

加密格式：

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   新会话临时公钥                      |
  +             32个字节                  +
  |     使用Elligator2编码               |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           ML-KEM encap_key            +
  |       ChaCha20加密数据                |
  +      （参见下表以了解长度）           +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305消息认证码                   |
  +    （MAC）用于encap_key段             +
  |             16字节                    |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           X25519静态密钥              +
  |       ChaCha20加密数据                |
  +             32字节                    +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305消息认证码                   |
  +    （MAC）用于静态密钥段              +
  |             16字节                    |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            载荷段                    +
  |       ChaCha20加密数据                |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305消息认证码                   |
  +         （MAC）用于载荷段             +
  |             16字节                    |
  +----+----+----+----+----+----+----+----+


```

解密格式：

```dataspec
载荷部分1：

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       ML-KEM encap_key                +
  |                                       |
  +      （参见下表以了解长度）           +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  载荷部分2：

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       X25519静态密钥                  +
  |                                       |
  +      （32字节）                       +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

  载荷部分3：

  +----+----+----+----+----+----+----+----+
  |                                       |
  +            载荷段                    +
  |                                       |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

```

大小：

| 类型 | 代码   X le | 消息1 | n  消息1 En | len  消息1 Dec | n  PQ key len | pl len |  |
| --- | --------- | --- | --------- | ------------ | ------------- | ------ | --- |
| X25519 | 4 | 32 | 96+pl | 64+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 912+pl | 880+pl | 800+pl | 800 | pl |
| MLKEM768_X25519 | 6 | 32 | 1296+pl | 1360+pl | 1184+pl | 1184 | pl |
| MLKEM1024_X25519 | 7 | 32 | 1680+pl | 1648+pl | 1568+pl | 1568 | pl |


注意：载荷必须包含一个DateTime块，因此最小载荷大小为7。
可以相应地计算最小消息1大小。

1g) 新会话回复格式
````````````````````

更改：当前棘轮的第一个ChaCha段具有一个空的载荷，第二个段中具有载荷。
对于ML-KEM，现在有三个段。
第一个段包含加密的PQ密文。
第二个段具有一个空载荷。
第三个段包含载荷。

加密格式：

```dataspec
+----+----+----+----+----+----+----+----+
  |       会话标签，8字节                |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        临时公钥                      +
  |                                       |
  +             32字节                    +
  |     使用Elligator2编码                |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  | ChaCha20加密的ML-KEM密文             |
  +      （参见下表以了解长度）           +
  ~                                       ~
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305消息认证码                   |
  +    （MAC）用于密文段                 +
  |             16字节                    |
  +----+----+----+----+----+----+----+----+
  |  Poly1305消息认证码                   |
  +    （MAC）用于密钥段（无数据）       +
  |             16字节                    |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            载荷段                    +
  |       ChaCha20加密数据                |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305消息认证码                   |
  +         （MAC）用于载荷段             +
  |             16字节                    |
  +----+----+----+----+----+----+----+----+


```

解密格式：

```dataspec
载荷部分1：

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       ML-KEM密文                      +
  |                                       |
  +      （参见下表以了解长度）           +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  载荷部分2：

  空

  载荷部分3：

  +----+----+----+----+----+----+----+----+
  |                                       |
  +            载荷段                    +
  |                                       |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

```

大小：

| 类型 | 代码   Y le | 消息2 | n  消息2 En | len  消息2 Dec | n  PQ CT len | opt len |  |
| --- | --------- | --- | --------- | ------------ | ------------ | ------- | --- |
| X25519 | 4 | 32 | 72+pl | 32+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 856+pl | 816+pl | 768+pl | 768 | pl |
| MLKEM768_X25519 | 6 | 32 | 1176+pl | 1136+pl | 1088+pl | 1088 | pl |
| MLKEM1024_X25519 | 7 | 32 | 1656+pl | 1616+pl | 1568+pl | 1568 | pl |


注意：虽然消息2通常具有一个非零载荷，但棘轮规范 [ECIES](https://geti2p.net/spec/ecies) 并不要求它，所以最小载荷大小为0。
最小消息2大小可以相应计算。

### NTCP2

按如下更新NTCP2规范 [NTCP2](https://geti2p.net/spec/ntcp2)：

噪声标识符
`````````````````

- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM1024_ChaChaPoly_SHA256"

1) 会话请求
``````````````````

更改：当前NTCP2仅在ChaCha段中包含选项。
对于ML-KEM，ChaCha段还将包含加密的PQ公钥。

原始内容：

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +        用RH_B混淆                     +
  |       AES-CBC-256加密的X              |
  +             （32字节）                +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly框架（MLKEM）             |
  +      详见下表以了解长度              +
  |   k 在消息1的KDF中定义               |
  +   n = 0                               +
  |   详见KDF的关联数据                  |
  ~   n = 0                               ~
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   ChaChaPoly框架（选项）              +
  +         32字节                       +
  |   k 在消息1的KDF中定义               |
  +   n = 0                               +
  |   详见KDF的关联数据                  |
  +----+----+----+----+----+----+----+----+
  |     未加密认证的填充（可选）         |
  ~         长度定义在选项块中            ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  与之前相同，但在ChaChaPoly框架中添加第二个框架

```

未加密的数据（Poly1305认证标签未显示）：

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                   X                   |
  +              （32字节）               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM encap_key            |
  +      详见下表以了解长度              +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |               选项                     |
  +              （16字节）               +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     未加密认证的填充（可选）         |
  +         长度定义在选项块中            +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

```

大小：

| 类型 | 代码   X le | 消息1 | n  消息1 En | len  消息1 Dec | n  PQ key len | opt len |  |
| --- | --------- | --- | --------- | ------------ | ------------- | ------- | --- |
| X25519 | 4 | 32 | 64+pad | 32 | 16 | -- | 16 |
| MLKEM512_X25519 | 5 | 32 | 880+pad | 848 | 816 | 800 | 16 |
| MLKEM768_X25519 | 6 | 32 | 1264+pad | 1232 | 1200 | 1184 | 16 |
| MLKEM1024_X25519 | 7 | 32 | 1648+pad | 1616 | 1584 | 1568 | 16 |


注意：类型代码仅供内部使用。路由器将保持类型4，并在路由器地址中指明支持。

2) 会话创建
``````````````````

更改：当前NTCP2仅在ChaCha段中包含选项。
对于ML-KEM，ChaCha段还将包含加密的PQ公钥。

原始内容：

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +        用RH_B混淆                     +
  |       AES-CBC-256加密的Y              |
  +              （32字节）               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly框架（MLKEM）             |
  +   加密和认证的数据                   +
  -      详见下表以了解长度             -
  +   k 在消息2的KDF中定义               +
  |   n = 0；详见KDF的关联数据          |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly框架（选项）              +
  +   加密和认证的数据                   +
  -           32字节                      -
  +   k 在消息2的KDF中定义               +
  |   n = 0；详见KDF的关联数据          |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     未加密认证的填充（可选）         +
  |     长度定义在选项块中               ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  与之前相同，但在ChaChaPoly框架中添加第二个框架

```

未加密的数据（Poly1305认证标记未显示）：

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                  Y                    +
  +              （32字节）               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM密文                  +
  +      详见下表以了解长度              +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |               选项                     +
  +              （16字节）               +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     未加密认证的填充（可选）         +
  |     长度定义在选项块中               ~
  |                                       |
  +----+----+----+----+----+----+----+----+

```

大小：

| 类型 | 代码   Y le | 消息2 | n  消息2 En | len  消息2 Dec | n  PQ CT len | opt len |  |
| --- | --------- | --- | --------- | ------------ | ------------ | ------- | --- |
| X25519 | 4 | 32 | 64+pad | 32 | 16 | -- | 16 |
| MLKEM512_X25519 | 5 | 32 | 848+pad | 816 | 784 | 768 | 16 |
| MLKEM768_X25519 | 6 | 32 | 1136+pad | 1104 | 1104 | 1088 | 16 |
| MLKEM1024_X25519 | 7 | 32 | 1616+pad | 1584 | 1584 | 1568 | 16 |


注意：类型代码仅供内部使用。路由器将保持类型4，并在路由器地址中指明支持。

3) 会话确认
`````````````

保持不变

用于数据阶段的密钥派生函数（KDF）
``````````````````````````````````````

保持不变

### SSU2

按如下更新SSU2规范 [SSU2](https://geti2p.net/spec/ssu2)： 

噪声标识符
`````````````````

- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM1024_ChaChaPoly_SHA256"

长头
`````````````

长头为32字节，用于会话建立前的Token Request、SessionRequest、SessionCreated及重试。
也用于会话外的Peer Test和Hole Punch消息。

TODO: 我们可以在内部使用版本字段并使用3表示MLKEM512，4表示MLKEM768。
我们是否只对此类0和1进行处理，或为所有6种类型进行？

在加密之前的头：

```dataspec

+----+----+----+----+----+----+----+----+
  |   目标连接ID                      |
  +----+----+----+----+----+----+----+----+
  |   数据包编号  |类型| 版本| ID |标志|
  +----+----+----+----+----+----+----+----+
  |   源连接ID                       |
  +----+----+----+----+----+----+----+----+
  |   令牌                            |
  +----+----+----+----+----+----+----+----+

  目标连接ID :: 8字节，无符号大端整数

  数据包编号 :: 4字节，无符号大端整数

  类型 :: 消息类型 = 0, 1, 7, 9, 10, 或 11

  版本 :: 协议版本，等于2
         TODO: 我们可以在内部使用版本字段并使用3表示MLKEM512，4表示MLKEM768。

  ID :: 1字节，网络ID（当前为2，测试网络除外）

  标志 :: 1字节，未使用，为未来兼容设为0

  源连接ID :: 8字节，无符号大端整数

  令牌 :: 8字节，无符号大端整数

```

短头
`````````````

保持不变

会话请求（类型0）
```````````````````````

更改：当前SSU2仅在ChaCha段中包含块数据。
对于ML-KEM，ChaCha段还将包含加密的PQ公钥。

原始内容：

```dataspec
+----+----+----+----+----+----+----+----+
  |  长头字节0-15，用Bob介绍密钥ChaCha20加密 |
  +  参见头加密KDF                       |
  +----+----+----+----+----+----+----+----+
  |  长头字节16-31，用Bob介绍密钥n=0  |
  + ChaCha20加密                       |
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +       X，ChaCha20加密                 |
  |       用Bob介绍密钥n=0                |
  +              （32字节）               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   ChaCha20加密数据（MLKEM）          |
  +      （长度变化）                    +
  |  k在会话请求KDF中定义                |
  +  n = 0                                +
  |  参见KDF关联数据                     |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   ChaCha20加密数据（载荷）          |
  +      （长度变化）                    +
  |  k在会话请求KDF中定义                |
  +  n = 0                                +
  |  参见KDF关联数据                     |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        Poly1305 MAC（16字节）         +
  |                                       |
  +----+----+----+----+----+----+----+----+


```

未加密的数据（Poly1305认证标记未显示）：

```dataspec
+----+----+----+----+----+----+----+----+
  |   目标连接ID                        |
  +----+----+----+----+----+----+----+----+
  |   数据包编号  |类型| 版本| ID |标志|
  +----+----+----+----+----+----+----+----+
  |   源连接ID                         |
  +----+----+----+----+----+----+----+----+
  |   令牌                            |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                   X                   +
  +              （32字节）               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM encap_key            |
  +      详见下表以了解长度              +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     噪声载荷（块数据）                |
  +      （长度变化）                    +
  |     参见下方允许的块                   |
  +----+----+----+----+----+----+----+----+


```

大小，不包括IP开销：

| 类型 | 代码   X le | 消息1 | n  消息1 En | len  消息1 Dec | n  PQ key len | pl len |  |
| --- | --------- | --- | --------- | ------------ | ------------- | ------ | --- |
| X25519 | 4 | 32 | 80+pl | 16+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 896+pl | 832+pl | 800+pl | 800 | pl |
| MLKEM768_X25519 | 6 | 32 | 1280+pl | 1216+pl | 1184+pl | 1184 | pl |
| MLKEM1024_X25519 | 7 | n/a | 太大 |  |  |  |  |


注意：类型代码仅供内部使用。路由器将保持类型4，并在路由器地址中指明支持。

用于MLKEM768_X25519的最低MTU：
IPv4约1316和IPv6约1336。

会话已创建（类型1）
``````````````````````
更改：当前SSU2仅在ChaCha段中包含块数据。
对于ML-KEM，ChaCha段还将包含加密的PQ公钥。

原始内容：

```dataspec
+----+----+----+----+----+----+----+----+
  |  长头字节0-15，用Bob介绍密钥和派生密钥进行ChaCha20加密     |
  |  参见头部加密KDF                                            |
  +----+----+----+----+----+----+----+----+
  |  长头字节16-31，使用派生密钥的ChaCha20加密 n=0               |
  |  参见头部加密KDF                                            |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +       Y，ChaCha20加密                  +
  |       使用派生密钥 n=0                 |
  +              （32字节）                +
  |       参见头部加密KDF                 |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaCha20 数据（MLKEM）              +
  +   加密和验证的数据                   +
  |  长度变化                            +
  +  k在会话创建的KDF中定义              +
  |  n = 0；参见KDF的关联数据            |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaCha20 数据（载荷）              +
  +   加密和验证的数据                   +
  |  长度变化                            +
  +  k在会话创建的KDF中定义              +
  |  n = 0；参见KDF的关联数据            |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        Poly1305 MAC（16字节）         +
  |                                       |
  +----+----+----+----+----+----+----+----+


```

未加密的数据（Poly1305认证标签未显示）：

```dataspec
+----+----+----+----+----+----+----+----+
  |   目标连接ID                        |
  +----+----+----+----+----+----+----+----+
  |   数据包编号  |类型| 版本| ID |标志|
  +----+----+----+----+----+----+----+----+
  |   源连接ID                         |
  +----+----+----+----+----+----+----+----+
  |   令牌                            |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                  Y                    +
  +              （32字节）               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM 密文                +
  +      参见下表以了解长度             +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     噪声载荷（块数据）                +
  +      （长度变化）                    +
  |      参见下方允许的块               +
  +----+----+----+----+----+----+----+----+

```

大小，不包括IP开销：

| 类型 | 代码   Y le | 消息2 | n  消息2 En | len  消息2 Dec | n  PQ CT len | pl len |  |
| --- | --------- | --- | --------- | ------------ | ------------ | ------ | --- |
| X25519 | 4 | 32 | 80+pl | 16+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 864+pl | 800+pl | 768+pl | 768 | pl |
| MLKEM768_X25519 | 6 | 32 | 1184+pl | 1118+pl | 1088+pl | 1088 | pl |
| MLKEM1024_X25519 | 7 | n/a | 太大 |  |  |  |  |


注意：类型代码仅供内部使用。路由器将保持类型4，并在路由器地址中指明支持。

用于MLKEM768_X25519的最低MTU：
IPv4约为1316，IPv6约为1336。

会话确认（类型2）
```````````````````
保持不变

用于数据阶段的KDF
```````````````````
保持不变

中继和对等测试
````````````````````

中继块、对等测试块和对等测试消息都包含签名。
不幸的是，PQ签名比MTU大。
当前没有机制可以跨多个UDP数据包分段中继或对等测试块或消息。
协议必须扩展以支持分段。
这将在单独的提案中完成，待定。
在那之前，中继和对等测试将不被支持。

问题
``````

我们可以在内部使用版本字段并使用3表示MLKEM512，4表示MLKEM768。

对于消息1和2，如果MLKEM768会增加数据包大小超出1280的最低MTU。
可能在MTU太低时不会支持该连接。

对于消息1和2，MLKEM1024会增加数据包大小超出1500的最大MTU。
这将需要分段消息1和2，这将是一个大的复杂性。
可能不会这样做。

中继和对等测试：参见上文

### 流

TODO：是否有更有效的定义签名/验证的方法
以避免复制签名？

### SU3文件

TODO

[MLDSA-OIDS]_ 第8.1节不允许在X.509证书中使用HashML-DSA，也不分配OID给HashML-DSA，由于实现复杂性和安全性降低。

对于SU3文件的PQ专用签名，
使用 [MLDSA-OIDS]_ 中定义的非预散列变体用于证书。
我们不为SU3文件定义混合签名，
因为我们可能必须对文件进行两次哈希（尽管HashML-DSA和X2559使用相同的哈希函数SHA512）。此外，在
X.509证书中连接两个密钥和签名将是完全非标准的。

注意：我们不允许Ed25519签署SU3文件，
尽管我们已经定义了Ed25519ph签名，但我们从未同意为其设置OID或使用它。

通常sig类型不允许用于SU3文件；使用带ph（预散列）的变体。

### 其他规格

新最大目的大小将为2599（base 64为3468）。

更新其他提供目的尺寸指导的文件，包括：

- SAMv3
- Bittorrent
- 开发者指南
- 命名/地址簿/跳转服务器
- 其他文件

## 开销分析

### 密钥交换

大小增加（字节）：

| 类型 | （消息1）   密文（消息2 |  |
| --- | -------------- | --- |
| MLKEM512_X25519 | +816 | +784 |
| MLKEM768_X25519 | +1200 | +1104 |
| MLKEM1024_X25519 | +1584 | +1584 |


速度：

[CLOUDFLARE](https://blog.cloudflare.com/pq-2024/) 报告的速度：

| 类型 | 速度 |
| --- | --- |
| X25519 DH/keygen | 基线 |
| MLKEM512 | 2.25x 更快 |
| MLKEM768 | 1.5x 更快 |
| MLKEM1024 | 1x （相同） |
| XK | 4x DH (keygen |
| MLKEM512_X25519 | 4x DH + 2x PQ |
| MLKEM768_X25519 | 4x DH + 2x PQ |
| MLKEM1024_X25519 | 4x DH + 2x PQ |


Java中的初步测试结果：

| 类型 | DH/encaps速度   DH/de | ps     keyge |  |
| --- | ------------------- | ------------ | --- |
| X25519 | 基线           基 | 基线 |  |
| MLKEM512 | 29x 更快       2 | 更快      17x | 快 |
| MLKEM768 | 17x 更快       1 | 更快      9x |  |
| MLKEM1024 | 12x 更快       1 | 更快      6x |  |


### 签名

大小：

典型密钥、sig、RIdent、目的尺寸或尺寸增加（包括Ed25519参考）
假设RIs的X25519加密类型。
添加一个Router Info，LeaseSet，可回复报文，和两个流（SYN和SYN ACK）每个列出的数据包。
当前的目的和租约集包含重复的填充项，并在传输中可压缩。
新类型不包含填充，并将不可压缩，
从而导致传输中的大小大幅增加。
参见以上设计部分。

| 类型 | 钥   签名 | Key+ | g RIden | 目的   R | fo | S/流/数据报（ | 消息） |
| --- | ------ | ---- | ------- | ------ | --- | -------- | --- |
| EdDSA_SHA512_Ed25519 | 32 | 64 | 96 | 391 | 391 | 基线    基线 |  |
| MLDSA44 | 1312 | 2420 | 3732 | 1351 | 1319 | +3316 | 284 |
| MLDSA65 | 1952 | 3309 | 5261 | 1991 | 1959 | +5668 | 636 |
| MLDSA87 | 2592 | 4627 | 7219 | 2631 | 2599 | +707 |  |
