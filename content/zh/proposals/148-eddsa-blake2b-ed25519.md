```markdown
---
title: "RedDSA-BLAKE2b-Ed25519"
number: "148"
author: "zzz"
created: "2019-03-12"
lastupdated: "2019-04-11"
status: "Open"
thread: "http://zzz.i2p/topics/2689"
---

## 概述

此提案新增一种使用 BLAKE2b-512 的签名类型，带有个性化字符串和盐，以替代 SHA-512。这将消除三类可能的攻击。

## 动机

在讨论和设计 NTCP2（提案 111）和 LS2（提案 123）期间，我们简要考虑了各种可能的攻击，以及如何防止它们。其中三种攻击是长度扩展攻击、跨协议攻击和重复消息识别。

对于 NTCP2 和 LS2，我们决定这些攻击与当前提案无直接关联，且任何解决方案都与最小化基本构件的目标相冲突。此外，我们认为这些协议中哈希函数的速度不是我们决策的一个重要因素。因此，我们主要将解决方案推迟到单独的提案中。虽然我们在 LS2 规范中添加了一些个性化功能，但没有要求使用任何新的哈希函数。

许多项目，例如 ZCash [ZCASH]_，使用的哈希函数和签名算法基于不易受以下攻击影响的新算法。

### 长度扩展攻击

SHA-256 和 SHA-512 易受长度扩展攻击（LEA）[LEA]_ 的影响。这种情况发生在实际数据被签名，而不是数据的哈希被签名时。在大多数 I2P 协议（流式传输、数据报、网络数据库等）中，实际数据被签名。一个例外是 SU3 文件，其中哈希被签名。另一个例外是 DSA（签名类型 0）仅用于签名的数据报，其中哈希被签名。对于其他签名的数据报签名类型，数据被签名。

### 跨协议攻击

I2P 协议中的签名数据可能由于缺乏域分离而易受跨协议攻击（CPA）的影响。这使得攻击者可以将一上下文中接收到的数据（如签名的数据报）在另一个上下文中（如流式传输或网络数据库）作为有效的签名数据予以展示。虽然将一个上下文中的签名数据解析为另一个上下文中的有效数据的可能性较低，但很难或不可能分析所有情况以确定其安全性。此外，在某些情况下，攻击者可能会诱导受害者签署特制的数据，这些数据可能在另一个上下文中是有效的。同样，很难或不可能分析所有情况以确定其安全性。

### 重复消息识别

I2P 协议可能易受重复消息识别（DMI）攻击。这可能使攻击者即使在消息及其签名被加密时也能识别出两个签名消息具有相同内容。虽然由于 I2P 中使用的加密方法，这种情况的可能性较低，但很难或不可能分析所有情况以确保其安全。通过使用提供添加随机盐方法的哈希函数，即使是在签署相同数据时，所有签名也会不同。虽然提案 123 中定义的 Red25519 向哈希函数添加了随机盐，但这并不能解决未加密租约集合问题。

### 速度

虽然这不是本提案的主要动机，但 SHA-512 速度相对较慢，而一些更快的哈希函数可用。

## 目标

- 防止上述攻击
- 最小化新加密构件的使用
- 使用经过验证的标准加密构件
- 使用标准曲线
- 如有可能，使用更快的基本构件

## 设计

修改现有的 RedDSA_SHA512_Ed25519 签名类型，使用 BLAKE2b-512 替代 SHA-512。为每种用例添加独特的个性化字符串。新签名类型可用于非盲化和盲化的租约集合。

## 理由

- BLAKE2b 不易受 LEA 的影响 [BLAKE2]_。
- BLAKE2b 提供了一种为域分离添加个性化字符串的标准方法。
- BLAKE2b 提供了一种防止 DMI 的标准方法，添加随机盐。
- BLAKE2b 在现代硬件上比 SHA-256 和 SHA-512（以及 MD5）更快，根据 [BLAKE2]_。
- Ed25519 仍是我们最快的签名类型，比 ECDSA 快得多，至少在 Java 中是这样。
- Ed25519 [ED25519-REFS]_ 需要 512 位的加密哈希函数。它并不指定 SHA-512。BLAKE2b 同样适合作为哈希函数。
- BLAKE2b 在许多编程语言如 Noise 的库中广泛可用。

## 规范

使用 [BLAKE2]_ 中定义的未加密 BLAKE2b-512，带有盐和个性化。所有 BLAKE2b 签名的使用将使用一个 16 个字符的个性化字符串。

在 RedDSA_BLAKE2b_Ed25519 签名中，允许使用随机盐，但不必要，因为签名算法已经添加了 80 字节的随机数据（参见提案 123）。如有需要，在计算 r 的过程中哈希数据时，为每个签名设置一个新的 BLAKE2b 16 字节随机盐。在计算 S 时，将盐重置为全零的默认值。

在 RedDSA_BLAKE2b_Ed25519 验证中，不使用随机盐，使用全零的默认值。

[BLAKE2]_ 没有指定盐和个性化功能；使用 [BLAKE2]_ 中指定的那些功能。

### 签名类型

对于 RedDSA_BLAKE2b_Ed25519，将 RedDSA_SHA512_Ed25519 中的 SHA-512 哈希函数替换为 BLAKE2b-512（提案 123 中定义的签名类型 11）。无其他更改。

我们不需要为 su3 文件的 EdDSA_SHA512_Ed25519ph（签名类型 8）做替换，因为 EdDSA 的预哈希版本不易受 LEA 的影响。su3 文件不支持 EdDSA_SHA512_Ed25519（签名类型 7）。

=======================  ===========  ======  =====
        类型             类型代码     自      用途
=======================  ===========  ======  =====
RedDSA_BLAKE2b_Ed25519       12        待定    仅用于路由器身份、目的地和加密租约集合，不用于路由器身份
=======================  ===========  ======  =====

### 通用结构数据长度

以下适用于新签名类型。

==================================  =============
            数据类型                  长度
==================================  =============
哈希                                   64
私钥                                   32
公钥                                   32
签名                                   64
==================================  =============

### 个性化

为提供签名各种用途的域分离，我们将使用 BLAKE2b 的个性化特性。

所有 BLAKE2b 签名的使用将使用一个 16 个字符的个性化字符串。任何新的用途必须在此处添加到表中，具有唯一的个性化。

下面的 NTCP 1 和 SSU 握手用途是指在握手中定义的签名数据。
DatabaseStore 消息中的签名 RouterInfos 将使用与存储在 NetDB 中相同的网络数据库个性化。

==================================  ==========================
         用途                      16 字节个性化
==================================  ==========================
I2CP SessionConfig                  "I2CP_SessionConf"
NetDB Entries (RI, LS, LS2)         "network_database"
NTCP 1 握手                         "NTCP_1_handshake"
签名数据报                          "sign_datagramI2P"
流式传输                             "streaming_i2psig"
SSU 握手                            "SSUHandshakeSign"
SU3 文件                            不适用，不支持
单元测试                            "test1234test5678"
==================================  ==========================

## 备注

## 问题

- 备选方案 1：提案 146；
  提供 LEA 抗性
- 备选方案 2：RFC 8032 中的 Ed25519ctx；
  提供 LEA 抗性和个性化。
  标准化，但有人用吗？
  参见 [RFC-8032]_ 和 [ED25519CTX]_。
- “密钥格式”哈希对我们有用吗？

## 迁移

与先前签名类型的推出相同。

我们计划将新路由器的默认类型从 7 改为 12。
我们计划通过在类型 7 介绍后使用的“重新密钥”过程，最终将现有路由器从类型 7 迁移到类型 12。
我们计划将新目的地的默认类型从 7 改为 12。
我们计划将新加密目的地的默认类型从 11 改为 13。

我们将支持从类型 7、11 和 12 到类型 12 的盲化。
我们将不支持从类型 12 到类型 11 的盲化。

在几个月后，新路由器可以开始默认使用新的签名类型。
新目的地可能在一年后开始默认使用新的签名类型。

对于最低路由器版本 0.9.TBD，路由器必须确保：

- 不要存储（或传播）具有新签名类型的 RI 或 LS 给低于版本 0.9.TBD 的路由器。
- 在验证 netdb 存储时，不要从低于版本 0.9.TBD 的路由器获取具有新签名类型的 RI 或 LS。
- 具有新签名类型的路由器在它们的 RI 中可能不会连接到低于版本 0.9.TBD 的路由器，无论是通过 NTCP、NTCP2 还是 SSU。
- 流媒体连接和签名数据报不会在低于版本 0.9.TBD 的路由器上工作，但无法知道这一点，因此在 0.9.TBD 发布的几个月或几年后新签名类型不应默认使用。

## 参考文献

.. [BLAKE2]
   https://blake2.net/blake2.pdf

.. [ED25519CTX]
   https://moderncrypto.org/mail-archive/curves/2017/000925.html

.. [ED25519-REFS]
    "High-speed high-security signatures" by Daniel
    J. Bernstein, Niels Duif, Tanja Lange, Peter Schwabe, and
    Bo-Yin Yang. http://cr.yp.to/papers.html#ed25519

.. [EDDSA-FAULTS]
   https://news.ycombinator.com/item?id=15414760

.. [LEA]
   https://en.wikipedia.org/wiki/Length_extension_attack

.. [RFC-7693]
   https://tools.ietf.org/html/rfc7693

.. [RFC-8032]
   https://tools.ietf.org/html/rfc8032

.. [ZCASH]
   https://github.com/zcash/zips/tree/master/protocol/protocol.pdf

```
