```markdown
---
title: "SSU2"
number: "159"
author: "eyedeekay, orignal, zlatinb, zzz"
created: "2021-09-12"
lastupdated: "2025-03-05"
status: "Closed"
thread: "http://zzz.i2p/topics/2612"
target: "0.9.56"
---

## Status

Plán zavádění:


| Funkce | Testování (není ve výchozím nastavení) | Povoleno ve výchozím nastavení |
|--------|----------------------------------------|--------------------------------|
| Kód místního testu | 2022-02 |
| Kód společného testu | 2022-03 |
| Společný test v síti | 0.9.54 | 2022-05 |
| Zamrznutí základního protokolu | 0.9.54 | 2022-05 |
| Základní relace | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Ověření adresy (opětovný pokus) | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Fragmentované RI v handshakeu | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Nový token | 0.9.55 | 2022-08 | 0.9.57 | 2022-11 |
| Zamrznutí rozšířeného protokolu | 0.9.55 | 2022-08 |
| Přenos | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Testování peeru | 0.9.55 | 2022-08 | 0.9.56 | 2022-11 |
| Povolit pro náhodné 2% | 0.9.55 | 2022-08 |
| Ověření cesty | 0.9.55+ dev | 0.9.56 | 2022-11 |
| Migrace připojení | 0.9.55+ dev | 0.9.56 | 2022-11 |
| Okamžitý ACK příznak | 0.9.55+ dev | 0.9.56 | 2022-11 |
| Rotace klíčů | 0.9.57 | 2023-02 | 0.9.58 | 2023-05 |
| Deaktivace SSU 1 (i2pd) | 0.9.56 | 2022-11 |
| Deaktivace SSU 1 (Java I2P) | 0.9.58 | 2023-05 | 0.9.61 | 2023-12 |

Základní relace zahrnuje handshake a datovou fázi.
Rozšířený protokol zahrnuje přenos a testování peeru.



## Přehled

Tento návrh popisuje autentizovaný protokol pro dohodu o klíči za účelem zlepšení
odolnosti [SSU](/en/docs/transport/ssu/) proti různým formám automatizované identifikace a útoků.

Návrh je organizován následovně: jsou prezentovány bezpečnostní cíle,
následuje diskuse o základním protokolu. Dále je uvedena kompletní specifikace
všech zpráv protokolu. Nakonec jsou diskutovány adresy routerů a identifikace verze.

Stejně jako u jiných přenosů I2P, je SSU2 definováno
pro přenos zpráv I2NP z bodu do bodu (router-to-router).
Není to univerzální datová trubice.
Stejně jako [SSU](/en/docs/transport/ssu/), poskytuje i další dvě služby:
Přesměrování pro průchod NAT a Testování peerů pro určení příchozí dosažitelnosti.
Poskytuje také třetí službu, která není v SSU, pro migraci připojení,
když peer změní IP nebo port.


## Motivace

SSU je poslední zbývající vrstva protokolu, která vyžaduje ElGamal, který je velmi pomalý.
Řízení toku pro SSU je složité a nefunguje dobře.
Části SSU jsou zranitelné vůči útokům spoofování adres.
Handshake nepoužívá Noise.



## Cíle návrhu

- Snížit využití CPU odstraněním ElGamal. Použijte X25519 pro DH.

- Udržet funkce Testování peerů a Přenos, a zvýšit jejich bezpečnost.

- Usnadnit implementaci umožněním standardních algoritmů pro řízení toku.

- Snížit latenci nastavení.
  Medián doby nastavení je aktuálně asi 135 ms pro NTCP2 a 187 ms pro SSU,
  i když má NTCP2 další zpáteční cestu; nahrazení ElGamal v
  SSU2 by mělo snížit ho, ale další změny mohou také pomoci.

- Udržet nebo zvýšit maximální propustnost ve srovnání s SSU 1,
  měřeno v rozsahu simulovaných latencí a procentuálních ztrát paketů na testovací síti.

- Zabránit zesílení provozu a útokům na špatné směrování z podvržených zdrojových adres
  prostřednictvím "ověření adresy".

- Usnadnit identifikaci paketů, aby se snížila závislost na náhradních řešeních a
  heuristikách, které činí kód příliš komplikovaným.

- Formalizovat a zlepšit migraci připojení, když se IP nebo port partnera změní.
  Neukončovat migraci připojení, dokud není ověření adresy dokončeno, aby se předešlo útokům.
  Některé implementace SSU 1 používají nákladné heuristiky pro řešení změn portu
  způsobené znovupřipojením NAT. Žádné známé implementace SSU 1 nemohou vůbec řešit změny IP.

- Podpora SSU 1 a 2 na jednom portu, automatická detekce a publikování jako jediný
  "přenos" (tj. [RouterAddress](/en/docs/spec/common-structures/#routeraddress/)) v [NetDB](/en/docs/how/network-database/).

- Publikovat podporu pouze pro verzi 1, pouze pro verzi 2 nebo 1+2 v NetDB v samostatném
  poli a výchozí nastavení na verzi 1 (nepřiřazovat podporu verzí k
  konkrétní verzi routeru)

- Zajistit, aby všechny implementace (Java/i2pd/Go) mohly samy přidat podporu verze 2
  (nebo ne) na svých vlastních rozvrzích

- Přidat náhodné vycpávání ke všem zprávám včetně handshake a datových zpráv.
  Všechny vycpávky musí být kryté pomocí MAC, na rozdíl od vycpávky na konci paketu v SSU 1.
  Poskytnout mechanizmus možností pro obě strany k žádosti o min a max vycpání
  a/nebo distribuci vycpávání.  Specifika distribucí vycpávání jsou
  závislá na implementaci a nemusí nebo mohou být specifikována v samotném protokolu.

- Maskovat hlavičky a obsah zpráv, které nejsou plně šifrovány
  dostatečně, aby DPI boxy a AV podpisy nemohly snadno určit jejich klasifikaci.
  Také zajistit, aby zprávy zasílané jednomu peeru nebo sadě peerů neměly
  podobný vzor bitů.

- Opravit ztrátu bitů v DH kvůli formátu Java [Ticket1112](http://{{ i2pconv('trac.i2p2.i2p') }}/ticket/1112), a urychlit DH
  přechodem na X25519.

- Přechod na skutečnou funkci odvodzení klíčů (KDF) namísto použití výsledku DH
  jako je.

- Přidat "odolnost vůči sondování" (jak to nazývá Tor); to zahrnuje odolnost proti replayům.

- Udržovat výměnu autentikovaných klíčů ve dvou směrech (2W-AKE). 1W-AKE není dostatečné
  pro naši aplikaci.

- Spoléhat se na statický veřejný klíč, zveřejněný v RouterInfo, jako další součást
  autentizace.

- Přidat možnosti/verzi v handshake pro budoucí rozšiřitelnost.

- Nepřidávat výrazně potřebu CPU pro nastavení připojení; pokud je to možné,
  výrazně ji snížit.

- Odstranit požadavek na vycpávání na násobky 16 bajtů
  vynucené šifrováním AES v SSU 1.

- Použít standard ChaCha/Poly1305 pro šifrování a MAC,
  nahrazení šifrování AES a nestandardní HMAC-MD5-128 MAC použité v SSU 1.

- Použít samostatné klíče pro šifrování pro odesílání a příjem, místo
  společných klíčů pro oba směry použité v SSU 1.

- Použít 3-zprávový, jednorázový handshake, jako v [NTCP2](/en/proposals/111-ntcp-2/).
  Odstranit zpoždění čekání na datové zprávy, které dělají
  [SSU](/en/docs/transport/ssu/) efektivně dvoukruhový handshake.

- Výrazně zlepšit efektivitu ACKů a NACKů,
  což je v SSU 1 hrůza. Snížit šířku pásma vyžadovanou pro
  ACKy a NACKy, a zvýšit dostupnou velikost paketu pro data.
  Efektivně zakódovat NACKy pro sérii chybějících zpráv,
  což je běžné přes WiFi.

- Snížit složitost potřebnou pro implementaci fragmentace zpráv I2NP.
  Obejít mechanizmy a kódování fragmentace pro kompletní zprávy I2NP.

- Minimalizovat režijní náklady na protokol před vycpáváním, zejména u ACKů.
  I když bude přidáno vycpávání,
  režijní náklady před vycpáváním jsou stále režijními náklady.
  Nízkoširokopásmové uzly musí být schopny používat SSU2.

- Udržovat časové značky pro detekci replayů a odchylky.

- Vyhnout se jakýmkoli problémům roku 2038 v časových značkách, musí pracovat minimálně do roku 2106.

- Zvýšit minimální MTU z 620 na 1280 pro efektivitu, snadnost implementace,
  a zvětšení maximální velikosti zpráv I2NP.
  Fragmentace a opětovné sestavení jsou poměrně nákladné.
  Poskytnutím místa pro zprávy v tunelu o velikosti 1028 bajtů, velká většina zpráv I2NP
  nebude vyžadovat fragmentaci.

- Zvýšit maximální MTU z 1488 (1484 pro IPv6) na 1500 pro účinnost.
  Odstranit požadavek, aby MTU byla násobkem 16.

- Zvýšit maximální velikost zprávy I2NP přibližně z 32K v SSU 1
  na přibližně 64 KB jako v NTCP2.

- Odstranit podpis polí IP a port z handshake,
  aby routery, které neznají
  svou externí IP a port, mohly se připojit.

- Zachovat mechanizmus zjišťování IP/portu z SSU 1 v handshake,
  aby se routery mohly naučit svou externí IP a port.

- Zahrnout zástupce vývojářů routerů v jazyce Java, C++ a Go do návrhu.



### Non-cíle

- Nezničitelná odolnost vůči DPI... to by byly pluginovatelné přenosy,
  [Prop109](/en/proposals/109-hashcash/).

- Přenos na bázi TLS (nebo podobný HTTPS)... to by byla [Prop104](/en/proposals/104-new-protocol/).

- Odolnost vůči časování DPI (časování zpoždění mezi zprávami může být
  závislé na implementaci; zpoždění uvnitř zpráv může být zavedeno v libovolném
  bodě, včetně před odesláním náhodného vycpávání, například). Umělé
  zpoždění (což obfs4 nazývá IAT nebo inter-arrival time) jsou nezávislá na
  samotném protokolu.

- Zapírání účasti na relaci (jsou tam podpisy).

Non-cíle, které mohou být částečně zváženy nebo diskutovány:

- Míra ochrany proti Deep Packet Inspection (DPI)

- Post-kvantová (PQ) bezpečnost

- Zapírání



## Cíle bezpečnosti

Zvažujeme tři strany:

- Alice, která si přeje navázat novou relaci.
- Bob, se kterým Alice chce navázat relaci.
- Mallory, "člověk v prostředí" mezi Alicí a Bobem.

Nejvíce dva účastníci se mohou zapojit do aktivních útoků.

Alice a Bob jsou oba v držení statického klíčového páru, který je obsažen
v jejich [RouterIdentity](/en/docs/spec/common-structures/#routeridentity/).

Navrhovaný protokol se snaží umožnit Alici a Bobovi dohodnout se na sdíleném
tajném klíči (K) za následujících požadavků:

1) Bezpečnost soukromého klíče: ani Bob ani Mallory se nic nedozví o Aliceině
   statickém soukromém klíči. Symetricky, Alice se nic nedozví o Bobově
   statickém soukromém klíči.

2) Session klíč K je znám pouze Alice a Bobovi.

3) Dokonalá dopředná utajitelnost: dohodnutý session klíč zůstává tajný do
   budoucnosti, i když jsou statické soukromé klíče Alice a/nebo Boba odhaleny
   po dohodě klíče.

4) Oboustranná autentizace: Alice si je jistá, že navázala relaci
   s Bobem, a naopak.

5) Ochrana proti online DPI: Zajistit, aby nebylo triviálně detekovatelné, že
   Alice a Bob se účastní protokolu pouze pomocí jednoduchých technik hluboké
   analýzy paketů (DPI). Viz níže.

6) Omezené zapírání: ani Alice, ani Bob nemohou popřít účast v protokolu, ale pokud
   jeden z nich unikne sdílený klíč, druhá strana může popřít
   autenticitu obsahu přenášených dat.

Současný návrh se snaží poskytnout všech pět požadavků na základě
protokolu Station-To-Station (STS) [STS](https://en.wikipedia.org/wiki/Station-to-Station_protocol). Upozorňujeme, že tento protokol je také základem
protokolu [SSU](/en/docs/transport/ssu/).


### Dodatečná informace o DPI

Předpokládáme dvě složky DPI:

Online DPI
`````````````

Online DPI sleduje všechny toky v reálném čase. Připojení mohou být blokována nebo
jinak záměrně narušována. Data připojení nebo metadata mohou být identifikována a
uložena pro offline analýzu. Online DPI nemá přístup ke
síťové databázi I2P. Online DPI má pouze omezenou schopnost
výpočtu v reálném čase, včetně výpočtu délky, prohlížení polí a jednoduchých
výpočtů, jako je například XOR. Online DPI má schopnost rychlých
kryptografických funkcí v reálném čase, jako je ChaCha20, AEAD a hashování, ale tyto
by byly příliš nákladné pro použití ve většině nebo na všech tocích. Jakákoli použití těchto
kryptografických operací by se vztahovala pouze na toky na IP/Port kombinacích
předtím identifikovaných analýzou offline. Online DPI nemá schopnost
kryptografických funkcí s vysokými náklady, jako je DH nebo elligator2.
Online DPI není navržena speciálně pro detekci I2P, i když může mít
omezená pravidla pro klasifikaci za tímto účelem.

Je cílem zabránit identifikaci protokolu online DPI.

Pojem online nebo "jednoduché" DPI je zde brán v úvahu jako
následující schopnosti útočníka:

1) Schopnost inspekce všech dat odeslaných nebo přijatých cílem.

2) Schopnost provádět operace na pozorovaných datech, jako je
   použití blokových šifrovacích či hashovacích funkcí.

3) Schopnost ukládat a porovnávat s dříve odeslanými zprávami.

4) Schopnost modifikovat, zpozdit nebo fragmentovat pakety.

Nicméně, online DPI se předpokládá, že má následující omezení:

5) Neschopnost mapovat IP adresy na hashe routerů. Zatímco to je triviální
   se skutečným přístupem k síťové databázi,
   vyžadovalo by to systém DPI speciálně navržený k cílení na I2P.

6) Neschopnost použít časové informace k detekci protokolu. 

7) Obecně řečeno, toolbox online DPI neobsahuje žádné vestavěné
   nástroje speciálně navržené pro detekci I2P. To zahrnuje
   vytváření "honeypotů", které by například zahrnovaly nenáhodné vycpávání ve
   svých zprávách. Upozorňujeme, že to nevylučuje systémy strojového učení nebo
   vysoce konfigurovatelné nástroje DPI, pokud splňují ostatní požadavky.

Aby se zabránilo analýze obsahu, je zajištěno, že všechny zprávy jsou
nerozeznatelné od náhodných. To také vyžaduje, aby jejich délka byla náhodná,
což je složitější než jen přidání náhodného vycpávky. Ve skutečnosti, v příloze
A autoři argumentují, že naivní (tj. uniformní) schéma vycpávání neřeší
problém. Příloha A proto doporučuje buď zahrnout náhodná
zpoždění, nebo vyvinout alternativní schéma vycpávání, které by mohlo poskytnout rozumnou
ochranu proti navrženému útoku.

Aby byla chráněna šestá položka výše, by implementace měla zahrnovat náhodná
zpoždění v protokolu. Tyto techniky nejsou obsaženy v tomto návrhu, ale
mohou také řešit problémy s délkou vycpávání. Shrnutím lze říci, že návrh
poskytuje dobrou ochranu proti analýze obsahu (když jsou
úvahy v příloze A brány v úvahu), ale pouze omezenou ochranu proti analýze toku.


Offline DPI
``````````````

Offline DPI inspekci dat uložených online DPI pro pozdější analýzu.
Offline DPI může být navržen speciálně pro detekci I2P.
Offline DPI má skutečný přístup k síťové databázi I2P.
Offline DPI má přístup k této a jiným specifikacím I2P.
Offline DPI má neomezenou výpočetní schopnost, včetně
všech kryptografických funkcí definovaných v této specifikaci.

Offline DPI nemá schopnost blokovat existující připojení. 
Offline DPI má skutečnou schopnost posílat na host/port stran pomocí vložení pak

etů. 
Offline DPI

 má skutečnou schopnost skutečného (do několika minut po nastavení) přehrání
 předchozích zpráv (modifikovaných nebo ne) z důvodu "sondování" nebo jiných důvodů.

Není cílem zabránit identifikaci protokolu offline DPI.
Všechny dekódování zamaskovaných dat v prvních dvou zprávách, která
jsou implementována routery I2P, může být také implementována offline DPI.

Je cílem odmítnout pokusy o připojení s použitím replayu předchozích zpráv.




### Ověření adresy

Následující je zkopírováno z QUIC [RFC-9000](https://www.rfc-editor.org/rfc/rfc9000.html).
Pro každou část přehodnoťte a upravte.

Ověření adresy zajišťuje, že endpoint nelze použít pro
útok na zesílení provozu. V takovém útoku je
paket odeslán na server s podvrženou informací o zdrojové adrese, která identifikuje
oběť. Pokud server generuje v reakci na tento paket více nebo větší
pakety, může útočník použít server k odesílání více dat směrem k oběti, než by byl
schopen sám.

Hlavní obranou proti útokům na zesílení je ověření, že
partner je schopen přijímat pakety na transportní adrese, kterou
prohlašuje. Proto, po přijetí paketů z adresy, která nebyla
ověřena, endpoint MUSÍ omezit množství dat, která odesílá na
neověřenou adresu, na trojnásobek počtu dat přijatých z této
adresy. Toto omezení na velikost odpovědí je známé jako
omezení na zesílení.

Ověření adresy se provádí jak během navazování spojení
(viz část 8.1), tak během migrace spojení (viz část 8.2).

Ověření adresy při navazování spojení
```````````````````````````````````````````````

Navazování spojení implicitně poskytuje ověření adresy pro
obě strany. Zejména přijetí paketu chráněného pomocí
klíčů handshake potvrzuje, že partner úspěšně zpracoval
inicializační paket. Jakmile endpoint úspěšně zpracuje
handshake paket od partnera, může považovat partnerovu adresu za
ověřenou.

Kromě toho může endpoint považovat partnerovu adresu za ověřenou, pokud
partner používá ID spojení vybrané endpointem a
ID spojení obsahuje alespoň 64 bitů entropie.

Pro klienta hodnota pole Destination Connection ID v
prvním inicializačním paketu umožňuje ověřit adresu serveru jako
součást úspěšného zpracování libovolného paketu. Inicializační pakety od
serveru jsou chráněny pomocí klíčů, které jsou odvozeny z této hodnoty
(viz sekce 5.2 dokumentu [QUIC-TLS]). Alternativně je hodnota
omezena serverem v paketech Version Negotiation (část 6) nebo zahrnuta
do Integrity Tag v paketech Retry (část 5.8 dokumentu [QUIC-TLS]).

Před ověřením adresy klienta MUSÍ servery nezdesílat více
než trojnásobek množství bajtů, které obdržely. Toto omezení
velikosti zesílení slouží k omezení rozsahu jakéhokoliv útoku na zesílení
, který lze provést pomocí podvržených zdrojových adres. Pro účely
omezení na zesílení před ověřením adresy,
servery MUSÍ započítat všechny bajty zatížení přijatého v datagramech,
které jsou jednoznačně přiřazeny jediné

mu spojení
. Toto zahrnuje datagramy
, které obsahují pakety, které byly úspěšně zpracovány, a datagramy
, které obsahují pakety, které byly všechny zablokovány.

Klienti MUSÍ zajistit, aby UDP datagramy obsahující inicializační pakety
měly užitečný náklad UDP alespoň 1200 bajtů a přidaly PADDING rámce podle potřeby. Klient, který
odesílá vycpané datagramy, umožňuje serveru
odesílat více dat před dokončením ověření adresy.

Ztráta inicializačního nebo handshake paketu od serveru může způsobit
vytuhnutí, pokud klient neodesílá další inicializační nebo handshake
pakety. V takovém případě, pokud server dosáhne svých omezení na
zesílení a klient obdržel potvrzení pro všechny data, která odeslal.
V tomto případě, pokud klient nemá důvod odesílat další pakety, server nebude schopen odeslat více dat, protože neověřil adresu klienta. Aby se této situaci předešlo,
klienti MUSÍ odeslat paket na Probe Timeout (PTO); viz část 6.2 dokumentu [QUIC-RECOVERY]. Konkrétně,
klient MUSÍ odeslat inicializační paket v datagramu UDP, který obsahuje alespoň
1200 bajtů, pokud nemá klíče handshake, a jinak odeslat
handshake paket.

Server může chtít ověřit adresu klienta před
zahájením kryptografického handshaku. QUIC používá
token v inicializačním paketu k poskytnutí ověření adresy před dokončením handshaku.
Tento token je doručen klientovi během navazování spojení
s retrypaketem (viz sekce 8.1.2) nebo v předchozím spojení
pomocí rámce NEW_TOKEN (viz sekce 8.1.3).

Kromě omezení odesílání, která se uplatňují před ověřením adresy,
jsou servery také omezeny limity stanovenými společným obslužným programem. Klienti jsou omezeni
pouze společným ovladačem.

Stavba tokenu
`````````````````````````````````````````````````````````

Token odeslaný v rámci NEW_TOKEN nebo paket retry MUSÍ být
sestaven způsobem, který umožňuje serveru identifikovat, jak byl
poskytnut klientovi. Tyto tokeny jsou přenášeny ve stejném poli, ale
vyžadují rozdílné zpracování od serverů.

Ověření adresy pomocí retrypaketů
```````````````````````````````````````````````````````

Po přijetí inicializačního paketu od klienta může server požádat
o ověření adresy odesláním retrypaketu (část 17.2.5)
obsahujícího token. Klient MUSÍ opakovat tento token ve všech
inicializačních paketech, které pro toto spojení odesílá poté, co
obdrží retrypaket.

V reakci na zpracování inicializačního paketu obsahujícího token, který
byl poskytnut v retrypaketu, nemůže server zaslat další retrypaket; může pouze
odmítnout spojení nebo ho nechat pokračovat.

Pokud tedy není možné, aby útočník vygeneroval platný
token pro svoji vlastní adresu (viz sekce 8.1.4) a token je
schopen klient vrátit, je potvrzeno serverem, že tento token přijal.

Server může také použít retrypaket k odložení nákladů
stavu a zpracování navázání spojení. Požadavek na server
poskytnout jiné ID spojení spolu s transportním parametrem
original_destination_connection_id definovaným v sekci 18.2
nutí server demonstrovat, že on nebo subjekt, s nímž spolupracuje,
přijal původní inicializační paket od klienta. Poskytnutí jiného ID
spojení také poskytuje serveru určitou kontrolu nad tím, jak jsou následné
pakety vedeny. Toto lze použít k nasměrování spojení na jinou
instanci serveru.

Pokud server obdrží inicializační paket klienta, který obsahuje neplatný
retry token, ale jinak je platný, ví, že klient nepřijme
žádný další retry token. Server může takový paket zablokovat
a počkat, až klient zjistí selhání handshaku na základě
vypršení časového limitu, ale to by mohlo klientovi uložit výrazné
latence. Místo toho by server měl okamžitě ukončit (část 10.2) spojení s
chybou INVALID_TOKEN. Upozorňujeme, že server v tomto bodě ještě
nebyl pro spojení vytvořen žádný stav, a proto nevstupuje
do uzavíracího období.

Tok, který ukazuje použití retrypaketu, je uveden na obrázku 9.

```
Klient                                                  Server

  Initial[0]: CRYPTO[CH] ->

                                                <- Retry+Token

  Initial+Token[1]: CRYPTO[CH] ->

                                 Initial[0]: CRYPTO[SH] ACK[1]
                       Handshake[0]: CRYPTO[EE, CERT, CV, FIN]
                                 <- 1-RTT[0]: STREAM[1, "..."]

                Obrázek 9: Příklad handshake s retry
```



Ověření adresy pro budoucí spojení
```````````````````````````````````````````````````````

Server MŮŽE poskytnout klientům token pro ověření adresy během
jednoho spojení, který může být použit při budoucím spojení. Ověření
adresy je obzvláště důležité u 0-RTT, protože server
potenciálně odesílá značné množství dat klientovi v
reakci na 0-RTT data.

Server využívá rámce NEW_TOKEN (část 19.7) k poskytnutí
klientovi tokenu pro ověření adresy, který může být použit k ověření
budoucích spojení. V budoucím spojení klient zahrne tento
token ve všech inicializačních paketech, pokud není novější
token přepsán retrypaketem. Klient NESMÍ používat
token poskytnutý v retrypaketu pro budoucí spojení. Servery MŮŽOU
blokovat jakýkoli inicializační paket, který nenese očekávaný token.

Na rozdíl od tokenu, který je vytvořen pro retrypaket, který se používá
okamžitě, token odeslaný v rámci NEW_TOKEN může být použit po
nějakém časovém bodě. Proto by měl mít token
doba expirace, což může být buď explicitní doba expirace, nebo
časové razítko vydání, které může být použito k dynamickému výpočtu
doby expirace. Server může uložit dobu expirace nebo ji zahrnout
v zašifrované formě v tokenu.

Token vydaný s NEW_TOKEN NESMÍ obsahovat informace, které by
umožňovaly mapování hodnot pozorovatelem na spojení, při kterém
byl vydán. Například nemůže obsahovat předchozí
connection ID nebo informace o adrese, pokud nejsou
zašifrovány. Server MUSÍ zajistit, že každý rámec NEW_TOKEN, který
odošle, je jedinečný pro všechny klienty, s výjimkou těch,
které jsou odesílány k opravě ztrát předchozích
rámců NEW_TOKEN. Informace, které umožňují serveru rozlišit mezi
tokeny z retrypaketů a NEW_TOKEN MŮŽE být přístupná jiným subjektům
než serveru.

Je nepravděpodobné, že číslo portu klienta bude stejné ve dvou
různých spojeních; proto je nepravděpodobné, že ověření portu bude
úspěšné.

Token přijatý v rámci NEW_TOKEN je použitelný pro jakýkoli server,
u něhož se spojení považuje za autoritativní (např. jména serverů
zahrnutá v certifikátu). Při připojení k serveru, pro
který klient uchovává příslušný a nepoužitý token, by ho měl
klient zahrnout do pole Token inicializačního paketu.
Zahrnutím tokenu by mohl server ověřit adresu klienta bez
dalšího zpátečního výletu. Klient NESMÍ zahrnout token,
který není použitelný pro server, ke kterému se připojuje, pokud
klient nemá znalosti, že server, který vydal
token, a server, ke kterému se klient připojuje, sdílejí
řízení tokenů. Klient MŮŽE použít token z jakéhokoli předchozího
spojení s tímto serverem.

Token serveru umožňuje korelovat aktivitu mezi spojením,
v němž byl token vydán, a jakýmkoli spojením, v němž je použit.
Klienti, kteří chtějí přerušit kontinuitu identity se serverem,
mohou odhodit tokeny poskytnuté pomocí rámce NEW_TOKEN.
Naopak, token získaný v retrypaketu MUSÍ být použit
okamžitě během pokusu o připojení a nemůže být použit v
následných pokusech o připojení.

Klient NESMÍ znovu použít token ze rámce NEW_TOKEN pro
různé pokusy o připojení. Opětovné použití tokenu umožňuje spojení
být propojeno entitami na síťové cestě; viz sekce 9.5.

Klienti mohou obdržet více tokenů v jediném spojení. Kromě
zamezení možnosti propojení může být jakýkoli token použit v
jakémkoliv pokusu o připojení. Servery mohou posílat další tokeny buď
k umožnění ověření adresy pro více pokusů o připojení, nebo k
nahrazení starších tokenů, které by mohly být neplatné.  Pro klienta toto
ambiguita znamená, že odesíláním nejnovějšího nepoužitého tokenu je
nejpravděpodobnější, že bude účinný. I když uchování a
použití starších tokenů není negativní, klienti mohou považovat starší
tokeny za méně pravděpodobné, že budou serveru k ověření
adresy užitečné.

Při přijetí inicializačního paketu s tokenem pro ověření
adresy MUSÍ server pokusit ověřit token, pokud není adresa
již ověřena. Pokud je token neplatný, měl by server pokračovat jako kdyby
klient neměl ověřenou adresu, což zahrnuje potenciálně poslání
retrypaketu. Tokeny poskytované s rámci NEW_TOKEN a retrypakety mohou
být rozlišeny servery (viz část 8.1.1), a ty poslední mohou být
ověřovány přísněji. Pokud ověření uspěje, server by měl pak umožnit
handshaku pokračovat.

Poznámka: Důvod pro zacházení s klientem jako neověřeným
místo zahození paketu spočívá v tom, že klient mohl
obdržeti token v předchozím spojení pomocí rámce NEW_TOKEN, a pokud
servery ztratily stav, nemuselo by být schopno
ověřit token vůbec, což vedlo k selhání spojení, pokud
by byl paket zahoditelný.

Ve stateless designu může server použít zašifrované a autentizované
tokeny k předání informací klientům, které server může později
získat a použít pro ověření adresy klienta. Tokeny nejsou
integrované do kryptografického handshake, a proto nejsou
ověřovány. Například klient může být schopen použít znovu
token. Aby se předešlo útokům, které využívají tuto vlastnost, může server
omezit použití tokenů pouze na informace potřebné k ověření
adres klientů.

Klienti mohou použít tokeny získané v jednom spojení pro jakýkoli pokus o
připojení pomocí stejné verze. Při výběru tokenu
k použití, klienti nemusí brát v úvahu jiné vlastnosti
spojení, které je pokoušeno, včetně volby možných aplikačních
protokolů, session ticketů nebo jiných vlastností spojení.

Adresy pro integritu tokenu validace
```````````````````````````````````````````````````````

Token pro ověření adresy MUSÍ být těžký na uhodnutí. Zahrnutí
náhodné hodnoty s alespoň 128 bity entropie do tokenu by bylo
dostatečné, ale závisí to na serveru, který si pamatuje hodnotu, kterou
zašle klientům.

Schéma na bázi tokenů umožňuje serveru převést jakékoli náklady související
s validací na klienta. Aby tento design fungoval,
token MUSÍ mít krytí na integritu proti
modifikaci nebo falšování klienty. Bez
ochrany integrity by mohli zlí klienti generovat nebo hádat hodnoty pro
tokeny, které by server přijal. Pouze server
potřebuje přístup ke klíčům pro ochranu integrity tokenů.

Není potřeba jediného definovaného formátu tokenu, protože server,
který generuje token, ho také spotřebovává. Tokeny
odeslané v retrypaketech MĚLI by zahrnovat informace, které
umožňují serveru ověřit, že zdrojová IP adresa a port v paketov
sidla zůstávají konstantní.

Tokeny odeslané v rámcích NEW_TOKEN MUSÍ zahrnovat informace, které
umožňují serveru ověřit, že se IP adresa klienta nezměnila
od chvíle, kdy byl token vydán. Servery mohou používat tokeny z
NEW_TOKEN rámců při rozhodování, aby neposílaly retrypaket, i když
adresa klienta se změnila. Pokud se IP adresa klienta změnila, server
MUSÍ dodržovat anti-amplifikační omezení; viz sekce 8.
Pozor, že při přítomnosti NAT, tento požadavek nemusí být
dostačující k ochraně ostatních hostitelů, kteří sdílejí NAT,
před amplifikačními útoky.

Útočníci by mohli znovu přehrávat tokeny k použití serverů jako zesilovačů v útocích typu DDoS.
Aby se ochránilo před takovými útoky, servery MUSÍ zajistit, že
znovuzahájení tokenů je zabráněno nebo omezeno. Servery MĚLI
zajistit, že tokeny odeslané v retrypaketech jsou přijímány pouze po
krátkou dobu, protože jsou okamžitě vráceny klienty. Tokeny, které
jsou poskytnuty v rámcích NEW_TOKEN (část 19.7) musí
být platné po delší dobu, ale NESMÍ být přijímány několikrát.
Servery jsou povinny umožnit použití tokenů pouze jednou
, pokud je to možné; tokeny MOHOU zahrnovat
dodatečné informace o klientech k dalšímu zužování použití nebo
opětovného použití.

Ověření cesty
```````````````````````````````````````````````````````

Ověření cesty je používáno oběma partnery během migrace spojení
(viz sekce 9) k ověření dosažitelnosti po změně adresy. V
ověření cesty, endpointy testují dosažitelnost mezi specifickou lokální
adresou a specifickou adresou partnera, kde adresa je 2-tuple
IP adresa a port.

Ověření cesty testuje, zda jsou pakety zaslané na cestu k
partnerovi přijímány tímto partnerem. Ověření cesty slouží k
zajistit, že pakety přijaté z migrujícího partnera nemají podvrženou
zdrojovou adresu.

Ověření cesty neověřuje, že partner může odesílat v návratovém
směru. Acknowledgmenty nelze použít k ověření návratové cesty,
protože obsahují nedostatečnou entropii a mohou být podvrženy.
Endpointy si nezávisle na sobě určují dosažitelnost v každém směru
cesty, a proto návratovou dosažitelnost může stanovit
pouze partner.

Ověření cesty může být použito kdykoliv kterýmkoli partnerem. Pro
příklad, endpoint může ověřit, že partner je stále v držení
své adresy po období nečinnosti.

Ověření cesty není navrženo jako mechanizmus pro průchod NAT.
I když mechanizmus popsaný zde může být efektivní pro vývoj
NAT připojení, která podporují průchod NAT, očekává se, že jeden
endpoint je schopen přijímat pakety bez předchozího odeslání
paketu na tuto cestu. Efektivní průchod NAT potřebuje dodatečné
synchronizační mechanizmy, které zde nejsou poskytovány.

Endpoint MŮŽE zahrnovat další rámce s rámci PATH_CHALLENGE a
PATH_RESPONSE používanými pro ověření cesty. Zejména,
endpoint může zahrnovat PADDING rámce s rámcem PATH_CHALLENGE pro
Objevování maximální přenosové jednotky cesty (PMTUD); viz sekce 14.2.1.
Endpoint může také zahrnout svůj vlastní rámec PATH_CHALLENGE při
odesílání rámce PATH_RESPONSE.

Endpoint použije nové ID spojení pro sondy odesílané z nové lokální
adresy; viz sekce 9.5. Při sondování nové cesty může endpoint
zajistit, že partner má nepoužité ID spojení dostupné pro
reakce. Odesláním rámců NEW_CONNECTION_ID a PATH_CHALLENGE ve
stejném paketu, pokud limit peerů active_connection_id_limit to dovoluje,
zajistí, že bude k dispozici nevyužité ID spojení pro partnera,
když odesílá odpověď.

Endpoint může zvolit současně sondovat více cest. Počet
simultánních cest použitých pro sondy je omezen počtem
extra ID spojení, které dříve poskytl partner, protože každá
nová lokální adresa použitá pro sondu vyžaduje dříve nepoužité
ID spojení.

Zahájení ověření cesty
```````````````````````````````````````````````````````

K zahájení ověření cesty, endpoint odešle rámec PATH_CHALLENGE 
obsahující nepředvídatelné zatížení na cestu, kterou je třeba 
ověřit.

Endpoint MŮŽE odeslat více rámců PATH_CHALLENGE k zajištění proti 
ztrátě paketů. Nicméně, endpoint NESMĚJTE odeslat více
rámců PATH_CHALLENGE v jediném paketu.

Endpoint NESMÍ sondovat novou cestu s pakety obsahujícími
rámec PATH_CHALLENGE častěji, než by odeslal inicializační
paket. Toto zajišťuje, že migrace spojení není větší 
zátěž na novou cestu než založení nového spojení.

Endpoint MUSÍ použít nepředvídatelné data v každém rámci PATH_CHALLENGE 
tak, aby mohl spojit reakci partnera s 
odpovídajícím rámcem PATH_CHALLENGE.

Endpoint MUSÍ rozšířit datagramy, které obsahují rámec PATH_CHALLENGE 
alespoň na nejmenší dovolenou maximální velikost datagramu o 1200 byte,
pokud anti-amplifikační limit pro cestu neumožňuje
odeslání datagramu této velikosti. Odesílání UDP datagramů o této velikosti
zajistí, že síťová cesta od endpointu k peeru může být
použita pro QUIC; viz sekce 14.

Pokud je endpoint neschopen rozšířit velikost datagramu na 1200 bajtů
kvůli anti-amplifikačnímu limitu, nebude ověřena
MTU cesty. Aby bylo zajištěno, že je MTU cesty dostatečně
velká, endpoint MUSÍ provést druhé ověření cesty odesláním
rámce PATH_CHALLENGE v datagramu o velikosti alespoň 1200 bajtů. Toto
dodatečné ověření lze provést poté, co je úspěšně
obdržen PATH_RESPONSE, nebo když bylo přijato dostatečné množství bajtů na
cesty, že odesílání většího datagramu by nezpůsobilo
překročení anti-amplifikačního limitu.

Na rozdíl od jiných situací, kdy jsou datagramy rozšířeny, endpointi NESMÍ
zahodit datagramy, které vypadají příliš malé, když obsahují
rámec PATH_CHALLENGE nebo PATH_RESPONSE.

Odpovědi na ověření cesty
```````````````````````````````````````````````````````

Při přijetí rámce PATH_CHALLENGE MUSÍ endpoint reagovat
tím, že zopakuje data obsažená v rámci PATH_CHALLENGE v
rámci PATH_RESPONSE. Endpoint NESMÍ zdržovat přenos paketu 
obsahujícího rámec PATH_RESPONSE, pokud to neomezuje
řízení přetížení.

Rámec PATH_RESPONSE MUSÍ být odeslán na síťovou cestu, na které
byl rámec PATH_CHALLENGE přijat. Toto zajišťuje, že ověření cesty
partnerem uspěje, pouze pokud je cesta funkční v obou
směrech. Tento požadavek NESMÍ být vynucován endpointem, který zahajuje
ověření cesty, protože by to umožnilo útok na migraci;
viz sekce 9.3.3.

Endpoint MUSÍ rozšířit datagramy, které obsahují rámec PATH_RESPONSE 
alespoň na nejmenší dovolenou maximální velikost datagramu o 1200 bajtů.
Toto ověřuje, že cesta je schopna přenášet datagramy této velikosti
v obou směrech. Nicméně endpoint NESMÍ rozšířit
datagram obsahující PATH_RESPONSE, pokud výsledná data překročí
anti-amplifikační limit. Toto se očekává pouze tehdy, pokud
přijatý PATH_CHALLENGE nebyl odeslán v rozšířeném datagramu.

Endpoint NESMÍ odeslat více než jeden rámec PATH_RESPONSE jako
odpověď na jeden rámec PATH_CHALLENGE; viz sekce 13.3. Peer
očekává, že pošle více rámců PATH_CHALLENGE podle potřeby, aby
cel terapii rámce PATH_RESPONSE.

Úspěšné ověření cesty
```````````````````````````````````````````````````````

Ověření cesty uspěje, když je přijat rámec PATH_RESPONSE obsahující
data, která byla odeslána v předchozím rámci PATH_CHALLENGE.
Rámec PATH_RESPONSE přijatý na jakékoliv síťové cestě 
ověřuje cestu, na které byl odeslán PATH_CHALLENGE.

Pokud endpoint odesílá rámec PATH_CHALLENGE v datagramu, který není
rozšířen alespoň na 1200 bajtů a pokud reakce na něj ověřuje
peerovu adresu, je cesta ověřena, ale není
ověřena MTU cesty. V důsledku toho může endpoint odesílat více
než trojnásobek množství dat, které bylo přijato. Nicméně, endpoint MUSÍ
zahájit další ověření cesty s rozšířeným datagramem k ověření, že
cesta podporuje požadovanou MTU.

Přijetí potvrzení o paketu obsahujícím rámec PATH_CHALLENGE
není dostatečným ověřením, protože potvrzení může být
podvrženo zlomyslným peerem.

Neúspěšné ověření cesty
```````````````````````````````````````````````````````

Ověření cesty selže, jen když endpoint, který se pokouší
ověřit cestu, opustí svůj pokus o ověření cesty.

Endpointi by měli opustit ověřování cesty na základě časovače. 
Pokud nastavujete tento časovač, implementace by měly brát v úvahu, že
nová cesta může mít delší round-trip time než původní. 
Hodnota třikrát větší než je současná PTO nebo
PTO pro novou cestu (použitím kInitialRtt, jak je definováno v [QUIC

- RECOVERY]) se DOPORUČUJE.

Tato časová prodleva umožňuje, aby několik PTO vypršelo před selháním
ověření cesty, aby se ztráta jednoho rámce PATH_CHALLENGE nebo PATH_RESPONSE 
nezpůsobila selhání ověření cesty.

Všimněte si, že endpoint může obdržet pakety obsahující jiné rámce
na nové cestě, ale rámec PATH_RESPONSE s odpovídajícími daty je
nutný pro úspěšné ověření cesty.

Pokud endpoint opustí ověření cesty, určuje, že
cesta je nepoužitelná. To nemusí nutně znamenat selhání spojení -
endpointi mohou pokračovat v odesílání paketů po jiných
cestách podle potřeby. Pokud nejsou k dispozici žádné cesty,
endpoint může čekat na novou cestu, která bude k dispozici, nebo
uzavřít spojení. Endpoint, který nemá žádnou validní síťovou cestu ke
svému peerovi MŮŽE signalizovat to pomocí chybového kódu NO_VIABLE_PATH
pro spojení s ohledem, že to je možné pouze tehdy, když síťová cesta
existuje, ale nepodporuje požadovanou MTU
(část 14).

Ověření cesty může být opuštěno z jiných důvodů než
selhání. Primárně k tomu dochází, pokud je zahájena migrace spojení
na novou cestu, zatímco ověření cesty na staré cestě
probíhá.

### Migrace spojení

Následující je zkopírováno z QUIC [RFC-9000](https://www.rfc-editor.org/rfc/rfc9000.html).
Pro každou sekci přehodnoťte a upravte.


Použití ID spojení umožňuje spojení přežít změny
adres endpointů (IP adresa a port), jako jsou ty, které
způsobují změny v síti. Tato sekce popisuje
proces, kterým se endpoint přesouvá na novou adresu.

Návrh QUIC se spoléhá na endpointy, které si udržují stabilní adresu během
handshaku. Endpoint NESMÍ zahájit
migraci spojení před potvrzením handshaku, jak je definováno v
sekci 4.1.2 dokumentu [QUIC-TLS].

Pokud partner odeslal transportní parametr disable_active_migration, endpoint také NESMÍ 
odeslat pakety (včetně sondovacích paketů; viz
oddíl 9.1) z jiné lokální adresy na adresu, kterou partner
používá během handshaku, pokud endpoint nejedná na
preferovaný_transport_parameter partnera. Pokud partner
poruší tento požadavek, endpoint MUSÍ buď zlikvidovat příchozí
pakety na této cestě bez generování stateless_reset nebo
pokračovat v ověřování cesty a umožnit partnerovi migrovat. Generování
stateless_reset nebo uzavření spojení by umožnilo třetím stranám
v síti způsobit uzavření spojení podvržením nebo jinou manipulací
pozorovaného provozu.

Ne všechny změny adres partnera jsou zamýšlené nebo aktivní
migrace. Partner může zažít NAT znovupřipojení: změna
adresy kvůli middleboxu, obvykle NAT, přidělujícího nové
odchozí porty nebo dokonce novou odchozí IP adresu pro tok. Endpoint MUSÍ
provést ověření cesty (oddíl 8.2), pokud zjišťuje jakoukoli změnu
adresy partnera, pokud tuto adresu dříve neověřil.

Pokud endpoint nemá validní cestu, po které může odesílat pakety, může
stavu připojení zrušit. Endpoint schopný migrace
spojení MŮŽE čekat, až bude k dispozici nová cesta, než
zruší stav spojení.

Tento dokument omezuje migraci spojení na nové adresy klientů, s výjimkou
těch popsaných ve sekci 9.6. Klienti jsou
odpovědní za zahájení všech migrací. Servery neodesílají
ne-sondující pakety (viz oddíl 9.1) směrem k adrese klienta, dokud
nevidí ne-sondující paket z této adresy. Pokud klient obdrží
pakety z neznámé adresy serveru, klient musí tyto
pakety zahodit.

Sondování nové cesty
`````````````````````````

Endpoint MŮŽE sondovat dosažitelnost partnera z nové lokální adresy
použitím ověření cesty (oddíl 8.2) před migrací připojení
na novou lokální adresu. Neúspěch ověření cesty prostě znamená,
že nová cesta není použitelná pro toto připojení. Neúspěch
ověřit cestu nemusí způsobit konec spojení, pokud jsou
k dispozici jiné platné cesty.

PATH_CHALLENGE, PATH_RESPONSE, NEW_CONNECTION_ID a PADDING rámce
jsou "sondovací rámce", a všechny ostatní rámce jsou
"ne-sondovací rámce". Paket obsahující pouze sondovací rámce je "sondovací paket"
a paket obsahující jakýkoliv jiný rámec je "ne-sondovací paket".

Zahájení migrace spojení
```````````````````````````

Endpoint může migrovat spojení na novou lokální adresu
odesláním paketů obsahujících ne-sondovací rámce z této adresy.

Každý endpoint ověřuje adresu svého partnera během
založení spojení. Proto může migrující endpoint odesílat svému partnerovi
vědomý toho, že partner je ochoten přijímat na aktuální
adrese partnera. Takže endpoint může migrovat na novou lokální adresu
bez předchozího ověření adresy partnera.

K dosažení dosažitelnost na nové dráze zahájí endpoint ověření cesty
(část 8.2) na nové cestě. Endpoint MŮŽE odložit ověření cesty
do doby, kdy partner odešle další ne-sondovací rámec na svoji
novou adresu.

Při migraci nemusí nová cesta podporovat současný
transferový rychlostní limit endpointu. Proto endpoint resetuje svůj
přenosový ovladač a odhadu RTT, jak je popsáno v části 9.4.

Nová cesta nemusí mít stejnou schopnost ECN. Proto endpoint
ověří schopnost ECN jak je popsáno v sekci 13.4.

Reakce na migraci spojení
```````````````````````````````````````````

Přijetí paketu z nové adresy partnera obsahujícího ne-sondovací
rámec naznačuje, že se partner na tuto adresu migroval.

Pokud příjemce povolí migraci, MUSÍ odesílat následující
pakety na novou adresu partnera a MUSÍ zahájit ověření cesty
(část 8.2) k ověření vlastnictví adresy partnera, pokud
ověření není již na cestě. Pokud příjemce nemá nevyužité
ID spojení od partnera, nebude moci na nové cestě odesílat žádné
pakety, dokud nezíská jedno; viz sekci 9.5.

Endpoint mění adresu, na kterou odesílá pakety, pouze v
reakci na nejvýše očíslovaný ne-sondovací paket. Tím je zajištěno,
že endpoint neodesílá pakety na starou adresu partnera, pokud
obdrží znovuspracované pakety.

Endpoint MŮŽE odesílat data na neověřenou adresu partnera, ale MUSÍ
chránit proti potenciálním útokům, jak je popsáno v oddílech 9.3.1 a
9.3.2. Endpoint MŮŽE přeskočit ověření adresy partnera, pokud
byla tato adresa nedávno viděna. Zejména pokud se endpoint
vrací na dříve ověřenou cestu po detekci
nepravdivé migrace, přeskočení ověření adresy a obnovení
zjišťování ztrát a stavu přetížení může snížit
výkonové dopady útoku.

Po změně adresy, na kterou odesílá ne-sondovací pakety,
může endpoint opustit jakékoliv ověření cesty na jiné adresy.

Přijetí paketu z nové adresy partnera může být důsledkem
NAT znovuspojení u partnera.

Po ověření nové adresy klienta by měl server odeslat nové
tokeny pro ověření adresy (část 8) klientovi.

Falšování adresy partnera
```````````````````````````

Je možné, že partner podvádí svou zdrojovou adresu, aby způsobil, že
endpoint odesílá nadměrná množství dat na nevítané hosty. Pokud
endpoint odesílá výrazně více dat než útočící partner,
migrace spojení může být použita ke zvýšení objemu dat, které
útočník může generovat směrem k oběti.

Jak je popsáno v sekci 9.3, endpoint musí ověřit novou adresu
partnera, aby potvrdil vlastnictví nové adresy partnerem. Do
chvíle, než je adresa partnera považována za platnou, endpoint
omezuje množství dat, které odesílá na tuto adresu; viz sekce 8. 
Pokud toto omezení chybí, endpoint riskuje být použit
pro útok typu denial-of-service proti nevinné oběti.

Pokud endpoint přeskočí ověření adresy partnera, jak je popsáno výše,
nemusí omezovat svoji rychlost odesílání.

Falšování adresy na místě
`````````````````````````

Útočník na místě by mohl způsobit falešnou migraci spojení tím, že
zopakuje a přepošle paket s podvrženou adresou tak, aby
dorazil dříve než původní paket. Paket s podvrženou
adresou bude považován za pocházející z migrujícího spojení, a
původní paket bude považován za duplicitní a vyřazený. Po
sporné migraci ověření zdrojové adresy selže, protože entita
na zdrojové adrese nemá potřebné kryptografické klíče pro přečtení
nebo reakci na rámec PATH_CHALLENGE, který je na něj odeslán, i kdyby to chtěla.

Aby se zabránilo selhání spojení v důsledku takové sporné
migrace, endpoint MUSÍ obrátit k používání poslední ověřené
peer adresy, když ověření nové peer adresy selže. Navíc,
přijetí paketů s vyššími čísly paketů z legitimní
peer adresy způsobí další migraci spojení. Tímto se
protahuje ověření adresy falešné migrace, což omezuje migrace
zahájené útočníkem injekcí jediného paketu.

Pokud endpoint nemá žádný stav o poslední ověřené peer adrese, MUSÍ
uzavřít spojení tiše tím, že zruší veškerý stav
spojení. To způsobí, že nové pakety na spojení budou
zpracovávány obecně. Například endpoint MŮŽE odeslat stateless_reset
jako odpověď na jakékoliv další příchozí pakety.

Předávání paketů mimo linku
`````````````````````````````````````

Útočník mimo linku, který může pozorovat pakety, může přeposílat kopie
pravých paketů endpointům. Pokud zkopírovaný paket dorazí před
pravým paketem, bude se to zdát jako NAT znovuspojení. 
Jakýkoliv pravý paket bude považován za duplicitní, a budou
zahozeny. Pokud je útočník schopen pokračovat v přeposílání
paketů, mohl by způsobit migraci na cestu přes
útočníka. To umisťuje útočníka na linku, což mu
umožňuje pozorovat nebo vyřadit všechny následující pakety.

Tento styl útoku závisí na útočníku používajícím cestu,
která má přibližně stejné vlastnosti jako přímá cesta mezi
endpointy. Útok je spolehlivější, pokud je odesláno
poměrně málo paketů nebo pokud ztráta paketů souvisí
s pokusem o útok.

Ne-sondovací paket přijatý na původní cestě, který zvyšuje
maximální obdržené číslo paketu, způsobí, že endpoint se vrátí
na tuto cestu. Elicitace paketů na této cestě zvyšuje
pravděpodobnost, že útok nebude úspěšný. Proto obrana proti
tomuuto útoku závisí na zpracování výměny paketů.

V reakci na zjevnou migraci MUSÍ endpoint ověřit
původně aktivní cestu pomocí rámců PATH_CHALLENGE. Toto vyvolává
odesílání nových paketů na této cestě. Pokud cesta není již
funkční, pokus o ověření vyprší a selže; pokud je cesta
funkční, ale již nežádoucí, ověření uspěje, ale pouze
výsledkem je zasílání sondovacích paketů na cesty.

Endpoint, který obdrží rámec PATH_CHALLENGE na aktivní cestě,
by MĚL poslat ne-sondovací paket jako odpověď. Pokud ne-sondovací paket
dorazí před jakoukoliv kopií vyrobenou útočníkem, výsledkem
bude migrace na původní cestu. Každá následná
migrace na jinou cestu znovu spustí tento celý proces.

Tato obrana je nedokonalá, ale není to považováno za vážný
problém. Pokud cesta přes útok je spolehlivě rychlejší než
původní cesta navzdory několika pokusům o použití té původní,
není možné rozlišit mezi útokem a zlepšením
trasy.

Endpoint by mohl také použít heuristiky ke zlepšení detekce tohoto
stylu útoku. Například NAT znovuspojení je nepravděpodobné, pokud
pakety byly nedávno přijaty na staré cestě; podobně, znovuspojení
je vzácné na IPv6 cestách. Endpointy mohou také hledat zpodvojené
pakety. Naopak změna ID spojení pravděpodobně
naznačuje záměrné migrace než jako útok.

Detekce ztrát a řízení přetížení
```````````````````````````````````````````

Dostupná kapacita na nové cestě by nemusela být stejná jako
na staré cestě. Pakety odeslané na staré cestě NESMÍ přispívat k
řízení přetížení nebo RTT odhadu pro novou cestu.

Po ověření vlastnictví novou adresu peerem MUSÍ endpoint
okamžitě resetovat congestion kontrolér a RTT odhad pro novou cestu
na počáteční hodnoty (viz Příloha A.3 a
B.3 v [QUIC-RECOVERY]), pokud jediné, co se změnilo v peerové adrese,
je jeho číslo portu. Port-only změny jsou běžně výsledkem
NAT znovuspojení nebo jiné middlebox aktivity, takže endpoint MŮŽE
místo toho zachovat svůj stav řízení přetížení a odhad RTT
v těchto případech místo vracení se na počáteční hodnoty. Ve
případech, kdy je použit stav řízení přetížení zachován
na novou cestu s výrazně odlišnými charakteristikami, by mohlo dojít
k tomu, že odesílatel bude přenášet příliš agresivně, dokud se 
přizpůsobí zjišťování přetížení a odhad RTT.
Obecně se doporučuje být opatrný při použití předchozích
hodnot na nové cestě.

Může dojít ke zdánlivému přeskupení na přijímači, když endpoint
odesílá data a provádí sondování z / na více adres 
během období migrace, protože tyto dvě výsledné cesty mohou 
ma různá RT živá mi. Přijímač bude pořád odesílat
ACK rámce pokrývající všechny přijaté pakety.

I když mohou být během migrace spojení použity různé cesty, 
jediný kontext řízení přetížení a jediný kontext loss recovery
(jak je popsáno ve [QUIC-RECOVERY]) by mohl být dostatečný.
Například endpoint může oddálit přepnutí na nový kontext řízení přetíže

ní
dokud není potvrzeno, že stará cesta není
již potřeba (například případy popsané v sekci 9.3.3).

Odesílatel může udělat výjimky pro sondové pakety, aby jejich
detekce ztrát byla nezávislá a nezpůsobovala zbytečně, že by řízení
přetížení snížilo svou míru odesílání. Endpoint může nastavit
separátní časovač, když je odeslán PATH_CHALLENGE, který
se zruší, pokud bude odpovídající PATH_RESPONSE přijat.
Pokud časovač skončí dříve, než je PATH_RESPONSE přijat, endpoint může
odeslat nový PATH_CHALLENGE a restartovat časovač na delší období
času. Tento časovač by MĚL být nastaven jak je popsáno v sekci 6.2.1
v [QUIC-RECOVERY] a NESMÍ být agresivnější.

Důsledky ochrany osobních údajů během migrace spojení
``````````````````````````````````````
