---
title: "ECIES-X25519-AEAD-Ratchet"
number: "144"
author: "zzz, chisana, orignal"
created: "2018-11-22"
lastupdated: "2025-03-05"
status: "Closed"
thread: "http://zzz.i2p/topics/2639"
target: "0.9.46"
implementedin: "0.9.46"
---

## ملاحظة
جارٍ نشر الشبكة واختبارها.
عرضة لتعديلات طفيفة.
راجع [SPEC](/en/docs/spec/ecies/) لمواصفات الرسمية.

الميزات التالية غير منفذة في الإصدار 0.9.46:

- كتل الرسائل والأرقام، الخيارات، والانتهاء
- ردود بروتوكولات البروتوكول
- مفتاح ثابت صفر
- الإرسال المتعدد

## نظرة عامة

هذا اقتراح لنوع جديد من التشفير من النهاية إلى النهاية منذ بداية I2P، لاستبدال ElGamal/AES+SessionTags [Elg-AES](/en/docs/spec/elgamal-aes/).

يعتمد على العمل السابق كما يلي:

- المواصفات الهياكل المشتركة [Common](/en/docs/spec/common-structures/)
- مواصفات [I2NP](/en/docs/spec/i2np/) بما في ذلك LS2
- ElGamal/AES+Session Tags [Elg-AES](/en/docs/spec/elgamal-aes/)
- نظرة عامة على التشفير غير المتماثل الجديد http://zzz.i2p/topics/1768
- نظرة عامة على التشفير منخفض المستوى [CRYPTO-ELG](/en/docs/how/cryptography/)
- ECIES http://zzz.i2p/topics/2418
- [NTCP2](/en/docs/transport/ntcp2/) [Prop111](/en/proposals/111-ntcp2/)
- 123 إدخال جديد netDB
- 142 قالب تشفير جديد
- بروتوكول [Noise](https://noiseprotocol.org/noise.html)
- خوارزمية المضاعف المزدوجة [Signal](https://signal.org/docs/specifications/doubleratchet/)

الهدف هو دعم تشفير جديد للاتصال من النهاية إلى النهاية، وبين الوجهات.

سيستخدم التصميم تجربة Noise ومراحل البيانات المدمجة مع مضاعفة Signal المزدوجة.

جميع الإشارات إلى Signal وNoise في هذا الاقتراح هي لمعلومات خلفية فقط.
لا يُطلب معرفة بروتوكولات Signal وNoise لفهم أو تنفيذ هذا الاقتراح.


### الاستخدامات الحالية لـElGamal

كمراجعة،
يمكن العثور على مفاتيح ElGamal العامة بحجم 256 بايت في الهياكل البيانية التالية.
راجع المواصفات الهياكل المشتركة.

- في هوية الموجه
  هذا مفتاح تشفير الموجه.

- في الوجهة
  تم استخدام المفتاح العام للوجهة للتشفير من i2cp إلى i2cp القديم
  والذي تم تعطيله في الإصدار 0.6، وهو غير مستخدم حاليًا إلا
  لIV تشفير LeaseSet، والذي تم إيقافه.
  يستخدم المفتاح العام في LeaseSet بدلاً من ذلك.

- في LeaseSet
  هذا مفتاح تشفير الوجهة.

- في LS2
  هذا مفتاح تشفير الوجهة.


### الأنواع التشفيرية في شهادات المفتاح

كمراجعة،
أضفنا دعمًا لأنواع التشفير عندما أضفنا دعمًا لأنواع التوقيع.
حقول نوع التشفير هي دائمًا صفر، سواء في الوجهات أو هويات الموجهات.
ما إذا كان يجب تغير ذلك من قبل هو المنهج الذي برسم عليه.
راجع المواصفات الهياكل المشتركة [Common](/en/docs/spec/common-structures/).


### استخدامات التشفير غير المتماثل

كمراجعة، نستخدم ElGamal لـ:

1) رسائل بناء الأنفاق (المفتاح موجود في هوية الموجه)
   الاستبدال غير مغطى في هذا الاقتراح.
   راجع الاقتراح 152 [Prop152](/en/proposals/152-ecies-tunnels/).

2) تشفير رسائل netdb وغيرها من رسائل I2NP بين الموجهات (المفتاح موجود في هوية الموجه)
   يعتمد على هذا الاقتراح.
   يتطلب اقتراحًا لـ 1) أيضًا، أو وضع المفتاح في خيارات RI.

3) تشفير الطرف إلى الطرف للمستخدم بواسطة ElGamal+AES/SessionTag (المفتاح موجود في LeaseSet، مفتاح الوجهة غير مستخدم)
   الاستبدال مغطى في هذا الاقتراح.

4) DH مؤقت لـ NTCP1 و SSU
   الاستبدال غير مغطى في هذا الاقتراح.
   راجع الاقتراح 111 لـ NTCP2.
   لا يوجد اقتراح حالي لـ SSU2.


### أهداف

- التوافق مع السابق
- يتطلب ويبني على LS2 (اقتراح 123)
- الاستفادة من التشفير أو البدائل الجديدة المضافة لـ NTCP2 (اقتراح 111)
- لا توجد حاجة لتشفير جديد أو بدائل لدعم
- المحافظة على الفواصل الزمنية بين التشفير والتوقيع؛ دعم جميع النسخ الحالية والمستقبلية
- تمكين التشفير الجديد للوجهات
- تمكين التشفير الجديد للموجهات، ولكن فقط لرسائل الثوم - سيكون بناء الأنفاق اقتراحاً منفصلًا
- عدم كسر أي شيء يعتمد على هاش الوجهة الثنائية 32 بايت، مثل التورنت
- الحفاظ على تسليم الرسائل 0-RTT باستخدام DH مؤقت-ثابت
- لا تتطلب تباطؤ / تصفّح الرسائل في هذا الط层 البروتوكولي؛# نستمر في دعم إرسال الرسائل غير المحدودة في كلا الاتجاهين دون انتظار الرد
- الترقية إلى DH مؤقت-مؤقت بعد 1 RTT
- المحافظة على معالجة الرسائل بترتيب غير ملتزم
- المحافظة على الأمان بقوة 256 بت
- إضافة سرية انتقالية
- إضافة التحقق (AEAD)
- كفاءة أكبر بكثير على مستوى وحدة المعالجة المركزية من ElGamal
- عدم الاعتماد على Java jbigi لجعل DH فعالًا
- تقليل العمليات DH
- كفاءته كبيرة بعرض النطاق الترددي أكثر من ElGamal (كتلة ElGamal بحجم 514 بايت)
- دعم التشفير الجديد والقديم على نفس النفق إذا لزم الأمر
- المتلقي قادر على التمييز بكفاءة بين التشفير الجديد والقديم القادم من نفس النفق
- لا يمكن للآخرين التمييز بين التشفير الجديد والقديم أو التشفير المستقبلي
- اتخاذ إجراءات للقضاء على التصنيف على أساس طول الجلسة الجديد مقابل الجلسة الحالية (دعم التوسيع)
- لا توجد رسائل جديدة في I2NP مطلوبة
- استبدال SHA-256 الاختبارية في حمولات AES باستخدام AEAD
- دعم الربط بين الجلسات الإرسال والاستقبال بحيث يمكن أن تحدث التأكيدات داخل البروتوكول، بدلاً من أن تكون فقط خارج النطاق.
  سيسمح هذا أيضًا بأن تحتوي الردود على سرية انتقالية فورياً.
- تمكين تشفير المستخدم النهائي لبعض الرسائل (تخزين RouterInfo) التي نحن حاليًا لا نقوم بذلك بسبب تحميل وحدة المعالجة المركزية.
- عدم تغيير رسالة I2NP Garlic أو تنسيق تعليمات تسليم الرسائل.
- إزالة الحقول التي لا تستخدم أو المتكررة في مجموعة الثوم والقرنفل.

إزالة العديد من المشاكل مع علامات الجلسة، بما في ذلك:

- عدم القدرة على استخدام AES حتى الرد الأول
- عدم الاعتمادية والتوقفات إذا كان تسليم العلامات يُفترض
- فعالية سيئة في استخدام عرض النطاق، خاصة في التسليم الأول
- كفاءة كبيرة في تخزين العلامات
- من الصعب ضبط الأداء للاستخدامات المختلفة
  (التدفق مقابل الرزم، الخادم مقابل العميل، عرض النطاق العالي مقابل منخفض)
- نقاط ضعف استنفاد الذاكرة بسبب تسليم العلامات


### الأهداف غير المضمونة / خارج النطاق

- تغييرات تنسيق LS2 (اقتراح 123 اكتمل)
- خوارزمية دوران DHT الجديدة أو توليد الكود العشوائي المشترك
- التشفير الجديد لبناء الأنفاق.
  راجع الاقتراح 152 [Prop152](/en/proposals/152-ecies-tunnels/).
- التشفير الجديد لتشفير ق层 الأنفاق.
  راجع الاقتراح 153 [Prop153](/en/proposals/153-ecies-garlic/).
- طرق التشفير والارسال والاستقبال لرسائل I2NP DLM / DSM / DSRM.
  لن يتم التغيير.
- ليست مدعومة آلية الاتصال من LS1 إلى LS2 أو من ElGamal/AES إلى هذا الاقتراح.
  هذا الاقتراح هو بروتوكول ثنائي الاتجاه.
  يمكن للوجهات التعامل مع التوافق العكسي عن طريق نشر مجموعات إيجار اثنين باستخدام الأنفاق نفسها، أو وضع كلا النوعين من التشفير في LS2.
- تغييرات نموذج التهديد
- التفاصيل التنفيذية ليست مشروحة هنا وتترك لكل مشروع.
- (بتفاؤل) إضافة امتدادات أو خطافات لدعم الإرسال الجماعي


### التبرير

كان ElGamal/AES+SessionTag بروتوكول النهاية إلى النهاية الوحيد لدينا لحوالي 15 عامًا، بدون تعديلات جوهرية على البروتوكول.
هناك الآن بدائل تشفير أسرع.
نحتاج إلى تحسين أمان البروتوكول.
لقد طورنا أيضًا استراتيجيات استكشاف الأخطاء والحلول التغلب على المشكلات لتقليل
ذاكرة وبروتوكول الاستخدام العريض للنطاق الترددي، ولكن هذه الاستراتيجيات
هشة، وصعبة الضبط، وتجعل البروتوكول حتى أكثر عرضة للكسر، مما يؤدي إلى انخفاض الجلسة.

على مدار نفس الفترة تقريبًا، تشرح مواصفات ElGamal/AES+SessionTag والوثائق ذات الصلة
مدى تكلفة عرض النطاق الترددي لتسليم علامات الجلسة،
واقترحت استبدال تسليم العلامة باستخدام "PRNG متزامن".
يولد PRNG متزامنًا العلامات نفسها في كلا الطرفين،
مستمدًا من بذرة مشتركة.
يمكن أيضًا تسمية PRNG متزامن بـ "ratchet".
هذا الاقتراح (أخيرًا) يحدد آلية الربط، ويقضي على تسليم العلامة.

باستخدام مضرب (PRNG متزامن) لتوليد
علامات الجلسة، نقضي على الحمل الزائد لإرسال علامات الجلسة
في رسالة الجلسة الجديدة والرسائل التالية عند الحاجة.
لمجموعة علامات تقليدية من 32 علامة، هذا هو 1 كيلو بايت.
وهذا أيضًا يقضي على تخزين علامات الجلسة في الجانب المرسل،
وبالتالي القص في متطلبات التخزين إلى النصف.

تحتاج مصافحة كاملة من اتجاهين، مماثلة لنمط Noise IK، لتجنب هجمات Key Compromise Impersonation (KCI).
راجع جدول "خصائص الحمولة الأمنية" الخاص بـ Noise في [NOISE](https://noiseprotocol.org/noise.html).
لمزيد من المعلومات حول KCI، راجع الورقة https://www.usenix.org/system/files/conference/woot15/woot15-paper-hlauschek.pdf


### نموذج التهديد

يختلف نموذج التهديد إلى حد ما عن NTCP2 (اقتراح 111).
تُفترض أن تكون نقاط الوسط و OBEP و IBGW لديها نظرة كاملة على
النتائج الحالية أو التاريخية للـ NetDB العالمي، من خلال التعاون مع الغمرات.

الهدف هو منع هذه النقاط الوسطى من تصنيف حركة المرور على أنها
رسائل جلسة جديدة و جلسات حالية، أو كـتشفير جديد مقابل تشفير قديم.


## اقتراح تفصيلي

هذا الاقتراح يحدد بروتوكول نهاية إلى نهاية جديد لاستبدال ElGamal/AES+SessionTags.
سيستخدم التصميم تجربة Noise ومراحل البيانات المدمجة مع مضاعفة Signal المزدوجة.


### ملخص تصميم التشفير

هناك خمسة أجزاء من البروتوكول بحاجة إلى إعادة التصميم:


- 1) يتم استبدال تنسيقات حاوية الجلسة الجديدة والجلسات الحالية بتنسيقات جديدة.
- 2) يتم استبدال ElGamal (مفاتيح عامة بحجم 256 بايت، مفاتيح خاصة بحجم 128 بايت)
  بـ ECIES-X25519 (مفاتيح عامة وخاصة بحجم 32 بايت)
- 3) يتم استبدال AES بـ
  AEAD_ChaCha20_Poly1305 (اختصارًا إلى ChaChaPoly أدناه)
- 4) يتم استبدال SessionTags بـ ratchets،
  وهو في الأساس PRNG مشفر، ومتزامن.
- 5) يتم استبدال حمولة AES، كما هو محدد في مواصفات ElGamal/AES+SessionTags،
  بتنسيق كتلة مشابه للذي في NTCP2.

كل من التغييرات الخمسة لديه قسمه الخاص أدناه.


### بدائل تشفير جديدة لـ I2P

تتطلب تطبيقات الموجه I2P الحالية تنفيذات لـ
البدائل التشفيرية القياسية التالية،
التي ليست مطلوبة للبروتوكولات الحالية لـ I2P:

- ECIES (ولكن هذا في الأساس X25519)
- Elligator2

تطبيقات الموجه I2P الحالية التي لم تنفذ بعد [NTCP2](/en/docs/transport/ntcp2/) ([Prop111](/en/proposals/111-ntcp2/))
تتطلب أيضًا تنفيذات لـ:

- توليد مفتاح X25519 و DH
- AEAD_ChaCha20_Poly1305 (اختصارًا إلى ChaChaPoly أدناه)
- HKDF


### نوع التشفير

نوع التشفير (المستخدم في LS2) هو 4.
هذا يشير إلى مفتاح X25519 32 بايت قليلا انديان،
والبروتوكول النهائي إلى النهائي المحدد هنا.

نوع التشفير 0 هو ElGamal.
أنواع التشفير 1-3 مخصصة لـ ECIES-ECDH-AES-SessionTag، راجع الاقتراح 145 [Prop145](/en/proposals/145-ecies/).


### إطار عمل بروتوكول Noise

يوفر هذا الاقتراح المتطلبات بناءً على إطار عمل بروتوكول Noise
[NOISE](https://noiseprotocol.org/noise.html) (الإصدار 34، 2018-07-11).
Noise لديه خصائص مشابهة لبروتوكول Station-To-Station
[STS] والذي يعد أساسًا لبروتوكول [SSU](/en/docs/transport/ssu/).
في عرف Noise، أليس هي المبادر، وبوب هو المستجيب.

هذا الاقتراح يعتمد على بروتوكول Noise Noise_IK_25519_ChaChaPoly_SHA256.
(الهوية الفعلية لوظيفة اشتقاق المفتاح الأولية
هي "Noise_IKelg2_25519_ChaChaPoly_SHA256"
للإشارة إلى امتدادات I2P - راجع قسم KDF 1 أدناه)
يستخدم بروتوكول Noise البدائل التالية:

- نمط المصافحة التفاعلية: IK
  أليس تنقل على الفور مفتاحها الثابت إلى بوب (I)
  أليس تعرف مفتاح بوب الثابت مسبقًا (K)

- نمط المصافحة ذو الاتجاه الواحد: N
  لا تنقل أليس مفتاحها الثابت إلى بوب (N)

- وظيفة DH: X25519
  X25519 DH بطول مفتاح 32 بايت كما هو محدد في [RFC-7748](https://tools.ietf.org/html/rfc7748).

- وظيفة التشفير: ChaChaPoly
  AEAD_CHACHA20_POLY1305 كما هو محدد في [RFC-7539](https://tools.ietf.org/html/rfc7539) القسم 2.8.
  عداد 12 بايت، مع ضبط البايتات الأولى الأربعة إلى صفر.
  مماثل لما في [NTCP2](/en/docs/transport/ntcp2/).

- وظيفة التجزئة: SHA256
  تجزئة قياسية 32 بايت، مستخدمة بشكل مكثف بالفعل في I2P.


الإضافات إلى الإطار
````````````````````

يحدد هذا الاقتراح التحسينات التالية لـ
Noise_IK_25519_ChaChaPoly_SHA256. تتبع هذه عمومًا الإرشادات في
[NOISE](https://noiseprotocol.org/noise.html) القسم 13.

1) يتم ترميز المفاتيح المؤقتة بنصوص واضحة مع [Elligator2](https://elligator.org/).

2) يتم إرفاق الرد بتسمية نص واضحة.

3) يتم تعريف تنسيق الحمولة للرسائل 1 و 2 ومرحلة البيانات.
   بالطبع، لم يتم تعريف هذا في Noise.

تتضمن جميع الرسائل عنوان رسالة I2NP Garlic.
تستخدم مرحلة البيانات تشفيرًا مشابهًا، لكن غير متوافق مع مرحلة البيانات Noise.


### أنماط المصافحة

تستخدم المصافحات أنماط المصافحة [Noise](https://noiseprotocol.org/noise.html).

التعيين الحروفي التالي يستخدم:

- e = مفتاح مؤقت واحد الاستخدام
- s = مفتاح ثابت
- p = حمولة رسالة

جلسات المؤقتة والجلسات غير المرتبطة مشابهة لنمط Noise N.

```dataspec

<- s
  ...
  e es p ->


```

الجلسات المرتبطة تشبه نمط Noise IK.

```dataspec

<- s
  ...
  e es s ss p ->
  <- علامة e ee se
  <- p
  p ->


```


### الجلسات

البروتوكول الحالي ElGamal/AES+SessionTag أحادي الاتجاه.
في هذه الطبقة، لا يعرف المستلم من أين تأتي الرسالة.
الجلسات الصادرة والواردة ليست مرتبطة.
التأكيدات خارج النطاق باستخدام رسالة التسليم
(المحاطة برسالة ثوم) داخل القرنفل.

هناك عدم فعالية كبيرة في بروتوكول أحادي الاتجاه.
أي رد يجب أيضًا استخدام رسالة الجلسة الجديدة مكلفة.
هذا يسبب زيادة في عرض النطاق الترددي واستخدام وحدة المعالجة المركزية والذاكرة.

هناك أيضًا نقاط ضعف أمنية في بروتوكول أحادي الاتجاه.
جميع الجلسات تعتمد على DH الثابت المؤقت.
بدون مسار عكسي، لا توجد طريقة لبوب لـ "ratchet" مفتاحه الثابت إلى مفتاح مؤقت.
بدون معرفة من أين تأتي الرسالة، لا توجد وسيلة لاستخدام
المفتاح المؤقت المستلم للرسائل الصادرة،
لذلك يستخدم الرد الأولي أيضًا DH مؤقت-ثابت.

لهذا الاقتراح، نحدد آليتين لإنشاء بروتوكول ثنائي الاتجاه -
"الاقتران" و "الربط".
تقدم هذه الآليات زيادة الكفاءة والأمان.


سياق الجلسة
```````````````

كما هو الحال مع ElGamal/AES+SessionTags، يجب أن تكون جميع الجلسات الواردة والصادرة
في سياق معين، إما في سياق الموجه أو
السياق لوجهة محلية معينة.
في Java I2P، هذا السياق يسمی مدير مفتاح الجلسة.

يجب عدم مشاركة الجلسات بين السياقات، حيث أنه من الممكن أن
يسمح ذلك بالتوافق بين الوجهات المحلية المختلفة،
أو بين وجهة محلية وموجه.

عندما تدعم وجهة معينة كلاً من ElGamal/AES+SessionTags
وهذا الاقتراح، يمكن أن تشترك كلا نوعي الجلسات في سياق.
انظر القسم 1c) أدناه.



اقتران جلسات الواردة والصادرة
``````````````````````````````````

عندما يتم إنشاء جلسة صادرة عند المنبع (أليس)،
يتم إنشاء جلسة واردة جديدة ويتم اقترانها بالجسلة الصادرة،
ما لم يكن لا حاجة للرد (مثل تدفقات البيانات الخام).

دائمًا ما يتم اقتران جلسة واردة جديدة بجلسة صادرة جديدة،
ما لم يُطلب لا رد (مثل تدفقات البيانات الخام).

إذا تم طلب رد ويتم ربطه بوجهة بعيدة أو موجه،
سيتم ربط الجلسة الصادرة الجديدة بتلك الوجهة أو الموجه،
وتستبدل أي جلسة صادرة سابقة إلى تلك الوجهة أو الموجه.

يوفر اقتران الجلسات الواردة والصادرة بروتوكول ثنائي الاتجاه
مع إمكانية تبديل DH.



ربط الجلسات والوجهات
``````````````````````````````````````

هناك جلسة صادرة واحدة فقط إلى وجهة معينة أو موجه.
قد يكون هناك عدة جلسات واردة حالية من وجهة معينة أو موجه.
بشكل عام، عندما يتم إنشاء جلسة واردة جديدة، ويتم استلام حركة مرور
على تلك الجلسة (والتي تعمل كإقرار)، سيتم توجيه أي جلسات أخرى
للانتهاء قريبًا، خلال دقيقة أو نحو ذلك.
يتم التحقق من قيمة الرسائل المرسلة السابقة (PN)، وإذا لم تكن هناك
رسائل غير مستلمة (داخل حجم النافذة) في الجلسة الواردة السابقة،
قد يتم حذف الجلسة السابقة مباشرةً.

عندما يتم إنشاء جلسة صادرة عند المنبع (أليس)،
فهي مربوطة بوجهة بعيدة (بوب)،
وأي جلسة واردة مقترنة ستكون أيضًا مرتبطة بالوجهة البعيدة.
بينما تتحرك الجلسات، تستمر في الارتباط بالوجهة البعيدة.

عندما يتم إنشاء جلسة واردة عند المتلقي (بوب)،
قد تكون مربوطة بوجهة بعيدة (أليس)، بناءً على اختيار أليس.
إذا تضمنت أليس معلومات الربط (مفتاحها الثابت) في رسالة الجلسة الجديدة،
سيتم ربط الجلسة بتلك الوجهة،
وسيتم إنشاء جلسة صادرة وربطها بنفس الوجهة.
بينما تتحرك الجلسات، تستمر في الارتباط بالوجهة البعيدة.


فوائد الربط والاقتران
``````````````````````````

في الحالة الشائعة، حالة التدفق، نتوقع من أليس وبوب استخدام البروتوكول على النحو التالي:

- تقرن أليس جلستها الصادرة الجديدة بجلسة واردة جديدة، وكلاهما مربوط بالوجهة البعيدة (بوب).
- تضمن أليس معلومات الربط والتوقيع، وطلب للرد، في رسالة الجلسة الجديدة المرسلة إلى بوب.
- يقرن بوب جلسته الواردة الجديدة بجلسة صادرة جديدة، وكلاهما مربوط بالوجهة البعيدة (أليس).
- يرسل بوب ردًا (تأكيدًا) إلى أليس في الجلسة المقترنة، مع تبديل مفتاح DH جديد.
- تقوم أليس بتبديل جلستها الصادرة إلى جلسة جديدة مع مفتاح بوب الجديد، مقترنة بالجلسة الواردة الحالية.

عن طريق ربط الجلسة الواردة بوجهة بعيدة، وقرن الجلسة الواردة
بجلسة صادرة مقترنة بالوجهة البعيدة، نحقق فائدتين رئيسيتين:

1) يستخدم الرد الأولي من بوب إلى أليس DH مؤقت-مؤقت

2) بعد أن تستقبل أليس رد بوب وتبديل، يتم استخدام DH مؤقت-مؤقت لجميع الرسائل اللاحقة من أليس إلى بوب.


إقرارات الرسائل
````````````````

في ElGamal/AES+SessionTags، عندما يتم ضم مجموعة إيجارات كقرنفل ثوم،
أو يتم تسليم العلامات، يطلب الموجه المرسل إقرارًا.
هذا هو قرنفل ثوم منفصل يحتوي على رسالة حالة التسليم.
لتوفير أمان إضافي، يتم لف رسالة حالة التسليم في رسالة ثوم.
هذه الآلية تكون خارج النطاق من منظور البروتوكول.

في البروتوكول الجديد، نظرًا لأن الجلسات الواردة والصادرة مقترنة،
يمكن أن تكون الإقرارات داخل النطاق. لا حاجة إلى قرنفل منفصل.

إقرار صريح هو ببساطة رسالة جلسة حالية بدون كتلة I2NP.
ومع ذلك، في معظم الحالات، يمكن تجنب إقرار صريح، حيث توجد حركة مرور عكسية.
قد يكون من المستحب أن تنتظر التنفيذات وقتًا قصيرًا (ربما مئة ميلي ثانية)
قبل إرسال إقرار صريح، لإعطاء طبقة التدفق أو التطبيق الوقت للاستجابة.

سيحتاج التنفيذات أيضا إلى تأجيل أي إرسال لإقرار حتى بعد
معالجة كتلة I2NP، نظرًا لأن رسالة الثوم قد تحتوي على رسالة تخزين قاعدة البيانات
مع مجموعة إيجارات. ستكون مجموعة إيجارات حديثة ضرورية لتوجيه الإقرار،
وستكون الوجهة البعيدة (الموجودة في مجموعة الإيجارات) ضرورية للتحقق من مفتاح الربط الثابت.


انتهاء الجلسة
``````````````

يجب أن تنتهي الجلسات الصادرة دائمًا قبل الجلسات الواردة.
بمجرد انتهاء جلسة صادرة، ويتم إنشاء واحدة جديدة، سيتم إنشاء جلسة واردة مقترنة جديدة أيضًا. إذا كانت هناك جلسة واردة قديمة،
سيسمح لها بالانتهاء.


### الإرسال الجماعي

لم يحدد بعد.


### التعريفات
نحدد الدوال التالية المطابقة للدعائم التشفير المستخدمة.

ZEROLEN
    مصفوفة بايت ذات طول صفري

CSRNG(n)
    إخراج بطول n من مولد أرقام عشوائية آمن تشفيرياً.

H(p, d)
    دالة التجزئة SHA-256 التي تأخذ سلسلة تهيئة p وبيانات d، وتنتج مخرجات بطول 32 بايت.
    كما هو محدد في [NOISE](https://noiseprotocol.org/noise.html).
    || أدناه تعني الضم.

    استخدام SHA-256 كما يلي::

        H(p, d) := SHA-256(p || d)

MixHash(d)
    دالة التجزئة SHA-256 التي تأخذ تجزئة سابقة h وبيانات جديدة d،
    وتنتج مخرجات بطول 32 بايت.
    || أدناه تعني الضم.

    استخدام SHA-256 كما يلي::

        MixHash(d) := h = SHA-256(h || d)

STREAM
    ChaCha20/Poly1305 AEAD كما هو محدد في [RFC-7539](https://tools.ietf.org/html/rfc7539).
    S_KEY_LEN = 32 و S_IV_LEN = 12.

    ENCRYPT(k, n, plaintext, ad)
        تشفر النص العادي باستخدام مفتاح التشفير k، والعداد n الذي يجب أن يكون فريدًا للمفتاح k.
        تكون البيانات المرتبطة اختياريًا.
        تعيد شفرة مشفرة تكون بحجم النص العادي + 16 بايت للمفتاح المشفر.

        يجب أن تكون الشفرة المشفرة بالكامل غير قابلة للتمييز عن العشوائي إذا كان المفتاح سريًا.

    DECRYPT(k, n, ciphertext, ad)
        تفك الشفرة المشفرة باستخدام مفتاح التشفير k، والعداد n.
        تكون البيانات المرتبطة اختياريًا.
        تعيد النص العادي.

DH
    نظام اتفاقية مفتاح عام X25519. مفاتيح خاصة بطول 32 بايت، مفاتيح عامة بطول 32
    بايت، تنتج مخرجات بطول 32 بايت. لديها الوظائف التالية:

    GENERATE_PRIVATE()
        ينشئ مفتاحًا خاصًا جديدًا.

    DERIVE_PUBLIC(privkey)
        يعيد المفتاح العام المقابل للمفتاح الخاص المعطى.

    GENERATE_PRIVATE_ELG2()
        ينشئ مفتاحًا خاصًا جديدًا يرسم إلى مفتاح عام مناسب لترميز Elligator2.
        يجب تجاهل نصف المفاتيح الخاصة المولدة عشوائيًا نظرًا لأنها لن تكون مناسبة.

    ENCODE_ELG2(pubkey)
        يعيد المفتاح العام المرمز باستخدام Elligator2 المقابل للمفتاح العام المعطى (رسمان عكسيان).
        المفاتيح المرمزة هي انديان قليلا.
        المفتاح المرمز يجب أن يكون بمقاس 256 بت لا يمكن تمييزه عن البيانات العشوائية.
        انظر قسم Elligator2 أدناه للمواصفات.

    DECODE_ELG2(pubkey)
        يعيد المفتاح العام المقابل للمفتاح العام المرمز باستخدام Elligator2.
        انظر قسم Elligator2 أدناه للمواصفات.

    DH(privkey, pubkey)
        ينشئ سرًا مشتركًا من المفاتيح الخاصة والعامة المقدمة.

HKDF(salt, ikm, info, n)
    دالة اشتقاق مفتاح تشفيري تأخذ بعض مواد الإدخال المفتاحي ikm (يجب أن تكون لديها انتروبيا جيدة ولكن لا يلزم أن تكون سلسلة عشوائية موحدة)،
    ملح بطول 32 بايت، وقيمة "معلومات" محددة السياق، وتنتج مخرجات
    بطول n بايت مناسبة للاستخدام كمادة مفتاحية.

    استخدام HKDF كما هو محدد في [RFC-5869](https://tools.ietf.org/html/rfc5869)، باستخدام دالة التجزئة HMAC SHA-256
    كما هو محدد في [RFC-2104](https://tools.ietf.org/html/rfc2104). هذا يعني أن طول SALT_LEN هو 32 بايت كحد أقصى.

MixKey(d)
    استخدام HKDF() مع سلسلة chainKey السابقة وبيانات جديدة d، و
    ضبط السلسلة الجديدة chainKey وk.
    كما هو محدد في [NOISE](https://noiseprotocol.org/noise.html).

    استخدام HKDF كما يلي::

        MixKey(d) := output = HKDF(chainKey, d, "", 64)
                     chainKey = output[0:31]
                     k = output[32:63]


### 1) تنسيق الرسالة


مراجعة تنسيق الرسالة الحالي
````````````````````````````

الرسالة الثوم كما هو محدد في [I2NP](/en/docs/spec/i2np/) هي كالتالي.
كهدف من التصميم هو أن الأعوان الوسيطة لا يمكنها التمييز بين التشفير الجديد والقديم،
هذا التنسيق لا يمكن تغييره، حتى وإن كان مجال الطول زائدًا.
يتم عرض التنسيق بالرأس الكامل 16 بايت، على الرغم من أن
الرأس الفعلي قد يكون بتنسيق مختلف، اعتمادًا على النقل المستخدم.

عند فك التشفير، تحتوي البيانات على سلسلة من قرون الثوم والبيانات الإضافية، والمعروفة أيضًا بمجموعة القرنفل.

انظر [I2NP](/en/docs/spec/i2np/) للتفاصيل والمواصفات الكاملة.


```dataspec

+----+----+----+----+----+----+----+----+
  |type|      msg_id       |  expiration
  +----+----+----+----+----+----+----+----+
                           |  size   |chks|
  +----+----+----+----+----+----+----+----+
  |      length       |                   |
  +----+----+----+----+                   +
  |          encrypted data               |
  ~                                       ~
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+


```


مراجعة تنسيق البيانات المشفرة
``````````````````````````````````

التنسيق الحالي للرسالة U in use لأكثر من 15 عامًا،
هو ElGamal/AES+SessionTags.
يوجد في ElGamal/AES+SessionTags تنسيقين للرسائل:

1) جلسة جديدة:
- كتلة ElGamal 514 بايت
- كتلة AES (128 بايت كحد أدنى، مضاعف 16)

2) جلسة حالية:
- علامة جلسة 32 بايت
- كتلة AES (128 بايت كحد أدنى، مضاعف 16)

التوصيل الأدنى إلى 128 كما هو مفعل في Java I2P ولكنه ليس مفروضًا عند الاسقبال.

تُغلف هذه الرسائل في رسالة ثوم I2NP، التي تحتوي على
مجال طول، لذا يصبح الطول معروفًا.

لاحظ أنه لا يوجد توسع معرف إلى غير مضاعف-16 طول،
لذا فإن الجلسة الجديدة دائمًا (mod 16 == 2)،
وجلسة حالية دائمًا (mod 16 == 0).
نحتاج إلى إصلاح ذلك.

يحاول المستقبل أولاً البحث عن أول 32 بايت كعلامة جلسة.
إذا تم العثور عليه، يقوم بفك تشفير كتلة AES.
إذا لم يتم العثور عليها، وكانت البيانات على الأقل (514+16) طويلة، فإنه يحاول فك تشفير كتلة ElGamal،
وإذا نجح، يفك تشفير كتلة AES.


علامات الجلسة الجديدة والمقارنة بـ Signal
```````````````````````````````````````````

في Signal Double Ratchet، يحتوي الرأس على:

- DH: مفتاح العجلة الحالي
- PN: طول رسالة السلسلة السابقة
- N: رقم الرسالة

"سلاسل الإرسال" لـ Signal تشبه تقريبًا مجموعات العلامات لدينا.
باستخدام علامة الجلسة، يمكننا التخلص من معظم ذلك.

في الجلسة الجديدة، نضع فقط المفتاح العام في الرأس غير المشفر.

في الجلسة الحالية، نستخدم علامة جلسة للرأس.
ترتبط علامة الجلسة بمفتاح العجلة الحالي للرسالة.

في كل من الجلسة الجديدة والجلسة الحالية، PN و N في الجسم المشفر.

في Signal، الأمور تتغير باستمرار. يتطلب مفتاح DH جديد من
المستلم قوله، باعتباره خوارزمًا للإقرار بالمفتاح المستلم من DH.
ستكون هذه العمليات DH الزائدة كثيرة جدًا بالنسبة لنا.
لذلك نحن نفصل الإقرار عن المفتاح المستلم وإرسال مفتاح جديد.
أي رسالة تستخدم علامة جلسة مُولدة من DH الجديد للمفتاح ي constituição.

في تسليم مفتاح الجلسة، نشتق "مجموعة العلامات" منه،
بدلاً من الحاجة إلى تسليم علامات الجلسة أيضًا.
يمكن أن تكون مجموعة العلامات حتى 65536 علامة.
ومع ذلك، يجب على المستقبلين تنفيذ استراتيجية "النظر إلى الأمام"، بدلاً من
توليد جميع العلامات الممكنة دفعة واحدة.
فقط قم بتوليد ما يصل إلى N علامة بعد آخر علامة جيدة مستقبلة.
قد يكون N كحد أقصى 128، ولكن 32 أو أقل قد يكون اختيارًا أفضل.


### 1a) تنسيق الجلسة الجديدة

المفتاح العام الجديد مرة واحدة (32 بايت)
البيانات المشفرة و MAC (بقية البايتات)

قد تحتوي رسالة الجلسة الجديدة أو لا تحتوي على المفتاح العام الثابت للمرسِل.
إذا تم تضمينه، تكون الجلسة العكسية متصلة بالمفتاح.
يجب تضمين المفتاح الثابت إذا كانت الردود متوقعة،
أي للبث والتدفقات الداتاجرام.

تشبه رسالة الجلسة الجديدة نمط Noise [NOISE](https://noiseprotocol.org/noise.html) ذو الاتجاه الواحد
"N" (إذا لم يتم إرسال المفتاح الثابت)،
أو نمط ذو الاتجاهين "IK" (إذا تم إرسال المفتاح الثابت).


### 1b) تنسيق الجلسة الجديدة (مع الربط)

الطول هو 96 + طول الحمولة.
التنسيق المشفر:

```dataspec

+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   مفتاح الجلسة الجديد للمرة الواحدة  |
  +             32 بايت                    +
  |    مشفر باستخدام Elligator2         |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +         مفتاح ثابت                    +
  |       بيانات ChaCha20 المشفرة         |
  +            32 بايت                    +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  رسالة مصادقة Poly1305              |
  +    (MAC) لإطار المفتاح الثابت       +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            إطار الحمولة              +
  |       بيانات ChaCha20 المشفرة         |
  ~                                       ~
  |                                       |
  +                                       +
//-------------------------  
  |  رسالة مصادقة Poly1305              |
  +    (MAC) لإطار الحمولة               +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+

  المفتاح العلني :: 32 بايت، انديان قليلا، Elligator2، نص واضح

  بيانات مفتاح ثابت مشفر :: 32 بايت

  بيانات إطار الحمولة مشفرة :: البيانات المتبقية ناقص 16 بايت

  MAC :: رسالة مصادقة Poly1305، 16 بايت


```


مفتاح الجلسة الجديد
````````````````````

المفتاح المؤقت هو 32 بايت، مشفر باستخدام Elligator2.
لم يتم إعادة استخدام هذا المفتاح؛ يتم توليد مفتاح جديد مع
كل رسالة، بما في ذلك عمليات إعادة الإرسال.

مفتاح ثابت
``````````

عند فك التشفير، مفتاح أليس الثابت X25519، 32 بايت.


حمولة
```````

طول البيانات المشفرة هو بقية البيانات.
طول البيانات المفككة هو 16 أقل من طول البيانات المشفرة.
يجب أن تحتوي الحمولة على كتلة DateTime وعادة ما تحتوي على كتلة أو أكثر من Garlic Clove.
انظر قسم الحمولة أدناه من أجل التنسيق والمتطلبات الإضافية.


### 1c) تنسيق الجلسة الجديدة (بدون الربط)

إذا لم يكن هناك حاجة للرد، لم يتم إرسال مفتاح ثابت.


الطول هو 96 + طول الحمولة.
التنسيق المشفر:

```dataspec

+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   مفتاح الجلسة الجديد للمرة الواحدة  |
  +             32 بايت                    +
  |    مشفر باستخدام Elligator2         |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           إطار الأعلام               +
  |       بيانات ChaCha20 المشفرة         |
  +            32 بايت                    +
  |                                       |
  +                                       +
//-------------------------  
  |                                       |
  +---+---+---+                          +
  |                                       |
  +               رمز MAC القسم العلوي       +
  |             16 بايت                  |
  +---+---+---+---+---+---+---+---+
  |                                       |
  +            إطار الحمولة              +
  |       بيانات ChaCha20 المشفرة         |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       +
  +----+----+----+----+----+----+----+----+
  |  رسالة مصادقة Poly1305              |
  +    (MAC) لإطار الحمولة               +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+

  المفتاح العلني :: 32 بايت، انديان قليلا، Elligator2، نص واضح

  بيانات إطار الأعلام مشفرة :: 32 بايت

  بيانات إطار الحمولة مشفرة :: البيانات المتبقية ناقص 16 بايت

  MAC :: رسالة مصادقة Poly1305، 16 بايت


```

مفتاح الجلسة الجديد
````````````````````

مفتاح أليس المؤقت.
المفتاح المؤقت هو 32 بايت، مشفر باستخدام Elligator2، انديان قليلا.
لم يتم إعادة استخدام هذا المفتاح؛ يتم توليد مفتاح جديد مع
كل رسالة، بما في ذلك عمليات إرسال.

بيانات إطار الأعلام مشفرة
``````````````````````````

يحتوي إطار الأعلام على لا شيء.
دائمًا 32 بايت، لأن يجب أن يكون بنفس طول المفتاح الثابت لرسائل الجلسة الجديدة مع الربط.
يحدد بوب ما إذا كان مفتاحًا ثابتًا أو إطارًا تابعًا لاختبار ما إذا كانت البايتات 32 كلها أصفار.

TODO هل هناك حاجة لأي أعلام هنا؟

حمولة
```````

طول البيانات المشفرة هو بقية البيانات.
طول البيانات المفككة هو 16 أقل من طول البيانات المشفرة.
يجب أن تحتوي الحمولة على كتلة DateTime وعادة ما تحتوي على كتلة أو أكثر من Garlic Clove.
انظر قسم الحمولة أدناه من أجل التنسيق والمتطلبات الإضافية.



### 1d) تنسيق مرة واحدة (بدون الربط أو الجلسة)

إذا كان من المتوقع إرسال رسالة واحدة فقط،
لا يلزم إنشاء جلسة أو مفتاح ثابت.

الطول هو 96 + طول الحمولة.
التنسيق المشفر:

```dataspec

+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
//-------------------------  
  +               مفتاح العام للمرة الواحدة       +
  |             32 بايت                    +
  |    مشفر باستخدام Elligator2         |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
//-------------------------  
  +           إطار الأعلام               +
  |       بيانات ChaCha20 المشفرة         +
  +            32 بايت                    +
  |                                       |
  +                                       +
  +----+----+----+----+----+----+----+----+
  |  رسالة مصادقة Poly1305              |
  +    (MAC) لإطار العلوي               +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            إطار الحمولة              +
  |       بيانات ChaCha20 المشفرة         |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
//-------------------------  
  +----+----+----+----+----+----+----+----+
  |  رسالة مصادقة Poly1305              +
  +    (MAC) لإطار الحمولة               +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+

  المفتاح العلني :: 32 بايت، انديان قليلا، Elligator2، نص واضح

  بيانات إطار الأعلام مشفرة :: 32 بايت

  بيانات إطار الحمولة مشفرة :: البيانات المتبقية ناقص 16 بايت

  MAC :: رسالة مصادقة Poly1305، 16 بايت


```


مفتاح الجلسة الجديد
````````````````````

المفتاح لمرة واحدة هو 32 بايت، مشفر باستخدام Elligator2، انديان قليلا.
لم يتم إعادة استخدام هذا المفتاح؛ يتم توليد مفتاح جديد مع
كل رسالة، بما في ذلك عمليات إعادة الإرسال.


بيانات إطار الأعلام مشفرة
````````````````````````````````

يحتوي إطار الأعلام على لا شيء.
دائمًا 32 بايت، لأن يجب أن يكون بنفس طول المفتاح الثابت لرسائل الجلسة الجديدة مع الربط.
يحدد بوب ما إذا كان مفتاحًا ثابتًا أو إطارًا تابعًا لاختبار ما إذا كانت البايتات 32 كلها أصفار.

TODO هل هناك حاجة لأي أعلام هنا؟

```dataspec

+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +     
  |                                       +
  +             كل الأصفار                   +
  |              32 بايت                    +
  +                                       +
  |                                       +
  +----+----+----+----+----+----+----+----+

  الأصفار:: جميع الأصفار، 32 بايت.


```


حمولة
```````

طول البيانات المشفرة هو بقية البيانات.
طول البيانات المفككة هو 16 أقل من طول البيانات المشفرة.
يجب أن تحتوي الحمولة على كتلة DateTime وعادة ما تحتوي على كتلة أو أكثر من Garlic Clove.
انظر قسم الحمولة أدناه من أجل التنسيق والمتطلبات الإضافية.



### 1f) عمليات اشتقاق المفاتيح للجلسة الجديدة

اشتقاق المفتاح لسلسلة المفاتيح الأولية
````````````````````````````````

هذا هو المعيار لـ [NOISE](https://noiseprotocol.org/noise.html) لـ IK معاسم بروتوكول معدلة.
لاحظ أننا نستخدم نفس التهيئة لكل من نمط IK (جلسات مرتبطة)
ونمط N (جلسات غير مرتبطة).

تم تعديل اسم البروتوكول لسببين.
أولاً، للإشارة إلى أن المفاتيح العابرة مشفرة باستخدام Elligator2،
وثانيًا، للإشارة إلى أن MixHash() يتم استدعاؤها قبل الرسالة الثانية
لخلط قيمة العلامة.

```text

هذه هي نمط رسالة "e":

  // قم بتعيين protocol_name
  set protocol_name = "Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256"
   (40 بايت، مشفر US-ASCII، بدون إنهاء NULL).

  // قم بتعيين Hash h = 32 بايت
  h = SHA256(protoco_name);

  قم بتعريف ck = 32 بايت سلسلة ربط. انسخ بيانات h إلى ck.
  set chainKey = h

  // MixHash(null prologue)
  h = SHA256(h);

  // حتى هنا، يمكن حسابها مسبقًا بواسطة أليس لجميع الاتصالات الصادرة


```
