```markdown
---
title: "بروتوكولات التشفير بعد الكم"
number: "169"
author: "zzz, orignal, drzed, eyedeekay"
created: "2025-01-21"
lastupdated: "2025-06-12"
status: "Open"
thread: "http://zzz.i2p/topics/3294"
target: "0.9.80"
---

## نظرة عامة

بينما يستمر البحث والتنافس على التشفير المناسب بعد الكم (PQ) لعقد من الزمان، لم تتضح الاختيارات حتى الآونة الأخيرة.

بدأنا بدراسة آثار تشفير PQ في عام 2022 [FORUM](http://zzz.i2p/topics/3294).

أضافت معايير TLS دعم التشفير الهجين في العامين الماضيين ويستخدم الآن لجزء كبير من حركة المرور المشفرة على الإنترنت بسبب الدعم في كروم وفايرفوكس [CLOUDFLARE](https://blog.cloudflare.com/pq-2024/).

مؤخراً، أكملت وتجذرت NIST ونشرت الخوارزميات الموصى بها للتشفير بعد الكم [NIST-PQ](https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards). تدعم الآن العديد من مكتبات التشفير الشائعة معايير NIST أو ستقوم بإصدار دعم في المستقبل القريب.

يوصى كل من [CLOUDFLARE](https://blog.cloudflare.com/pq-2024/) و [NIST-PQ](https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards) أن يبدأ الهجرة فوراً. انظر أيضاً إلى الأسئلة الشائعة لـ NSA PQ لعام 2022 [NSA-PQ](https://media.defense.gov/2022/Sep/07/2003071836/-1/-1/0/CSI_CNSA_2.0_FAQ_.PDF). يجب أن يكون I2P رائداً في الأمن والتشفير. حان الوقت الآن لتنفيذ الخوارزميات الموصى بها. باستخدام نظام النوع المرن للتشفير والتوقيع، سوف نضيف أنواعًا للتشفير الهجين، ولتوقيعات PQ والهجين.


## الأهداف

- اختيار الخوارزميات المقاومة لـ PQ
- إضافة الخوارزميات فقط لـ PQ والهجين إلى بروتوكولات I2P حيثما كان مناسباً
- تعريف عدة متغيرات
- اختيار أفضل المتغيرات بعد التنفيذ والاختبار والتحليل والبحث
- إضافة الدعم تدريجياً وبالتوافق مع التوافق العكسي


## الأهداف غير المرجوة

- عدم تغيير بروتوكولات التشفير في اتجاه واحد (Noise N)
- عدم الابتعاد عن SHA256، غير مهدد على المدى القريب من PQ
- عدم اختيار المتغيرات النهائية المفضلة في هذا الوقت


## نموذج التهديد

- الموجهات عند OBEP أو IBGW، ربما تتعاون، تخزين رسائل الثوم لفك التشفير لاحقاً (السرية الأمامية)
- مراقبو الشبكة
  تخزين رسائل النقل لفك التشفير لاحقاً (السرية الأمامية)
- المشاركون في الشبكة تزوير التوقيعات لـ RI، LS، البث، datagrams، أو هياكل أخرى


## البروتوكولات المتأثرة

سنعدل البروتوكولات التالية، بترتيب تقريباً في التطوير. ربما سيكون الإصدار العام من أواخر 2025 حتى منتصف 2027.
انظر قسم الأولويات وإصدار التنفيذ أدناه للحصول على التفاصيل.

| Protocol / Feature | Status |
| ------------------ | ------ |
| Hybrid MLKEM Ratchet and LS | Approv |
| Hybrid MLKEM NTCP2 | Some d |
| Hybrid MLKEM SSU2 | Some d |
| MLDSA SigTypes 12-14 | Propos |
| MLDSA Dests | Tested |
| Hybrid SigTypes 15-17 | Prelim |
| Hybrid Dests |  |




## التصميم

سندعم معايير NIST FIPS 203 و204 [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf) [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf)
التي تعتمد على، ولكنها غير متوافقة مع،
CRYSTALS-Kyber وCRYSTALS-Dilithium (الإصدارات 3.1، 3، والقديمة).



### تبادل المفاتيح

سندعم تبادل المفاتيح الهجين في البروتوكولات التالية:

| Proto | Noise Type | Support PQ only? | Support Hybrid? |
| ----- | ---------- | ---------------- | --------------- |
| NTCP2 | XK | no | yes |
| SSU2 | XK | no | yes |
| Ratchet | IK | no | yes |
| TBM | N | no | no |
| NetDB | N | no | no |


يوفر PQ KEM مفاتيح مؤقتة فقط، ولا يدعم مباشرة المصافحة بالمفاتيح الثابتة مثل Noise XK وIK.

Noise N لا يستخدم تبادل مفتاح ذو اتجاهين وبالتالي فهو غير مناسب للتشفير الهجين.

لذلك سندعم التشفير الهجين فقط لـ NTCP2 وSSU2 وRatchet.
سنحدد الثلاثة متغيرات ML-KEM كما في [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf),
للثلاثة أنواع تشفير جديدة بالمجمل.
ستُعرف الأنواع الهجينة فقط بالاشتراك مع X25519.

أنواع التشفير الجديدة هي:

| Type | Code |
| ---- | ---- |
| MLKEM512_X25519 | 5 |
| MLKEM768_X25519 | 6 |
| MLKEM1024_X25519 | 7 |


سيكون هناك عبء ثقيل. الأحجام النموذجية للرسالة 1 و2 (لـ XK وIK)
حالياً حوالي 100 بايت (قبل أي حمولة إضافية).
سيزداد هذا بنسبة من 8x إلى 15x حسب الخوارزمية.


### التوقيعات

سندعم توقيعات PQ والهجين في الهياكل التالية:

| Type | Support PQ only? | Support Hybrid? |
| ---- | ---------------- | --------------- |
| RouterInfo | yes | yes |
| LeaseSet | yes | yes |
| Streaming SYN/SYNACK/Close | yes | yes |
| Repliable Datagrams | yes | yes |
| Datagram2 (prop. 163) | yes | yes |
| I2CP create session msg | yes | yes |
| SU3 files | yes | yes |
| X.509 certificates | yes | yes |
| Java keystores | yes | yes |



لذلك سندعم توقيعات PQ-only وتوقيعات الهجين.
سنحدد الثلاثة متغيرات ML-DSA كما في [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf),
الثلاثة متغيرات الهجين مع Ed25519،
والثلاثة متغيرات PQ-only مع ما قبل التجزئة لملفات SU3 فقط،
للمجموع تسعة أنواع توقيع جديدة بالمجمل.
ستُعرف الأنواع الهجينة فقط بالاشتراك مع Ed25519.
سنستخدم الـ ML-DSA القياسي، NOT المتغيرات قبل التجزئة (HashML-DSA)،
إلا في ملفات SU3.

سنستخدم المتغير الموقع "المحصن" أو العشوائي،
وليس المتغير "التقريري"، كما هو محدد في [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf) القسم 3.4.
وهذا يضمن أن كل توقيع يختلف، حتى عندما يكون على نفس البيانات،
ويقدم حماية إضافية ضد الهجمات الجانبية.
انظر قسم ملاحظات التنفيذ أدناه للحصول على تفاصيل إضافية
حول اختيارات الخوارزمية بما في ذلك الترميز والسياق.


أنواع التوقيع الجديدة هي:

| Type | Code |
| ---- | ---- |
| MLDSA44 | 12 |
| MLDSA65 | 13 |
| MLDSA87 | 14 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 |
| MLDSA44ph | 18 |
| MLDSA65ph | 19 |
| MLDSA87ph | 20 |


ستستخدم شهادات X.509 وDER الأخرى
الهياكل المركبة وOIDs المحددة في [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/).

سيكون العبء ثقيلاً. مقاصد نمطية Ed25519 والهوية الراوتر
هي 391 بايت.
سيزيد هذا بنسبة من 3.5x إلى 6.8x حسب الخوارزمية.
توقيعات Ed25519 هي 64 بايت.
سيزداد هذا بنسبة من 38x إلى 76x حسب الخوارزمية.
الرسائل الموقعة النموذجية لـ RouterInfo وLeaseSet وdatagrams القابلة للرد، ورسائل البث الموقعة هي حوالي 1KB.
ستزداد هذه بنسبة من 3x إلى 8x حسب الخوارزمية.

نظراً لأن الأنواع الجديدة من المقاصد والهويات الراوتر لن تحتوي على حشو،
فهي لن تكون قابلة للضغط. الأحجام من المقاصد وهويات الراوتر
التي يتم ضغطها في-transit ستزداد بنسبة 12x - 38x حسب الخوارزمية.



### التركيبات القانونية

للمقاصد، الأنواع الجديدة للتوقيع مدعومة مع جميع أنواع التشفير
في مجموعة التأجير. ضبط نوع التشفير في شهادة المفتاح على NONE (255).

لهويات الراوتر، نوع التشفير ElGamal معطل.
الأنواع الجديدة للتوقيع مدعومة مع تشفير X25519 (النوع 4) فقط.
سيتم الإشارة إلى الأنواع الجديدة للتشفير في عناوين الراوتر.
سوف يستمر نوع التشفير في شهادة المفتاح ليكون النوع 4.



### التشفير الجديد المطلوب

- ML-KEM (المعروفة سابقاً باسم CRYSTALS-Kyber) [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf)
- ML-DSA (المعروفة سابقاً باسم CRYSTALS-Dilithium) [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf)
- SHA3-128 (المعروفة سابقاً Keccak-256) [FIPS202]_ مستخدم فقط للـ SHAKE128
- SHA3-256 (المعروفة سابقاً Keccak-512) [FIPS202]_
- SHAKE128 وSHAKE256 (امتدادات XOF لـ SHA3-128 وSHA3-256) [FIPS202]_

نواقل اختبار للـ SHA3-256 وSHAKE128 وSHAKE256 متوفرة في [NIST-VECTORS]_.

لاحظ أن مكتبة Java bouncycastle تدعم كل ما سبق.
الدعم لمكتبة C++ موجود في OpenSSL 3.5 [OPENSSL]_.


### البدائل

لن ندعم [FIPS205]_ (Sphincs+)، فهي أبطأ وأكبر بكثير من ML-DSA.
لن ندعم FIPS206 القادمة (Falcon)، لم يتم تقنيتها بعد.
لن ندعم NTRU أو المرشحين PQ الآخرين الذين لم تتم تقنيتهم بواسطة NIST.


Rosenpass
``````````

هناك بعض الأبحاث [PQ-WIREGUARD]_ حول تكييف Wireguard (IK)
للتشفير النقي بعد الكم، ولكن هناك العديد من الأسئلة المفتوحة في تلك الورقة.
لاحقاً، تم تنفيذ هذا النهج كـ Rosenpass [Rosenpass]_ [Rosenpass-Whitepaper]_
للـ PQ Wireguard.

تستخدم Rosenpass مصافحة شبيهة بـ Noise KK مع مفاتيح ثابتة Classic McEliece 460896 مكمشة
(500 كيلوبايت لكل منهما) ومفاتيح مؤقتة Kyber-512 (تقريباً MLKEM-512).
نظراً لأن كلاسيك McEliece cryptotexts هي فقط 188 بايت، ومفاتيح العامة والفواصل لـ Kyber-512 معقولة، فإن كلا رسائل المصافحة تتناسب مع MTU قياسي UDP.
المفتاح المشترك الناتج (osk) من مصافحة PQ KK يستخدم كمفتاح مسبق التش

شارك للقياسات العادية في مصافحة القياسات العادية Wireguard IK.
لذا فهناك مصافحتين كاملتين بالمجمل، واحدة نقية PQ وواحدة نقية X25519.

لا يمكننا تنفيذ أي من هذه لتحل محل مصافحات XK وIK الخاصة بنا لأن:

- لا يمكننا تنفيذ KK، بوب لا يملك مفتاح أليس الثابت
- المفاتيح الثابتة بحجم 500 كيلو بايت ضخمة جداً
- لا نريد جولة إضافية

هناك الكثير من المعلومات المفيدة في الورقة البيضاء،
وسنراجعها للحصول على أفكار وإلهام. TODO.



## المواصفات

### الهياكل المشتركة

تحديث الأقسام والجداول في وثيقة الهياكل المشتركة [COMMON](https://geti2p.net/spec/common-structures) كما يلي:


المفتاح العام
````````````````

أنواع المفاتيح العامة الجديدة هي:

| النوع | طول المفتاح العا | منذ | ستخدا |
| ----- | ---------------- | --- | ----- |
| MLKEM512_X25519 | 32 | 0.9.xx | انظر |
| MLKEM768_X25519 | 32 | 0.9.xx | انظر |
| MLKEM1024_X25519 | 32 | 0.9.xx | انظر |
| MLKEM512 | 800 | 0.9.xx | انظر |
| MLKEM768 | 1184 | 0.9.xx | انظر |
| MLKEM1024 | 1568 | 0.9.xx | انظر |
| MLKEM512_CT | 768 | 0.9.xx | انظر |
| MLKEM768_CT | 1088 | 0.9.xx | انظر |
| MLKEM1024_CT | 1568 | 0.9.xx | انظر |
| NONE | 0 | 0.9.xx | انظر |


المفاتيح العامة الهجينة هي المفاتيح X25519.
المفاتيح العامة لـ KEM هي المفتاح PQ المؤقت المرسل من أليس إلى بوب.
التشفير وترتيب البايتات محددة في [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf).

مفاتيح MLKEM*_CT ليست مفاتيح عامة حقاً، هي "النص المشفر" المرسل من Bob إلى أليس في مصافحة Noise.
تم إدراجها هنا لأغراض الإكمال.


المفتاح الخاص
````````````````

أنواع المفاتيح الخاصة الجديدة هي:

| النوع | طول المفتاح الخاص | منذ | تخدام |
| ----- | ----------------- | --- | ----- |
| MLKEM512_X25519 | 32 | 0.9.xx | انظر |
| MLKEM768_X25519 | 32 | 0.9.xx | انظر |
| MLKEM1024_X25519 | 32 | 0.9.xx | انظر |
| MLKEM512 | 1632 | 0.9.xx | انظر |
| MLKEM768 | 2400 | 0.9.xx | انظر |
| MLKEM1024 | 3168 | 0.9.xx | انظر |


المفاتيح الخاصة الهجينة هي المفاتيح X25519.
مفاتيح KEM الخاصة هي لأليس فقط.
تش

فير KEM وترتيب البايتات محددة في [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf).




المفتاح العام للتوقيع
````````````````

أنواع المفاتيح العامة للتوقيع الجديدة هي:

| النوع | طول (بايتات) | نذ   ا | خدام |
| ----- | ------------ | ------ | ---- |
| MLDSA44 | 1312 | 0.9.xx | انظر |
| MLDSA65 | 1952 | 0.9.xx | انظر |
| MLDSA87 | 2592 | 0.9.xx | انظر |
| MLDSA44_EdDSA_SHA512_Ed25519 | 1344 | 0.9.xx | انظر |
| MLDSA65_EdDSA_SHA512_Ed25519 | 1984 | 0.9.xx | انظر |
| MLDSA87_EdDSA_SHA512_Ed25519 | 2624 | 0.9.xx | انظر |
| MLDSA44ph | 1344 | 0.9.xx | فقط ل |
| MLDSA65ph | 1984 | 0.9.xx | فقط ل |
| MLDSA87ph | 2624 | 0.9.xx | فقط ل |


المفاتيح العامة للتوقيع الهجين هي مفتاح Ed25519 يليه PQ، كما في [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/).
الترميز وترتيب البايتات محددة في [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf).


المفتاح الخاص للتوقيع
`````````````````

أنواع المفاتيح الخاصة للتوقيع الجديدة هي:

============================   ==============  ======  =====
         النوع                  طول (بايتات)  منذ   استخ

دام
============================   ==============  ======  =====
MLDSA44                              2560      0.9.xx  انظر الاقتراح 169
MLDSA65                              4032      0.9.xx  انظر الاقتراح 169
MLDSA87                              4896      0.9.xx  انظر الاقتراح 169
MLDSA44_EdDSA_SHA512_Ed25519         2592      0.9.xx  انظر الاقتراح 169
MLDSA65_EdDSA_SHA512_Ed25519         4064      0.9.xx  انظر الاقتراح 169
MLDSA87_EdDSA_SHA512_Ed25519         4928      0.9.xx  انظر الاقتراح 169
MLDSA44ph                            2592      0.9.xx  فقط لملفات SU3، وليس للهياكل netdb
MLDSA65ph                            4064      0.9.xx  فقط لملفات SU3، وليس للهياكل netdb
MLDSA87ph                            4928      0.9.xx  فقط لملفات SU3، وليس للهياكل netdb
============================   ==============  ======  =====

المفاتيح الخاصة للتوقيع الهجين هي المفتاح Ed25519 يليه المفتاح PQ، كما في [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/).
التشفير وترتيب البايتات محددة في [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf).


التوقيع
````````

أنواع التوقيع الجديدة هي:

| النوع | طول (بايتات) | نذ   ا | خدام |
| ----- | ------------ | ------ | ---- |
| MLDSA44 | 2420 | 0.9.xx | انظر |
| MLDSA65 | 3309 | 0.9.xx | انظر |
| MLDSA87 | 4627 | 0.9.xx | انظر |
| MLDSA44_EdDSA_SHA512_Ed25519 | 2484 | 0.9.xx | انظر |
| MLDSA65_EdDSA_SHA512_Ed25519 | 3373 | 0.9.xx | انظر |
| MLDSA87_EdDSA_SHA512_Ed25519 | 4691 | 0.9.xx | انظر |
| MLDSA44ph | 2484 | 0.9.xx | فقط ل |
| انظر الاقتراح 169 |  |  |  |
| MLDSA65ph | 3373 | 0.9.xx | فقط ل |
| MLDSA87ph | 4691 | 0.9.xx | فقط ل |


التوقيعات الهجينة هي توقيع Ed25519 يليه توقيع PQ، كما في [COMPOSITE-SIGS](https://datatracker.ietf.org/doc/draft-ounsworth-pq-composite-sigs/).
التوقيعات الهجينة يتم التحقق منها بواسطة التحقق من كلا التوقيعين، والفشل
إذا فشل أي منهما.
التشفير وترتيب البايتات محددة في [FIPS204](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf).



شهادات المفتاح
````````````````

أنواع المفاتيح العامة للتوقيع الجديدة هي:

| النوع | رمز النوع | طول المفتاح العام الإج | لي  من | است |
| ----- | --------- | ---------------------- | ------ | --- |
| MLDSA44 | 12 | 1312 | 0.9.xx | انظر |
| MLDSA65 | 13 | 1952 | 0.9.xx | انظر |
| MLDSA87 | 14 | 2592 | 0.9.xx | انظر |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 0.9.xx | انظر |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 0.9.xx | انظر |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 0.9.xx | انظر |
| MLDSA44ph | 18 | n/a | 0.9.xx | فقط ل |
| MLDSA65ph | 19 | n/a | 0.9.xx | فقط ل |
| MLDSA87ph | 20 | n/a | 0.9.xx | فقط ل |




أنواع المفاتيح العامة للتشفير الجديدة هي:

| النوع | رمز النوع | طول المفتاح العام الإج | الي من | است |
| ----- | --------- | ---------------------- | ------ | --- |
| MLKEM512_X25519 | 5 | 32 | 0.9.xx | انظر |
| MLKEM768_X25519 | 6 | 32 | 0.9.xx | انظر |
| MLKEM1024_X25519 | 7 | 32 | 0.9.xx | انظر |
| NONE | 255 | 0 | 0.9.xx | انظر |



أنواع المفاتيح الهجينة لا تُدرج أبداً في شهادات المفاتيح؛ فقط في مجموعات التأجير.

للمقاصد مع أنواع توقيع هجينة أو PQ،
استخدم NONE (النوع 255) لنوع التشفير،
ولكن لا يوجد مفتاح تشفير، و

القسم بأكمله بحجم 384 بايت هو للمفتاح التوقيعي.



أحجام المقاصد
````````````````

هنا طول أنواع المقاصد الجديدة.
نوع التشفير للجميع هو NONE (النوع 255) ويعتبر طول مفتاح التشفير 0.
يتم استخدام القسم بأكمله بحجم 384 بايت للجزء الأول من المفتاح العام للتوقيع.
ملاحظة: هذا يختلف عن المواصفات لأنواع التوقيع ECDSA_SHA512_P521
و RSA، حيث حافظنا على المفتاح ElGamal بحجم 256 بايت في المقصد حتى وإن لم يُستخدم.

لا يوجد حشو.
الأطوال الإجمالية هي 7 + الطول الإجمالي للمفتاح.
طول شهادة المفتاح هو 4 + الطول الزائد.

مثال على التدفق البايت للمقصد 1319 لـ MLDSA44:

skey[0:383] 5 (932 >> 8) (932 & 0xff) 00 12 00 255 skey[384:1311]



| النوع | رمز النوع | طول المفتاح العام الإج | لي  رئ | ي    ز | د |
| ----- | --------- | ---------------------- | ------ | ------ | --- |
| MLDSA44 | 12 | 1312 | 384 | 928 | 1319 |
| MLDSA65 | 13 | 1952 | 384 | 1568 | 1959 |
| MLDSA87 | 14 | 2592 | 384 | 2208 | 2599 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 384 | 960 | 1351 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 384 | 1600 | 1991 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 384 | 2240 | 2631 |




أحجام هوية الراوتر
``````````````````

هنا الطول لأنواع المقاصد الجديدة.
نوع التشفير للجميع هو X25519 (النوع 4).
يتم استخدام القسم بأكمله بحجم 352 بايت بعد مفتاح X28819 العام للجزء الأول من المفتاح العام للتوقيع.
لا يوجد حشو.
الأطوال الإجمالية هي 39 + الطول الإجمالي للمفتاح.
طول شهادة المفتاح هو 4 + الطول الزائد.

مثال على تدفق بايت هوية الراوتر 1351 لـ MLDSA44:

enckey[0:31] skey[0:351] 5 (960 >> 8) (960 & 0xff) 00 12 00 4 skey[352:1311]



| النوع | رمز النوع | طول المفتاح العام الإج | لي  رئ | ي    ز | د |
| ----- | --------- | ---------------------- | ------ | ------ | --- |
| MLDSA44 | 12 | 1312 | 352 | 960 | 1351 |
| MLDSA65 | 13 | 1952 | 352 | 1600 | 1991 |
| MLDSA87 | 14 | 2592 | 352 | 2240 | 2631 |
| MLDSA44_EdDSA_SHA512_Ed25519 | 15 | 1344 | 352 | 992 | 1383 |
| MLDSA65_EdDSA_SHA512_Ed25519 | 16 | 1984 | 352 | 1632 | 2023 |
| MLDSA87_EdDSA_SHA512_Ed25519 | 17 | 2624 | 352 | 2272 | 2663 |




### أنماط المصافحة

تستخدم المصافحات أنماط [Noise]_ handshake.

يستخدم الخريطة الحرفية التالية:

- e = مفتاح مؤقت ذو استخدام واحد
- s = مفتاح ثابت
- p = حمولة الرسائل
- e1 = مفتاح مؤقت لـ PQ، يرسل من Alice إلى Bob
- ekem1 = الـ KEM النص المشفر، يرسل من Bob إلى Alice

التعديلات التالية لـ XK وIK للسرية المستقبلية الهجينة (hfs) كما هو محدد في [Noise-Hybrid]_ القسم 5:

```dataspec

XK:                       XKhfs:
  <- s                      <- s
  ...                       ...
  -> e, es, p               -> e, es, e1, p
  <- e, ee, p               <- e, ee, ekem1, p
  -> s, se                  -> s, se
  <- p                      <- p
  p ->                      p ->


  IK:                       IKhfs:
  <- s                      <- s
  ...                       ...
  -> e, es, s, ss, p       -> e, es, e1, s, ss, p
  <- tag, e, ee, se, p     <- tag, e, ee, ekem1, se, p
  <- p                     <- p
  p ->                     p ->

  e1 and ekem1 are encrypted. See pattern definitions below.
  NOTE: e1 and ekem1 are different sizes (unlike X25519)

```

النمط e1 معرف كما يلي، كما هو محدد في [Noise-Hybrid]_ القسم 4:

```dataspec

For Alice:
  (encap_key, decap_key) = PQ_KEYGEN()

  // EncryptAndHash(encap_key)
  ciphertext = ENCRYPT(k, n, encap_key, ad)
  n++
  MixHash(ciphertext)

  For Bob:

  // DecryptAndHash(ciphertext)
  encap_key = DECRYPT(k, n, ciphertext, ad)
  n++
  MixHash(ciphertext)


```


النمط ekem1 معرف كما يلي، كما هو محدد في [Noise-Hybrid]_ القسم 4:

```dataspec

For Bob:

  (kem_ciphertext, kem_shared_key) = ENCAPS(encap_key)

  // EncryptAndHash(kem_ciphertext)
  ciphertext = ENCRYPT(k, n, kem_ciphertext, ad)
  MixHash(ciphertext)

  // MixKey
  MixKey(kem_shared_key)


  For Alice:

  // DecryptAndHash(ciphertext)
  kem_ciphertext = DECRYPT(k, n, ciphertext, ad)
  MixHash(ciphertext)

  // MixKey
  kem_shared_key = DECAPS(kem_ciphertext, decap_key)
  MixKey(kem_shared_key)


```




### Noise Handshake KDF

القضايا
``````

- هل يجب علينا تغيير دالة hash في المصافحة؟ انظر [Choosing-Hash]_.
  SHA256 غير مهددة بواسطة PQ، ولكن إذا كنا نريد ترقية
  دالة hash لدينا، الآن هو الوقت، بينما نقوم بتغيير أشياء أخرى.
  الاقتراح الحالي IETF SSH [SSH-HYBRID]_ هو استخدام MLKEM768
  مع SHA256، وMLKEM1024 مع SHA384. ذلك الاقتراح يتضمن
  مناقشة الاعتبارات الأمنية.
- هل يجب علينا التوقف عن إرسال بيانات الارتباط 0-RTT (غير LS)؟
- هل يجب علينا تغيير الارتباط من IK إلى XK إذا لم نرسل بيانات 0-RTT؟


نظرة عامة
````````

ينطبق هذا القسم على كل من بروتوكولات IK وXK.

المصافحة الهجينة محددة في [Noise-Hybrid]_.
تحتوي الرسالة الأولى، من Alice إلى Bob، على e1، مفتاح التغليف، قبل حمولة الرسالة.
يُع

امل هذا كمفتاح ثابت إضافي؛ قم بتنفيذ EncryptAndHash() عليه (كما أليس)
أو DecryptAndHash() (كبوب).
ثم قم بمعالجة حمولة الرسالة كالمعتاد.

تحتوي الرسالة الثانية، من بوب إلى أليس، على ekem1 النص المشفر، قبل حمولة الرسالة.
يتم التعامل معها كمفتاح ثابت إضافي؛ قم بتنفيذ EncryptAndHash() عليه (كبوب)
أو DecryptAndHash() (كما أليس).
ثم، احسب kem_shared_key وقم بتنفيذ MixKey(kem_shared_key).
ثم قم بمعالجة حمولة الرسالة كالمعتاد.


العمليات المعرفة لـ ML-KEM
```````````````````````````

نحن نعرف الوظائف التالية التي تتوافق مع اللبنات التشفيرية المستخدمة
كما هو محدد في [FIPS203](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf).

(encap_key, decap_key) = PQ_KEYGEN()
    يقوم أليس بإنشاء مفتاح التغليف وفك التغليف
    يتم إرسال مفتاح التغليف في الرسالة 1.
    أحجام encap_key وdecap_key تختلف بحسب متغير ML-KEM.

(ciphertext, kem_shared_key) = ENCAPS(encap_key)
    يقوم بوب بحساب النص المشفر والمفتاح المشترك،
    باستخدام النص المشفر المستلم في الرسالة 1.
    يتم إرسال النص المشفر في الرسالة 2.
    حجم النص المشفر يختلف طبقاً لمتغير ML-KEM.
    kem_shared_key دائماً

 بحجم 32 بايت.

kem_shared_key = DECAPS(ciphertext, decap_key)
    يقوم أليس بحساب المفتاح المشترك،
    باستخدام النص المشفر المستلم في الرسالة 2.
    kem_shared_key دائماً بحجم 32 بايت.

لاحظ أن كل من encap_key والنص المشفر مشفر داخل كتل ChaCha/Poly
في رسائل المصافحة Noise الرسائل 1 و2.
سيتم فك تشفيرها كجزء من عملية المصافحة.

يتم مزج kem_shared_key في مفتاح الربط مع MixHash().
انظر أدناه للحصول على التفاصيل.


KDF لـ Alice للرسالة 1
`````````````````````````

بالنسبة لـ XK: بعد نمط "es" وقبل الحمولة، أضف:

أو

بالنسبة لـ IK: بعد نمط "es" وقبل نمط "s"، أضف:

```text
هذا هو نمط الرسالة "e1":
  (encap_key, decap_key) = PQ_KEYGEN()

  // EncryptAndHash(encap_key)
  // المعلمات AEAD
  k = keydata[32:63]
  n = 0
  ad = h
  ciphertext = ENCRYPT(k, n, encap_key, ad)
  n++

  // MixHash(ciphertext)
  h = SHA256(h || ciphertext)


  نهاية نمط رسالة "e1".

  ملاحظة: بالنسبة للقسم التالي (الحمولة لـ XK أو المفتاح الثابت لـ IK)،
  تبقى keydata ومفتاح السلسلة كما هي،
  وn الآن يساوي 1 (بدلاً من 0 لغير الهجين).

```


KDF لـ Bob للرسالة 1
`````````````````````````

بالنسبة لـ XK: بعد نمط "es" وقبل الحمولة، أضف:

أو

بالنسبة لـ IK: بعد نمط "es" وقبل نمط "s"، أضف:

```text
هذا هو نمط الرسالة "e1":

  // DecryptAndHash(encap_key_section)
  // المعلمات AEAD
  k = keydata[32:63]
  n = 0
  ad = h
  encap_key = DECRYPT(k, n, encap_key_section, ad)
  n++

  // MixHash(encap_key_section)
  h = SHA256(h || encap_key_section)

  نهاية نمط رسالة "e1".

  ملاحظة: بالنسبة للقسم التالي (الحمولة لـ XK أو المفتاح الثابت لـ IK)،
  تبقى keydata ومفتاح السلسلة كما هي،
  وn الآن يساوي 1 (بدلاً من 0 لغير الهجين).

```


KDF لـ Bob للرسالة 2
`````````````````````````

بالنسبة لـ XK: بعد نمط "ee" وقبل الحمولة، أضف:

أو

بالنسبة لـ IK: بعد نمط "ee" وقبل نمط "se"، أضف:

```text
هذا هو نمط الرسالة "ekem1":

  (kem_ciphertext, kem_shared_key) = ENCAPS(encap_key)

  // EncryptAndHash(kem_ciphertext)
  // المعلمات AEAD
  k = keydata[32:63]
  n = 0
  ad = h
  ciphertext = ENCRYPT(k, n, kem_ciphertext, ad)

  // MixHash(ciphertext)
  h = SHA256(h || ciphertext)

  // MixKey(kem_shared_key)
  keydata = HKDF(chainKey, kem_shared_key, "", 64)
  chainKey = keydata[0:31]

  نهاية نمط الرسالة "ekem1".

```


KDF لـ Alice للرسالة 2
`````````````````````````

بعد نمط "ee" (وقبل نمط "ss" لـ IK)، أضف:

```text
هذا هو نمط الرسالة "ekem1":

  // DecryptAndHash(kem_ciphertext_section)
  // المعلمات AEAD
  k = keydata[32:63]
  n = 0
  ad = h
  kem_ciphertext = DECRYPT(k, n, kem_ciphertext_section, ad)

  // MixHash(kem_ciphertext_section)
  h = SHA256(h || kem_ciphertext_section)

  // MixKey(kem_shared_key)
  kem_shared_key = DECAPS(kem_ciphertext, decap_key)
  keydata = HKDF(chainKey, kem_shared_key, "", 64)
  chainKey = keydata[0:31]

  نهاية نمط الرسالة "ekem1".

```


KDF للرسالة 3 (XK فقط)
```````````````````````````
بدون تغيير


KDF لـ split()
```````````````
بدون تغيير



### Ratchet

قم بتحديث مواصفة ECIES-Ratchet [ECIES](https://geti2p.net/spec/ecies) كما يلي:


معرفات Noise
`````````````````

- "Noise_IKhfselg2_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_IKhfselg2_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_IKhfselg2_25519+MLKEM1024_ChaChaPoly_SHA256"



1b) تنسيق الجلسة الجديدة (مع الربط)
`````````````````````````````````````

التغييرات: يحتوي الراشيت الحالي على المفتاح الثابت في القسم الأول من ChaCha،
والحمولة في القسم الثاني.
مع ML-KEM، هناك الآن ثلاثة أقسام.
يحتوي القسم الأول على المفتاح PQ المشفر.
يحتوي القسم الثاني على المفتاح الثابت.
يحتوي القسم الثالث على الحمولة.


التنسيق المشفر:

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   مفتاح الجلسة المؤقت الجديد            |
  +              32 بايت                   +
  |     مشفر باستخدام Elligator2         |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           مفتاح ML-KEM encap         +
  |       بيانات مشفرة باستخدام ChaCha20   |
  +      (انظر الجدول أدناه للطول)       +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  رمز التحقق من الرسالة Poly1305       |
  +    (MAC) لقسم encap_key              +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           مفتاح ثابت X25519            +
  |       بيانات مشفرة باستخدام ChaCha20   |
  +             32 بايت                  +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  رمز التحقق من الرسالة Poly1305       |
  +    (MAC) لقسم المفتاح الثابت          +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            قسم الحمولة               +
  |       بيانات مشفرة باستخدام ChaCha20   |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  رمز التحقق من الرسالة Poly1305       |
  +         (MAC) لقسم الحمولة          +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+


```

التنسيق بعد فك التشفير:

```dataspec
الجزء الأول من الحمولة:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       ML-KEM encap_key                +
  |

                                      |
  +      (انظر الجدول أدناه للطول)      +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  الجزء الثاني من الحمولة:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       X25519 مفتاح ثابت               +
  |                                       |
  +      (32 بايت)                       +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

  الجزء الثالث من الحمولة:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +            قسم الحمولة               +
  |                                       |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

```

الأحجام:

| النوع | نوع الكو | X le | Msg 1 le | Msg 1 Enc le | Msg 1 Dec le | PQ key le | pl len |
| ----- | -------- | ---- | -------- | ------------ | ------------ | --------- | ------ |
| X25519 | 4 | 32 | 96+pl | 64+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 912+pl | 880+pl | 800+pl | 800 | pl |
| MLKEM768_X25519 | 6 | 32 | 1296+pl | 1360+pl | 1184+pl | 1184 | pl |
| MLKEM1024_X25519 | 7 | 32 | 1680+pl | 1648+pl | 1568+pl | 1568 | pl |


لاحظ أن الحمولة يجب أن تحتوي على كتلة DateTime، لذا فإن الحد الأدنى لحجم الحمولة هو 7.
يمكن حساب الأحجام الدنيا للرسالة 1 وفقاً لذلك.



1g) تنسيق الرد على الجلسة الجديد
`````````````````````````````````

التغييرات: يحتوي الراشيت الحالي على حمولة فارغة للقسم الأول من ChaCha،
والحمولة في القسم الثاني.
مع ML-KEM، هناك الآن ثلاثة أقسام.
يحتوي القسم الأول على الـ PQ النص المشفر.
القسم الثاني لديه حمولة فارغة.
يحتوي القسم الثالث على الحمولة.


التنسيق المشفر:

```dataspec
+----+----+----+----+----+----+----+----+
  |       علامة الجلسة 8 بايت            |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        مفتاح عام مؤقت                +
  |                                       |
  +             32 بايت                  +
  |     مشفر باستخدام Elligator2         |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  | ChaCha20 النص المشفر باستخدام ML-KEM  |
  +      (انظر الجدول أدناه للطول)       +
  ~                                       ~
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  رمز التحقق من الرسالة Poly1305       |
  +  (MAC) لقسم النص المشفر             +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+
  |  رمز التحقق من الرسالة Poly1305       |
  +  (MAC) للقسم المفتاح (لا بيانات)      +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            قسم الحمولة               +
  |       بيانات مشفرة باستخدام ChaCha20   |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  رمز التحقق من الرسالة Poly1305       |
  +         (MAC) لقسم الحمولة          +
  |             16 بايت                  |
  +----+----+----+----+----+----+----+----+


```

التنسيق بعد فك التشفير:

```dataspec
الجزء الأول من الحمولة:


  +----+----+----+----+----+----+----+----+
  |                                       |
  +       ML-KEM النص المشفر              +
  |                                       |
  +      (انظر الجدول أدناه للطول)       +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  الجزء الثاني من الحمولة:

  فارغة

  الجزء الثالث من الحمولة:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +            قسم الحمولة               +
  |                                       |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

```

الأحجام:

| النوع | نوع الكو | Y le | Msg 2 le | Msg 2 Enc le | Msg 2 Dec le | PQ CT len | opt le |
| ----- | -------- | ---- | -------- | ------------ | ------------ | --------- | ------ |
| X25519 | 4 | 32 | 72+pl | 32+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 856+pl | 816+pl | 768+pl | 768 | pl |
| MLKEM768_X25519 | 6 | 32 | 1176+pl | 1136+pl | 108 |  |  |
| 8+pl         108 | pl |  |  |  |  |  |  |
| MLKEM1024_X25519 | 7 | 32 | 1656+pl | 1616+pl | 1568+pl | 1568 | pl |


لاحظ أنه بينما ستكون الرسالة 2 تحتوي عادة على حمولة غير صفرية،
لا يتطلب مواصفات الراشيت [ECIES](https://geti2p.net/spec/ecies) ذلك، لذا فإن الحد الأدنى لحجم الحمولة هو 0.
يمكن حساب الأحجام الدنيا للرسالة 2 وفقاً لذلك.



### NTCP2

قم بتحديث مواصفة NTCP2 [NTCP2](https://geti2p.net/spec/ntcp2) كما يلي:


Noise identifiers
`````````````````

- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM1024_ChaChaPoly_SHA256"


1) طلب الجلسة
``````````````````

التغييرات: تحتوي NTCP2 الحالية على الخيارات فقط في قسم ChaCha.
مع ML-KEM، سيحتوي قسم ChaCha أيضاً على المفتاح PQ المشفر.


المحتويات الخام:

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +        مموهة مع RH_B                 +
  |       AES-CBC-256 نص مشفر X          |
  +

             (32 بايت)                +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   إطار ChaChaPoly (MLKEM)            |
  +     (انظر الجدول أدناه للطول)       +
  |   k معرف في KDF للرسالة 1          |
  +   n = 0                               +
  |   انظر KDF للبيانات المرتبطة        |
  ~   n = 0                               ~
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |    إطار ChaChaPoly (الخيارات)         |
  +             32 بايت                  +
  |   k معرف في KDF للرسالة 1          |
  +   n = 0                               +
  |   انظر KDF للبيانات المرتبطة        |
  +----+----+----+----+----+----+----+----+
  |     حشو موثوق غير مشفر               +
  ~      الطول معرف في كتلة الخيارات    ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  نفس كما كان من قبل باستثناء إضافة إطار ChaChaPoly ثاني


```

البيانات غير المشفرة (تسمية توثيق لا تظهر):

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                   X                   |
  +              (32 بايت)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM encap_key           |
  +      (انظر الجدول أدناه للطول)     +

  |                                       |
  +----+----+----+----+----+----+----+----+
  |               الخيارات               |
  +              (16 بايت)              +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     حشو موثوق غير مشفر               +
  |      الطول معرف في كتلة الخيارات    ~
  |                                       |
  +----+----+----+----+----+----+----+----+



```

الأحجام:

| النوع | نوع الكو | X le | Msg 1 le | Msg 1 Enc le | Msg 1 Dec le | PQ key le | opt le |
| ----- | -------- | ---- | -------- | ------------ | ------------ | --------- | ------ |
| X25519 | 4 | 32 | 64+pad | 32 | 16 | -- | 16 |
| MLKEM512_X25519 | 5 | 32 | 880+pad | 848 | 816 | 800 | 16 |
| MLKEM768_X25519 | 6 | 32 | 1264+pad | 1232 | 1200 | 1184 | 16 |
| MLKEM1024_X25519 | 7 | 32 | 1648+pad | 1616 | 1584 | 1568 | 16 |


ملاحظة: الأكواد النوعية للاستخدام الداخلي فقط. البوابات ستبقى النوع 4،
وسيتم الاعتماد في عناوين الراوتر للإشارة إلى الدعم.


2) الجلسة المنشأة
``````````````````

التغييرات: تحتوي NTCP2 الحالية على الخيارات فقط في قسم ChaCha.
مع ML-KEM، سيحتوي قسم ChaCha أيضاً على النص المشفر PQ.


المحتويات الخام:

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +        مموهة مع RH_B                 +
  |       AES-CBC-256 نص مشفر Y          +
  +              (32 بايت)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   إطار ChaChaPoly (MLKEM)            |
  +   بيانات مشفرة ومعتمدة                +
  -      (انظر الجدول أدناه للطول)     -
  +   k معرف في KDF للرسالة 2          +
  |   n = 0؛ انظر KDF للبيانات المرتبطة |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   إطار ChaChaPoly (الخيارات)          |
  +   بيانات مشفرة ومعتمدة                +
  -           32 بايت                    -
  +   k معرف في KDF للرسالة 2          +
  |   n = 0؛ انظر KDF للبيانات المرتبطة |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     حشو موثوق غير مشفر               |
  +         (اختياري)                    +
  |      الطول معرف في الخيارات         ~
  ~               .   .   .               ~
  |

                                       |
  +----+----+----+----+----+----+----+----+

  نفس كما كان من قبل باستثناء إضافة إطار ChaChaPoly ثاني

```

البيانات غير المشفرة (تسمية التحقق من الرسالة لا تظهر):

```dataspec
+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                  Y                    |
  +              (32 بايت)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM النص المشفر          |
  +      (انظر الجدول أدناه للطول)     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |               الخيارات               |
  +              (16 بايت)              +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     حشو موثوق غير مشفر               +
  |      الطول معرف في كتلة الخيارات    ~
  |                                       |
  +----+----+----+----+----+----+----+----+

```

الأحجام:

| النوع | نوع الكو | Y le | Msg 2 le | Msg 2 Enc le | Msg 2 Dec le | PQ CT len | opt len |
| ----- | -------- | ---- | -------- | ------------ | ------------ | --------- | ------- |
| X25519 | 4 | 32 | 64+pad | 32 | 16 | -- | 16 |
| MLKEM512_X25519 | 5 | 32 | 848+pad | 816 | 784 | 768 | 16 |
| MLKEM768_X25519 | 6 | 32 | 1136+pad | 1104 | 1104 | 1088 | 16 |
| MLKEM1024_X25519 | 7 | 32 | 1616+pad | 1584 | 1584 | 1568 | 16 |


ملاحظة: الأكواد النوعية للاستخدام الداخلي فقط. البوابات ستبقى النوع 4،
وسيتم الاعتماد في عناوين الراوتر للإشارة إلى الدعم.



3) الجلسة المؤكدة
```````````````````

بدون تغيير


دالة اشتقاق المفاتيح (KDF) (لمرحلة البيانات)
``````````````````````````````````````````````

بدون تغيير




### SSU2

قم بتحديث مواصفة SSU2 [SSU2](https://geti2p.net/spec/ssu2) كما يلي:


معرفات Noise
`````````````````

- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM512_ChaChaPoly_SHA256"
- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM768_ChaChaPoly_SHA256"
- "Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM1024_ChaChaPoly_SHA256"


الرأس الطويل
`````````````
الرأس الطويل هو 32 بايت. يتم استخدامه قبل إنشاء الجلسة، لطلب التوكن، SessionRequest، SessionCreated، وRetry.
كما يستخدم للرسائل Peer Test وHole Punch خارج الجلسة.

TODO: يمكننا استخدام الحقل الإصدار داخلياً واستخدام 3 لـ MLKEM512 و4 لـ MLKEM768.
هل نقوم بذلك فقط للأنواع 0 و1 أم لجميع الأنواع الـ 6؟


قبل تشفير الرأس:

```dataspec

+----+----+----+----+----+----+----+----+
  |      معرف الاتصال بالوجهة          |
  +----+----+----+----+----+----+----+----+
  |   رقم الحزمة   |النوع|الإصدار|المعرف|العلامة|
  +----+----+----+----+----+----+----+----+
  |        معرف الاتصال بالمصدر        |
  +----+----+----+----+----+----+----+----+
  |                 التوكن              |
  +----+----+----+----+----+----+----+----+

  معرف الاتصال بالوجهة :: 8 بايت، عدد غير موقع بالطول الكبير

  رقم الحزمة :: 4 بايت، عدد غير موقع بالطول الكبير

  النوع :: نوع الرسالة = 0، 1، 7، 9، 10، أو 11

  الإصدار :: الإصدار البروتوكولي، يساوي 2
         TODO يمكننا استخدام الحقل الإصدار داخلياً واستخدام 3 لـ MLKEM512 و4 لـ MLKEM768.

  المعرف :: 1 بايت، معرف الشبكة (حالياً 2، باستثناء الشبكات التجريبية)

  العلامة :: 1 بايت، غير مستخدمة، تم ضبطها على 0 للتوافق المستقبلي

  معرف الاتصال بالمصدر :: 8 بايت، عدد غير موقع بالطول الكبير

  التوكن :: 8 بايت، عدد غير موقع بالطول الكبير

```


الرأس القصير
`````````````
بدون تغيير


طلب الجلسة (النوع 0)
`````````````````````

التغييرات: تحتوي SSU2 الحالية على بيانات الكتلة فقط في قسم ChaCha.
مع ML-KEM، سيحتوي قسم ChaCha أيضاً على المفتاح PQ المشفر.


المحتويات الخام:

```dataspec
+----+----+----+----+----+----+----+----+
  |  رؤوس طويلة بايتات 0-15، ChaCha20    |
  +  مشفرة بمفتاح Bob التعريفي          +
  |    انظر KDF لتشفير الرأس            |
  +----+----+----+----+----+----+----+----+
  |  رؤوس طويلة بايتات 16-31، ChaCha20   |
  +  مشفرة بالمفتاح Bob التعريفي n=0    +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +       X، مشفرة باستخدام ChaCha20    +
  |       مع المفتاح Bob التعريفي n=0    |
  +              (32 بايت)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   بيانات مشفرة باستخدام ChaCha20 (MLKEM)     |
  +          (الطول متغير)                  +
  |  k محدد في  KDF للطلب الجلسة        |
  +  n = 0                                +
  |  انظر KDF للبيانات المرتبطة          |
  +----+-

---+----+----+----+----+----+
  |                                       |
  +                                       +
  |   بيانات مشفرة باستخدام ChaCha20 (الحمولة)   |
  +          (الطول متغير)                  +
  |  k محدد في KDF للطلب الجلسة        |
  +  n = 0                                +
  |  انظر KDF للبيانات المرتبطة          |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        رمز MAC Poly1305 (16 بايت)     +
  |                                       |
  +----+----+----+----+----+----+----+----+


```

البيانات غير المشفرة (تسمية المصادقة Poly1305 لا تظهر):

```dataspec
+----+----+----+----+----+----+----+----+
  |      معرف الاتصال بالوجهة           |
  +----+----+----+----+----+----+----+----+
  |   رقم الحزمة  |نوع|إصدار|معرف|علامة|
  +----+----+----+----+----+----+----+----+
  |        معرف الاتصال بالمصدر         |
  +----+----+----+----+----+----+----+----+
  |                 التوكن              |
  +----+----+----+----+----+----+----+----+
  |

                                       |
  +                                       +
  |                   X                   |
  +              (32 بايت)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM encap_key           |
  +      (انظر الجدول أدناه للطول)      +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     الحمولة Noise (بيانات الكتلة)    |
  +          (الطول متغير)                  +
  |     انظر أدناه للأكتلات المسموح بها |
  +----+----+----+----+----+----+----+----+


```

الأحجام، لا تشمل النفط IP:

| النوع | نوع الكو | X le | Msg 1 le | Msg 1 Enc le | Msg 1 Dec le | PQ key le | pl len |
| ----- | -------- | ---- | -------- | ------------ | ------------ | --------- | ------ |
| X25519 | 4 | 32 | 80+pl | 16+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 896+pl | 832+pl | 800+pl | 800 | pl |
| MLKEM768_X25519 | 6 | 32 | 1280+pl | 1216+pl | 1184+pl | 1184 | pl |
| MLKEM1024_X25519 | 7 | n/a | too big |  |  |  |  |


ملاحظة: الأكواد النوعية للاستخدام الداخلي فقط. البوابات ستبقى النوع 4،
وسيتم الاعتماد في عناوين الراوتر للإشارة إلى الدعم.

MTU الأقل للـ MLKEM768_X25519:
حوالي 1316 لـ IPv4 و1336 لـ IPv6.



SessionCreated (النوع 1)
``````````````````````````
التغييرات: تحتوي SSU2 الحالية على بيانات الكتلة فقط في قسم ChaCha.
مع ML-KEM، سيحتوي قسم ChaCha أيضاً على النص المشفر PQ.


المحتويات الخام:

```dataspec
+----+----+----+----+----+----+----+----+
  |  رؤوس طويلة بايتات 0-15، ChaCha20    |
  +  مشفرة باستخدام مفتاح Bob التعريفي  +
  | مع المفتاح المستمد، انظر KDF لتشفير الرأس |
  +----+----+----+----+----+----+----+----+
  |  رؤوس طويلة بايتات 16-31، ChaCha20   |
  +  مشفرة باستخدام المفتاح المستمد n=0  +
  |  انظر KDF لتشفير الرأس          |
  +----+----+----+----+----+----+---+

-+----+
  |                                       |
  +       Y، مشفرة باستخدام ChaCha20     +
  |       مع المفتاح المستمد n=0          |
  +              (32 بايت)               +
  |       انظر KDF لتشفير الرأس        |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   بيانات ChaCha20 (MLKEM)            |
  +   بيانات مشفرة ومعتمدة                +
  |  الطول متغير                        |
  +  k معرف في KDF للجلسة المنشأة     +
  |  n = 0؛ انظر KDF للبيانات المرتبطة |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   بيانات ChaCha20 (الحمولة)          |
  +   بيانات مشفرة ومعتمدة                +
  |  الطول متغير                        |
  +  k معرف في KDF للجلسة المنشأة     +
  |  n = 0؛ انظر KDF للبيانات المرتبطة |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        رمز MAC Poly1305 (16 بايت)     +
  |                                       |
  +----+----+----+----+----+----+----+----+


```

البيانات غير المشفرة (رمز التحقق من الرسالة Poly1305 لا يظهر):

```dataspec
+----+----+----+----+----+----+----+----+
  |      معرف الاتصال بالوجهة           |
  +----+----+----+----+----+----+----+----+
  |   رقم الحزمة  |نوع|إصدار|معرف|علامة|
  +----+----+----+----+----+----+----+----+
  |        معرف الاتصال بالمصدر         |
  +----+----+----+----+----+----+----+----+
  |                 التوكن              |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                  Y                    |
  +              (32 بايت)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM النص المشفر          |
  +      (انظر الجدول أدناه للطول)      +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     الحمولة Noise (بيانات الكتلة)    |
  +          (الطول متغير)                  +
  |      انظر أدناه للأكتلات المسموح بها |
  +----+----+----+----+----+----+----+----+

```

الأحجام، لا تشمل النفقة IP:

| النوع | نوع الكو | Y le | Msg 2 le | Msg 2 Enc le | Msg 2 Dec le | PQ CT len | pl len |
| ----- | -------- | ---- | -------- | ------------ | ------------ | --------- | ------ |
| X25519 | 4 | 32 | 80+pl | 16+pl | pl | -- | pl |
| MLKEM512_X25519 | 5 | 32 | 864+pl | 800+pl | 768+pl | 768 | pl |
| MLKEM768_X25519 | 6 | 32 | 1184+pl | 1118+pl | 1088+pl | 1088 | pl |
| MLKEM1024_X25519 | 7 | n/a | too big |  |  |  |  |


ملاحظة:
