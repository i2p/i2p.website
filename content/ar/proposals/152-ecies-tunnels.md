```markdown
---
title: "أنفاق ECIES"
number: "152"
author: "chisana, zzz, orignal"
created: "2019-07-04"
lastupdated: "2025-03-05"
status: "مغلق"
thread: "http://zzz.i2p/topics/2737"
target: "0.9.48"
implementedin: "0.9.48"
---

## ملاحظة
يتم حالياً نشر وتطوير الشبكة.
قابل للتعديلات الصغيرة.
اطلع على [SPEC](/en/docs/spec/) للحصول على المواصفات الرسمية.

## النظرة العامة

يقترح هذا المستند تغييرات في تشفير رسائل بناء الأنفاق باستخدام البدائل التشفيرية المقدمة بواسطة [ECIES-X25519](/en/docs/spec/ecies/).
إنه جزء من الاقتراح العام [Prop156](/en/proposals/156-ecies-routers/) لتحويل أجهزة التوجيه من مفاتيح ElGamal إلى مفاتيح ECIES-X25519.

لأغراض تحويل الشبكة من ElGamal + AES256 إلى ECIES + ChaCha20،
تكون الأنفاق مع أجهزة توجيه ElGamal وECIES المختلطة ضرورية.
تُقدم المواصفات للتعامل مع نقاط الأنفاق المختلطة.
لن يتم إجراء تغييرات على تنسيق أو معالجة أو تشفير نقاط ElGamal.

يحتاج منشئو أنفاق ElGamal إلى إنشاء زوج مفاتيح X25519 مؤقت لكل نقطة،
واتباع هذا المواصفات لإنشاء أنفاق تحتوي على نقاط ECIES.

هذا الاقتراح يُحدد التغييرات اللازمة لبناء أنفاق باستخدام ECIES-X25519.
للحصول على نظرة عامة على جميع التغييرات المطلوبة لأجهزة التوجيه ECIES، انظر الاقتراح 156 [Prop156](/en/proposals/156-ecies-routers/).

يحافظ هذا الاقتراح على نفس حجم سجلات بناء الأنفاق،
حسب ما هو مطلوب للتوافق. سيتم تنفيذ سجلات ورسائل بناء أصغر لاحقًا - انظر [Prop157](/en/proposals/157-new-tbm/).

### البدائل التشفيرية

لا يتم تقديم أي بدائل تشفير جديدة. البدائل المطلوبة لتنفيذ هذا الاقتراح:

- AES-256-CBC كما في [Cryptography](/en/docs/spec/cryptography/)
- دوال STREAM ChaCha20/Poly1305:
  ENCRYPT(k, n, plaintext, ad) وDECRYPT(k, n, ciphertext, ad) - كما في [NTCP2](/en/docs/spec/ntcp2/) و[ECIES-X25519](/en/docs/spec/ecies/) و[RFC-7539](https://tools.ietf.org/html/rfc7539)
- دوال X25519 DH - كما في [NTCP2](/en/docs/spec/ntcp2/) و[ECIES-X25519](/en/docs/spec/ecies/)
- HKDF(salt, ikm, info, n) - كما في [NTCP2](/en/docs/spec/ntcp2/) و[ECIES-X25519](/en/docs/spec/ecies/)

دوال Noise الأخرى المعرفة في مكان آخر:

- MixHash(d) - كما في [NTCP2](/en/docs/spec/ntcp2/) و[ECIES-X25519](/en/docs/spec/ecies/)
- MixKey(d) - كما في [NTCP2](/en/docs/spec/ntcp2/) و[ECIES-X25519](/en/docs/spec/ecies/)

### الأهداف

- زيادة سرعة عمليات التشفير
- استبدال ElGamal + AES256/CBC ببدائل ECIES لسجلات BuildRequestRecords وBuildReplyRecords.
- لا تغيير في حجم سجلات BuildRequestRecords وBuildReplyRecords المشفرة (528 بايت) للتوافق
- لا رسائل I2NP جديدة
- الحفاظ على حجم السجل المشفر للتوافق
- إضافة الوراثة الآمنة للرسائل بناء الأنفاق.
- إضافة تشفير موثوق
- اكتشاف إعادة ترتيب النقاط في BuildRequestRecords
- زيادة دقة الطابع الزمني حتى يمكن تقليل حجم مرشح Bloom
- إضافة حقل لانتهاء النفق بحيث تكون هناك إمكانية لأن تعيش الأنفاق لفترات مختلفة (فقط أنفاق مع ECIES)
- إضافة حقل خيارات قابلة للتوسيع للميزات المستقبلية
- إعادة استخدام البدائل التشفيرية الموجودة
- تحسين أمان رسالة بناء النفق حيثما أمكن مع الحفاظ على التوافق
- دعم الأنفاق مع الأقران المختلطين ElGamal/ECIES
- تحسين الدفاعات ضد الهجمات "التصنيفية" على الرسائل البناء
- لا تحتاج النقاط إلى معرفة نوع التشفير للنقطة التالية قبل معالجة الرسالة البناء،
  لأنها قد لا تكون لديها مسار النقطة التالية في ذلك الوقت
- تعظيم التوافق مع الشبكة الحالية
- لا تغيير في تشفير الطلب/الرد لبناء النفق باستخدام AES لـ ElGamal
- لا تغيير في تشفير الطبقة AES للنفق، لذلك راجع [Prop153](/en/proposals/153-chacha20-layer-encryption/)
- الاستمرار في دعم كل من TBM/TBRM ذات 8 سجلات وحجم متغير VTBM/VTBRM
- عدم الحاجة إلى "يوم العلم" لترقية الشبكة بالكامل

### الأهداف غير المرغوب فيها

- إعادة تصميم كامل للرسائل بناء النفق الذي يتطلب "يوم العلم".
- تقليص الرسائل بناء النفق (يتطلب كل الأنفاق مع ECIES واقتراح جديد)
- استخدام خيارات بناء النفق كما هو معرف في [Prop143]، مطلوب فقط للرسائل الصغيرة
- الأنفاق ثنائية الاتجاه - لذلك راجع [Prop119](/en/proposals/119-bidirectional-tunnels/)
- تقليل عدد الرسائل البناء النفق - لذلك راجع [Prop157](/en/proposals/157-new-tbm/)

## نموذج التهديد

### أهداف التصميم

- لا يمكن لأي نقطة تحديد مصدر النفق.

- يجب ألا تتمكن نقاط الوسطية من تحديد اتجاه النفق
  أو موقعهم في النفق.

- لا يمكن لأي نقطة قراءة أي محتوى من الطلبات أو الردود الأخرى، باستثناء
  الهاش المقتطع والمفتاح المؤقت للنقطة التالية

- لا يمكن لأي عضو في نفق الرد لبناء خارجي قراءة أي سجلات رد.

- لا يمكن لأي عضو في النفق الخارج لبناء وارد قراءة أي سجلات طلب، 
  باستثناء أن OBEP يمكنه رؤية الهاش المقتطع والمفتاح المؤقت لإدخال IBGW

### الهجمات التصنيفية

الهدف الرئيسي من تصميم بناء النفق هو جعل الأمر أكثر صعوبة
للموجهات المتواطئة X وY لمعرفة أنهم في نفق واحد.
إذا كانت الموجهة X عند النقطة m والموجهة Y عند النقطة m+1، فسوف يعرفون بوضوح.
ولكن إذا كانت الموجهة X عند النقطة m والموجهة Y عند النقطة m+n حيث n>1، فيجب أن يكون ذلك أصعب بكثير.

الهجمات التصنيفية هي حيث يغير موجه النقطة الوسطية X رسالة بناء النفق بطريقة يمكن للموجه Y اكتشاف التغيير عند الوصول الرسالة البناء.
الهدف هو أن أي رسالة معدلة يتم إلقاؤها من قبل موجه بين X وY قبل أن تصل إلى الموجه Y.
بالنسبة للتعديلات التي لم يتم إلقاؤها قبل الموجهة Y، يجب أن يكتشف منشئ النفق التلف في الرد
ويتجاهل النفق.

الهجمات المحتملة:

- تغيير سجل بناء
- استبدال سجل بناء
- إضافة أو إزالة سجل بناء
- إعادة ترتيب سجلات البناء

TODO: هل يمنع التصميم الحالي كل هذه الهجمات؟

## تصميم

### إطار عمل بروتوكول Noise

يوفر هذا الاقتراح المتطلبات بناءً على إطار عمل بروتوكول Noise
[NOISE](https://noiseprotocol.org/noise.html) (المراجعة 34، 2018-07-11).
في لغة Noise، أليس هي البادئة، وبوب هو المستجيب.

يعتمد هذا الاقتراح على بروتوكول Noise_N_25519_ChaChaPoly_SHA256.
يستخدم هذا البروتوكول الث Noise البدائل التالية:

- نمط التصافح ذات الاتجاه الواحد: N
  أليس لا ترسل مفتاحها الثابت إلى بوب (N)

- وظيفة DH: X25519
  X25519 DH بطول مفتاح 32 بايت كما هو محدد في [RFC-7748](https://tools.ietf.org/html/rfc7748).

- وظيفة تشفير: ChaChaPoly
  AEAD_CHACHA20_POLY1305 كما هو محدد في [RFC-7539](https://tools.ietf.org/html/rfc7539) القسم 2.8.
  مفتاح غير متكرر 12 بايت، مع تعيين الأربعة بايت الأولى إلى الصفر.
  مطابقة لمتطلبات [NTCP2](/en/docs/spec/ntcp2/).

- وظيفة Hash: SHA256
  هاش معيارية بحجم 32 بايت، تُستخدم بشكل كبير في I2P.

إضافات إلى الإطار
``````````````````````````````````

لا شيء.

### أنماط التصافح

تستخدم التصافحات أنماط التصافح [Noise](https://noiseprotocol.org/noise.html)

يتم استخدام التعيين التالي للحروف:

- e = مفتاح مؤقت يستخدم مرة واحدة
- s = مفتاح ثابت
- p = حمولة الرسالة

التكوين الطلب مطابق لنمط Noise N.
وهذا مطابق أيضًا للرسالة الأولى (طلب الجلسة) في النمط XK المستخدم في [NTCP2](/en/docs/spec/ntcp2/).

  ```dataspec

<- s
  ...
  e es p ->




  ```


### تشفير الطلب

تُنشأ سجلات طلب البناء بواسطة منشئ النفق وتُشفّر بشكل غير متماثل إلى النقطة الفردية.
يشمل التشفير غير المتماثل لسجلات الطلبات حاليًا ElGamal كما هو معرف في [Cryptography](/en/docs/spec/cryptography/)
ويتضمن فحص SHA-256. هذا التصميم ليس سريًا للأمام.

سيستخدم التصميم الجديد نمط Noise ذو الاتجاه الواحد "N" باستخدام ECIES-X25519 ephemeral-static DH، مع HKDF، و
ChaCha20/Poly1305 AEAD للسريّة، النزاهة، والمصادقة.
أليس هي طالب بناء النفق. كل نقطة في النفق هي بوب.

(خصائص أمنية للحمولة)

  ```text

N:                      Authentication   Confidentiality
    -> e, es                  0                2

    Authentication: None (0).
    This payload may have been sent by any party, including an active attacker.

    Confidentiality: 2.
    Encryption to a known recipient, forward secrecy for sender compromise
    only, vulnerable to replay.  This payload is encrypted based only on DHs
    involving the recipient's static key pair.  If the recipient's static
    private key is compromised, even at a later date, this payload can be
    decrypted.  This message can also be replayed, since there's no ephemeral
    contribution from the recipient.

    "e": Alice generates a new ephemeral key pair and stores it in the e
         variable, writes the ephemeral public key as cleartext into the
         message buffer, and hashes the public key along with the old h to
         derive a new h.

    "es": A DH is performed between the Alice's ephemeral key pair and the
          Bob's static key pair.  The result is hashed along with the old ck to
          derive a new ck and k, and n is set to zero.




  ```




### تشفير الرد

تُنشأ سجلات رد البناء بواسطة منشئ النقاط وتُشفّر بشكل متماثل إلى المنشئ.
يشمل التشفير المتماثل لسجلات الرد حاليًا AES مع فحص SHA-256 مضاف مسبقًا.
يتضمن فحص SHA-256. هذا التصميم ليس سريًا للأمام.

سيستخدم التصميم الجديد ChaCha20/Poly1305 AEAD لتحقيق النزاهة والمصادقة.

### التبرير

لا يحتاج المفتاح المؤقت في الطلب إلى أن يتم تغليفه باستخدام AES أو Elligator2. النقطة السابقة هي الوحيدة التي يمكنها رؤيته، وتلك النقطة تعرف أن النقطة التالية هي ECIES.

لا تتطلب سجلات الرد تشفيرًا غير متناظر كامل مع DH آخر.

## المواصفات

### سجلات طلب البناء

تكون سجلات BuildRequestRecords المشفرة 528 بايت لكل من ElGamal وECIES، لأغراض التوافق.

سجل الطلب غير المشفر (ElGamal)
```````````````````````````````````````

للمراجعة، هذا هو المواصفات الحالية لـ tunnel BuildRequestRecord لأجهزة توجيه ElGamal، مأخوذ من [I2NP](/en/docs/spec/i2np/).
يتم إضافة بايت غير صفري وهش البيانات (SHA-256) إلى البيانات غير المشفرة قبل التشفير،
كما هو معرف في [Cryptography](/en/docs/spec/cryptography/).

كل الحقول بتسلسل كبير.

الحجم غير المشفر: 222 بايت

  ```dataspec


bytes     0-3: tunnel ID للاستقبال، غير صفري
  bytes    4-35: hash هوية الموجه المحلي
  bytes   36-39: ID النفق التالي، غير صفري
  bytes   40-71: hash هوية الموجه التالي
  bytes  72-103: مفتاح الطبقة AES-256 للنفق
  bytes 104-135: مفتاح IV AES-256 للنفق
  bytes 136-167: مفتاح الرد AES-256
  bytes 168-183: IV الرد AES-256
  byte      184: الأعلام
  bytes 185-188: وقت الطلب (بالساعات منذ العصر، مستديرًا للأسفل)
  bytes 189-192: معرف الرسالة التالية
  bytes 193-221: ملء عشوائي / غير مفسر




  ```


سجل الطلب المشفر (ElGamal)
`````````````````````````````````````

للمراجعة، هذا هو المواصفات الحالية لـ tunnel BuildRequestRecord لأجهزة توجيه ElGamal، مأخوذ من [I2NP](/en/docs/spec/i2np/).

الحجم المشفر: 528 بايت

  ```dataspec


bytes    0-15: hash هوية الموجه المقتطع
  bytes  16-528: سجل BuildRequestRecord مشفر بـ ElGamal




  ```




سجل الطلب غير المشفر (ECIES)
```````````````````````````````````````

هذا هو المواصفات المقترحة لـ tunnel BuildRequestRecord لأجهزة توجيه ECIES-X25519.
ملخص التغييرات:

- إزالة hash الموجه غير المستخدم بطول 32 بايت
- تغيير وقت الطلب من الساعات إلى الدقائق
- إضافة حقل انتهاء الصلاحية للوقت المتغير المستقبلي للنفق
- توفير مساحة أكبر للأعلام
- إضافة Mapping لخيارات البناء الإضافية
- مفتاح وIV الرد AES-256 غير مستخدمان للرد الخاص بالنقطة
- سجل غير مشفر أطول نظرًا لوجود تشفير أقل

لا يحتوي سجل الطلب على أي مفاتيح رد ChaCha.
تشتق تلك المفاتيح من KDF. اطلع على التفاصيل أدناه.

كل الحقول بتسلسل كبير.

الحجم غير المشفر: 464 بايت

  ```dataspec


bytes     0-3: معرف النفق لاستقبال الرسائل، غير صفري
  bytes     4-7: معرف النفق التالي، غير صفري
  bytes    8-39: hash هوية الموجه التالي
  bytes   40-71: مفتاح الطبقة AES-256 للنفق
  bytes  72-103: مفتاح IV AES-256 للنفق
  bytes 104-135: مفتاح الرد AES-256
  bytes 136-151: IV الرد AES-256
  byte      152: الأعلام
  bytes 153-155: مزيد من الأعلام، غير مستخدمة، تعيينها إلى 0 للتوافق
  bytes 156-159: وقت الطلب (بالدقائق منذ العصر، مستديرًا للأسفل)
  bytes 160-163: انتهاء طلب (بالثواني منذ الإنشاء)
  bytes 164-167: معرف الرسالة التالية
  bytes   168-x: خيارات البناء للنفق (Mapping)
  bytes     x-x: بيانات أخرى كما هو مفترض بواسطة الأعلام أو الخيارات
  bytes   x-463: ملء عشوائي




  ```

حقل الأعلام هو نفس ما تم تعريفه في [Tunnel-Creation](/en/docs/spec/tunnel-creation/) ويحتوي على:

 ترتيب البت: 76543210 (البت السابع هو الأكثر أهمية)
 البت 7: إذا تم تحديده، السماح بالرسائل من أي شخص
 البت 6: إذا تم تحديدها، السماح بالرسائل إلى أي شخص، وإرسال الرد إلى
        النقطة التالية المحددة في رسالة بناء النفق
 البتات 5-0: غير معرف، يجب تعيينها إلى 0 للتوافق مع الخيارات المستقبلية

تشير البت 7 إلى أن النقطة ستكون بوابة واردة (IBGW). يشير البت 6
إلى أن النقطة ستكون نقطة نهاية صادرة (OBEP). إذا لم يتم تعيين أي منهما،
ستكون النقطة عبارة عن مشارك وسيط. لا يمكن تعيين كلاهما في وقت واحد.

الانتهاء من الطلب هو لوقت النفق المتغير المستقبلي.
في الوقت الحاضر، القيمة المدعومة الوحيدة هي 600 (10 دقائق).

خيارات بناء النفق هي بنية Mapping كما هو معرف في [Common](/en/docs/spec/common-structures/).
هذا للاستخدام المستقبلي. لا توجد خيارات معرفة حاليًا.
إذا كانت بنية Mapping فارغة، فهذا يعني وجود بايتين 0x00 0x00.
الحجم الأقصى لـ Mapping (بما في ذلك حقل الطول) هو 296 بايت،
وأقصى قيمة لحقل طول Mapping هي 294.

سجل الطلب المشفر (ECIES)
`````````````````````````````````````

كل الحقول بتسلسل كبير باستثناء المفتاح العام المؤقت الذي بترتيب صغير.

الحجم المشفر: 528 بايت

  ```dataspec


bytes    0-15: hash هوية الموجه المقتطع
  bytes   16-47: المفتاح العام المؤقت للمرسل X25519
  bytes  48-511: سجل BuildRequestRecord مشفر بـ ChaCha20
  bytes 512-527: MAC بـ Poly1305




  ```


### سجلات الرد للبناء

تكون سجلات BuildReplyRecords المشفرة 528 بايت لكل من ElGamal وECIES، لأغراض التوافق.

سجل الرد غير المشفر (ElGamal)
`````````````````````````````````````
تُشفّر ردود ElGamal باستخدام AES.

كل الحقول بتسلسل كبير.

الحجم غير المشفر: 528 بايت

  ```dataspec


bytes   0-31: هاش SHA-256 للبايتات 32-527
  bytes 32-526: بيانات عشوائية
  byte     527: الرد

  الطول الإجمالي: 528




  ```


سجل الرد غير المشفر (ECIES)
`````````````````````````````````````
هذا هو المواصفة المقترحة لـ tunnel BuildReplyRecord لأجهزة توجيه ECIES-X25519.
تلخيص التغييرات:

- إضافة Mapping لخيارات الرد للبناء
- سجل غير مشفر أطول نظرًا لوجود تشفير أقل

تُشفّر ردود ECIES باستخدام ChaCha20/Poly1305.

كل الحقول بتسلسل كبير.

الحجم غير المشفر: 512 بايت

  ```dataspec


bytes    0-x: خيارات الرد لبناء النفق (Mapping)
  bytes    x-x: بيانات أخرى كما هو مفترض بواسطة الخيارات
  bytes  x-510: ملء عشوائي
  byte     511: بايت الرد




  ```

خيارات الرد لبناء النفق هي بنية Mapping كما هو معرف في [Common](/en/docs/spec/common-structures/).
هذا للاستخدام المستقبلي. لا توجد خيارات معرفة حاليًا.
إذا كانت بنية Mapping فارغة، فهذا هو بايتين 0x00 0x00.
الحجم الأقصى لـ Mapping (بما في ذلك حقل الطول) هو 511 بايت،
وأقصى قيمة لحقل طول Mapping هي 509.

البايت الرد هو أحد القيم التالية
كما هو معرف في [Tunnel-Creation](/en/docs/spec/tunnel-creation/) لتجنب البصمة:

- 0x00 (قبول)
- 30 (TUNNEL_REJECT_BANDWIDTH)

سجل الرد المشفر (ECIES)
```````````````````````````````````

الحجم المشفر: 528 بايت

  ```dataspec


bytes   0-511: سجل BuildReplyRecord مشفر بـ ChaCha20
  bytes 512-527: MAC بـ Poly1305




  ```

بعد الانتقال الكامل إلى سجلات ECIES، تكون قواعد الملء النطاقي هي نفسها بالنسبة لسجلات الطلب.

### التشفير المتماثل للسجلات

تُسمح الأنفاق المختلطة، وهي ضرورية، للانتقال من ElGamal إلى ECIES.
خلال فترة الانتقال، ستكون هناك زيادة في عدد أجهزة التوجيه المجهزة بمفاتيح ECIES.

ستعمل المعالجة المسبقة للتشفير المتماثل بنفس الطريقة:

- "التشفير":

  - الشيفرة تعمل في وضع فك التشفير
  - يتم فك التشفير الاستباقي لسجلات الطلب أثناء المعالجة المسبقة (إخفاء سجلات الطلب المشفرة)

- "فك التشفير":

  - الشيفرة تعمل في وضع التشفير
  - يتم تشفير سجلات الطلب (إظهار سجل الطلب العادي التالي) بواسطة النقاط المشاركة

- ChaCha20 لا يحتوي على "أوضاع"، لذا يتم تشغيله ثلاث مرات:

  - مرة واحدة في المعالجة المسبقة
  - مرة واحدة بواسطة النقطة
  - مرة واحدة في المعالجة النهائية للرد

عندما تُستخدم الأنفاق المختلطة، يحتاج منشئو الأنفاق إلى بناء التشفير المتماثل
لـ BuildRequestRecord استنادًا إلى نوع التشفير الحالي للنقطة السابقة.

سيستخدم كل نقطة نوع التشفير الخاص بها لتشفير BuildReplyRecords، والسجلات الأخرى في رسالة VariableTunnelBuildMessage (VTBM).

في مسار الرد، سيحتاج الطرف الرئيسي (المرسل) إلى إلغاء [Multiple-Encryption](https://en.wikipedia.org/wiki/Multiple_encryption), باستخدام مفتاح الرد الخاص بكل نقطة.

كمثال توضيحي، دعونا نلقي نظرة على نفق خارجي مع ECIES محاطة بـ ElGamal:

- مرسل (OBGW) -> ElGamal (H1) -> ECIES (H2) -> ElGamal (H3)

كل سجلات BuildRequestRecords تكون في حالتها المشفرة (باستخدام ElGamal أو ECIES).

شيفرة AES256/CBC، عند استخدامها، لا تزال تُستخدم لكل سجل، بدون سلسلة عبر سجلات متعددة.

بالمثل، سيُستخدم ChaCha20 لتشفير كل سجل، وليس بتدفق عبر VTBM بأكمله.

تُعالج مسبقًا سجلات الطلب بواسطة المرسل (OBGW):

- يتم "تشفير" سجل H3 باستخدام:

  - مفتاح الرد لـ H2 (ChaCha20)
  - مفتاح الرد لـ H1 (AES256/CBC)

- يتم "تشفير" سجل H2 باستخدام:

  - مفتاح الرد لـ H1 (AES256/CBC)

- يخرج سجل H1 بدون تشفير متماثل

فقط H2 تدقق علم التشفير الرد، وترى انه متبوع بـ AES256/CBC.

بعد أن تتم معالجته بواسطة كل نقطة، تكون السجلات في حالة "فك التشفير":

- يتم "فك تشفير" سجل H3 باستخدام:

  - مفتاح الرد لـ H3 (AES256/CBC)

- يتم "فك تشفير" سجل H2 باستخدام:

  - مفتاح الرد لـ H3 (AES256/CBC)
  - مفتاح الرد لـ H2 (ChaCha20-Poly1305)

- يتم "فك تشفير" سجل H1 باستخدام:

  - مفتاح الرد لـ H3 (AES256/CBC)
  - مفتاح الرد لـ H2 (ChaCha20)
  - مفتاح الرد لـ H1 (AES256/CBC)

يقوم منشئ النفق، المعروف باسم النهاية الداخلة (IBEP)، بمعالجة الرد في النهاية:

- يتم "إعادة تشفير" سجل H3 باستخدام:

  - مفتاح الرد لـ H3 (AES256/CBC)

- يتم "إعادة تشفير" سجل H2 باستخدام:

  - مفتاح الرد لـ H3 (AES256/CBC)
  - مفتاح الرد لـ H2 (ChaCha20-Poly1305)

- يتم "إعادة تشفير" سجل H1 باستخدام:

  - مفتاح الرد لـ H3 (AES256/CBC)
  - مفتاح الرد لـ H2 (ChaCha20)
  - مفتاح الرد لـ H1 (AES256/CBC)


### مفاتيح سجل الطلب (ECIES)

تُتضمن هذه المفاتيح بشكل صريح في سجلات ElGamal BuildRequestRecords.
بالنسبة لسجلات ECIES BuildRequestRecords، تُتضمن مفاتيح النفق ومفاتيح الرد AES،
لكن مفاتيح الرد ChaCha تشتق من تبادل DH.
اطلع على [Prop156](/en/proposals/156-ecies-routers/) للحصول على تفاصيل مفاتيح التوجيه الثابتة لـ ECIES.

فيما يلي وصف لكيفية اشتقاق المفاتيح التي كانت تُرسل سابقاً في سجلات الطلب.


KDF للمفتاح ck و h الأولي
````````````````````````

هذا هو [NOISE](https://noiseprotocol.org/noise.html) القياسي للنمط "N" مع اسم بروتوكول قياسي.

  ```text

هذا هو نمط الرسالة "e":

  // تعريف protocol_name.
  تعيين protocol_name = "Noise_N_25519_ChaChaPoly_SHA256"
  (31 بايت، مُرمز ASCII، لا يوجد إنهاء NULL).

  // تعريف Hash h = 32 بايت
  // ملء حتى 32 بايت. لا تُجر حقًا، لأنها ليست أكثر من 32 بايت.
  h = protocol_name || 0

  تعريف ck = المفتاح المتسلسل بطول 32 بايت. نسخ بيانات h إلى ck.
  تعيين chainKey = h

  // MixHash(null prologue)
  h = SHA256(h);

  // حتى هذه النقطة، يمكن حساب كل ذلك مسبقاً بواسطة جميع أجهزة التوجيه.




  ```


KDF لسجل الطلب
````````````````````````

يُنشئ منشئو نفق ElGamal زوج مفاتيح X25519 مؤقت لكل
نقطة ECIES في النفق، ويستخدم المخطط أعلاه لتشفير BuildRequestRecord الخاصة بهم.
سيستخدم منشئو نفق ElGamal المخطط ما قبل هذا المواصفات للتشفير إلى نقاط ElGamal.

سيحتاج منشئو الأنفاق ECIES إلى التشفير إلى المفتاح العام لنقطة ElGamal باستخدام
المخطط الذي تم تعريفه في [Tunnel-Creation](/en/docs/spec/tunnel-creation/). سيستخدم منشئو الأنفاق ECIES المخطط أعلاه للتشفير
إلى نقاط ECIES.

هذا يعني أن نقاط النفق ستشاهد فقط سجلات مشفرة من نفس نوع التشفير.

بالنسبة لمنشئي الأنفاق ElGamal وECIES، سيُنشئون أزواج مفاتيح مؤقتة فريدة
لكل نقطة ECIES للتشفير إليها.

**هام**:
يجب أن تكون المفاتيح المؤقتة فريدة لكل نقطة ECIES ولكل سجل بناء.
فشل استخدام المفاتيح الفريدة يفتح مجالًا لهجوم النقاط المتواطئة لتأكيد أنها في نفس النفق.

  ```dataspec


// يتحصل كل نقطة على زوج مفاتيح X25519 ثابتة (hesk، hepk) من هوية الموجه
  hesk = GENERATE_PRIVATE()
  hepk = DERIVE_PUBLIC(hesk)

  // MixHash(hepk)
  // || أدناه يعني إلحاق
  h = SHA256(h || hepk);

  // حتى هذه النقطة، يمكن حساب كل ذلك مسبقاً بواسطة كل موجه
  // لجميع الطلبات البناء الواردة

  // يُنشئ المرسل زوج مفاتيح X25519 مؤقت لكل نقطة ECIES في VTBM (sesk، sepk)
  sesk = GENERATE_PRIVATE()
  sepk = DERIVE_PUBLIC(sesk)

  // MixHash(sepk)
  h = SHA256(h || sepk);

  نهاية نمط الرسالة "e".

  هذا هو نمط الرسالة "es":

  // Noise es
  // يقوم المرسل بتنفيذ X25519 DH باستخدام المفتاح العام الثابت للنقطة.
  // يجد كل نقطة، السجل المشتمل على hash هويتهم المقتطع،
  // ويستخرج المفتاح المؤقت للمرسل الذي يسبق السجل المشفر.
  sharedSecret = DH(sesk، hepk) = DH(hesk، sepk)

  // MixKey(DH())
  //[chainKey، k] = MixKey(sharedSecret)
  // معلمات ChaChaPoly للتشفير/فك التشفير
  keydata = HKDF(chainKey، sharedSecret، ""، 64)
  // حفظ لـ طلب رد KDF
  chainKey = keydata[0:31]

  // معلمات AEAD
  k = keydata[32:63]
  n = 0
  plaintext = 464 بايت سجل الطلب البناء
  ad = h
  ciphertext = ENCRYPT(k، n، plaintext، ad)

  نهاية نمط الرسالة "es".

  // MixHash(ciphertext)
  // حفظ لـ طلب رد KDF
  h = SHA256(h || ciphertext)




  ```

"replyKey"، "layerKey" و "layerIV" لا تزال يجب تضمينها داخل سجلات ElGamal،
ويمكن توليدها عشوائيًا.


### تشفير سجل الطلب (ElGamal)

كما هو معرف في [Tunnel-Creation](/en/docs/spec/tunnel-creation/).
لا توجد تغييرات على التشفير لنقاط ElGamal.


### تشفير سجل الرد (ECIES)

الرد يُشفّر باستخدام ChaCha20/Poly1305.

  ```dataspec


// معلمات AEAD
  k = chainkey من طلب البناء
  n = 0
  plaintext = 512 بايت سجل الرد للبناء
  ad = h من طلب البناء

  ciphertext = ENCRYPT(k، n، plaintext، ad)




  ```

### تشفير سجل الرد (ElGamal)

كما هو معرف في [Tunnel-Creation](/en/docs/spec/tunnel-creation/).
لا توجد تغييرات على التشفير لنقاط ElGamal.


### تحليل أمني

ElGamal لا يوفر السرية الأمامية لرسائل بناء النفق.

AES256/CBC في وضع أفضل قليلاً، بكونه فقط عُرضة لهجوم إضعاف نظري باستخدام هجوم `biclique` ذاته.

الهجوم العملي الوحيد المعروف ضد AES256/CBC هو هجوم oracle padding، عندما تكون IV معروفة للمهاجم.

يحتاج المهاجم إلى اختراق تشفير ElGamal للنقطة التالية للحصول على معلومات مفتاح AES256/CBC (مفتاح الرد وIV).

ElGamal أكثر إرهاقًا لوحدة المعالجة المركزية من ECIES، مما يؤدي إلى إمكانية استنفاد الموارد.

يوفر ECIES، عند استخدامه مع مفاتيح جديدة مؤقتة لكل BuildRequestRecord أو VariableTunnelBuildMessage، السرية الأمامية.

يوفر ChaCha20Poly1305 تشفير AEAD، مما يتيح للمستلم التحقق من سلامة الرسالة قبل محاولة فك التشفير.

## التبرير

يُعظّم هذا التصميم إعادة استخدام البدائل التشفيرية، والبروتوكولات، والكود الموجودة.
يُقلّل هذا التصميم من المخاطر.

## ملاحظات التنفيذ

* لا تقوم أجهزة التوجيه القديمة بفحص نوع التشفير للنقطة وسترسل سجلات مشفرة بـ ElGamal.
  بعض أجهزة التوجيه الحديثة ليست صحيحة وسترسل أنواعًا مختلفة من السجلات غير الصحيحة.
  يجب على المنفذين اكتشاف ورفض هذه السجلات قبل عملية DH
  إن أمكن، لتقليل استخدام وحدة المعالجة المركزية.

## قضايا

## الانتقال

راجع [Prop156](/en/proposals/156-ecies-routers/).
