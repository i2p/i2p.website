---
title: "توجيه الأنفاق"
description: "نظرة عامة على مصطلحات tunnel في I2P، وبنائها، ودورة حياتها"
slug: "tunnel-routing"
lastUpdated: "2025-10"
accurateFor: "2.10.0"
---

## نظرة عامة

يبني I2P أنفاقًا مؤقتة أحادية الاتجاه — تسلسلات مرتبة من routers التي تعيد توجيه حركة البيانات المشفرة. تُصنّف tunnels على أنها **inbound** (تتدفق الرسائل نحو المنشئ) أو **outbound** (تتدفق الرسائل بعيدًا عن المنشئ).

يقوم التبادل النموذجي بتوجيه رسالة أليس عبر أحد أنفاقها الصادرة (outbound tunnels)، ثم يوجه نقطة النهاية الصادرة لإعادة توجيهها إلى بوابة أحد أنفاق بوب الواردة (inbound tunnels)، وبعد ذلك يستقبلها بوب عند نقطة النهاية الواردة الخاصة به.

![أليس تتصل عبر نفق الصادر الخاص بها إلى بوب عبر نفق الوارد الخاص به](/images/tunnelSending.png)

- **A**: Outbound Gateway (أليس)
- **B**: Outbound Participant
- **C**: Outbound Endpoint
- **D**: Inbound Gateway
- **E**: Inbound Participant
- **F**: Inbound Endpoint (بوب)

تمتلك الأنفاق عمرًا افتراضيًا ثابتًا مدته 10 دقائق وتحمل رسائل ذات حجم ثابت يبلغ 1024 بايت (1028 بايت بما في ذلك رأس النفق) لمنع تحليل حركة المرور بناءً على حجم الرسالة أو أنماط التوقيت.

## مفردات النفق

- **Tunnel gateway:** أول router في النفق. بالنسبة للأنفاق الواردة، تظهر هوية هذا الـ router في [LeaseSet](/docs/specs/common-structures/) المنشور. بالنسبة للأنفاق الصادرة، الـ gateway هو الـ router المصدر (A و D أعلاه).
- **Tunnel endpoint:** آخر router في النفق (C و F أعلاه).
- **Tunnel participant:** router وسيط في النفق (B و E أعلاه). لا يمكن للمشاركين تحديد موقعهم أو اتجاه النفق.
- **n-hop tunnel:** عدد القفزات بين الـ routers.
  - **0-hop:** الـ gateway والـ endpoint هما نفس الـ router - إخفاء هوية ضئيل.
  - **1-hop:** الـ gateway يتصل مباشرة بالـ endpoint - زمن استجابة منخفض، إخفاء هوية منخفض.
  - **2-hop:** الإعداد الافتراضي للأنفاق الاستكشافية؛ توازن بين الأمان والأداء.
  - **3-hop:** موصى به للتطبيقات التي تتطلب إخفاء هوية قوي.
- **Tunnel ID:** عدد صحيح من 4 بايتات فريد لكل router ولكل قفزة، يتم اختياره عشوائياً من قبل المنشئ. تستقبل كل قفزة وتُعيد التوجيه على معرفات مختلفة.

## معلومات بناء النفق

أجهزة التوجيه (routers) التي تملأ أدوار gateway وparticipant وendpoint تستقبل سجلات مختلفة ضمن رسالة بناء النفق (Tunnel Build Message). يدعم I2P الحديث طريقتين:

- **ElGamal** (قديم، سجلات بحجم 528 بايت)
- **ECIES-X25519** (حالي، سجلات بحجم 218 بايت عبر Short Tunnel Build Message – STBM)

### Information Distributed to Participants

**يستقبل البوابة:** - مفتاح طبقة النفق (مفتاح AES-256 أو ChaCha20 حسب نوع النفق) - مفتاح IV للنفق (لتشفير متجهات التهيئة) - مفتاح الرد و IV الرد (لتشفير رد البناء) - معرّف النفق (للبوابات الواردة فقط) - hash هوية القفزة التالية ومعرّف النفق (إذا لم يكن طرفياً)

**المشاركون الوسيطون يتلقون:** - مفتاح طبقة tunnel ومفتاح IV للقفزة الخاصة بهم - معرف tunnel ومعلومات القفزة التالية - مفتاح الرد و IV لتشفير استجابة البناء

**تستقبل النقاط النهائية:** - مفاتيح طبقة tunnel ومفاتيح IV - router الرد ومعرف tunnel (النقاط النهائية الصادرة فقط) - مفتاح الرد ومفتاح IV (النقاط النهائية الصادرة فقط)

للحصول على التفاصيل الكاملة، راجع [مواصفات إنشاء Tunnel](/docs/specs/implementation/) و[مواصفات إنشاء Tunnel باستخدام ECIES](/docs/specs/implementation/).

## Tunnel Pooling

تقوم routers بتجميع tunnels في **مجموعات tunnels** (tunnel pools) لتحقيق التكرار وتوزيع الحمل. تحافظ كل مجموعة على عدة tunnels متوازية، مما يسمح بالتبديل التلقائي عند فشل أحدها. المجموعات المستخدمة داخلياً هي **exploratory tunnels**، بينما المجموعات الخاصة بالتطبيقات هي **client tunnels**.

تحتفظ كل وجهة بمجموعات منفصلة للاتصالات الواردة والصادرة يتم تكوينها بواسطة خيارات I2CP (عدد الأنفاق، عدد النسخ الاحتياطية، الطول، ومعاملات جودة الخدمة). تراقب الموجهات صحة الأنفاق، وتجري اختبارات دورية، وتعيد بناء الأنفاق الفاشلة تلقائياً للحفاظ على حجم المجموعة.

## تجميع الأنفاق (Tunnel Pooling)

**أنفاق 0-hop**: توفر فقط إمكانية الإنكار المعقول. تنشأ حركة البيانات وتنتهي دائمًا عند نفس الموجه — لا يُنصح بها لأي استخدام مجهول.

**أنفاق ذات قفزة واحدة (1-hop Tunnels)**: توفر إخفاء هوية أساسي ضد المراقبين السلبيين لكنها عرضة للخطر إذا سيطر خصم على تلك القفزة الوحيدة.

**أنفاق ثنائية القفزات (2-hop Tunnels)**: تتضمن جهازي توجيه بعيدين وتزيد بشكل كبير من تكلفة الهجوم. الإعداد الافتراضي لمجمعات الاستكشاف.

**أنفاق 3 قفزات**: موصى بها للتطبيقات التي تتطلب حماية قوية لإخفاء الهوية. القفزات الإضافية تزيد من زمن الاستجابة دون تحقيق فائدة أمنية ملموسة.

**الإعدادات الافتراضية**: تستخدم الـ routers أنفاق استكشافية بـ **قفزتين** وأنفاق عميل خاصة بالتطبيقات بـ **قفزتين أو 3 قفزات**، لتحقيق التوازن بين الأداء وعدم الكشف عن الهوية.

## طول النفق

تختبر الـ routers الأنفاق بشكل دوري عن طريق إرسال رسالة `DeliveryStatusMessage` عبر نفق صادر إلى نفق وارد. إذا فشل الاختبار، يتلقى كلا النفقين وزناً سلبياً في الملف الشخصي. تؤدي الإخفاقات المتتالية إلى تمييز النفق على أنه غير قابل للاستخدام؛ ثم يقوم الـ router بإعادة بناء بديل ونشر LeaseSet جديد. تُغذي النتائج مقاييس سعة الأقران المستخدمة بواسطة [نظام اختيار الأقران](/docs/overview/tunnel-routing/).

## اختبار الأنفاق

تقوم أجهزة الـ router ببناء الأنفاق (tunnels) باستخدام طريقة **تلسكوبية** غير تفاعلية: حيث تنتشر رسالة بناء النفق الواحدة (Tunnel Build Message) من قفزة إلى أخرى. تقوم كل قفزة بفك تشفير سجلها، وإضافة ردها، وإعادة توجيه الرسالة. تُرجع القفزة النهائية رد البناء المجمّع عبر مسار مختلف، مما يمنع الربط بينها. تستخدم التطبيقات الحديثة **رسائل بناء النفق القصيرة (Short Tunnel Build Messages - STBM)** لـ ECIES و**رسائل بناء النفق المتغيرة (Variable Tunnel Build Messages - VTBM)** للمسارات القديمة. يتم تشفير كل سجل لكل قفزة باستخدام ElGamal أو ECIES-X25519.

## إنشاء النفق

يستخدم حركة المرور عبر الأنفاق التشفير متعدد الطبقات. تضيف أو تزيل كل نقطة قفز طبقة من التشفير أثناء عبور الرسائل عبر النفق.

- **أنفاق ElGamal:** AES-256/CBC للبيانات مع حشوة PKCS#5.
- **أنفاق ECIES:** ChaCha20 أو ChaCha20-Poly1305 للتشفير المصادق عليه.

كل قفزة (hop) لها مفتاحان: **مفتاح الطبقة** (layer key) و **مفتاح IV**. تقوم الموجهات (routers) بفك تشفير IV، واستخدامه لمعالجة الحمولة (payload)، ثم إعادة تشفير IV قبل الإعادة. يمنع نظام IV المزدوج هذا وضع العلامات على الرسائل (message tagging).

بوابات الخروج (Outbound gateways) تفك تشفير جميع الطبقات مسبقاً بحيث تستقبل نقاط النهاية النص الواضح بعد أن يضيف جميع المشاركين التشفير. أنفاق الدخول (Inbound tunnels) تشفر في الاتجاه المعاكس. لا يستطيع المشاركون تحديد اتجاه النفق أو طوله.

## تشفير الأنفاق

- أوقات حياة النفق الديناميكية وتحديد حجم المجموعة التكيفي لموازنة حمل الشبكة
- استراتيجيات اختبار النفق البديلة وتشخيصات القفزة الفردية
- التحقق الاختياري من إثبات العمل أو شهادة النطاق الترددي (مُنفَّذ في API 0.9.65+)
- تشكيل حركة المرور وبحث إدراج البيانات الوهمية لخلط نقاط النهاية
- الاستمرار في إيقاف ElGamal والترحيل إلى ECIES-X25519

## التطوير المستمر

- [مواصفات تنفيذ Tunnel](/docs/specs/implementation/)
- [مواصفات إنشاء Tunnel (ElGamal)](/docs/specs/implementation/)
- [مواصفات إنشاء Tunnel (ECIES-X25519)](/docs/specs/implementation/)
- [مواصفات رسائل Tunnel](/docs/specs/implementation/)
- [Garlic Routing](/docs/overview/garlic-routing/)
- [قاعدة بيانات شبكة I2P](/docs/specs/common-structures/)
- [تحليل واختيار النظراء](/docs/overview/tunnel-routing/)
- [نموذج التهديدات I2P](/docs/overview/threat-model/)
- [تشفير ElGamal/AES + SessionTag](/docs/legacy/elgamal-aes/)
- [خيارات I2CP](/docs/specs/i2cp/)
