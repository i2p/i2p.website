<!DOCTYPE html>
<html lang="en" data-theme="light">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Encrypted LeaseSet | I2P - The Invisible Internet Project</title>

    <meta name="description" content="Access-controlled LeaseSet format for private Destinations">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="Encrypted LeaseSet | I2P - The Invisible Internet Project">
    <meta property="og:description" content="Access-controlled LeaseSet format for private Destinations">
    <meta property="og:type" content="website">
    <meta property="og:url" content="//localhost:1313/en/docs/specs/encryptedleaseset/">

    
    <link rel="icon" type="image/png" href="../../../../images/i2plogo.png">

    
    
    
        
        <link rel="stylesheet" href="../../../../css/main.min.css">
    

    
    <link rel="stylesheet" href="https://feedback.stormycloud.org/widgets/styles.css">

    
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    
    <script>(function(w,d,s,n,a){if(!w[n]){var l='call,catch,on,once,set,then,track,openCheckout'
    .split(','),i,o=function(n){return'function'==typeof n?o.l.push([arguments])&&o
    :function(){return o.l.push([n,arguments])&&o}},t=d.getElementsByTagName(s)[0],
    j=d.createElement(s);j.async=!0;j.src='https://cdn.fundraiseup.com/widget/'+a+'';
    t.parentNode.insertBefore(j,t);o.s=Date.now();o.v=5;o.h=w.location.href;o.l=[];
    for(i=0;i<8;i++)o[l[i]]=o(l[i]);w[n]=o}
    })(window,document,'script','FundraiseUp','AAYKECHT');</script>
    

    
</head>
<body>
    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../en/" class="logo-link">
                    <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <button class="mobile-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
                <span class="hamburger"></span>
            </button>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../en/about/" class="">About</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../en/about/">Overview</a></li>
                            <li><a href="../../../../en/papers/">Research Papers</a></li>
                            <li><a href="../../../../en/about/media/">Press</a></li>
                            <li><a href="../../../../en/contact/">Contact Us</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../en/docs/" class="active">Docs</a></li>
                    <li><a href="../../../../en/downloads/" class="">Downloads</a></li>
                    <li><a href="../../../../en/blog/" class="">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../en/get-involved/" class="">Get Involved</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../en/get-involved/">Overview</a></li>
                            <li><a href="../../../../en/feedback/">Feature Suggestions</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span class="current-lang">en</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                                
                                
                                
                                    
                                    <a href="../../../../en/docs/specs/encryptedleaseset/" class="lang-option active">English</a>
                                
                            
                                
                                
                                
                                    <a href="../../../../es/" class="lang-option">Español</a>
                                
                            
                                
                                
                                
                                    <a href="../../../../ko/" class="lang-option">한국어</a>
                                
                            
                                
                                
                                
                                    <a href="../../../../de/" class="lang-option">Deutsch</a>
                                
                            
                        </div>
                    </div>

                    
                    <button class="theme-toggle" aria-label="Toggle dark mode" title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2"/>
                            <path d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </button>

                    
                    <a href="#XTLSAXYD" style="display: none"></a>

                    
                    <a href="../../../../en/downloads/" class="btn btn-primary">Get I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>


    <main id="main-content">
        



<div class="docs-page">
    <div class="container">
        <div class="docs-layout">
            
            
            <aside class="docs-sidebar">
    <div class="sidebar-header">
        <a href="../../../../en/docs/" class="sidebar-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Documentation
        </a>
    </div>

    <nav class="sidebar-nav">
        <div class="nav-section">
            <div class="nav-section-title">Overview</div>
            <a href="../../../../en/docs/overview/intro/" class="nav-link">Introduction to I2P</a>
            <a href="../../../../en/docs/overview/tech-intro/" class="nav-link">Technical Introduction</a>
            <a href="../../../../en/docs/overview/faq/" class="nav-link">Frequently Asked Questions</a>
            <a href="../../../../en/docs/overview/comparison/" class="nav-link">Comparisons</a>
            <a href="../../../../en/docs/overview/threat-model/" class="nav-link">Threat Model</a>
            <a href="../../../../en/docs/overview/alternative-clients/" class="nav-link">Alternative I2P Clients</a>
            <a href="../../../../en/docs/overview/performance/" class="nav-link">Performance</a>
            <a href="../../../../en/docs/overview/restrictive-countries/" class="nav-link">Strict/Restrictive Countries</a>
            <a href="../../../../en/docs/overview/naming/" class="nav-link">Naming &amp; Address Book</a>
            <a href="../../../../en/docs/overview/tunnel-routing/" class="nav-link">Tunnel Routing</a>
            <a href="../../../../en/docs/overview/garlic-routing/" class="nav-link">Garlic Routing</a>
            <a href="../../../../en/docs/overview/glossary/" class="nav-link">Glossary</a>
            <a href="../../../../en/docs/overview/ports/" class="nav-link">Port Assignments</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Applications</div>
            <a href="../../../../en/docs/applications/managed-clients/" class="nav-link">Managed Clients</a>
            <a href="../../../../en/docs/applications/embedding/" class="nav-link">Embedding the Router</a>
            <a href="../../../../en/docs/applications/bittorrent/" class="nav-link">BitTorrent over I2P</a>
            <a href="../../../../en/docs/applications/irc/" class="nav-link">IRC Clients &amp; Servers</a>
            <a href="../../../../en/docs/applications/git/" class="nav-link">Git over I2P</a>
            <a href="../../../../en/docs/applications/git-bundle/" class="nav-link">Git Bundles</a>
            <a href="../../../../en/docs/guides/gitlab/" class="nav-link">GitLab Hosting</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">APIs</div>
            <a href="../../../../en/docs/api/i2ptunnel/" class="nav-link">I2PTunnel</a>
            <a href="../../../../en/docs/api/samv3/" class="nav-link">SAM v3</a>
            <a href="../../../../en/docs/api/socks/" class="nav-link">SOCKS Proxy</a>
            <a href="../../../../en/docs/api/streaming/" class="nav-link">Streaming Protocol</a>
            <a href="../../../../en/docs/api/datagrams/" class="nav-link">Datagram API</a>
            <a href="../../../../en/docs/api/v3dgsend/" class="nav-link">v3dgsend</a>
            <a href="../../../../en/docs/api/i2pcontrol/" class="nav-link">I2PControl JSON-RPC</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Guides</div>
            <a href="../../../../en/docs/guides/browser-config/" class="nav-link">Web Browser Configuration</a>
            <a href="../../../../en/docs/guides/plugins/" class="nav-link">Plugins Overview</a>
            <a href="../../../../en/docs/guides/ides/" class="nav-link">Using an IDE with I2P</a>
            <a href="../../../../en/docs/guides/creating-an-ssh-tunnel-to-access-i2p-remotely/" class="nav-link">SSH Tunnel to I2P</a>
            <a href="../../../../en/docs/guides/creating-and-running-an-i2p-reseed-server/" class="nav-link">Running a Reseed Server</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Specifications</div>
            <a href="../../../../en/docs/specs/overview/" class="nav-link">Specs Overview</a>
            <a href="../../../../en/docs/specs/streaming/" class="nav-link">Streaming</a>
            <a href="../../../../en/docs/specs/i2cp/" class="nav-link">I2CP</a>
            <a href="../../../../en/docs/specs/i2np/" class="nav-link">I2NP</a>
            <a href="../../../../en/docs/specs/ntcp2/" class="nav-link">NTCP2 Transport</a>
            <a href="../../../../en/docs/specs/ssu2/" class="nav-link">SSU2 Transport</a>
            <a href="../../../../en/docs/specs/ecies/" class="nav-link">ECIES Encryption</a>
            <a href="../../../../en/docs/specs/ecies-hybrid/" class="nav-link">ECIES Hybrid</a>
            <a href="../../../../en/docs/specs/red25519/" class="nav-link">Red25519 Signatures</a>
            <a href="../../../../en/docs/specs/encryptedleaseset/" class="nav-link">Encrypted LeaseSets</a>
            <a href="../../../../en/docs/specs/common-structures/" class="nav-link">Common Structures</a>
            <a href="../../../../en/docs/specs/updates/" class="nav-link">Software Updates</a>
            <a href="../../../../en/docs/specs/plugin/" class="nav-link">Plugin Package Format</a>
            <a href="../../../../en/docs/specs/blockfile/" class="nav-link">Blockfile</a>
            <a href="../../../../en/docs/specs/configuration/" class="nav-link">Router Configuration</a>
            <a href="../../../../en/docs/specs/filter-format/" class="nav-link">Access Filter Format</a>
            <a href="../../../../en/docs/specs/subscription/" class="nav-link">Subscription Feed</a>
            <a href="../../../../en/docs/specs/b32encrypted/" class="nav-link">B32 Encrypted Addresses</a>
            <a href="../../../../en/docs/specs/udp-announces/" class="nav-link">UDP Tracker Announces</a>
            <a href="../../../../en/docs/specs/implementation/" class="nav-link">Implementation Notes</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Developers</div>
            <a href="../../../../en/docs/develop/new-developers/" class="nav-link">New Developers Guide</a>
            <a href="../../../../en/docs/develop/dev-guidelines/" class="nav-link">Development Guidelines</a>
            <a href="../../../../en/docs/develop/applications/" class="nav-link">Application Development</a>
            <a href="../../../../en/docs/develop/new-translators/" class="nav-link">New Translators Guide</a>
            <a href="../../../../en/docs/develop/licenses/" class="nav-link">Software Licenses</a>
            <a href="../../../../en/docs/develop/release-signing-key/" class="nav-link">Release Signing Key</a>
            <a href="../../../../en/docs/develop/security-key/" class="nav-link">Security GPG Key</a>
            <a href="../../../../en/proposals/" class="nav-link">Proposals</a>
            <a href="../../../../en/get-involved/roadmap/" class="nav-link">Project Roadmap</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Legacy Protocols</div>
            <a href="../../../../en/docs/legacy/bob/" class="nav-link">BOB Protocol</a>
            <a href="../../../../en/docs/legacy/sam/" class="nav-link">SAM v1</a>
            <a href="../../../../en/docs/legacy/samv2/" class="nav-link">SAM v2</a>
            <a href="../../../../en/docs/legacy/ssu/" class="nav-link">SSU Transport</a>
            <a href="../../../../en/docs/legacy/elgamal-aes/" class="nav-link">ElGamal/AES Encryption</a>
            <a href="../../../../en/docs/legacy/tunnel/" class="nav-link">Tunnel Spec</a>
            <a href="../../../../en/docs/legacy/unidirectional/" class="nav-link">Unidirectional Tunnels</a>
            <a href="../../../../en/docs/legacy/old-implementation/" class="nav-link">Old Implementation Notes</a>
            <a href="../../../../en/docs/legacy/naming/" class="nav-link">Naming (legacy)</a>
            <a href="../../../../en/docs/legacy/ministreaming/" class="nav-link">Ministreaming</a>
            <a href="../../../../en/docs/legacy/geoip-file-formats/" class="nav-link">GeoIP File Formats</a>
        </div>
    </nav>
</aside>

            

            
            <main class="docs-article">
                
                <nav class="breadcrumbs">
                    <a href="../../../../en/">Home</a>
                    <span class="separator">/</span>
                    
                        <a href="../../../../en/docs/">Docs</a>
                        
                            
                                <span class="separator">/</span>
                                <a href="../../../../en/docs/specs/">Specifications</a>
                            
                        
                        <span class="separator">/</span>
                        <span class="current">Encrypted LeaseSet</span>
                    
                </nav>

                
                <header class="article-header">
                    <h1 class="article-title">Encrypted LeaseSet</h1>
                    
                        <p class="article-description">Access-controlled LeaseSet format for private Destinations</p>
                    
                    <div class="article-meta">
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Updated: 2025-10
                            </span>
                        
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Accurate for: 2.10.0
                            </span>
                        
                    </div>
                </header>

                
                
                <details class="toc">
                    <summary class="toc-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                        <svg class="toc-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </summary>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#version-history-and-implementation-status">Version History and Implementation Status</a>
      <ul>
        <li><a href="#protocol-development-timeline">Protocol Development Timeline</a></li>
        <li><a href="#implementation-milestones">Implementation Milestones</a></li>
        <li><a href="#current-status">Current Status</a></li>
      </ul>
    </li>
    <li><a href="#cryptographic-definitions">Cryptographic Definitions</a>
      <ul>
        <li><a href="#notation-and-conventions">Notation and Conventions</a></li>
        <li><a href="#csrngn">CSRNG(n)</a></li>
        <li><a href="#hp-d">H(p, d)</a></li>
        <li><a href="#stream-chacha20">STREAM: ChaCha20</a></li>
        <li><a href="#sig-red25519">SIG: Red25519</a></li>
        <li><a href="#dh-x25519">DH: X25519</a></li>
        <li><a href="#hkdf">HKDF</a></li>
      </ul>
    </li>
    <li><a href="#format-specification">Format Specification</a>
      <ul>
        <li><a href="#layer-0-outer---plaintext">Layer 0 (Outer) - Plaintext</a></li>
        <li><a href="#layer-1-middle---client-authorization">Layer 1 (Middle) - Client Authorization</a></li>
        <li><a href="#layer-2-inner---leaseset-data">Layer 2 (Inner) - LeaseSet Data</a></li>
      </ul>
    </li>
    <li><a href="#blinding-key-derivation">Blinding Key Derivation</a>
      <ul>
        <li><a href="#overview-1">Overview</a></li>
        <li><a href="#mathematical-definitions">Mathematical Definitions</a></li>
        <li><a href="#alpha-generation">Alpha Generation</a></li>
        <li><a href="#private-key-blinding">Private Key Blinding</a></li>
        <li><a href="#public-key-blinding">Public Key Blinding</a></li>
        <li><a href="#signing-with-blinded-keys">Signing with Blinded Keys</a></li>
        <li><a href="#security-considerations">Security Considerations</a></li>
      </ul>
    </li>
    <li><a href="#encryption-and-processing">Encryption and Processing</a>
      <ul>
        <li><a href="#subcredential-derivation">Subcredential Derivation</a></li>
        <li><a href="#layer-1-encryption">Layer 1 Encryption</a></li>
        <li><a href="#layer-2-encryption">Layer 2 Encryption</a></li>
        <li><a href="#encryption-layer-summary">Encryption Layer Summary</a></li>
      </ul>
    </li>
    <li><a href="#per-client-authorization">Per-Client Authorization</a>
      <ul>
        <li><a href="#overview-2">Overview</a></li>
        <li><a href="#dh-client-authorization">DH Client Authorization</a></li>
        <li><a href="#psk-client-authorization">PSK Client Authorization</a></li>
        <li><a href="#comparison-and-recommendations">Comparison and Recommendations</a></li>
        <li><a href="#security-considerations-1">Security Considerations</a></li>
      </ul>
    </li>
    <li><a href="#base32-addressing-for-encrypted-leasesets">Base32 Addressing for Encrypted LeaseSets</a>
      <ul>
        <li><a href="#overview-3">Overview</a></li>
        <li><a href="#address-format-specification">Address Format Specification</a></li>
        <li><a href="#address-generation">Address Generation</a></li>
        <li><a href="#address-parsing">Address Parsing</a></li>
        <li><a href="#comparison-with-traditional-base32">Comparison with Traditional Base32</a></li>
        <li><a href="#usage-restrictions">Usage Restrictions</a></li>
        <li><a href="#address-book-integration">Address Book Integration</a></li>
        <li><a href="#implementation-examples">Implementation Examples</a></li>
        <li><a href="#security-considerations-2">Security Considerations</a></li>
      </ul>
    </li>
    <li><a href="#offline-keys-support">Offline Keys Support</a>
      <ul>
        <li><a href="#overview-4">Overview</a></li>
        <li><a href="#offline-key-structure">Offline Key Structure</a></li>
        <li><a href="#key-generation-process">Key Generation Process</a></li>
        <li><a href="#router-usage">Router Usage</a></li>
        <li><a href="#security-considerations-3">Security Considerations</a></li>
        <li><a href="#file-format-todo">File Format (TODO)</a></li>
        <li><a href="#i2cp-protocol-enhancement-todo">I2CP Protocol Enhancement (TODO)</a></li>
        <li><a href="#implementation-status">Implementation Status</a></li>
      </ul>
    </li>
    <li><a href="#security-considerations-4">Security Considerations</a>
      <ul>
        <li><a href="#cryptographic-security">Cryptographic Security</a></li>
        <li><a href="#forward-secrecy">Forward Secrecy</a></li>
        <li><a href="#privacy-properties">Privacy Properties</a></li>
        <li><a href="#threat-model">Threat Model</a></li>
        <li><a href="#attack-scenarios">Attack Scenarios</a></li>
        <li><a href="#operational-security">Operational Security</a></li>
        <li><a href="#implementation-security">Implementation Security</a></li>
        <li><a href="#recommendations">Recommendations</a></li>
      </ul>
    </li>
    <li><a href="#implementation-notes">Implementation Notes</a>
      <ul>
        <li><a href="#java-i2p-implementation">Java I2P Implementation</a></li>
        <li><a href="#i2pd-c-implementation">i2pd (C++) Implementation</a></li>
        <li><a href="#testing-and-debugging">Testing and Debugging</a></li>
        <li><a href="#performance-considerations">Performance Considerations</a></li>
        <li><a href="#compatibility">Compatibility</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a>
      <ul>
        <li><a href="#ietf-rfcs">IETF RFCs</a></li>
        <li><a href="#i2p-specifications">I2P Specifications</a></li>
        <li><a href="#cryptographic-references">Cryptographic References</a></li>
        <li><a href="#security-references">Security References</a></li>
        <li><a href="#implementation-references">Implementation References</a></li>
        <li><a href="#version-history">Version History</a></li>
      </ul>
    </li>
    <li><a href="#appendix-a-cryptographic-constants">Appendix A: Cryptographic Constants</a>
      <ul>
        <li><a href="#ed25519--red25519-constants">Ed25519 / Red25519 Constants</a></li>
        <li><a href="#chacha20-constants">ChaCha20 Constants</a></li>
        <li><a href="#hkdf-constants">HKDF Constants</a></li>
        <li><a href="#hash-personalization-strings">Hash Personalization Strings</a></li>
        <li><a href="#structure-sizes">Structure Sizes</a></li>
      </ul>
    </li>
    <li><a href="#appendix-b-test-vectors">Appendix B: Test Vectors</a>
      <ul>
        <li><a href="#test-vector-1-alpha-generation">Test Vector 1: Alpha Generation</a></li>
        <li><a href="#test-vector-2-chacha20-encryption">Test Vector 2: ChaCha20 Encryption</a></li>
        <li><a href="#test-vector-3-hkdf">Test Vector 3: HKDF</a></li>
        <li><a href="#test-vector-4-base32-address">Test Vector 4: Base32 Address</a></li>
      </ul>
    </li>
    <li><a href="#appendix-c-glossary">Appendix C: Glossary</a></li>
    <li><a href="#document-information">Document Information</a></li>
  </ul>
</nav>
                    </div>
                </details>
                

                
                <article class="article-content">
                    <h2 id="overview">Overview</h2>
<p>This document specifies the blinding, encryption, and decryption of encrypted LeaseSet2 (LS2). Encrypted LeaseSets provide access-controlled publication of hidden service information in the I2P network database.</p>
<p><strong>Key Features:</strong></p>
<ul>
<li>Daily key rotation for forward secrecy</li>
<li>Two-tier client authorization (DH-based and PSK-based)</li>
<li>ChaCha20 encryption for performance on devices without AES hardware</li>
<li>Red25519 signatures with key blinding</li>
<li>Privacy-preserving client membership</li>
</ul>
<p><strong>Related Documentation:</strong></p>
<ul>
<li><a href="../../../../en/docs/specs/common-structures/">Common Structures Specification</a> - Encrypted LeaseSet structure</li>
<li><a href="../../../../en/proposals/123-new-netdb-entries/">Proposal 123: New netDB Entries</a> - Background on encrypted LeaseSets</li>
<li><a href="../../../../en/docs/specs/common-structures/">Network Database Documentation</a> - NetDB usage</li>
</ul>
<hr>
<h2 id="version-history-and-implementation-status">Version History and Implementation Status</h2>
<h3 id="protocol-development-timeline">Protocol Development Timeline</h3>
<p><strong>Important Note on Version Numbering:</strong><br>
I2P uses two separate version numbering schemes:</p>
<ul>
<li><strong>API/Router Version:</strong> 0.9.x series (used in technical specifications)</li>
<li><strong>Product Release Version:</strong> 2.x.x series (used for public releases)</li>
</ul>
<p>Technical specifications reference API versions (e.g., 0.9.41), while end users see product versions (e.g., 2.10.0).</p>
<h3 id="implementation-milestones">Implementation Milestones</h3>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Version</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Release Date</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Features</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>0.9.38</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">January 2019</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Floodfill support for standard LS2, offline keys</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>0.9.39</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">March 2019</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Full encrypted LS2 support, Red25519 (sig type&nbsp;11)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>0.9.40</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">May 2019</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Per-client authorization, encrypted LS2 with offline keys, B32 support</strong></td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>0.9.41</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">June 2019</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Protocol finalized as stable</strong></td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>2.10.0</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">September 2025</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Latest Java implementation (API version 0.9.61)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>i2pd 2.58.0</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">September 2025</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Full C++ implementation compatibility</td></tr>
  </tbody>
</table>
<h3 id="current-status">Current Status</h3>
<ul>
<li>✅ <strong>Protocol Status:</strong> Stable and unchanged since June 2019</li>
<li>✅ <strong>Java I2P:</strong> Fully implemented in version 0.9.40+</li>
<li>✅ <strong>i2pd (C++):</strong> Fully implemented in version 2.58.0+</li>
<li>✅ <strong>Interoperability:</strong> Complete between implementations</li>
<li>✅ <strong>Network Deployment:</strong> Production-ready with 6+ years of operational experience</li>
</ul>
<hr>
<h2 id="cryptographic-definitions">Cryptographic Definitions</h2>
<h3 id="notation-and-conventions">Notation and Conventions</h3>
<ul>
<li><code>||</code> denotes concatenation</li>
<li><code>mod L</code> denotes modular reduction by the Ed25519 order</li>
<li>All byte arrays are in network byte order (big-endian) unless otherwise specified</li>
<li>Little-endian values are explicitly noted</li>
</ul>
<h3 id="csrngn">CSRNG(n)</h3>
<p><strong>Cryptographically Secure Random Number Generator</strong></p>
<p>Produces <code>n</code> bytes of cryptographically secure random data suitable for key material generation.</p>
<p><strong>Security Requirements:</strong></p>
<ul>
<li>Must be cryptographically secure (suitable for key generation)</li>
<li>Must be safe when adjacent byte sequences are exposed on the network</li>
<li>Implementations should hash output from potentially untrustworthy sources</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="http://projectbullrun.org/dual-ec/ext-rand.html">PRNG Security Considerations</a></li>
<li><a href="https://lists.torproject.org/pipermail/tor-dev/2015-November/009954.html">Tor Dev Discussion</a></li>
</ul>
<h3 id="hp-d">H(p, d)</h3>
<p><strong>SHA-256 Hash with Personalization</strong></p>
<p>Domain-separated hash function that takes:</p>
<ul>
<li><code>p</code>: Personalization string (provides domain separation)</li>
<li><code>d</code>: Data to hash</li>
</ul>
<p><strong>Implementation:</strong></p>
<pre tabindex="0"><code>H(p, d) := SHA-256(p || d)
</code></pre><p><strong>Usage:</strong> Provides cryptographic domain separation to prevent collision attacks between different protocol uses of SHA-256.</p>
<h3 id="stream-chacha20">STREAM: ChaCha20</h3>
<p><strong>Stream Cipher: ChaCha20 as specified in RFC 7539 Section 2.4</strong></p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>S_KEY_LEN = 32</code> (256-bit key)</li>
<li><code>S_IV_LEN = 12</code> (96-bit nonce)</li>
<li>Initial counter: <code>1</code> (RFC 7539 permits 0 or 1; 1 recommended for AEAD contexts)</li>
</ul>
<p><strong>ENCRYPT(k, iv, plaintext)</strong></p>
<p>Encrypts plaintext using:</p>
<ul>
<li><code>k</code>: 32-byte cipher key</li>
<li><code>iv</code>: 12-byte nonce (MUST be unique for each key)</li>
<li>Returns ciphertext same size as plaintext</li>
</ul>
<p><strong>Security Property:</strong> Entire ciphertext must be indistinguishable from random if key is secret.</p>
<p><strong>DECRYPT(k, iv, ciphertext)</strong></p>
<p>Decrypts ciphertext using:</p>
<ul>
<li><code>k</code>: 32-byte cipher key</li>
<li><code>iv</code>: 12-byte nonce</li>
<li>Returns plaintext</li>
</ul>
<p><strong>Design Rationale:</strong> ChaCha20 selected over AES because:</p>
<ul>
<li>2.5-3x faster than AES on devices without hardware acceleration</li>
<li>Constant-time implementation easier to achieve</li>
<li>Comparable security and speed when AES-NI available</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7539">RFC 7539</a> - ChaCha20 and Poly1305 for IETF Protocols</li>
</ul>
<h3 id="sig-red25519">SIG: Red25519</h3>
<p><strong>Signature Scheme: Red25519 (SigType 11) with Key Blinding</strong></p>
<p>Red25519 is based on Ed25519 signatures over the Ed25519 curve, using SHA-512 for hashing, with support for key blinding as specified in ZCash RedDSA.</p>
<p><strong>Functions:</strong></p>
<h4 id="derive_publicprivkey">DERIVE_PUBLIC(privkey)</h4>
<p>Returns the public key corresponding to the given private key.</p>
<ul>
<li>Uses standard Ed25519 scalar multiplication by base point</li>
</ul>
<h4 id="signprivkey-m">SIGN(privkey, m)</h4>
<p>Returns a signature by the private key <code>privkey</code> over message <code>m</code>.</p>
<p><strong>Red25519 Signing Differences from Ed25519:</strong></p>
<ol>
<li>
<p><strong>Random Nonce:</strong> Uses 80 bytes of additional random data</p>
<pre tabindex="0"><code>T = CSRNG(80)  // 80 random bytes
r = H*(T || publickey || message)
</code></pre><p>This makes every Red25519 signature unique, even for the same message and key.</p>
</li>
<li>
<p><strong>Private Key Generation:</strong> Red25519 private keys are generated from random numbers and reduced <code>mod L</code>, rather than using Ed25519&rsquo;s bit-clamping approach.</p>
</li>
</ol>
<h4 id="verifypubkey-m-sig">VERIFY(pubkey, m, sig)</h4>
<p>Verifies signature <code>sig</code> against public key <code>pubkey</code> and message <code>m</code>.</p>
<ul>
<li>Returns <code>true</code> if signature is valid, <code>false</code> otherwise</li>
<li>Verification is identical to Ed25519</li>
</ul>
<p><strong>Key Blinding Operations:</strong></p>
<h4 id="generate_alphadata-secret">GENERATE_ALPHA(data, secret)</h4>
<p>Generates alpha for key blinding.</p>
<ul>
<li><code>data</code>: Typically contains the signing public key and signature types</li>
<li><code>secret</code>: Optional additional secret (zero-length if not used)</li>
<li>Result is identically distributed as Ed25519 private keys (after mod L reduction)</li>
</ul>
<h4 id="blind_privkeyprivkey-alpha">BLIND_PRIVKEY(privkey, alpha)</h4>
<p>Blinds a private key using secret <code>alpha</code>.</p>
<ul>
<li>Implementation: <code>blinded_privkey = (privkey + alpha) mod L</code></li>
<li>Uses scalar arithmetic in the field</li>
</ul>
<h4 id="blind_pubkeypubkey-alpha">BLIND_PUBKEY(pubkey, alpha)</h4>
<p>Blinds a public key using secret <code>alpha</code>.</p>
<ul>
<li>Implementation: <code>blinded_pubkey = pubkey + DERIVE_PUBLIC(alpha)</code></li>
<li>Uses group element (point) addition on the curve</li>
</ul>
<p><strong>Critical Property:</strong></p>
<pre tabindex="0"><code>BLIND_PUBKEY(pubkey, alpha) == DERIVE_PUBLIC(BLIND_PRIVKEY(privkey, alpha))
</code></pre><p><strong>Security Considerations:</strong></p>
<p>From ZCash Protocol Specification Section 5.4.6.1: For security, alpha must be identically distributed as the unblinded private keys. This ensures &ldquo;the combination of a re-randomized public key and signature(s) under that key do not reveal the key from which it was re-randomized.&rdquo;</p>
<p><strong>Supported Signature Types:</strong></p>
<ul>
<li><strong>Type 7 (Ed25519):</strong> Supported for existing destinations (backward compatibility)</li>
<li><strong>Type 11 (Red25519):</strong> Recommended for new destinations using encryption</li>
<li><strong>Blinded keys:</strong> Always use type 11 (Red25519)</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://zips.z.cash/protocol/protocol.pdf">ZCash Protocol Specification</a> - Section 5.4.6 RedDSA</li>
<li>[I2P Red25519 Specification](/docs/specs/red25519-signature-scheme/</li>
</ul>
<h3 id="dh-x25519">DH: X25519</h3>
<p><strong>Elliptic Curve Diffie-Hellman: X25519</strong></p>
<p>Public key agreement system based on Curve25519.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li>Private keys: 32 bytes</li>
<li>Public keys: 32 bytes</li>
<li>Shared secret output: 32 bytes</li>
</ul>
<p><strong>Functions:</strong></p>
<h4 id="generate_private">GENERATE_PRIVATE()</h4>
<p>Generates a new 32-byte private key using CSRNG.</p>
<h4 id="derive_publicprivkey-1">DERIVE_PUBLIC(privkey)</h4>
<p>Derives the 32-byte public key from the given private key.</p>
<ul>
<li>Uses scalar multiplication on Curve25519</li>
</ul>
<h4 id="dhprivkey-pubkey">DH(privkey, pubkey)</h4>
<p>Performs Diffie-Hellman key agreement.</p>
<ul>
<li><code>privkey</code>: Local 32-byte private key</li>
<li><code>pubkey</code>: Remote 32-byte public key</li>
<li>Returns: 32-byte shared secret</li>
</ul>
<p><strong>Security Properties:</strong></p>
<ul>
<li>Computational Diffie-Hellman assumption on Curve25519</li>
<li>Forward secrecy when ephemeral keys are used</li>
<li>Constant-time implementation required to prevent timing attacks</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7748">RFC 7748</a> - Elliptic Curves for Security</li>
</ul>
<h3 id="hkdf">HKDF</h3>
<p><strong>HMAC-based Key Derivation Function</strong></p>
<p>Extracts and expands key material from input keying material.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>salt</code>: 32 bytes maximum (typically 32 bytes for SHA-256)</li>
<li><code>ikm</code>: Input key material (any length, should have good entropy)</li>
<li><code>info</code>: Context-specific information (domain separation)</li>
<li><code>n</code>: Output length in bytes</li>
</ul>
<p><strong>Implementation:</strong></p>
<p>Uses HKDF as specified in RFC 5869 with:</p>
<ul>
<li><strong>Hash Function:</strong> SHA-256</li>
<li><strong>HMAC:</strong> As specified in RFC 2104</li>
<li><strong>Salt Length:</strong> Maximum 32 bytes (HashLen for SHA-256)</li>
</ul>
<p><strong>Usage Pattern:</strong></p>
<pre tabindex="0"><code>keys = HKDF(salt, ikm, info, n)
</code></pre><p><strong>Domain Separation:</strong> The <code>info</code> parameter provides cryptographic domain separation between different uses of HKDF in the protocol.</p>
<p><strong>Verified Info Values:</strong></p>
<ul>
<li><code>&quot;ELS2_L1K&quot;</code> - Layer 1 (outer) encryption</li>
<li><code>&quot;ELS2_L2K&quot;</code> - Layer 2 (inner) encryption</li>
<li><code>&quot;ELS2_XCA&quot;</code> - DH client authorization</li>
<li><code>&quot;ELS2PSKA&quot;</code> - PSK client authorization</li>
<li><code>&quot;i2pblinding1&quot;</code> - Alpha generation</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc5869">RFC 5869</a> - HKDF Specification</li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc2104">RFC 2104</a> - HMAC Specification</li>
</ul>
<hr>
<h2 id="format-specification">Format Specification</h2>
<p>Encrypted LS2 consists of three nested layers:</p>
<ol>
<li><strong>Layer 0 (Outer):</strong> Plaintext information for storage and retrieval</li>
<li><strong>Layer 1 (Middle):</strong> Client authentication data (encrypted)</li>
<li><strong>Layer 2 (Inner):</strong> Actual LeaseSet2 data (encrypted)</li>
</ol>
<p><strong>Overall Structure:</strong></p>
<pre tabindex="0"><code>Layer 0 data + Enc(layer 1 data + Enc(layer 2 data)) + Signature
</code></pre><p><strong>Important:</strong> Encrypted LS2 uses blinded keys. The Destination is not in the header. DHT storage location is <code>SHA-256(sig type || blinded public key)</code>, rotated daily.</p>
<h3 id="layer-0-outer---plaintext">Layer 0 (Outer) - Plaintext</h3>
<p>Layer 0 does NOT use the standard LS2 header. It has a custom format optimized for blinded keys.</p>
<p><strong>Structure:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Type</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1 byte</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Not in header, from DatabaseStore message field</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Blinded Public Key Sig Type</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, always <code>0x000b</code> (Red25519 type 11)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Blinded Public Key</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Red25519 blinded public key</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Published Timestamp</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, seconds since epoch (rolls over in 2106)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Expires</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, offset from published in seconds (max 65,535 &asymp; 18.2 hours)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Flags</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Bit flags (see below)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">[Optional] Transient Key Data</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Present if flag bit&nbsp;0 is set</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">lenOuterCiphertext</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, length of outer ciphertext</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">outerCiphertext</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">lenOuterCiphertext</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Encrypted Layer&nbsp;1 data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Signature</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">64 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Red25519 signature over all preceding data</td></tr>
  </tbody>
</table>
<p><strong>Flags Field (2 bytes, bits 15-0):</strong></p>
<ul>
<li><strong>Bit 0:</strong> Offline keys indicator
<ul>
<li><code>0</code> = No offline keys</li>
<li><code>1</code> = Offline keys present (transient key data follows)</li>
</ul>
</li>
<li><strong>Bits 1-15:</strong> Reserved, must be 0 for future compatibility</li>
</ul>
<p><strong>Transient Key Data (present if flag bit 0 = 1):</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Expires Timestamp</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, seconds since epoch</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Transient Sig Type</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, signature type</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Transient Signing Public Key</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Length implied by signature type</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Signature</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">64 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Signed by blinded public key; covers expires timestamp, transient sig type, and transient public key</td></tr>
  </tbody>
</table>
<p><strong>Signature Verification:</strong></p>
<ul>
<li><strong>Without offline keys:</strong> Verify with blinded public key</li>
<li><strong>With offline keys:</strong> Verify with transient public key</li>
</ul>
<p>The signature covers all data from Type through outerCiphertext (inclusive).</p>
<h3 id="layer-1-middle---client-authorization">Layer 1 (Middle) - Client Authorization</h3>
<p><strong>Decryption:</strong> See <a href="../../../../en/docs/specs/encryptedleaseset/#layer-1-encryption">Layer 1 Encryption</a> section.</p>
<p><strong>Structure:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Flags</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1 byte</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Authorization flags (see below)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">[Optional] Auth Data</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Present based on flags</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">innerCiphertext</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Encrypted Layer&nbsp;2 data (remainder)</td></tr>
  </tbody>
</table>
<p><strong>Flags Field (1 byte, bits 7-0):</strong></p>
<ul>
<li><strong>Bit 0:</strong> Authorization mode
<ul>
<li><code>0</code> = No per-client authorization (everybody)</li>
<li><code>1</code> = Per-client authorization (auth section follows)</li>
</ul>
</li>
<li><strong>Bits 3-1:</strong> Authentication scheme (only if bit 0 = 1)
<ul>
<li><code>000</code> = DH client authentication</li>
<li><code>001</code> = PSK client authentication</li>
<li>Others reserved</li>
</ul>
</li>
<li><strong>Bits 7-4:</strong> Unused, must be 0</li>
</ul>
<p><strong>DH Client Authorization Data (flags = 0x01, bits 3-1 = 000):</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">ephemeralPublicKey</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Server's ephemeral X25519 public key</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">clients</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, number of client entries</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">authClient[]</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">40 bytes each</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Array of client authorization entries</td></tr>
  </tbody>
</table>
<p><strong>authClient Entry (40 bytes):</strong></p>
<ul>
<li><code>clientID_i</code>: 8 bytes</li>
<li><code>clientCookie_i</code>: 32 bytes (encrypted authCookie)</li>
</ul>
<p><strong>PSK Client Authorization Data (flags = 0x03, bits 3-1 = 001):</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">authSalt</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Salt for PSK key derivation</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">clients</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, number of client entries</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">authClient[]</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">40 bytes each</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Array of client authorization entries</td></tr>
  </tbody>
</table>
<p><strong>authClient Entry (40 bytes):</strong></p>
<ul>
<li><code>clientID_i</code>: 8 bytes</li>
<li><code>clientCookie_i</code>: 32 bytes (encrypted authCookie)</li>
</ul>
<h3 id="layer-2-inner---leaseset-data">Layer 2 (Inner) - LeaseSet Data</h3>
<p><strong>Decryption:</strong> See <a href="../../../../en/docs/specs/encryptedleaseset/#layer-2-encryption">Layer 2 Encryption</a> section.</p>
<p><strong>Structure:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Type</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1 byte</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><code>3</code> (LS2) or <code>7</code> (Meta LS2)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Complete LeaseSet2 or MetaLeaseSet2</td></tr>
  </tbody>
</table>
<p>The inner layer contains the full LeaseSet2 structure including:</p>
<ul>
<li>LS2 header</li>
<li>Lease information</li>
<li>LS2 signature</li>
</ul>
<p><strong>Verification Requirements:</strong>
After decryption, implementations must verify:</p>
<ol>
<li>Inner timestamp matches outer published timestamp</li>
<li>Inner expiration matches outer expiration</li>
<li>LS2 signature is valid</li>
<li>Lease data is well-formed</li>
</ol>
<p><strong>References:</strong></p>
<ul>
<li><a href="../../../../en/docs/specs/common-structures/">Common Structures Specification</a> - LeaseSet2 format details</li>
</ul>
<hr>
<h2 id="blinding-key-derivation">Blinding Key Derivation</h2>
<h3 id="overview-1">Overview</h3>
<p>I2P uses an additive key blinding scheme based on Ed25519 and ZCash RedDSA. Blinded keys are rotated daily (UTC midnight) for forward secrecy.</p>
<p><strong>Design Rationale:</strong></p>
<p>I2P explicitly chose NOT to use Tor&rsquo;s rend-spec-v3.txt Appendix A.2 approach. According to the specification:</p>
<blockquote>
<p>&ldquo;We do not use Tor&rsquo;s rend-spec-v3.txt appendix A.2, which has similar design goals, because its blinded public keys may be off the prime-order subgroup, with unknown security implications.&rdquo;</p></blockquote>
<p>I2P&rsquo;s additive blinding guarantees that blinded keys remain on the prime-order subgroup of the Ed25519 curve.</p>
<h3 id="mathematical-definitions">Mathematical Definitions</h3>
<p><strong>Ed25519 Parameters:</strong></p>
<ul>
<li><code>B</code>: Ed25519 base point (generator) = <code>2^255 - 19</code></li>
<li><code>L</code>: Ed25519 order = <code>2^252 + 27742317777372353535851937790883648493</code></li>
</ul>
<p><strong>Key Variables:</strong></p>
<ul>
<li><code>A</code>: Unblinded 32-byte signing public key (in Destination)</li>
<li><code>a</code>: Unblinded 32-byte signing private key</li>
<li><code>A'</code>: Blinded 32-byte signing public key (used in encrypted LeaseSet)</li>
<li><code>a'</code>: Blinded 32-byte signing private key</li>
<li><code>alpha</code>: 32-byte blinding factor (secret)</li>
</ul>
<p><strong>Helper Functions:</strong></p>
<h4 id="leos2ipx">LEOS2IP(x)</h4>
<p>&ldquo;Little-Endian Octet String to Integer&rdquo;</p>
<p>Converts a byte array from little-endian to integer representation.</p>
<h4 id="hx">H*(x)</h4>
<p>&ldquo;Hash and Reduce&rdquo;</p>
<pre tabindex="0"><code>H*(x) = (LEOS2IP(SHA512(x))) mod L
</code></pre><p>Same operation as in Ed25519 key generation.</p>
<h3 id="alpha-generation">Alpha Generation</h3>
<p><strong>Daily Rotation:</strong> A new alpha and blinded keys MUST be generated each day at UTC midnight (00:00:00 UTC).</p>
<p><strong>GENERATE_ALPHA(destination, date, secret) Algorithm:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Input parameters</span>
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing public key (32 bytes)</span>
</span></span><span style="display:flex;"><span>stA <span style="color:#f92672">=</span> signature type of A (<span style="color:#ae81ff">2</span> bytes, big endian)
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># 0x0007 for Ed25519 or 0x000b for Red25519</span>
</span></span><span style="display:flex;"><span>stA<span style="color:#e6db74">&#39; = signature type of blinded key A&#39;</span> (<span style="color:#ae81ff">2</span> bytes, big endian) 
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># Always 0x000b (Red25519)</span>
</span></span><span style="display:flex;"><span>datestring <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;YYYYMMDD&#34;</span> (<span style="color:#ae81ff">8</span> bytes ASCII <span style="color:#f92672">from</span> current UTC date)
</span></span><span style="display:flex;"><span>secret <span style="color:#f92672">=</span> optional UTF<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span> encoded string (zero<span style="color:#f92672">-</span>length <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> used)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Computation</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> A <span style="color:#f92672">||</span> stA <span style="color:#f92672">||</span> stA<span style="color:#e6db74">&#39;  # 36 bytes total</span>
</span></span><span style="display:flex;"><span>seed <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>H(<span style="color:#e6db74">&#34;I2PGenerateAlpha&#34;</span>, keydata),
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>datestring <span style="color:#f92672">||</span> secret,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;i2pblinding1&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Treat seed as 64-byte little-endian integer and reduce</span>
</span></span><span style="display:flex;"><span>alpha <span style="color:#f92672">=</span> seed mod L
</span></span></code></pre></div><p><strong>Parameters Verified:</strong></p>
<ul>
<li>Salt personalization: <code>&quot;I2PGenerateAlpha&quot;</code></li>
<li>HKDF info: <code>&quot;i2pblinding1&quot;</code></li>
<li>Output: 64 bytes before reduction</li>
<li>Alpha distribution: Identically distributed as Ed25519 private keys after <code>mod L</code></li>
</ul>
<h3 id="private-key-blinding">Private Key Blinding</h3>
<p><strong>BLIND_PRIVKEY(a, alpha) Algorithm:</strong></p>
<p>For the destination owner publishing the encrypted LeaseSet:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># For Ed25519 private key (type 7)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> sigtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">7</span>:
</span></span><span style="display:flex;"><span>    seed <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing private key (32 bytes)</span>
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> left_half(SHA512(seed))  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> clamp(a)  <span style="color:#75715e"># Ed25519 clamping</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For Red25519 private key (type 11)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> sigtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">11</span>:
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing private key (32 bytes)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># No clamping for Red25519</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Additive blinding using scalar arithmetic</span>
</span></span><span style="display:flex;"><span>blinded_privkey <span style="color:#f92672">=</span> a<span style="color:#e6db74">&#39; = (a + alpha) mod L</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive blinded public key</span>
</span></span><span style="display:flex;"><span>blinded_pubkey <span style="color:#f92672">=</span> A<span style="color:#e6db74">&#39; = DERIVE_PUBLIC(a&#39;</span>)
</span></span></code></pre></div><p><strong>Critical:</strong> The <code>mod L</code> reduction is essential for maintaining the correct algebraic relationship between private and public keys.</p>
<h3 id="public-key-blinding">Public Key Blinding</h3>
<p><strong>BLIND_PUBKEY(A, alpha) Algorithm:</strong></p>
<p>For clients retrieving and verifying the encrypted LeaseSet:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>alpha <span style="color:#f92672">=</span> GENERATE_ALPHA(destination, date, secret)
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing public key (32 bytes)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Additive blinding using group elements (curve points)</span>
</span></span><span style="display:flex;"><span>blinded_pubkey <span style="color:#f92672">=</span> A<span style="color:#e6db74">&#39; = A + DERIVE_PUBLIC(alpha)</span>
</span></span></code></pre></div><p><strong>Mathematical Equivalence:</strong></p>
<p>Both methods produce identical results:</p>
<pre tabindex="0"><code>BLIND_PUBKEY(A, alpha) == DERIVE_PUBLIC(BLIND_PRIVKEY(a, alpha))
</code></pre><p>This is because:</p>
<pre tabindex="0"><code>A&#39; = A + [alpha]B
   = [a]B + [alpha]B
   = [a + alpha]B  (group operation)
   = DERIVE_PUBLIC(a + alpha mod L)
</code></pre><h3 id="signing-with-blinded-keys">Signing with Blinded Keys</h3>
<p><strong>Unblinded LeaseSet Signing:</strong></p>
<p>The unblinded LeaseSet (sent directly to authenticated clients) is signed using:</p>
<ul>
<li>Standard Ed25519 (type 7) or Red25519 (type 11) signature</li>
<li>Unblinded signing private key</li>
<li>Verified with unblinded public key</li>
</ul>
<p><strong>With Offline Keys:</strong></p>
<ul>
<li>Signed by unblinded transient private key</li>
<li>Verified with unblinded transient public key</li>
<li>Both must be type 7 or 11</li>
</ul>
<p><strong>Encrypted LeaseSet Signing:</strong></p>
<p>The outer portion of encrypted LeaseSet uses Red25519 signatures with blinded keys.</p>
<p><strong>Red25519 Signing Algorithm:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate per-signature random nonce</span>
</span></span><span style="display:flex;"><span>T <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">80</span>)  <span style="color:#75715e"># 80 random bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Calculate r (differs from Ed25519)</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> H<span style="color:#f92672">*</span>(T <span style="color:#f92672">||</span> blinded_pubkey <span style="color:#f92672">||</span> message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Rest is same as Ed25519</span>
</span></span><span style="display:flex;"><span>R <span style="color:#f92672">=</span> [r]B
</span></span><span style="display:flex;"><span>S <span style="color:#f92672">=</span> (r <span style="color:#f92672">+</span> H(R <span style="color:#f92672">||</span> A<span style="color:#e6db74">&#39; || message) * a&#39;</span>) mod L
</span></span><span style="display:flex;"><span>signature <span style="color:#f92672">=</span> R <span style="color:#f92672">||</span> S  <span style="color:#75715e"># 64 bytes total</span>
</span></span></code></pre></div><p><strong>Key Differences from Ed25519:</strong></p>
<ol>
<li>Uses 80 bytes of random data <code>T</code> (not hash of private key)</li>
<li>Uses public key value directly (not hash of private key)</li>
<li>Every signature is unique even for same message and key</li>
</ol>
<p><strong>Verification:</strong></p>
<p>Same as Ed25519:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Parse signature</span>
</span></span><span style="display:flex;"><span>R <span style="color:#f92672">=</span> signature[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>]
</span></span><span style="display:flex;"><span>S <span style="color:#f92672">=</span> signature[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">64</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify equation: [S]B = R + [H(R || A&#39; || message)]A&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> [S]B <span style="color:#f92672">==</span> R <span style="color:#f92672">+</span> [H(R <span style="color:#f92672">||</span> A<span style="color:#e6db74">&#39; || message)]A&#39;</span>
</span></span></code></pre></div><h3 id="security-considerations">Security Considerations</h3>
<p><strong>Alpha Distribution:</strong></p>
<p>For security, alpha must be identically distributed as unblinded private keys. When blinding Ed25519 (type 7) to Red25519 (type 11), the distributions differ slightly.</p>
<p><strong>Recommendation:</strong> Use Red25519 (type 11) for both unblinded and blinded keys to meet ZCash requirements: &ldquo;the combination of a re-randomized public key and signature(s) under that key do not reveal the key from which it was re-randomized.&rdquo;</p>
<p><strong>Type 7 Support:</strong> Ed25519 is supported for backward compatibility with existing destinations, but type 11 is recommended for new encrypted destinations.</p>
<p><strong>Daily Rotation Benefits:</strong></p>
<ul>
<li>Forward secrecy: Compromising today&rsquo;s blinded key doesn&rsquo;t reveal yesterday&rsquo;s</li>
<li>Unlinkability: Daily rotation prevents long-term tracking via DHT</li>
<li>Key separation: Different keys for different time periods</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://zips.z.cash/protocol/protocol.pdf">ZCash Protocol Specification</a> - Section 5.4.6.1</li>
<li><a href="https://lists.torproject.org/pipermail/tor-dev/2013-December/005943.html">Tor Key Blinding Discussion</a></li>
<li><a href="https://trac.torproject.org/projects/tor/ticket/8106">Tor Ticket #8106</a></li>
</ul>
<hr>
<h2 id="encryption-and-processing">Encryption and Processing</h2>
<h3 id="subcredential-derivation">Subcredential Derivation</h3>
<p>Before encryption, we derive a credential and subcredential to bind encrypted layers to knowledge of the Destination&rsquo;s signing public key.</p>
<p><strong>Goal:</strong> Ensure only those who know the Destination&rsquo;s signing public key can decrypt the encrypted LeaseSet. The full Destination is not required.</p>
<h4 id="credential-calculation">Credential Calculation</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>A <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing public key (32 bytes)</span>
</span></span><span style="display:flex;"><span>stA <span style="color:#f92672">=</span> signature type of A (<span style="color:#ae81ff">2</span> bytes big endian)
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># 0x0007 for Ed25519 or 0x000b for Red25519</span>
</span></span><span style="display:flex;"><span>stA<span style="color:#e6db74">&#39; = signature type of blinded key A&#39;</span> (<span style="color:#ae81ff">2</span> bytes big endian)
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># Always 0x000b (Red25519)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> A <span style="color:#f92672">||</span> stA <span style="color:#f92672">||</span> stA<span style="color:#e6db74">&#39;  # 36 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>credential <span style="color:#f92672">=</span> H(<span style="color:#e6db74">&#34;credential&#34;</span>, keydata)  <span style="color:#75715e"># 32 bytes</span>
</span></span></code></pre></div><p><strong>Domain Separation:</strong> The personalization string <code>&quot;credential&quot;</code> ensures this hash doesn&rsquo;t collide with any DHT lookup keys or other protocol uses.</p>
<h4 id="subcredential-calculation">Subcredential Calculation</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>blindedPublicKey <span style="color:#f92672">=</span> A<span style="color:#e6db74">&#39; (32 bytes, from blinding process)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>subcredential <span style="color:#f92672">=</span> H(<span style="color:#e6db74">&#34;subcredential&#34;</span>, credential <span style="color:#f92672">||</span> blindedPublicKey)  <span style="color:#75715e"># 32 bytes</span>
</span></span></code></pre></div><p><strong>Purpose:</strong> The subcredential binds the encrypted LeaseSet to:</p>
<ol>
<li>The specific Destination (via credential)</li>
<li>The specific blinded key (via blindedPublicKey)</li>
<li>The specific day (via daily rotation of blindedPublicKey)</li>
</ol>
<p>This prevents replay attacks and cross-day linking.</p>
<h3 id="layer-1-encryption">Layer 1 Encryption</h3>
<p><strong>Context:</strong> Layer 1 contains client authorization data and is encrypted with a key derived from the subcredential.</p>
<h4 id="encryption-algorithm">Encryption Algorithm</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Prepare input</span>
</span></span><span style="display:flex;"><span>outerInput <span style="color:#f92672">=</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span><span style="color:#75715e"># publishedTimestamp: 4 bytes from Layer 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate random salt</span>
</span></span><span style="display:flex;"><span>outerSalt <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive encryption key and IV</span>
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>outerSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>outerInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_L1K&#34;</span>,  <span style="color:#75715e"># Domain separation</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>  <span style="color:#75715e"># 32 bytes key + 12 bytes IV</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>outerKey <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes (indices 0-31 inclusive)</span>
</span></span><span style="display:flex;"><span>outerIV <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes (indices 32-43 inclusive)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt and prepend salt</span>
</span></span><span style="display:flex;"><span>outerPlaintext <span style="color:#f92672">=</span> [Layer <span style="color:#ae81ff">1</span> data]
</span></span><span style="display:flex;"><span>outerCiphertext <span style="color:#f92672">=</span> outerSalt <span style="color:#f92672">||</span> ENCRYPT(outerKey, outerIV, outerPlaintext)
</span></span></code></pre></div><p><strong>Output:</strong> <code>outerCiphertext</code> is <code>32 + len(outerPlaintext)</code> bytes.</p>
<p><strong>Security Properties:</strong></p>
<ul>
<li>Salt ensures unique key/IV pairs even with same subcredential</li>
<li>Context string <code>&quot;ELS2_L1K&quot;</code> provides domain separation</li>
<li>ChaCha20 provides semantic security (ciphertext indistinguishable from random)</li>
</ul>
<h4 id="decryption-algorithm">Decryption Algorithm</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Parse salt from ciphertext</span>
</span></span><span style="display:flex;"><span>outerSalt <span style="color:#f92672">=</span> outerCiphertext[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># First 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive decryption key and IV (same process as encryption)</span>
</span></span><span style="display:flex;"><span>outerInput <span style="color:#f92672">=</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>outerSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>outerInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_L1K&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>outerKey <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>outerIV <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decrypt (skip salt bytes)</span>
</span></span><span style="display:flex;"><span>outerPlaintext <span style="color:#f92672">=</span> DECRYPT(outerKey, outerIV, outerCiphertext[<span style="color:#ae81ff">32</span>:end])
</span></span></code></pre></div><p><strong>Verification:</strong> After decryption, verify Layer 1 structure is well-formed before proceeding to Layer 2.</p>
<h3 id="layer-2-encryption">Layer 2 Encryption</h3>
<p><strong>Context:</strong> Layer 2 contains the actual LeaseSet2 data and is encrypted with a key derived from the authCookie (if per-client auth enabled) or empty string (if not).</p>
<h4 id="encryption-algorithm-1">Encryption Algorithm</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Determine authCookie based on authorization mode</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> per_client_auth_enabled:
</span></span><span style="display:flex;"><span>    authCookie <span style="color:#f92672">=</span> [<span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>byte cookie <span style="color:#f92672">from</span> client authorization process]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    authCookie <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>  <span style="color:#75715e"># Zero-length byte array</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Prepare input</span>
</span></span><span style="display:flex;"><span>innerInput <span style="color:#f92672">=</span> authCookie <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate random salt</span>
</span></span><span style="display:flex;"><span>innerSalt <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive encryption key and IV</span>
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>innerSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>innerInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_L2K&#34;</span>,  <span style="color:#75715e"># Domain separation</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>  <span style="color:#75715e"># 32 bytes key + 12 bytes IV</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>innerKey <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>innerIV <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt and prepend salt</span>
</span></span><span style="display:flex;"><span>innerPlaintext <span style="color:#f92672">=</span> [Layer <span style="color:#ae81ff">2</span> data: LS2 type byte <span style="color:#f92672">+</span> LeaseSet2 data]
</span></span><span style="display:flex;"><span>innerCiphertext <span style="color:#f92672">=</span> innerSalt <span style="color:#f92672">||</span> ENCRYPT(innerKey, innerIV, innerPlaintext)
</span></span></code></pre></div><p><strong>Output:</strong> <code>innerCiphertext</code> is <code>32 + len(innerPlaintext)</code> bytes.</p>
<p><strong>Key Binding:</strong></p>
<ul>
<li>If no client auth: Bound only to subcredential and timestamp</li>
<li>If client auth enabled: Additionally bound to authCookie (different for each authorized client)</li>
</ul>
<h4 id="decryption-algorithm-1">Decryption Algorithm</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Determine authCookie (same as encryption)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> per_client_auth_enabled:
</span></span><span style="display:flex;"><span>    authCookie <span style="color:#f92672">=</span> [<span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>byte cookie <span style="color:#f92672">from</span> client authorization process]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    authCookie <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>  <span style="color:#75715e"># Zero-length byte array</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Parse salt from ciphertext</span>
</span></span><span style="display:flex;"><span>innerSalt <span style="color:#f92672">=</span> innerCiphertext[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># First 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive decryption key and IV</span>
</span></span><span style="display:flex;"><span>innerInput <span style="color:#f92672">=</span> authCookie <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>innerSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>innerInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_L2K&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>innerKey <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>innerIV <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decrypt (skip salt bytes)</span>
</span></span><span style="display:flex;"><span>innerPlaintext <span style="color:#f92672">=</span> DECRYPT(innerKey, innerIV, innerCiphertext[<span style="color:#ae81ff">32</span>:end])
</span></span></code></pre></div><p><strong>Verification:</strong> After decryption:</p>
<ol>
<li>Verify LS2 type byte is valid (3 or 7)</li>
<li>Parse LeaseSet2 structure</li>
<li>Verify inner timestamp matches outer published timestamp</li>
<li>Verify inner expiration matches outer expiration</li>
<li>Verify LeaseSet2 signature</li>
</ol>
<h3 id="encryption-layer-summary">Encryption Layer Summary</h3>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────┐
│ Layer 0 (Plaintext)                             │
│ - Blinded public key                            │
│ - Timestamps                                    │
│ - Signature                                     │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ Layer 1 (Encrypted with subcredential)  │   │
│  │ - Authorization flags                   │   │
│  │ - Client auth data (if enabled)         │   │
│  │                                          │   │
│  │  ┌────────────────────────────────┐     │   │
│  │  │ Layer 2 (Encrypted with        │     │   │
│  │  │          authCookie + subcred) │     │   │
│  │  │ - LeaseSet2 type               │     │   │
│  │  │ - LeaseSet2 data               │     │   │
│  │  │ - Leases                       │     │   │
│  │  │ - LS2 signature                │     │   │
│  │  └────────────────────────────────┘     │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
</code></pre><p><strong>Decryption Flow:</strong></p>
<ol>
<li>Verify Layer 0 signature with blinded public key</li>
<li>Decrypt Layer 1 using subcredential</li>
<li>Process authorization data (if present) to obtain authCookie</li>
<li>Decrypt Layer 2 using authCookie and subcredential</li>
<li>Verify and parse LeaseSet2</li>
</ol>
<hr>
<h2 id="per-client-authorization">Per-Client Authorization</h2>
<h3 id="overview-2">Overview</h3>
<p>When per-client authorization is enabled, the server maintains a list of authorized clients. Each client has key material that must be securely transmitted out-of-band.</p>
<p><strong>Two Authorization Mechanisms:</strong></p>
<ol>
<li><strong>DH (Diffie-Hellman) Client Authorization:</strong> More secure, uses X25519 key agreement</li>
<li><strong>PSK (Pre-Shared Key) Authorization:</strong> Simpler, uses symmetric keys</li>
</ol>
<p><strong>Common Security Properties:</strong></p>
<ul>
<li>Client membership privacy: Observers see client count but cannot identify specific clients</li>
<li>Anonymous client addition/revocation: Cannot track when specific clients are added or removed</li>
<li>8-byte client identifier collision probability: ~1 in 18 quintillion (negligible)</li>
</ul>
<h3 id="dh-client-authorization">DH Client Authorization</h3>
<p><strong>Overview:</strong> Each client generates an X25519 keypair and sends their public key to the server via a secure out-of-band channel. The server uses ephemeral DH to encrypt a unique authCookie for each client.</p>
<h4 id="client-key-generation">Client Key Generation</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Client generates keypair</span>
</span></span><span style="display:flex;"><span>csk_i <span style="color:#f92672">=</span> GENERATE_PRIVATE()  <span style="color:#75715e"># 32-byte X25519 private key</span>
</span></span><span style="display:flex;"><span>cpk_i <span style="color:#f92672">=</span> DERIVE_PUBLIC(csk_i)  <span style="color:#75715e"># 32-byte X25519 public key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client sends cpk_i to server via secure out-of-band channel</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client KEEPS csk_i secret (never transmitted)</span>
</span></span></code></pre></div><p><strong>Security Advantage:</strong> The client&rsquo;s private key never leaves their device. An adversary intercepting the out-of-band transmission cannot decrypt future encrypted LeaseSets without breaking X25519 DH.</p>
<h4 id="server-processing">Server Processing</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Server generates new auth cookie and ephemeral keypair</span>
</span></span><span style="display:flex;"><span>authCookie <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32-byte cookie</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>esk <span style="color:#f92672">=</span> GENERATE_PRIVATE()  <span style="color:#75715e"># 32-byte ephemeral private key</span>
</span></span><span style="display:flex;"><span>epk <span style="color:#f92672">=</span> DERIVE_PUBLIC(esk)  <span style="color:#75715e"># 32-byte ephemeral public key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For each authorized client i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cpk_i <span style="color:#f92672">in</span> authorized_clients:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform DH key agreement</span>
</span></span><span style="display:flex;"><span>    sharedSecret <span style="color:#f92672">=</span> DH(esk, cpk_i)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive client-specific encryption key</span>
</span></span><span style="display:flex;"><span>    authInput <span style="color:#f92672">=</span> sharedSecret <span style="color:#f92672">||</span> cpk_i <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>    okm <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>        salt<span style="color:#f92672">=</span>epk,  <span style="color:#75715e"># Ephemeral public key as salt</span>
</span></span><span style="display:flex;"><span>        ikm<span style="color:#f92672">=</span>authInput,
</span></span><span style="display:flex;"><span>        info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_XCA&#34;</span>,  <span style="color:#75715e"># Domain separation</span>
</span></span><span style="display:flex;"><span>        n<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>  <span style="color:#75715e"># 32 key + 12 IV + 8 ID</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract components</span>
</span></span><span style="display:flex;"><span>    clientKey_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    clientIV_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>    clientID_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">51</span>]    <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Encrypt authCookie for this client</span>
</span></span><span style="display:flex;"><span>    clientCookie_i <span style="color:#f92672">=</span> ENCRYPT(clientKey_i, clientIV_i, authCookie)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Store [clientID_i, clientCookie_i] entry in Layer 1</span>
</span></span></code></pre></div><p><strong>Layer 1 Data Structure:</strong></p>
<pre tabindex="0"><code>ephemeralPublicKey (32 bytes)
clients (2 bytes) = N
[clientID_1 (8 bytes) || clientCookie_1 (32 bytes)]
[clientID_2 (8 bytes) || clientCookie_2 (32 bytes)]
...
[clientID_N (8 bytes) || clientCookie_N (32 bytes)]
</code></pre><p><strong>Server Recommendations:</strong></p>
<ul>
<li>Generate new ephemeral keypair for each published encrypted LeaseSet</li>
<li>Randomize client order to prevent position-based tracking</li>
<li>Consider adding dummy entries to hide true client count</li>
</ul>
<h4 id="client-processing">Client Processing</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Client has: csk_i (their private key), destination, date, secret</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client receives: encrypted LeaseSet with epk in Layer 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Perform DH key agreement with server&#39;s ephemeral public key</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(csk_i, epk)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive expected client identifier and decryption key</span>
</span></span><span style="display:flex;"><span>cpk_i <span style="color:#f92672">=</span> DERIVE_PUBLIC(csk_i)  <span style="color:#75715e"># Client&#39;s own public key</span>
</span></span><span style="display:flex;"><span>authInput <span style="color:#f92672">=</span> sharedSecret <span style="color:#f92672">||</span> cpk_i <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>okm <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>epk,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>authInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_XCA&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clientKey_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>clientIV_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>clientID_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">51</span>]    <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Search Layer 1 authorization data for clientID_i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (clientID, clientCookie) <span style="color:#f92672">in</span> layer1_auth_entries:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> clientID <span style="color:#f92672">==</span> clientID_i:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Found matching entry, decrypt authCookie</span>
</span></span><span style="display:flex;"><span>        authCookie <span style="color:#f92672">=</span> DECRYPT(clientKey_i, clientIV_i, clientCookie)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use authCookie to decrypt Layer 2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># No matching entry - client not authorized or revoked</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> AuthorizationError(<span style="color:#e6db74">&#34;Client not authorized&#34;</span>)
</span></span></code></pre></div><p><strong>Client Error Handling:</strong></p>
<ul>
<li>If <code>clientID_i</code> not found: Client has been revoked or never authorized</li>
<li>If decryption fails: Corrupted data or wrong keys (extremely rare)</li>
<li>Clients should periodically re-fetch to detect revocation</li>
</ul>
<h3 id="psk-client-authorization">PSK Client Authorization</h3>
<p><strong>Overview:</strong> Each client has a pre-shared 32-byte symmetric key. The server encrypts the same authCookie using each client&rsquo;s PSK.</p>
<h4 id="key-generation">Key Generation</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Option 1: Client generates key</span>
</span></span><span style="display:flex;"><span>psk_i <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32-byte pre-shared key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client sends psk_i to server via secure out-of-band channel</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Option 2: Server generates key</span>
</span></span><span style="display:flex;"><span>psk_i <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32-byte pre-shared key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server sends psk_i to one or more clients via secure out-of-band channel</span>
</span></span></code></pre></div><p><strong>Security Note:</strong> The same PSK can be shared among multiple clients if desired (creates a &ldquo;group&rdquo; authorization).</p>
<h4 id="server-processing-1">Server Processing</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Server generates new auth cookie and salt</span>
</span></span><span style="display:flex;"><span>authCookie <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32-byte cookie</span>
</span></span><span style="display:flex;"><span>authSalt <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)     <span style="color:#75715e"># 32-byte salt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For each authorized client i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> psk_i <span style="color:#f92672">in</span> authorized_clients:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive client-specific encryption key</span>
</span></span><span style="display:flex;"><span>    authInput <span style="color:#f92672">=</span> psk_i <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    okm <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>        salt<span style="color:#f92672">=</span>authSalt,
</span></span><span style="display:flex;"><span>        ikm<span style="color:#f92672">=</span>authInput,
</span></span><span style="display:flex;"><span>        info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2PSKA&#34;</span>,  <span style="color:#75715e"># Domain separation</span>
</span></span><span style="display:flex;"><span>        n<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>  <span style="color:#75715e"># 32 key + 12 IV + 8 ID</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract components</span>
</span></span><span style="display:flex;"><span>    clientKey_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    clientIV_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>    clientID_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">51</span>]    <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Encrypt authCookie for this client</span>
</span></span><span style="display:flex;"><span>    clientCookie_i <span style="color:#f92672">=</span> ENCRYPT(clientKey_i, clientIV_i, authCookie)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Store [clientID_i, clientCookie_i] entry in Layer 1</span>
</span></span></code></pre></div><p><strong>Layer 1 Data Structure:</strong></p>
<pre tabindex="0"><code>authSalt (32 bytes)
clients (2 bytes) = N
[clientID_1 (8 bytes) || clientCookie_1 (32 bytes)]
[clientID_2 (8 bytes) || clientCookie_2 (32 bytes)]
...
[clientID_N (8 bytes) || clientCookie_N (32 bytes)]
</code></pre><h4 id="client-processing-1">Client Processing</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Client has: psk_i (their pre-shared key), destination, date, secret</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client receives: encrypted LeaseSet with authSalt in Layer 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive expected client identifier and decryption key</span>
</span></span><span style="display:flex;"><span>authInput <span style="color:#f92672">=</span> psk_i <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>okm <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>authSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>authInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2PSKA&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clientKey_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>clientIV_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>clientID_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">51</span>]    <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Search Layer 1 authorization data for clientID_i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (clientID, clientCookie) <span style="color:#f92672">in</span> layer1_auth_entries:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> clientID <span style="color:#f92672">==</span> clientID_i:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Found matching entry, decrypt authCookie</span>
</span></span><span style="display:flex;"><span>        authCookie <span style="color:#f92672">=</span> DECRYPT(clientKey_i, clientIV_i, clientCookie)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use authCookie to decrypt Layer 2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># No matching entry - client not authorized or revoked</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> AuthorizationError(<span style="color:#e6db74">&#34;Client not authorized&#34;</span>)
</span></span></code></pre></div><h3 id="comparison-and-recommendations">Comparison and Recommendations</h3>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Feature</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">DH Authorization</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">PSK Authorization</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Key Exchange</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Asymmetric (X25519)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Symmetric (shared secret)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Security</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Higher (forward secrecy)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Lower (depends on PSK secrecy)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Client Privacy</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Private key never transmitted</td><td style="border:1px solid var(--color-border); padding:0.5rem;">PSK must be transmitted securely</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Performance</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">N+1 DH operations</td><td style="border:1px solid var(--color-border); padding:0.5rem;">No DH operations</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Key Sharing</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">One key per client</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Can share key among multiple clients</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Revocation Detection</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Adversary cannot tell when revoked</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Adversary can track revocation if PSK intercepted</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Use Case</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">High security requirements</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Performance-critical or group access</td></tr>
  </tbody>
</table>
<p><strong>Recommendation:</strong></p>
<ul>
<li><strong>Use DH authorization</strong> for high-security applications where forward secrecy is important</li>
<li><strong>Use PSK authorization</strong> when performance is critical or when managing client groups</li>
<li><strong>Never reuse PSKs</strong> across different services or time periods</li>
<li><strong>Always use secure channels</strong> for key distribution (e.g., Signal, OTR, PGP)</li>
</ul>
<h3 id="security-considerations-1">Security Considerations</h3>
<p><strong>Client Membership Privacy:</strong></p>
<p>Both mechanisms provide privacy for client membership through:</p>
<ol>
<li><strong>Encrypted client identifiers:</strong> 8-byte clientID derived from HKDF output</li>
<li><strong>Indistinguishable cookies:</strong> All 32-byte clientCookie values appear random</li>
<li><strong>No client-specific metadata:</strong> No way to identify which entry belongs to which client</li>
</ol>
<p>An observer can see:</p>
<ul>
<li>Number of authorized clients (from <code>clients</code> field)</li>
<li>Changes in client count over time</li>
</ul>
<p>An observer CANNOT see:</p>
<ul>
<li>Which specific clients are authorized</li>
<li>When specific clients are added or removed (if count stays same)</li>
<li>Any client-identifying information</li>
</ul>
<p><strong>Randomization Recommendations:</strong></p>
<p>Servers SHOULD randomize client order each time they generate an encrypted LeaseSet:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Before serializing</span>
</span></span><span style="display:flex;"><span>auth_entries <span style="color:#f92672">=</span> [(clientID_i, clientCookie_i) <span style="color:#66d9ef">for</span> each client]
</span></span><span style="display:flex;"><span>random<span style="color:#f92672">.</span>shuffle(auth_entries)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Now serialize in randomized order</span>
</span></span></code></pre></div><p><strong>Benefits:</strong></p>
<ul>
<li>Prevents clients from learning their position in the list</li>
<li>Prevents inference attacks based on position changes</li>
<li>Makes client addition/revocation indistinguishable</li>
</ul>
<p><strong>Hiding Client Count:</strong></p>
<p>Servers MAY insert random dummy entries:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add dummy entries</span>
</span></span><span style="display:flex;"><span>num_dummies <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, max_dummies)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(num_dummies):
</span></span><span style="display:flex;"><span>    dummy_id <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>    dummy_cookie <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    auth_entries<span style="color:#f92672">.</span>append((dummy_id, dummy_cookie))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Randomize all entries (real + dummy)</span>
</span></span><span style="display:flex;"><span>random<span style="color:#f92672">.</span>shuffle(auth_entries)
</span></span></code></pre></div><p><strong>Cost:</strong> Dummy entries increase encrypted LeaseSet size (40 bytes each).</p>
<p><strong>AuthCookie Rotation:</strong></p>
<p>Servers SHOULD generate a new authCookie:</p>
<ul>
<li>Each time an encrypted LeaseSet is published (every few hours typical)</li>
<li>Immediately after revoking a client</li>
<li>On a regular schedule (e.g., daily) even if no client changes</li>
</ul>
<p><strong>Benefits:</strong></p>
<ul>
<li>Limits exposure if authCookie is compromised</li>
<li>Ensures revoked clients lose access quickly</li>
<li>Provides forward secrecy for Layer 2</li>
</ul>
<hr>
<h2 id="base32-addressing-for-encrypted-leasesets">Base32 Addressing for Encrypted LeaseSets</h2>
<h3 id="overview-3">Overview</h3>
<p>Traditional I2P base32 addresses contain only the hash of the Destination (32 bytes → 52 characters). This is insufficient for encrypted LeaseSets because:</p>
<ol>
<li>Clients need the <strong>non-blinded public key</strong> to derive the blinded public key</li>
<li>Clients need the <strong>signature types</strong> (unblinded and blinded) for proper key derivation</li>
<li>The hash alone does not provide this information</li>
</ol>
<p><strong>Solution:</strong> A new base32 format that includes the public key and signature types.</p>
<h3 id="address-format-specification">Address Format Specification</h3>
<p><strong>Decoded Structure (35 bytes):</strong></p>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────────┐
│ Byte 0   │ Byte 1  │ Byte 2  │ Bytes 3-34          │
│ Flags    │ Unblind │ Blinded │ Public Key          │
│ (XOR)    │ SigType │ SigType │ (32 bytes)          │
│          │ (XOR)   │ (XOR)   │                     │
└─────────────────────────────────────────────────────┘
</code></pre><p><strong>First 3 Bytes (XOR with Checksum):</strong></p>
<p>The first 3 bytes contain metadata XOR&rsquo;d with portions of a CRC-32 checksum:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Data structure before XOR</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>           <span style="color:#75715e"># 1 byte (reserved for future use)</span>
</span></span><span style="display:flex;"><span>unblinded_sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x07</span> <span style="color:#f92672">or</span> <span style="color:#ae81ff">0x0b</span>  <span style="color:#75715e"># 1 byte (7 or 11)</span>
</span></span><span style="display:flex;"><span>blinded_sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0b</span>  <span style="color:#75715e"># 1 byte (always 11)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Compute CRC-32 checksum of public key</span>
</span></span><span style="display:flex;"><span>checksum <span style="color:#f92672">=</span> crc32(pubkey)  <span style="color:#75715e"># 4-byte CRC-32 of bytes 3-34</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># XOR first 3 bytes with parts of checksum</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> flags XOR (checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> unblinded_sigtype XOR (checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>  
</span></span><span style="display:flex;"><span>data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> blinded_sigtype XOR (checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bytes 3-34 contain the unmodified 32-byte public key</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">34</span>] <span style="color:#f92672">=</span> pubkey
</span></span></code></pre></div><p><strong>Checksum Properties:</strong></p>
<ul>
<li>Uses standard CRC-32 polynomial</li>
<li>False negative rate: ~1 in 16 million</li>
<li>Provides error detection for address typos</li>
<li>Cannot be used as authentication (not cryptographically secure)</li>
</ul>
<p><strong>Encoded Format:</strong></p>
<pre tabindex="0"><code>Base32Encode(35 bytes) || &#34;.b32.i2p&#34;
</code></pre><p><strong>Characteristics:</strong></p>
<ul>
<li>Total characters: 56 (35 bytes × 8 bits ÷ 5 bits per char)</li>
<li>Suffix: &ldquo;.b32.i2p&rdquo; (same as traditional base32)</li>
<li>Total length: 56 + 8 = 64 characters (excluding null terminator)</li>
</ul>
<p><strong>Base32 Encoding:</strong></p>
<ul>
<li>Alphabet: <code>abcdefghijklmnopqrstuvwxyz234567</code> (standard RFC 4648)</li>
<li>5 unused bits at the end MUST be 0</li>
<li>Case-insensitive (by convention lowercase)</li>
</ul>
<h3 id="address-generation">Address Generation</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> zlib <span style="color:#f92672">import</span> crc32
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_encrypted_b32_address</span>(pubkey, unblinded_sigtype, blinded_sigtype):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Generate base32 address for encrypted LeaseSet.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte public key (bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        unblinded_sigtype: Unblinded signature type (7 or 11)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        blinded_sigtype: Blinded signature type (always 11)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        String address ending in .b32.i2p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify inputs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(pubkey) <span style="color:#f92672">==</span> <span style="color:#ae81ff">32</span>, <span style="color:#e6db74">&#34;Public key must be 32 bytes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> unblinded_sigtype <span style="color:#f92672">in</span> [<span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">11</span>], <span style="color:#e6db74">&#34;Unblinded sigtype must be 7 or 11&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> blinded_sigtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">11</span>, <span style="color:#e6db74">&#34;Blinded sigtype must be 11&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Compute CRC-32 of public key</span>
</span></span><span style="display:flex;"><span>    checksum <span style="color:#f92672">=</span> crc32(pubkey) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span>  <span style="color:#75715e"># Ensure 32-bit unsigned</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prepare metadata bytes</span>
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># XOR metadata with checksum parts</span>
</span></span><span style="display:flex;"><span>    byte0 <span style="color:#f92672">=</span> flags <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    byte1 <span style="color:#f92672">=</span> unblinded_sigtype <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    byte2 <span style="color:#f92672">=</span> blinded_sigtype <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Construct 35-byte data</span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> bytes([byte0, byte1, byte2]) <span style="color:#f92672">+</span> pubkey
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Base32 encode (standard alphabet)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Python&#39;s base64 module uses uppercase by default</span>
</span></span><span style="display:flex;"><span>    b32 <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b32encode(data)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;ascii&#39;</span>)<span style="color:#f92672">.</span>lower()<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#39;=&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Construct full address</span>
</span></span><span style="display:flex;"><span>    address <span style="color:#f92672">=</span> b32 <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.b32.i2p&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> address
</span></span></code></pre></div><h3 id="address-parsing">Address Parsing</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> zlib <span style="color:#f92672">import</span> crc32
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_encrypted_b32_address</span>(address):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Parse base32 address for encrypted LeaseSet.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        address: String address ending in .b32.i2p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Tuple of (pubkey, unblinded_sigtype, blinded_sigtype)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Raises:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ValueError: If address is invalid or checksum fails
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Remove suffix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> address<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.b32.i2p&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Invalid address suffix&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    b32 <span style="color:#f92672">=</span> address[:<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>]  <span style="color:#75715e"># Remove &#34;.b32.i2p&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify length (56 characters for 35 bytes)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(b32) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">56</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid length: </span><span style="color:#e6db74">{</span>len(b32)<span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 56)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Base32 decode</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add padding if needed</span>
</span></span><span style="display:flex;"><span>    padding_needed <span style="color:#f92672">=</span> (<span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> (len(b32) <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>)) <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    b32_padded <span style="color:#f92672">=</span> b32<span style="color:#f92672">.</span>upper() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">*</span> padding_needed
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b32decode(b32_padded)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid base32 encoding: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify decoded length</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(data) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">35</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid decoded length: </span><span style="color:#e6db74">{</span>len(data)<span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 35)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract public key</span>
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">35</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Compute CRC-32 for verification</span>
</span></span><span style="display:flex;"><span>    checksum <span style="color:#f92672">=</span> crc32(pubkey) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Un-XOR metadata bytes</span>
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    unblinded_sigtype <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    blinded_sigtype <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify expected values</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> flags <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x00</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid flags: </span><span style="color:#e6db74">{</span>flags<span style="color:#e6db74">:</span><span style="color:#e6db74">#x</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 0x00)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> unblinded_sigtype <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [<span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">11</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid unblinded sigtype: </span><span style="color:#e6db74">{</span>unblinded_sigtype<span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 7 or 11)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> blinded_sigtype <span style="color:#f92672">!=</span> <span style="color:#ae81ff">11</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid blinded sigtype: </span><span style="color:#e6db74">{</span>blinded_sigtype<span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 11)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pubkey, unblinded_sigtype, blinded_sigtype
</span></span></code></pre></div><h3 id="comparison-with-traditional-base32">Comparison with Traditional Base32</h3>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Feature</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Traditional B32</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Encrypted LS2 B32</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Content</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">SHA-256 hash of Destination</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Public key + signature types</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Decoded Size</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">35 bytes</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Encoded Length</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">52 characters</td><td style="border:1px solid var(--color-border); padding:0.5rem;">56 characters</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Suffix</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">.b32.i2p</td><td style="border:1px solid var(--color-border); padding:0.5rem;">.b32.i2p</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Total Length</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">60 chars</td><td style="border:1px solid var(--color-border); padding:0.5rem;">64 chars</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Checksum</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">None</td><td style="border:1px solid var(--color-border); padding:0.5rem;">CRC-32 (XOR'd into first 3 bytes)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Use Case</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Regular destinations</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Encrypted LeaseSet destinations</td></tr>
  </tbody>
</table>
<h3 id="usage-restrictions">Usage Restrictions</h3>
<p><strong>BitTorrent Incompatibility:</strong></p>
<p>Encrypted LS2 addresses CANNOT be used with BitTorrent&rsquo;s compact announce replies:</p>
<pre tabindex="0"><code>Compact announce reply format:
┌────────────────────────────┐
│ 32-byte destination hash   │  ← Only hash, no signature types
│ 2-byte port                │
└────────────────────────────┘
</code></pre><p><strong>Problem:</strong> Compact format only contains the hash (32 bytes), with no room for signature types or public key information.</p>
<p><strong>Solution:</strong> Use full announce replies or HTTP-based trackers that support full addresses.</p>
<h3 id="address-book-integration">Address Book Integration</h3>
<p>If a client has the full Destination in an address book:</p>
<ol>
<li>Store full Destination (includes public key)</li>
<li>Support reverse lookup by hash</li>
<li>When encrypted LS2 is encountered, retrieve public key from address book</li>
<li>No need for new base32 format if full Destination already known</li>
</ol>
<p><strong>Address book formats that support encrypted LS2:</strong></p>
<ul>
<li>hosts.txt with full destination strings</li>
<li>SQLite databases with destination column</li>
<li>JSON/XML formats with full destination data</li>
</ul>
<h3 id="implementation-examples">Implementation Examples</h3>
<p><strong>Example 1: Generate Address</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Ed25519 destination example</span>
</span></span><span style="display:flex;"><span>pubkey <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>)  <span style="color:#75715e"># 32-byte public key</span>
</span></span><span style="display:flex;"><span>unblinded_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>   <span style="color:#75715e"># Ed25519</span>
</span></span><span style="display:flex;"><span>blinded_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>    <span style="color:#75715e"># Red25519 (always)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>address <span style="color:#f92672">=</span> generate_encrypted_b32_address(pubkey, unblinded_type, blinded_type)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Address: </span><span style="color:#e6db74">{</span>address<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output: 56 base32 characters + .b32.i2p</span>
</span></span></code></pre></div><p><strong>Example 2: Parse and Validate</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;abc...xyz.b32.i2p&#34;</span>  <span style="color:#75715e"># 56 chars + suffix</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    pubkey, unblinded, blinded <span style="color:#f92672">=</span> parse_encrypted_b32_address(address)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Public Key: </span><span style="color:#e6db74">{</span>pubkey<span style="color:#f92672">.</span>hex()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Unblinded SigType: </span><span style="color:#e6db74">{</span>unblinded<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Blinded SigType: </span><span style="color:#e6db74">{</span>blinded<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid address: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p><strong>Example 3: Convert from Destination</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">destination_to_encrypted_b32</span>(destination):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Convert full Destination to encrypted LS2 base32 address.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        destination: I2P Destination object
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Base32 address string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract public key and signature type from destination</span>
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> destination<span style="color:#f92672">.</span>signing_public_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    sigtype <span style="color:#f92672">=</span> destination<span style="color:#f92672">.</span>sig_type  <span style="color:#75715e"># 7 or 11</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Blinded type is always 11 (Red25519)</span>
</span></span><span style="display:flex;"><span>    blinded_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate address</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> generate_encrypted_b32_address(pubkey, sigtype, blinded_type)
</span></span></code></pre></div><h3 id="security-considerations-2">Security Considerations</h3>
<p><strong>Privacy:</strong></p>
<ul>
<li>Base32 address reveals the public key</li>
<li>This is intentional and required for the protocol</li>
<li>Does NOT reveal the private key or compromise security</li>
<li>Public keys are public information by design</li>
</ul>
<p><strong>Collision Resistance:</strong></p>
<ul>
<li>CRC-32 provides only 32 bits of collision resistance</li>
<li>Not cryptographically secure (use only for error detection)</li>
<li>Do NOT rely on checksum for authentication</li>
<li>Full destination verification still required</li>
</ul>
<p><strong>Address Validation:</strong></p>
<ul>
<li>Always validate checksum before use</li>
<li>Reject addresses with invalid signature types</li>
<li>Verify public key is on the curve (implementation specific)</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="../../../../en/proposals/149-b32-encrypted-ls2/">Proposal 149: B32 for Encrypted LS2</a></li>
<li>[B32 Addressing Specification](/docs/specs/b32-for-encrypted-leasesets/</li>
<li><a href="../../../../en/docs/overview/naming/">I2P Naming Specification</a></li>
</ul>
<hr>
<h2 id="offline-keys-support">Offline Keys Support</h2>
<h3 id="overview-4">Overview</h3>
<p>Offline keys allow the main signing key to remain offline (cold storage) while a transient signing key is used for day-to-day operations. This is critical for high-security services.</p>
<p><strong>Encrypted LS2 Specific Requirements:</strong></p>
<ul>
<li>Transient keys must be generated offline</li>
<li>Blinded private keys must be pre-generated (one per day)</li>
<li>Both transient and blinded keys delivered in batches</li>
<li>No standardized file format yet defined (TODO in specification)</li>
</ul>
<h3 id="offline-key-structure">Offline Key Structure</h3>
<p><strong>Layer 0 Transient Key Data (when flag bit 0 = 1):</strong></p>
<pre tabindex="0"><code>┌───────────────────────────────────────────────────┐
│ Expires Timestamp       │ 4 bytes (seconds)       │
│ Transient Sig Type      │ 2 bytes (big endian)    │
│ Transient Signing Pubkey│ Variable (sigtype len)  │
│ Signature (by blinded)  │ 64 bytes (Red25519)     │
└───────────────────────────────────────────────────┘
</code></pre><p><strong>Signature Coverage:</strong>
The signature in the offline key block covers:</p>
<ul>
<li>Expires timestamp (4 bytes)</li>
<li>Transient sig type (2 bytes)</li>
<li>Transient signing public key (variable)</li>
</ul>
<p>This signature is verified using the <strong>blinded public key</strong>, proving that the entity with the blinded private key authorized this transient key.</p>
<h3 id="key-generation-process">Key Generation Process</h3>
<p><strong>For Encrypted LeaseSet with Offline Keys:</strong></p>
<ol>
<li>
<p><strong>Generate transient keypairs</strong> (offline, in cold storage):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># For each day in future</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> date <span style="color:#f92672">in</span> future_dates:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate daily transient keypair</span>
</span></span><span style="display:flex;"><span>    transient_privkey <span style="color:#f92672">=</span> generate_red25519_privkey()  <span style="color:#75715e"># Type 11</span>
</span></span><span style="display:flex;"><span>    transient_pubkey <span style="color:#f92672">=</span> derive_public(transient_privkey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Store for later delivery</span>
</span></span><span style="display:flex;"><span>    keys[date] <span style="color:#f92672">=</span> (transient_privkey, transient_pubkey)
</span></span></code></pre></div></li>
<li>
<p><strong>Generate daily blinded keypairs</strong> (offline, in cold storage):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># For each day</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> date <span style="color:#f92672">in</span> future_dates:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive alpha for this date</span>
</span></span><span style="display:flex;"><span>    datestring <span style="color:#f92672">=</span> date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>)  <span style="color:#75715e"># &#34;YYYYMMDD&#34;</span>
</span></span><span style="display:flex;"><span>    alpha <span style="color:#f92672">=</span> GENERATE_ALPHA(destination, datestring, secret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Blind the signing private key</span>
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> destination_signing_privkey  <span style="color:#75715e"># Type 7 or 11</span>
</span></span><span style="display:flex;"><span>    blinded_privkey <span style="color:#f92672">=</span> BLIND_PRIVKEY(a, alpha)  <span style="color:#75715e"># Result is type 11</span>
</span></span><span style="display:flex;"><span>    blinded_pubkey <span style="color:#f92672">=</span> DERIVE_PUBLIC(blinded_privkey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Store for later delivery</span>
</span></span><span style="display:flex;"><span>    blinded_keys[date] <span style="color:#f92672">=</span> (blinded_privkey, blinded_pubkey)
</span></span></code></pre></div></li>
<li>
<p><strong>Sign transient keys with blinded keys</strong> (offline):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> date <span style="color:#f92672">in</span> future_dates:
</span></span><span style="display:flex;"><span>    transient_pubkey <span style="color:#f92672">=</span> keys[date][<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    blinded_privkey <span style="color:#f92672">=</span> blinded_keys[date][<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create signature data</span>
</span></span><span style="display:flex;"><span>    expires <span style="color:#f92672">=</span> int((date <span style="color:#f92672">+</span> timedelta(days<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>timestamp())
</span></span><span style="display:flex;"><span>    sig_data <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, expires)  <span style="color:#75715e"># 4 bytes</span>
</span></span><span style="display:flex;"><span>    sig_data <span style="color:#f92672">+=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, <span style="color:#ae81ff">11</span>)     <span style="color:#75715e"># Transient type (Red25519)</span>
</span></span><span style="display:flex;"><span>    sig_data <span style="color:#f92672">+=</span> transient_pubkey          <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Sign with blinded private key</span>
</span></span><span style="display:flex;"><span>    signature <span style="color:#f92672">=</span> RED25519_SIGN(blinded_privkey, sig_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Package for delivery</span>
</span></span><span style="display:flex;"><span>    offline_sig_blocks[date] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;expires&#39;</span>: expires,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;transient_type&#39;</span>: <span style="color:#ae81ff">11</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;transient_pubkey&#39;</span>: transient_pubkey,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;signature&#39;</span>: signature
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></li>
<li>
<p><strong>Package for delivery to router:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># For each date</span>
</span></span><span style="display:flex;"><span>delivery_package[date] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;transient_privkey&#39;</span>: keys[date][<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;transient_pubkey&#39;</span>: keys[date][<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;blinded_privkey&#39;</span>: blinded_keys[date][<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;blinded_pubkey&#39;</span>: blinded_keys[date][<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;offline_sig_block&#39;</span>: offline_sig_blocks[date]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h3 id="router-usage">Router Usage</h3>
<p><strong>Daily Key Loading:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># At UTC midnight (or before publishing)</span>
</span></span><span style="display:flex;"><span>date <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()<span style="color:#f92672">.</span>date()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load keys for today</span>
</span></span><span style="display:flex;"><span>today_keys <span style="color:#f92672">=</span> load_delivery_package(date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>transient_privkey <span style="color:#f92672">=</span> today_keys[<span style="color:#e6db74">&#39;transient_privkey&#39;</span>]
</span></span><span style="display:flex;"><span>transient_pubkey <span style="color:#f92672">=</span> today_keys[<span style="color:#e6db74">&#39;transient_pubkey&#39;</span>]
</span></span><span style="display:flex;"><span>blinded_privkey <span style="color:#f92672">=</span> today_keys[<span style="color:#e6db74">&#39;blinded_privkey&#39;</span>]
</span></span><span style="display:flex;"><span>blinded_pubkey <span style="color:#f92672">=</span> today_keys[<span style="color:#e6db74">&#39;blinded_pubkey&#39;</span>]
</span></span><span style="display:flex;"><span>offline_sig_block <span style="color:#f92672">=</span> today_keys[<span style="color:#e6db74">&#39;offline_sig_block&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use these keys for today&#39;s encrypted LeaseSet</span>
</span></span></code></pre></div><p><strong>Publishing Process:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 1. Create inner LeaseSet2</span>
</span></span><span style="display:flex;"><span>inner_ls2 <span style="color:#f92672">=</span> create_leaseset2(
</span></span><span style="display:flex;"><span>    destinations, leases, expires, 
</span></span><span style="display:flex;"><span>    signing_key<span style="color:#f92672">=</span>transient_privkey  <span style="color:#75715e"># Use transient key</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. Encrypt Layer 2</span>
</span></span><span style="display:flex;"><span>layer2_ciphertext <span style="color:#f92672">=</span> encrypt_layer2(inner_ls2, authCookie, subcredential, timestamp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. Create Layer 1 with authorization data</span>
</span></span><span style="display:flex;"><span>layer1_plaintext <span style="color:#f92672">=</span> create_layer1(authorization_data, layer2_ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. Encrypt Layer 1  </span>
</span></span><span style="display:flex;"><span>layer1_ciphertext <span style="color:#f92672">=</span> encrypt_layer1(layer1_plaintext, subcredential, timestamp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. Create Layer 0 with offline signature block</span>
</span></span><span style="display:flex;"><span>layer0 <span style="color:#f92672">=</span> create_layer0(
</span></span><span style="display:flex;"><span>    blinded_pubkey,
</span></span><span style="display:flex;"><span>    timestamp,
</span></span><span style="display:flex;"><span>    expires,
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0001</span>,  <span style="color:#75715e"># Bit 0 set (offline keys present)</span>
</span></span><span style="display:flex;"><span>    offline_sig_block<span style="color:#f92672">=</span>offline_sig_block,
</span></span><span style="display:flex;"><span>    layer1_ciphertext<span style="color:#f92672">=</span>layer1_ciphertext
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. Sign Layer 0 with transient private key</span>
</span></span><span style="display:flex;"><span>signature <span style="color:#f92672">=</span> RED25519_SIGN(transient_privkey, layer0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7. Append signature and publish</span>
</span></span><span style="display:flex;"><span>encrypted_leaseset <span style="color:#f92672">=</span> layer0 <span style="color:#f92672">+</span> signature
</span></span><span style="display:flex;"><span>publish_to_netdb(encrypted_leaseset)
</span></span></code></pre></div><h3 id="security-considerations-3">Security Considerations</h3>
<p><strong>Tracking via Offline Signature Block:</strong></p>
<p>The offline signature block is in plaintext (Layer 0). An adversary scraping floodfills could:</p>
<ul>
<li>Track the same encrypted LeaseSet across multiple days</li>
<li>Correlate encrypted LeaseSets even though blinded keys change daily</li>
</ul>
<p><strong>Mitigation:</strong> Generate new transient keys daily (in addition to blinded keys):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate BOTH new transient and new blinded keys each day</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> date <span style="color:#f92672">in</span> future_dates:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># New transient keypair for this day</span>
</span></span><span style="display:flex;"><span>    transient_privkey <span style="color:#f92672">=</span> generate_red25519_privkey()
</span></span><span style="display:flex;"><span>    transient_pubkey <span style="color:#f92672">=</span> derive_public(transient_privkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># New blinded keypair for this day</span>
</span></span><span style="display:flex;"><span>    alpha <span style="color:#f92672">=</span> GENERATE_ALPHA(destination, datestring, secret)
</span></span><span style="display:flex;"><span>    blinded_privkey <span style="color:#f92672">=</span> BLIND_PRIVKEY(signing_privkey, alpha)
</span></span><span style="display:flex;"><span>    blinded_pubkey <span style="color:#f92672">=</span> DERIVE_PUBLIC(blinded_privkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Sign new transient key with new blinded key</span>
</span></span><span style="display:flex;"><span>    sig <span style="color:#f92672">=</span> RED25519_SIGN(blinded_privkey, transient_pubkey <span style="color:#f92672">||</span> metadata)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Now offline sig block changes daily</span>
</span></span></code></pre></div><p><strong>Benefits:</strong></p>
<ul>
<li>Prevents tracking across days via offline signature block</li>
<li>Provides same security as encrypted LS2 without offline keys</li>
<li>Each day appears completely independent</li>
</ul>
<p><strong>Cost:</strong></p>
<ul>
<li>More keys to generate and store</li>
<li>More complex key management</li>
</ul>
<h3 id="file-format-todo">File Format (TODO)</h3>
<p><strong>Current Status:</strong> No standardized file format defined for batch key delivery.</p>
<p><strong>Requirements for Future Format:</strong></p>
<ol>
<li>
<p><strong>Must support multiple dates:</strong></p>
<ul>
<li>Batch delivery of 30+ days worth of keys</li>
<li>Clear date association for each key set</li>
</ul>
</li>
<li>
<p><strong>Must include all necessary data:</strong></p>
<ul>
<li>Transient private key</li>
<li>Transient public key</li>
<li>Blinded private key</li>
<li>Blinded public key</li>
<li>Pre-computed offline signature block</li>
<li>Expiration timestamps</li>
</ul>
</li>
<li>
<p><strong>Should be tamper-evident:</strong></p>
<ul>
<li>Checksums or signatures over entire file</li>
<li>Integrity verification before loading</li>
</ul>
</li>
<li>
<p><strong>Should be encrypted:</strong></p>
<ul>
<li>Keys are sensitive material</li>
<li>Encrypt file with router&rsquo;s key or passphrase</li>
</ul>
</li>
</ol>
<p><strong>Proposed Format Example (JSON, encrypted):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;destination_hash&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;keys&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;date&#34;</span>: <span style="color:#e6db74">&#34;2025-10-15&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;transient&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#ae81ff">11</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;privkey&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;pubkey&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;blinded&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;privkey&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;pubkey&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;offline_sig_block&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;expires&#34;</span>: <span style="color:#ae81ff">1729123200</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;signature&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;signature&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>  <span style="color:#75715e">// Signature over entire structure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="i2cp-protocol-enhancement-todo">I2CP Protocol Enhancement (TODO)</h3>
<p><strong>Current Status:</strong> No I2CP protocol enhancement defined for offline keys with encrypted LeaseSet.</p>
<p><strong>Requirements:</strong></p>
<ol>
<li>
<p><strong>Key delivery mechanism:</strong></p>
<ul>
<li>Upload batch of keys from client to router</li>
<li>Acknowledgment of successful key loading</li>
</ul>
</li>
<li>
<p><strong>Key expiration notification:</strong></p>
<ul>
<li>Router notifies client when keys running low</li>
<li>Client can generate and upload new batch</li>
</ul>
</li>
<li>
<p><strong>Key revocation:</strong></p>
<ul>
<li>Emergency revocation of future keys if compromise suspected</li>
</ul>
</li>
</ol>
<p><strong>Proposed I2CP Messages:</strong></p>
<pre tabindex="0"><code>UPLOAD_OFFLINE_KEYS
  - Batch of encrypted key material
  - Date range covered

OFFLINE_KEY_STATUS
  - Number of days remaining
  - Next key expiration date

REVOKE_OFFLINE_KEYS  
  - Date range to revoke
  - New keys to replace (optional)
</code></pre><h3 id="implementation-status">Implementation Status</h3>
<p><strong>Java I2P:</strong></p>
<ul>
<li>✅ Offline keys for standard LS2: Fully supported (since 0.9.38)</li>
<li>⚠️ Offline keys for encrypted LS2: Implemented (since 0.9.40)</li>
<li>❌ File format: Not standardized</li>
<li>❌ I2CP protocol: Not enhanced</li>
</ul>
<p><strong>i2pd (C++):</strong></p>
<ul>
<li>✅ Offline keys for standard LS2: Fully supported</li>
<li>✅ Offline keys for encrypted LS2: Fully supported (since 2.58.0)</li>
<li>❌ File format: Not standardized</li>
<li>❌ I2CP protocol: Not enhanced</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="../../../../en/proposals/123-new-netdb-entries/">Offline Signatures Proposal</a></li>
<li><a href="../../../../en/docs/specs/i2cp/">I2CP Specification</a></li>
</ul>
<hr>
<h2 id="security-considerations-4">Security Considerations</h2>
<h3 id="cryptographic-security">Cryptographic Security</h3>
<p><strong>Algorithm Selection:</strong></p>
<p>All cryptographic primitives are based on well-studied algorithms:</p>
<ul>
<li><strong>ChaCha20:</strong> Modern stream cipher, constant-time, no timing attacks</li>
<li><strong>SHA-256:</strong> NIST-approved hash, 128-bit security level</li>
<li><strong>HKDF:</strong> RFC 5869 standard, proven security bounds</li>
<li><strong>Ed25519/Red25519:</strong> Curve25519-based, ~128-bit security level</li>
<li><strong>X25519:</strong> Diffie-Hellman over Curve25519, ~128-bit security level</li>
</ul>
<p><strong>Key Sizes:</strong></p>
<ul>
<li>All symmetric keys: 256 bits (32 bytes)</li>
<li>All public/private keys: 256 bits (32 bytes)</li>
<li>All nonces/IVs: 96 bits (12 bytes)</li>
<li>All signatures: 512 bits (64 bytes)</li>
</ul>
<p>These sizes provide adequate security margins against current and near-future attacks.</p>
<h3 id="forward-secrecy">Forward Secrecy</h3>
<p><strong>Daily Key Rotation:</strong></p>
<p>Encrypted LeaseSets rotate keys daily (UTC midnight):</p>
<ul>
<li>New blinded public/private key pair</li>
<li>New storage location in DHT</li>
<li>New encryption keys for both layers</li>
</ul>
<p><strong>Benefits:</strong></p>
<ul>
<li>Compromising today&rsquo;s blinded key doesn&rsquo;t reveal yesterday&rsquo;s</li>
<li>Limits exposure window to 24 hours</li>
<li>Prevents long-term tracking via DHT</li>
</ul>
<p><strong>Enhanced with Ephemeral Keys:</strong></p>
<p>DH client authorization uses ephemeral keys:</p>
<ul>
<li>Server generates new ephemeral DH keypair for each publication</li>
<li>Compromising ephemeral key only affects that publication</li>
<li>True forward secrecy even if long-term keys compromised</li>
</ul>
<h3 id="privacy-properties">Privacy Properties</h3>
<p><strong>Destination Blinding:</strong></p>
<p>The blinded public key:</p>
<ul>
<li>Is unlinkable to the original destination (without knowing the secret)</li>
<li>Changes daily, preventing long-term correlation</li>
<li>Cannot be reversed to find the original public key</li>
</ul>
<p><strong>Client Membership Privacy:</strong></p>
<p>Per-client authorization provides:</p>
<ul>
<li><strong>Anonymity:</strong> No way to identify which clients are authorized</li>
<li><strong>Untraceability:</strong> Cannot track when specific clients added/revoked</li>
<li><strong>Size obfuscation:</strong> Can add dummy entries to hide true count</li>
</ul>
<p><strong>DHT Privacy:</strong></p>
<p>Storage location rotates daily:</p>
<pre tabindex="0"><code>location = SHA-256(sig_type || blinded_public_key)
</code></pre><p>This prevents:</p>
<ul>
<li>Correlation across days via DHT lookups</li>
<li>Long-term monitoring of service availability</li>
<li>Traffic analysis of DHT queries</li>
</ul>
<h3 id="threat-model">Threat Model</h3>
<p><strong>Adversary Capabilities:</strong></p>
<ol>
<li>
<p><strong>Network Adversary:</strong></p>
<ul>
<li>Can monitor all DHT traffic</li>
<li>Can observe encrypted LeaseSet publications</li>
<li>Cannot decrypt without proper keys</li>
</ul>
</li>
<li>
<p><strong>Floodfill Adversary:</strong></p>
<ul>
<li>Can store and analyze all encrypted LeaseSets</li>
<li>Can track publication patterns over time</li>
<li>Cannot decrypt Layer 1 or Layer 2</li>
<li>Can see client count (but not identities)</li>
</ul>
</li>
<li>
<p><strong>Authorized Client Adversary:</strong></p>
<ul>
<li>Can decrypt specific encrypted LeaseSets</li>
<li>Can access inner LeaseSet2 data</li>
<li>Cannot determine other clients&rsquo; identities</li>
<li>Cannot decrypt past LeaseSets (with ephemeral keys)</li>
</ul>
</li>
</ol>
<p><strong>Out of Scope:</strong></p>
<ul>
<li>Malicious router implementations</li>
<li>Compromised router host systems</li>
<li>Side-channel attacks (timing, power analysis)</li>
<li>Physical access to keys</li>
<li>Social engineering attacks</li>
</ul>
<h3 id="attack-scenarios">Attack Scenarios</h3>
<p><strong>1. Offline Keys Tracking Attack:</strong></p>
<p><strong>Attack:</strong> Adversary tracks encrypted LeaseSets via unchanging offline signature block.</p>
<p><strong>Mitigation:</strong> Generate new transient keys daily (in addition to blinded keys).</p>
<p><strong>Status:</strong> Documented recommendation, implementation-specific.</p>
<p><strong>2. Client Position Inference Attack:</strong></p>
<p><strong>Attack:</strong> If client order is static, clients can infer their position and detect when other clients added/removed.</p>
<p><strong>Mitigation:</strong> Randomize client order in authorization list for each publication.</p>
<p><strong>Status:</strong> Documented recommendation in specification.</p>
<p><strong>3. Client Count Analysis Attack:</strong></p>
<p><strong>Attack:</strong> Adversary monitors client count changes over time to infer service popularity or client churn.</p>
<p><strong>Mitigation:</strong> Add random dummy entries to authorization list.</p>
<p><strong>Status:</strong> Optional feature, deployment-specific trade-off (size vs. privacy).</p>
<p><strong>4. PSK Interception Attack:</strong></p>
<p><strong>Attack:</strong> Adversary intercepts PSK during out-of-band exchange and can decrypt all future encrypted LeaseSets.</p>
<p><strong>Mitigation:</strong> Use DH client authorization instead, or ensure secure key exchange (Signal, OTR, PGP).</p>
<p><strong>Status:</strong> Known limitation of PSK approach, documented in specification.</p>
<p><strong>5. Timing Correlation Attack:</strong></p>
<p><strong>Attack:</strong> Adversary correlates publication times across days to link encrypted LeaseSets.</p>
<p><strong>Mitigation:</strong> Randomize publication times, use delayed publishing.</p>
<p><strong>Status:</strong> Implementation-specific, not addressed in core specification.</p>
<p><strong>6. Long-term Secret Compromise:</strong></p>
<p><strong>Attack:</strong> Adversary compromises the blinding secret and can compute all past and future blinded keys.</p>
<p><strong>Mitigation:</strong></p>
<ul>
<li>Use optional secret parameter (not empty)</li>
<li>Rotate secret periodically</li>
<li>Use different secrets for different services</li>
</ul>
<p><strong>Status:</strong> Secret parameter is optional; using it is highly recommended.</p>
<h3 id="operational-security">Operational Security</h3>
<p><strong>Key Management:</strong></p>
<ol>
<li>
<p><strong>Signing Private Key:</strong></p>
<ul>
<li>Store offline in cold storage</li>
<li>Use only for generating blinded keys (batch process)</li>
<li>Never expose to online router</li>
</ul>
</li>
<li>
<p><strong>Blinded Private Keys:</strong></p>
<ul>
<li>Generate offline, deliver in batches</li>
<li>Rotate daily automatically</li>
<li>Delete after use (forward secrecy)</li>
</ul>
</li>
<li>
<p><strong>Transient Private Keys (with offline keys):</strong></p>
<ul>
<li>Generate offline, deliver in batches</li>
<li>Can be longer-lived (days/weeks)</li>
<li>Rotate regularly for enhanced privacy</li>
</ul>
</li>
<li>
<p><strong>Client Authorization Keys:</strong></p>
<ul>
<li>DH: Client private keys never leave client device</li>
<li>PSK: Use unique keys per client, secure exchange</li>
<li>Revoke immediately upon client removal</li>
</ul>
</li>
</ol>
<p><strong>Secret Management:</strong></p>
<p>The optional secret parameter in <code>GENERATE_ALPHA</code>:</p>
<ul>
<li>SHOULD be used for high-security services</li>
<li>MUST be transmitted securely to authorized clients</li>
<li>SHOULD be rotated periodically (e.g., monthly)</li>
<li>CAN be different for different client groups</li>
</ul>
<p><strong>Monitoring and Auditing:</strong></p>
<ol>
<li>
<p><strong>Publication Monitoring:</strong></p>
<ul>
<li>Verify encrypted LeaseSets published successfully</li>
<li>Monitor floodfill acceptance rates</li>
<li>Alert on publication failures</li>
</ul>
</li>
<li>
<p><strong>Client Access Monitoring:</strong></p>
<ul>
<li>Log client authorization attempts (without identifying clients)</li>
<li>Monitor for unusual patterns</li>
<li>Detect potential attacks early</li>
</ul>
</li>
<li>
<p><strong>Key Rotation Auditing:</strong></p>
<ul>
<li>Verify daily key rotation occurs</li>
<li>Check blinded key changes daily</li>
<li>Ensure old keys are deleted</li>
</ul>
</li>
</ol>
<h3 id="implementation-security">Implementation Security</h3>
<p><strong>Constant-Time Operations:</strong></p>
<p>Implementations MUST use constant-time operations for:</p>
<ul>
<li>All scalar arithmetic (mod L operations)</li>
<li>Private key comparisons</li>
<li>Signature verification</li>
<li>DH key agreement</li>
</ul>
<p><strong>Memory Security:</strong></p>
<ul>
<li>Zero sensitive key material after use</li>
<li>Use secure memory allocation for keys</li>
<li>Prevent keys from being paged to disk</li>
<li>Clear stack variables containing key material</li>
</ul>
<p><strong>Random Number Generation:</strong></p>
<ul>
<li>Use cryptographically secure RNG (CSRNG)</li>
<li>Properly seed RNG from OS entropy source</li>
<li>Do not use predictable RNGs for key material</li>
<li>Verify RNG output quality periodically</li>
</ul>
<p><strong>Input Validation:</strong></p>
<ul>
<li>Validate all public keys are on the curve</li>
<li>Check all signature types are supported</li>
<li>Verify all lengths before parsing</li>
<li>Reject malformed encrypted LeaseSets early</li>
</ul>
<p><strong>Error Handling:</strong></p>
<ul>
<li>Do not leak information via error messages</li>
<li>Use constant-time comparison for authentication</li>
<li>Do not expose timing differences in decryption</li>
<li>Log security-relevant events properly</li>
</ul>
<h3 id="recommendations">Recommendations</h3>
<p><strong>For Service Operators:</strong></p>
<ol>
<li>✅ <strong>Use Red25519 (type 11)</strong> for new destinations</li>
<li>✅ <strong>Use DH client authorization</strong> for high-security services</li>
<li>✅ <strong>Generate new transient keys daily</strong> when using offline keys</li>
<li>✅ <strong>Use the optional secret parameter</strong> in GENERATE_ALPHA</li>
<li>✅ <strong>Randomize client order</strong> in authorization lists</li>
<li>✅ <strong>Monitor publication success</strong> and investigate failures</li>
<li>⚠️ <strong>Consider dummy entries</strong> to hide client count (size trade-off)</li>
</ol>
<p><strong>For Client Implementers:</strong></p>
<ol>
<li>✅ <strong>Validate blinded public keys</strong> are on prime-order subgroup</li>
<li>✅ <strong>Verify all signatures</strong> before trusting data</li>
<li>✅ <strong>Use constant-time operations</strong> for cryptographic primitives</li>
<li>✅ <strong>Zero key material</strong> immediately after use</li>
<li>✅ <strong>Implement proper error handling</strong> without information leaks</li>
<li>✅ <strong>Support both Ed25519 and Red25519</strong> destination types</li>
</ol>
<p><strong>For Network Operators:</strong></p>
<ol>
<li>✅ <strong>Accept encrypted LeaseSets</strong> in floodfill routers</li>
<li>✅ <strong>Enforce reasonable size limits</strong> to prevent abuse</li>
<li>✅ <strong>Monitor for anomalous patterns</strong> (extremely large, frequent updates)</li>
<li>⚠️ <strong>Consider rate limiting</strong> encrypted LeaseSet publications</li>
</ol>
<hr>
<h2 id="implementation-notes">Implementation Notes</h2>
<h3 id="java-i2p-implementation">Java I2P Implementation</h3>
<p><strong>Repository:</strong> <a href="https://github.com/i2p/i2p.i2p">https://github.com/i2p/i2p.i2p</a></p>
<p><strong>Key Classes:</strong></p>
<ul>
<li><code>net.i2p.data.LeaseSet2</code> - LeaseSet2 structure</li>
<li><code>net.i2p.data.EncryptedLeaseSet</code> - Encrypted LS2 implementation</li>
<li><code>net.i2p.crypto.eddsa.EdDSAEngine</code> - Ed25519/Red25519 signatures</li>
<li><code>net.i2p.crypto.HKDF</code> - HKDF implementation</li>
<li><code>net.i2p.crypto.ChaCha20</code> - ChaCha20 cipher</li>
</ul>
<p><strong>Configuration:</strong></p>
<p>Enable encrypted LeaseSet in <code>clients.config</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Enable encrypted LeaseSet</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.encryptLeaseSet</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Optional: Enable client authorization</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.enableAccessList</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Optional: Use DH authorization (default is PSK)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.accessListType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Optional: Blinding secret (highly recommended)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.blindingSecret</span><span style="color:#f92672">=</span><span style="color:#e6db74">your-secret-here</span>
</span></span></code></pre></div><p><strong>API Usage Example:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// Create encrypted LeaseSet</span>
</span></span><span style="display:flex;"><span>EncryptedLeaseSet els <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EncryptedLeaseSet();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Set destination</span>
</span></span><span style="display:flex;"><span>els.<span style="color:#a6e22e">setDestination</span>(destination);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Enable per-client authorization</span>
</span></span><span style="display:flex;"><span>els.<span style="color:#a6e22e">setAuthorizationEnabled</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>els.<span style="color:#a6e22e">setAuthType</span>(EncryptedLeaseSet.<span style="color:#a6e22e">AUTH_DH</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Add authorized clients (DH public keys)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> clientPubKey : authorizedClients) {
</span></span><span style="display:flex;"><span>    els.<span style="color:#a6e22e">addClient</span>(clientPubKey);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Set blinding parameters</span>
</span></span><span style="display:flex;"><span>els.<span style="color:#a6e22e">setBlindingSecret</span>(<span style="color:#e6db74">&#34;your-secret&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Sign and publish</span>
</span></span><span style="display:flex;"><span>els.<span style="color:#a6e22e">sign</span>(signingPrivateKey);
</span></span><span style="display:flex;"><span>netDb.<span style="color:#a6e22e">publish</span>(els);
</span></span></code></pre></div><h3 id="i2pd-c-implementation">i2pd (C++) Implementation</h3>
<p><strong>Repository:</strong> <a href="https://github.com/PurpleI2P/i2pd">https://github.com/PurpleI2P/i2pd</a></p>
<p><strong>Key Files:</strong></p>
<ul>
<li><code>libi2pd/LeaseSet.h/cpp</code> - LeaseSet implementations</li>
<li><code>libi2pd/Crypto.h/cpp</code> - Cryptographic primitives</li>
<li><code>libi2pd/Ed25519.h/cpp</code> - Ed25519/Red25519 signatures</li>
<li><code>libi2pd/ChaCha20.h/cpp</code> - ChaCha20 cipher</li>
</ul>
<p><strong>Configuration:</strong></p>
<p>Enable in tunnel configuration (<code>tunnels.conf</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[my-hidden-service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">host</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">127.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">keys</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">my-service-keys.dat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable encrypted LeaseSet</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">encryptleaseset</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Optional: Client authorization type (0=DH, 1=PSK)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">authtype</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Optional: Blinding secret</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">secret</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">your-secret-here</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Optional: Authorized clients (one per line, base64 encoded public keys)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client.1</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">base64-encoded-client-pubkey-1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client.2</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">base64-encoded-client-pubkey-2</span>
</span></span></code></pre></div><p><strong>API Usage Example:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Create encrypted LeaseSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">auto</span> encryptedLS <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>i2p<span style="color:#f92672">::</span>data<span style="color:#f92672">::</span>EncryptedLeaseSet<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>    destination,
</span></span><span style="display:flex;"><span>    blindingSecret
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Enable per-client authorization
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>encryptedLS<span style="color:#f92672">-&gt;</span>SetAuthType(i2p<span style="color:#f92672">::</span>data<span style="color:#f92672">::</span>AUTH_TYPE_DH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Add authorized clients
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> clientPubKey : authorizedClients) {
</span></span><span style="display:flex;"><span>    encryptedLS<span style="color:#f92672">-&gt;</span>AddClient(clientPubKey);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Sign and publish
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>encryptedLS<span style="color:#f92672">-&gt;</span>Sign(signingPrivKey);
</span></span><span style="display:flex;"><span>netdb.Publish(encryptedLS);
</span></span></code></pre></div><h3 id="testing-and-debugging">Testing and Debugging</h3>
<p><strong>Test Vectors:</strong></p>
<p>Generate test vectors for implementation verification:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Test vector 1: Key blinding</span>
</span></span><span style="display:flex;"><span>destination_pubkey <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>blinded_sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;20251015&#34;</span>
</span></span><span style="display:flex;"><span>secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>alpha <span style="color:#f92672">=</span> generate_alpha(destination_pubkey, sigtype, blinded_sigtype, date, secret)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Alpha: </span><span style="color:#e6db74">{</span>alpha<span style="color:#f92672">.</span>hex()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Expected: (verify against reference implementation)</span>
</span></span></code></pre></div><p><strong>Unit Tests:</strong></p>
<p>Key areas to test:</p>
<ol>
<li>HKDF derivation with various inputs</li>
<li>ChaCha20 encryption/decryption</li>
<li>Red25519 signature generation and verification</li>
<li>Key blinding (private and public)</li>
<li>Layer 1/2 encryption/decryption</li>
<li>Client authorization (DH and PSK)</li>
<li>Base32 address generation and parsing</li>
</ol>
<p><strong>Integration Tests:</strong></p>
<ol>
<li>Publish encrypted LeaseSet to test network</li>
<li>Retrieve and decrypt from client</li>
<li>Verify daily key rotation</li>
<li>Test client authorization (add/remove clients)</li>
<li>Test offline keys (if supported)</li>
</ol>
<p><strong>Common Implementation Errors:</strong></p>
<ol>
<li><strong>Incorrect mod L reduction:</strong> Must use proper modular arithmetic</li>
<li><strong>Endianness errors:</strong> Most fields are big-endian, but some crypto uses little-endian</li>
<li><strong>Off-by-one in array slicing:</strong> Verify indices are inclusive/exclusive as needed</li>
<li><strong>Missing constant-time comparisons:</strong> Use constant-time for all sensitive comparisons</li>
<li><strong>Not zeroing key material:</strong> Always zero keys after use</li>
</ol>
<h3 id="performance-considerations">Performance Considerations</h3>
<p><strong>Computational Costs:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Operation</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Cost</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Key blinding (server)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 scalar mult</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per publication</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Key blinding (client)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 point add + 1 scalar mult</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per retrieval</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Layer 1 encryption</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 HKDF + 1 ChaCha20</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Fast</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Layer 2 encryption</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 HKDF + 1 ChaCha20</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Fast</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">DH client auth (server)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">N+1 X25519 ops</td><td style="border:1px solid var(--color-border); padding:0.5rem;">N = number of clients</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">DH client auth (client)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 X25519 op</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per retrieval</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">PSK client auth</td><td style="border:1px solid var(--color-border); padding:0.5rem;">0 DH ops</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Only HKDF + ChaCha20</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Signature (Red25519)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 signature op</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Similar cost to Ed25519</td></tr>
  </tbody>
</table>
<p><strong>Size Overhead:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Component</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Blinded public key</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Layer 1 encryption overhead</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes (salt)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Layer 2 encryption overhead</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes (salt)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">DH auth per client</td><td style="border:1px solid var(--color-border); padding:0.5rem;">40 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per client per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">DH ephemeral pubkey</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet (if DH auth)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">PSK auth per client</td><td style="border:1px solid var(--color-border); padding:0.5rem;">40 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per client per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">PSK salt</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet (if PSK auth)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Signature</td><td style="border:1px solid var(--color-border); padding:0.5rem;">64 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Offline sig block</td><td style="border:1px solid var(--color-border); padding:0.5rem;">≈100 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet (if offline keys)</td></tr>
  </tbody>
</table>
<p><strong>Typical Sizes:</strong></p>
<ul>
<li><strong>No client auth:</strong> ~200 bytes overhead</li>
<li><strong>With 10 DH clients:</strong> ~600 bytes overhead</li>
<li><strong>With 100 DH clients:</strong> ~4200 bytes overhead</li>
</ul>
<p><strong>Optimization Tips:</strong></p>
<ol>
<li><strong>Batch key generation:</strong> Generate blinded keys for multiple days in advance</li>
<li><strong>Cache subcredentials:</strong> Compute once per day, reuse for all publications</li>
<li><strong>Reuse ephemeral keys:</strong> Can reuse ephemeral DH key for short period (minutes)</li>
<li><strong>Parallel client encryption:</strong> Encrypt client cookies in parallel</li>
<li><strong>Fast path for no auth:</strong> Skip authorization layer entirely when disabled</li>
</ol>
<h3 id="compatibility">Compatibility</h3>
<p><strong>Backward Compatibility:</strong></p>
<ul>
<li>Ed25519 (type 7) destinations supported for unblinded keys</li>
<li>Red25519 (type 11) required for blinded keys</li>
<li>Traditional LeaseSets still fully supported</li>
<li>Encrypted LeaseSets do not break existing network</li>
</ul>
<p><strong>Forward Compatibility:</strong></p>
<ul>
<li>Reserved flag bits for future features</li>
<li>Extensible authorization scheme (3 bits allow 8 types)</li>
<li>Version field in various structures</li>
</ul>
<p><strong>Interoperability:</strong></p>
<ul>
<li>Java I2P and i2pd fully interoperable since:
<ul>
<li>Java I2P 0.9.40 (May 2019)</li>
<li>i2pd 2.58.0 (September 2025)</li>
</ul>
</li>
<li>Encrypted LeaseSets work across implementations</li>
<li>Client authorization works across implementations</li>
</ul>
<hr>
<h2 id="references">References</h2>
<h3 id="ietf-rfcs">IETF RFCs</h3>
<ul>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc2104">RFC 2104</a></strong> - HMAC: Keyed-Hashing for Message Authentication (February 1997)</li>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc5869">RFC 5869</a></strong> - HMAC-based Extract-and-Expand Key Derivation Function (HKDF) (May 2010)</li>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc7539">RFC 7539</a></strong> - ChaCha20 and Poly1305 for IETF Protocols (May 2015)</li>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc7748">RFC 7748</a></strong> - Elliptic Curves for Security (January 2016)</li>
</ul>
<h3 id="i2p-specifications">I2P Specifications</h3>
<ul>
<li><strong><a href="../../../../en/docs/specs/common-structures/">Common Structures Specification</a></strong> - LeaseSet2 and EncryptedLeaseSet structures</li>
<li><strong><a href="../../../../en/proposals/123-new-netdb-entries/">Proposal 123: New netDB Entries</a></strong> - Background and design of LeaseSet2</li>
<li><strong><a href="../../../../en/proposals/146-red25519/">Proposal 146: Red25519</a></strong> - Red25519 signature scheme specification</li>
<li><strong><a href="../../../../en/proposals/149-b32-encrypted-ls2/">Proposal 149: B32 for Encrypted LS2</a></strong> - Base32 addressing for encrypted LeaseSets</li>
<li><strong>[Red25519 Specification](/docs/specs/red25519-signature-scheme/</strong> - Detailed Red25519 implementation</li>
<li><strong>[B32 Addressing Specification](/docs/specs/b32-for-encrypted-leasesets/</strong> - Base32 address format</li>
<li><strong><a href="../../../../en/docs/specs/common-structures/">Network Database Documentation</a></strong> - NetDB usage and operations</li>
<li><strong><a href="../../../../en/docs/specs/i2cp/">I2CP Specification</a></strong> - I2P Client Protocol</li>
</ul>
<h3 id="cryptographic-references">Cryptographic References</h3>
<ul>
<li><strong><a href="http://cr.yp.to/papers.html#ed25519">Ed25519 Paper</a></strong> - &ldquo;High-speed high-security signatures&rdquo; by Bernstein et al.</li>
<li><strong><a href="https://zips.z.cash/protocol/protocol.pdf">ZCash Protocol Specification</a></strong> - Section 5.4.6: RedDSA signature scheme</li>
<li><strong><a href="https://spec.torproject.org/rend-spec">Tor Rendezvous Specification v3</a></strong> - Tor&rsquo;s onion service specification (for comparison)</li>
</ul>
<h3 id="security-references">Security References</h3>
<ul>
<li><strong><a href="https://lists.torproject.org/pipermail/tor-dev/2013-December/005943.html">Key Blinding Security Discussion</a></strong> - Tor Project mailing list discussion</li>
<li><strong><a href="https://trac.torproject.org/projects/tor/ticket/8106">Tor Ticket #8106</a></strong> - Key blinding implementation discussion</li>
<li><strong><a href="http://projectbullrun.org/dual-ec/ext-rand.html">PRNG Security</a></strong> - Random number generator security considerations</li>
<li><strong><a href="https://lists.torproject.org/pipermail/tor-dev/2015-November/009954.html">Tor PRNG Discussion</a></strong> - Discussion of PRNG usage in Tor</li>
</ul>
<h3 id="implementation-references">Implementation References</h3>
<ul>
<li><strong><a href="https://github.com/i2p/i2p.i2p">Java I2P Repository</a></strong> - Official Java implementation</li>
<li><strong><a href="https://github.com/PurpleI2P/i2pd">i2pd Repository</a></strong> - C++ implementation</li>
<li><strong><a href="../../../../en/">I2P Website</a></strong> - Official I2P project website</li>
<li><strong><a href="../../../../spec/">I2P Specifications</a></strong> - Complete specification index</li>
</ul>
<h3 id="version-history">Version History</h3>
<ul>
<li><strong><a href="../../../../en/blog">I2P Release Notes</a></strong> - Official release announcements</li>
<li><strong><a href="https://github.com/i2p/i2p.i2p/releases">Java I2P Releases</a></strong> - GitHub release history</li>
<li><strong><a href="https://github.com/PurpleI2P/i2pd/releases">i2pd Releases</a></strong> - GitHub release history</li>
</ul>
<hr>
<h2 id="appendix-a-cryptographic-constants">Appendix A: Cryptographic Constants</h2>
<h3 id="ed25519--red25519-constants">Ed25519 / Red25519 Constants</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Ed25519 base point (generator)</span>
</span></span><span style="display:flex;"><span>B <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">255</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">19</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ed25519 order (scalar field size)</span>
</span></span><span style="display:flex;"><span>L <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">252</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">27742317777372353535851937790883648493</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Signature type values</span>
</span></span><span style="display:flex;"><span>SIGTYPE_ED25519 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>    <span style="color:#75715e"># 0x0007</span>
</span></span><span style="display:flex;"><span>SIGTYPE_RED25519 <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>  <span style="color:#75715e"># 0x000b</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key sizes</span>
</span></span><span style="display:flex;"><span>PRIVKEY_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>  <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>PUBKEY_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>   <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>SIGNATURE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>  <span style="color:#75715e"># bytes</span>
</span></span></code></pre></div><h3 id="chacha20-constants">ChaCha20 Constants</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ChaCha20 parameters</span>
</span></span><span style="display:flex;"><span>CHACHA20_KEY_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>   <span style="color:#75715e"># bytes (256 bits)</span>
</span></span><span style="display:flex;"><span>CHACHA20_NONCE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>  <span style="color:#75715e"># bytes (96 bits)</span>
</span></span><span style="display:flex;"><span>CHACHA20_INITIAL_COUNTER <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># RFC 7539 permits 0 or 1</span>
</span></span></code></pre></div><h3 id="hkdf-constants">HKDF Constants</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># HKDF parameters</span>
</span></span><span style="display:flex;"><span>HKDF_HASH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SHA-256&#34;</span>
</span></span><span style="display:flex;"><span>HKDF_SALT_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>  <span style="color:#75715e"># bytes (HashLen)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># HKDF info strings (domain separation)</span>
</span></span><span style="display:flex;"><span>HKDF_INFO_ALPHA <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;i2pblinding1&#34;</span>
</span></span><span style="display:flex;"><span>HKDF_INFO_LAYER1 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2_L1K&#34;</span>
</span></span><span style="display:flex;"><span>HKDF_INFO_LAYER2 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2_L2K&#34;</span>
</span></span><span style="display:flex;"><span>HKDF_INFO_DH_AUTH <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2_XCA&#34;</span>
</span></span><span style="display:flex;"><span>HKDF_INFO_PSK_AUTH <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2PSKA&#34;</span>
</span></span></code></pre></div><h3 id="hash-personalization-strings">Hash Personalization Strings</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># SHA-256 personalization strings</span>
</span></span><span style="display:flex;"><span>HASH_PERS_ALPHA <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;I2PGenerateAlpha&#34;</span>
</span></span><span style="display:flex;"><span>HASH_PERS_RED25519 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;I2P_Red25519H(x)&#34;</span>
</span></span><span style="display:flex;"><span>HASH_PERS_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;credential&#34;</span>
</span></span><span style="display:flex;"><span>HASH_PERS_SUBCREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;subcredential&#34;</span>
</span></span></code></pre></div><h3 id="structure-sizes">Structure Sizes</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Layer 0 (outer) sizes</span>
</span></span><span style="display:flex;"><span>BLINDED_SIGTYPE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>   <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>BLINDED_PUBKEY_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>   <span style="color:#75715e"># bytes (for Red25519)</span>
</span></span><span style="display:flex;"><span>PUBLISHED_TS_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>      <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>EXPIRES_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>           <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>FLAGS_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>             <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>LEN_OUTER_CIPHER_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>  <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>SIGNATURE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>        <span style="color:#75715e"># bytes (Red25519)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Offline key block sizes</span>
</span></span><span style="display:flex;"><span>OFFLINE_EXPIRES_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>   <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>OFFLINE_SIGTYPE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>   <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>OFFLINE_SIGNATURE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>  <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Layer 1 (middle) sizes</span>
</span></span><span style="display:flex;"><span>AUTH_FLAGS_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>        <span style="color:#75715e"># byte</span>
</span></span><span style="display:flex;"><span>EPHEMERAL_PUBKEY_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>  <span style="color:#75715e"># bytes (DH auth)</span>
</span></span><span style="display:flex;"><span>AUTH_SALT_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>        <span style="color:#75715e"># bytes (PSK auth)</span>
</span></span><span style="display:flex;"><span>NUM_CLIENTS_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>       <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>CLIENT_ID_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>         <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>CLIENT_COOKIE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>    <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>AUTH_CLIENT_ENTRY_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>  <span style="color:#75715e"># bytes (CLIENT_ID + CLIENT_COOKIE)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encryption overhead</span>
</span></span><span style="display:flex;"><span>SALT_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>  <span style="color:#75715e"># bytes (prepended to each encrypted layer)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Base32 address</span>
</span></span><span style="display:flex;"><span>B32_ENCRYPTED_DECODED_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">35</span>  <span style="color:#75715e"># bytes</span>
</span></span><span style="display:flex;"><span>B32_ENCRYPTED_ENCODED_LEN <span style="color:#f92672">=</span> <span style="color:#ae81ff">56</span>   <span style="color:#75715e"># characters</span>
</span></span><span style="display:flex;"><span>B32_SUFFIX <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.b32.i2p&#34;</span>
</span></span></code></pre></div><hr>
<h2 id="appendix-b-test-vectors">Appendix B: Test Vectors</h2>
<h3 id="test-vector-1-alpha-generation">Test Vector 1: Alpha Generation</h3>
<p><strong>Input:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Destination public key (Ed25519)</span>
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;</span>)
</span></span><span style="display:flex;"><span>stA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0007</span>  <span style="color:#75715e"># Ed25519</span>
</span></span><span style="display:flex;"><span>stA_prime <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000b</span>  <span style="color:#75715e"># Red25519</span>
</span></span><span style="display:flex;"><span>date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;20251015&#34;</span>
</span></span><span style="display:flex;"><span>secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>  <span style="color:#75715e"># Empty secret</span>
</span></span></code></pre></div><p><strong>Computation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> A <span style="color:#f92672">||</span> bytes([<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x07</span>]) <span style="color:#f92672">||</span> bytes([<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x0b</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keydata = 36 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>salt <span style="color:#f92672">=</span> SHA256(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;I2PGenerateAlpha&#34;</span> <span style="color:#f92672">+</span> keydata)
</span></span><span style="display:flex;"><span>ikm <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;20251015&#34;</span>
</span></span><span style="display:flex;"><span>info <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;i2pblinding1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>seed <span style="color:#f92672">=</span> HKDF(salt, ikm, info, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>alpha <span style="color:#f92672">=</span> LEOS2IP(seed) mod L
</span></span></code></pre></div><p><strong>Expected Output:</strong></p>
<pre tabindex="0"><code>(Verify against reference implementation)
alpha = [64-byte hex value]
</code></pre><h3 id="test-vector-2-chacha20-encryption">Test Vector 2: ChaCha20 Encryption</h3>
<p><strong>Input:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>key <span style="color:#f92672">=</span> bytes([i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>)])  <span style="color:#75715e"># 0x00..0x1f</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> bytes([i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">12</span>)])  <span style="color:#75715e"># 0x00..0x0b</span>
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello, I2P!&#34;</span>
</span></span></code></pre></div><p><strong>Computation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ChaCha20_Encrypt(key, nonce, plaintext, counter<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><p><strong>Expected Output:</strong></p>
<pre tabindex="0"><code>ciphertext = [verify against RFC 7539 test vectors]
</code></pre><h3 id="test-vector-3-hkdf">Test Vector 3: HKDF</h3>
<p><strong>Input:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>salt <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># All zeros</span>
</span></span><span style="display:flex;"><span>ikm <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test input keying material&#34;</span>
</span></span><span style="display:flex;"><span>info <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2_L1K&#34;</span>
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">=</span> <span style="color:#ae81ff">44</span>
</span></span></code></pre></div><p><strong>Computation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(salt, ikm, info, n)
</span></span></code></pre></div><p><strong>Expected Output:</strong></p>
<pre tabindex="0"><code>keys = [44-byte hex value]
</code></pre><h3 id="test-vector-4-base32-address">Test Vector 4: Base32 Address</h3>
<p><strong>Input:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pubkey <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;bbbb&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;bb&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">30</span>)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>unblinded_sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>  <span style="color:#75715e"># Red25519</span>
</span></span><span style="display:flex;"><span>blinded_sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>    <span style="color:#75715e"># Red25519</span>
</span></span></code></pre></div><p><strong>Computation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>address <span style="color:#f92672">=</span> generate_encrypted_b32_address(pubkey, unblinded_sigtype, blinded_sigtype)
</span></span></code></pre></div><p><strong>Expected Output:</strong></p>
<pre tabindex="0"><code>address = [56 base32 characters].b32.i2p
# Verify checksum validates correctly
</code></pre><hr>
<h2 id="appendix-c-glossary">Appendix C: Glossary</h2>
<p><strong>Alpha (α):</strong> The secret blinding factor used to blind public and private keys. Generated from the destination, date, and optional secret.</p>
<p><strong>AuthCookie:</strong> A 32-byte random value encrypted for each authorized client, used as input to Layer 2 encryption.</p>
<p><strong>B (Base Point):</strong> The generator point for the Ed25519 elliptic curve.</p>
<p><strong>Blinded Key:</strong> A public or private key that has been transformed using the alpha blinding factor. Blinded keys cannot be linked to the original keys without knowing alpha.</p>
<p><strong>ChaCha20:</strong> A stream cipher providing fast, secure encryption without requiring AES hardware support.</p>
<p><strong>ClientID:</strong> An 8-byte identifier derived from HKDF output, used to identify authorization entries for clients.</p>
<p><strong>ClientCookie:</strong> A 32-byte encrypted value containing the authCookie for a specific client.</p>
<p><strong>Credential:</strong> A 32-byte value derived from the destination&rsquo;s public key and signature types, binding encryption to knowledge of the destination.</p>
<p><strong>CSRNG:</strong> Cryptographically Secure Random Number Generator. Must provide unpredictable output suitable for key generation.</p>
<p><strong>DH (Diffie-Hellman):</strong> A cryptographic protocol for securely establishing shared secrets. I2P uses X25519.</p>
<p><strong>Ed25519:</strong> An elliptic curve signature scheme providing fast signatures with 128-bit security level.</p>
<p><strong>Ephemeral Key:</strong> A short-lived cryptographic key, typically used once and then discarded.</p>
<p><strong>Floodfill:</strong> I2P routers that store and serve network database entries, including encrypted LeaseSets.</p>
<p><strong>HKDF:</strong> HMAC-based Key Derivation Function, used to derive multiple cryptographic keys from a single source.</p>
<p><strong>L (Order):</strong> The order of the Ed25519 scalar field (approximately 2^252).</p>
<p><strong>Layer 0 (Outer):</strong> The plaintext portion of an encrypted LeaseSet, containing blinded key and metadata.</p>
<p><strong>Layer 1 (Middle):</strong> The first encrypted layer, containing client authorization data.</p>
<p><strong>Layer 2 (Inner):</strong> The innermost encrypted layer, containing the actual LeaseSet2 data.</p>
<p><strong>LeaseSet2 (LS2):</strong> Second version of I2P&rsquo;s network database entry format, introducing encrypted variants.</p>
<p><strong>NetDB:</strong> The I2P network database, a distributed hash table storing router and destination information.</p>
<p><strong>Offline Keys:</strong> A feature allowing the main signing key to remain in cold storage while a transient key handles daily operations.</p>
<p><strong>PSK (Pre-Shared Key):</strong> A symmetric key shared in advance between two parties, used for PSK client authorization.</p>
<p><strong>Red25519:</strong> An Ed25519-based signature scheme with key blinding support, based on ZCash RedDSA.</p>
<p><strong>Salt:</strong> Random data used as input to key derivation functions to ensure unique outputs.</p>
<p><strong>SigType:</strong> A numeric identifier for signature algorithms (e.g., 7 = Ed25519, 11 = Red25519).</p>
<p><strong>Subcredential:</strong> A 32-byte value derived from the credential and blinded public key, binding encryption to a specific encrypted LeaseSet.</p>
<p><strong>Transient Key:</strong> A temporary signing key used with offline keys, with a limited validity period.</p>
<p><strong>X25519:</strong> An elliptic curve Diffie-Hellman protocol over Curve25519, providing key agreement.</p>
<hr>
<h2 id="document-information">Document Information</h2>
<p><strong>Status:</strong> This document represents the current stable encrypted LeaseSet specification as implemented in I2P since June 2019. The protocol is mature and widely deployed.</p>
<p><strong>Contributing:</strong> For corrections or improvements to this documentation, please submit issues or pull requests to the I2P specifications repository.</p>
<p><strong>Support:</strong> For questions about implementing encrypted LeaseSets:</p>
<ul>
<li>I2P Forum: <a href="https://i2pforum.net/">https://i2pforum.net/</a></li>
<li>IRC: #i2p-dev on OFTC</li>
<li>Matrix: #i2p-dev:matrix.org</li>
</ul>
<p><strong>Acknowledgments:</strong> This specification builds on work by the I2P development team, ZCash cryptography research, and Tor Project&rsquo;s key blinding research.</p>

                </article>

                
                <nav class="page-nav">
                    
                        <a href="../../../../en/docs/specs/i2cp/" class="page-nav-link prev">
                            <span class="nav-label">← Previous</span>
                            <span class="nav-title">I2P Client Protocol (I2CP)</span>
                        </a>
                    
                    
                        <a href="../../../../en/docs/specs/ecies-x25519-aead-ratchet-hybrid-encryption/" class="page-nav-link next">
                            <span class="nav-label">Next →</span>
                            <span class="nav-title">ECIES-X25519-AEAD-Ratchet Hybrid Encryption</span>
                        </a>
                    
                </nav>

                
                <div class="docs-feedback">
                    <p>Was this page helpful?</p>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn" id="feedback-yes">👍 Yes</button>
                        <button class="feedback-btn" id="feedback-no">👎 No</button>
                    </div>

                    
                    <div class="feedback-form-container" id="feedback-form-container" style="display: none;">
                        <p class="feedback-form-title">We're sorry to hear that. How can we improve this page?</p>
                        <form id="feedback-form">
                            <div class="form-group">
                                <label for="feedback-email">Email (optional - if you'd like a response)</label>
                                <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label for="feedback-message">Feedback *</label>
                                <textarea id="feedback-message" name="message" rows="4" required placeholder="Tell us what we can improve..."></textarea>
                            </div>
                            <button type="submit" class="btn-submit-feedback" id="feedback-submit-btn">
                                <span class="btn-text">Submit Feedback</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                    </div>

                    
                    <div class="feedback-message" id="feedback-success" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/>
                        </svg>
                        <span id="feedback-success-text">Thanks for your feedback!</span>
                    </div>
                    <div class="feedback-message feedback-error" id="feedback-error" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span id="feedback-error-text">Something went wrong. Please try again.</span>
                    </div>

                    <p class="feedback-note">
                        Found an issue? <a href="https://gitlab.com/stormycloud-group/i-2-p-www-v-2/-/blob/main/hugo-site/content/en/docs/specs/encryptedleaseset.md?ref_type=heads" target="_blank">Edit this page on GitLab</a>
                    </p>
                </div>
            </main>
        </div>
    </div>
</div>

<style>
.docs-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.docs-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

.docs-layout.docs-layout--no-sidebar {
    grid-template-columns: minmax(0, 1fr);
}

.docs-article.docs-article--wide,
.docs-layout.docs-layout--no-sidebar .docs-article {
    max-width: 960px;
    margin: 0 auto;
}

.docs-layout.docs-layout--no-sidebar .breadcrumbs {
    margin-bottom: var(--spacing-xl);
}

 
.docs-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.sidebar-header {
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.sidebar-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 1.125rem;
    color: var(--color-text);
    text-decoration: none;
}

.sidebar-title:hover {
    color: var(--color-primary);
}

.nav-section {
    margin-bottom: var(--spacing-lg);
}

.nav-section:last-child {
    margin-bottom: 0;
}

.nav-section-title {
    font-weight: 700;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-sm);
}

.nav-link {
    display: block;
    padding: var(--spacing-xs) var(--spacing-sm);
    color: var(--color-text);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    transition: all var(--transition-fast);
}

.nav-link:hover {
    background: var(--color-bg-secondary);
    color: var(--color-primary);
}

.nav-link.active {
    background: var(--color-primary);
    color: white;
    font-weight: 600;
}

 
.docs-article {
    max-width: 800px;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

.article-header {
    margin-bottom: var(--spacing-2xl);
}

.article-title {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
}

.article-meta {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.meta-item svg {
    color: var(--color-primary);
}

 
.toc {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-xl);
}

.toc-title {
    font-weight: 700;
    padding: var(--spacing-md) var(--spacing-lg);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    user-select: none;
    list-style: none;
}

.toc-title::-webkit-details-marker {
    display: none;
}

.toc-title:hover {
    background: var(--color-bg-tertiary);
}

.toc-chevron {
    margin-left: auto;
    transition: transform var(--transition-fast);
}

.toc[open] .toc-chevron {
    transform: rotate(180deg);
}

.toc-content {
    padding: 0 var(--spacing-lg) var(--spacing-md) var(--spacing-lg);
    max-height: 400px;
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 6px;
}

.toc-content::-webkit-scrollbar-track {
    background: var(--color-bg-secondary);
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc li {
    margin-bottom: var(--spacing-xs);
}

.toc ul ul {
    padding-left: var(--spacing-md);
    margin-top: var(--spacing-xs);
}

.toc a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    display: inline-block;
    padding: 0.125rem 0;
    transition: color var(--transition-fast);
}

.toc a:hover {
    color: var(--color-primary);
}

 
.article-content {
    line-height: 1.8;
    color: var(--color-text);
}

.article-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
}

.article-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
}

.article-content p {
    margin-bottom: var(--spacing-md);
}

.article-content ul,
.article-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.article-content li {
    margin-bottom: var(--spacing-xs);
}

.article-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.article-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
}

.article-content pre code {
    background: none;
    padding: 0;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

.article-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.article-content a:hover {
    border-bottom-color: var(--color-primary);
}

 
.page-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.page-nav-link {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.page-nav-link.next {
    text-align: right;
}

.nav-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.nav-title {
    font-weight: 600;
    color: var(--color-text);
}

 
.docs-feedback {
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
}

.feedback-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin: var(--spacing-md) 0;
}

.feedback-btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feedback-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
}

.feedback-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-md);
}

.feedback-note a {
    color: var(--color-primary);
    text-decoration: none;
}

.feedback-note a:hover {
    text-decoration: underline;
}

 
.feedback-form-container {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
}

.feedback-form-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
}

.form-group input[type="email"],
.form-group textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: border-color var(--transition-fast);
}

.form-group input[type="email"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn-submit-feedback {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-submit-feedback:hover:not(:disabled) {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
}

.btn-submit-feedback:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

 
.feedback-message {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: #d1fae5;
    color: #065f46;
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
}

.feedback-message.feedback-error {
    background: #fee2e2;
    color: #991b1b;
}

.feedback-message svg {
    flex-shrink: 0;
}

 
@media (max-width: 968px) {
    .docs-layout {
        grid-template-columns: 1fr;
    }

    .docs-sidebar {
        position: static;
        max-height: none;
    }

    .article-title {
        font-size: 2rem;
    }
}
</style>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-link').forEach(link => {
        if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
        }
    });
});
</script>


<script src="https://feedback.stormycloud.org/widgets/docs-feedback.js"></script>


    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light">
                <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light">
                            <img src="../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Stay updated with I2P news:</p>
                        <div id="mailing-list-widget"
                             data-api-url="https://feedback.stormycloud.org"
                             data-button-text="Subscribe"
                             data-placeholder="Enter your email">
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="../../../../en/financial-support/">Donate</a></li>
                    <li><a href="../../../../en/docs/overview/intro/">I2P Introduction</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Community</h3>
                <ul>
                    <li><a href="../../../../en/get-involved/">Get Involved</a></li>
                    <li><a href="../../../../en/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Official Forums</a></li>
                    <li><a href="../../../../en/contact/">Contact</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Resources</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P Metrics</a></li>
                    <li><a href="../../../../en/papers/">Research</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 The Invisible Internet Project. Licensed under Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../../en/privacy/">Privacy</a>
                <a href="../../../../en/terms/">Terms</a>
                <a href="../../../../en/impressum/">Impressum</a>
                <a href="../../../../en/about/media/">Press</a>
            </div>
        </div>
    </div>
</footer>


    
    
    
        
        <script src="../../../../js/main.min.js"></script>
    

    
    <script src="https://feedback.stormycloud.org/widgets/mailing-list.js"></script>

    
    <script src="https://feedback.stormycloud.org/widgets/features.js"></script>

    
</body>
</html>
