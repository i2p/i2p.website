<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang | default "en" }}" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>{{ block "title" . }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>

    <meta name="description" content="{{ .Description | default .Site.Params.description }}">
    <meta name="keywords" content="{{ .Keywords | default .Site.Params.keywords }}">

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="{{ .Title }} | {{ .Site.Title }}">
    <meta property="og:description" content="{{ .Description | default .Site.Params.description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ .Permalink }}">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/i2plogo.png">

    <!-- Styles -->
    {{ $styles := resources.Get "css/main.css" }}
    {{ if $styles }}
        {{ $styles = $styles | resources.Minify }}
        <link rel="stylesheet" href="{{ $styles.RelPermalink }}">
    {{ end }}

    <!-- Mailing List Widget Styles (loaded dynamically based on network) -->

    <!-- Theme Script (prevent flash) -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <!-- Fundraise Up: the new standard for online giving -->
    <script>(function(w,d,s,n,a){if(!w[n]){var l='call,catch,on,once,set,then,track,openCheckout'
    .split(','),i,o=function(n){return'function'==typeof n?o.l.push([arguments])&&o
    :function(){return o.l.push([n,arguments])&&o}},t=d.getElementsByTagName(s)[0],
    j=d.createElement(s);j.async=!0;j.src='https://cdn.fundraiseup.com/widget/'+a+'';
    t.parentNode.insertBefore(j,t);o.s=Date.now();o.v=5;o.h=w.location.href;o.l=[];
    for(i=0;i<8;i++)o[l[i]]=o(l[i]);w[n]=o}
    })(window,document,'script','FundraiseUp','AAYKECHT');</script>
    <!-- End Fundraise Up -->

    {{ block "head" . }}{{ end }}
</head>
<body>
    {{ partial "banner.html" . }}
    {{ partial "header.html" . }}

    <main id="main-content">
        {{ block "main" . }}{{ end }}
    </main>

    {{ partial "footer.html" . }}

    <!-- Poll Modal -->
    {{ partial "poll-modal.html" . }}

    <!-- Scripts -->
    {{ $scripts := resources.Get "js/main.js" }}
    {{ if $scripts }}
        {{ $scripts = $scripts | resources.Minify }}
        <script src="{{ $scripts.RelPermalink }}"></script>
    {{ end }}

    <!-- Feedback Widgets (loaded dynamically based on network) -->
    <script>
    (function() {
        'use strict';
        
        // Detect network based on hostname
        const hostname = window.location.hostname;
        let baseUrl;
        
        // Check for I2P (both .i2p and .b32.i2p addresses)
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://feedback.stormycloud.i2p';
            console.log('[Network Detector] I2P network detected, using:', baseUrl);
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            console.log('[Network Detector] Tor network detected, using:', baseUrl);
        } else {
            baseUrl = 'https://feedback.i2p.net';
            console.log('[Network Detector] Clearnet detected, using:', baseUrl);
        }
        
        // Store base URL for use by other scripts
        window.feedbackBaseUrl = baseUrl;
        
        // Load stylesheet
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = baseUrl + '/widgets/styles.css';
        document.head.appendChild(link);
        
        // Load mailing-list.js
        const mailingListScript = document.createElement('script');
        mailingListScript.src = baseUrl + '/widgets/mailing-list.js';
        mailingListScript.async = true;
        mailingListScript.onerror = function() {
            console.error('[Network Detector] Failed to load mailing-list.js from:', baseUrl);
        };
        document.body.appendChild(mailingListScript);
        
        // Load features.js
        const featuresScript = document.createElement('script');
        featuresScript.src = baseUrl + '/widgets/features.js';
        featuresScript.async = true;
        featuresScript.onerror = function() {
            console.error('[Network Detector] Failed to load features.js from:', baseUrl);
        };
        document.body.appendChild(featuresScript);
        
        // Update any existing widgets with data-api-url attributes
        function updateWidgetApiUrls() {
            const widgets = document.querySelectorAll('[data-api-url]');
            widgets.forEach(function(widget) {
                const currentUrl = widget.getAttribute('data-api-url');
                // Only update if it's still pointing to the default clearnet URL
                if (currentUrl === 'https://feedback.i2p.net' || currentUrl.startsWith('https://feedback.i2p.net/')) {
                    widget.setAttribute('data-api-url', baseUrl);
                }
            });
        }
        
        // Update immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateWidgetApiUrls);
        } else {
            updateWidgetApiUrls();
        }
    })();
    </script>

    <!-- Poll Widget Script is loaded dynamically when the modal opens -->

    {{ block "scripts" . }}{{ end }}
</body>
</html>
