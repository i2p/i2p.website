<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang | default "en" }}" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>{{ block "title" . }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>

    <meta name="description" content="{{ .Description | default .Site.Params.description }}">
    <meta name="keywords" content="{{ .Keywords | default .Site.Params.keywords }}">

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="{{ .Title }} | {{ .Site.Title }}">
    <meta property="og:description" content="{{ .Description | default .Site.Params.description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ .Permalink }}">

    <!-- Favicon -->
    <link rel="icon" type="image/webp" href="/images/i2plogo.webp">
    <link rel="icon" type="image/png" href="/images/i2plogo.png" sizes="32x32">

    <!-- Styles -->
    {{ $styles := resources.Get "css/main.css" }}
    {{ if $styles }}
        {{ $styles = $styles | resources.Minify | resources.Fingerprint }}
        <link rel="stylesheet" href="{{ $styles.RelPermalink }}" integrity="{{ $styles.Data.Integrity }}">
    {{ end }}


    <!-- Theme Script (prevent flash) -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    {{ block "head" . }}{{ end }}
</head>
<body>
    {{ partial "banner.html" . }}
    {{ partial "header.html" . }}

    <main id="main-content">
        {{ block "main" . }}{{ end }}
    </main>

    {{ partial "footer.html" . }}

    <!-- Poll Modal -->
    {{ partial "poll-modal.html" . }}

    <!-- Scripts -->
    {{ $scripts := resources.Get "js/main.js" }}
    {{ if $scripts }}
        {{ $scripts = $scripts | resources.Minify | resources.Fingerprint }}
        <script src="{{ $scripts.RelPermalink }}" integrity="{{ $scripts.Data.Integrity }}"></script>
    {{ end }}

    <!-- FundraiseUp Lazy Loader - loads only when needed for privacy -->
    {{ $fundraiseup := resources.Get "js/fundraiseup-loader.js" }}
    {{ if $fundraiseup }}
        {{ $fundraiseup = $fundraiseup | resources.Minify | resources.Fingerprint }}
        <script src="{{ $fundraiseup.RelPermalink }}" integrity="{{ $fundraiseup.Data.Integrity }}"></script>
    {{ end }}

    <!-- Feedback Widgets - Network-aware loading -->
    <script>
    (function() {
        'use strict';
        var hostname = window.location.hostname;
        var baseUrl;
        
        // Detect network
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        } else {
            baseUrl = 'https://feedback.i2p.net';
        }
        
        window.feedbackBaseUrl = baseUrl;
        
        // Update widget API URLs before scripts load
        document.querySelectorAll('[data-api-url]').forEach(function(widget) {
            widget.setAttribute('data-api-url', baseUrl);
        });
        
        // Write script tags synchronously so they load in order
        document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
        document.write('<script src="' + baseUrl + '/widgets/mailing-list.js"><\/script>');
        document.write('<script src="' + baseUrl + '/widgets/features.js"><\/script>');
    })();
    </script>

    <!-- Poll Widget Script is loaded dynamically when the modal opens -->

    {{ block "scripts" . }}{{ end }}

    <!-- =====================================================================
         Matomo Analytics - CLEARNET ONLY
         To disable: Remove or comment out this entire block
         ===================================================================== -->
    <script>
    (function() {
      var hostname = window.location.hostname;
      if (hostname.endsWith('.i2p') || hostname.endsWith('.b32.i2p') || hostname.endsWith('.onion')) {
        return; // Skip analytics on anonymous networks
      }
      var _paq = window._paq = window._paq || [];
      _paq.push(["setCookieDomain", "*.i2p.net"]);
      _paq.push(["setDoNotTrack", true]);
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="https://i2p.matomo.cloud/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src='https://cdn.matomo.cloud/i2p.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    })();
    </script>
    <noscript><p><img referrerpolicy="no-referrer-when-downgrade" src="https://i2p.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript>
    <!-- End Matomo Code -->
</body>
</html>
