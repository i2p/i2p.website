{{/*
  Docs Feedback Partial - Zero JavaScript Implementation

  Uses Cloudflare Worker to handle form submissions server-side.
  No client-side JavaScript required for core functionality.

  Usage: {{ partial "docs-feedback.html" . }}

  Requires hugo.toml params:
    [params.feedback]
      workerUrl = "https://i2p-docs-feedback.example.workers.dev"
*/}}

{{ $workerUrl := site.Params.feedback.workerUrl | default "https://i2p-docs-feedback.example.workers.dev" }}
{{ $documentId := .RelPermalink }}
{{ $redirectUrl := .Permalink }}

<div class="docs-feedback" id="docs-feedback">
  <p class="docs-feedback-title">Was this page helpful?</p>

  <div class="docs-feedback-buttons">
    {{/* Yes Button - Direct form submission */}}
    <form method="POST" action="{{ $workerUrl }}/feedback/vote" class="docs-feedback-form">
      <input type="hidden" name="document_id" value="{{ $documentId }}">
      <input type="hidden" name="type" value="up">
      <input type="hidden" name="redirect_url" value="{{ $redirectUrl }}#docs-feedback">
      <button type="submit" class="feedback-btn feedback-btn-yes">
        <span class="feedback-icon">&#128077;</span>
        <span>Yes</span>
      </button>
    </form>

    {{/* No Button - Shows inline form via CSS :target */}}
    <form class="docs-feedback-form" onsubmit="event.preventDefault(); window.location.hash='feedback-form';">
      <button type="submit" class="feedback-btn feedback-btn-no">
        <span class="feedback-icon">&#128078;</span>
        <span>No</span>
      </button>
    </form>
  </div>

  {{/* Inline Feedback Form - Hidden by default, shown via :target */}}
  <div class="feedback-form-container" id="feedback-form">
    <div class="feedback-form-card">
      <h3 class="feedback-form-title">Help us improve</h3>
      <p class="feedback-form-description">Sorry this page wasn't helpful. Please let us know what we could improve.</p>

      <form method="POST" action="{{ $workerUrl }}/feedback/submit-form" class="feedback-inline-form">
        <input type="hidden" name="document_id" value="{{ $documentId }}">
        <input type="hidden" name="redirect_url" value="{{ $redirectUrl }}#docs-feedback">

        <div class="feedback-form-group">
          <label for="feedback-message">What could be improved? <span class="required">*</span></label>
          <textarea id="feedback-message" name="message" required placeholder="Please describe what was unclear, missing, or incorrect..."></textarea>
        </div>

        <div class="feedback-form-group">
          <label for="feedback-email">Email (optional)</label>
          <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
          <p class="feedback-form-hint">If you'd like us to follow up about your feedback</p>
        </div>

        <div class="feedback-form-actions">
          <a href="#docs-feedback" class="feedback-form-cancel">Cancel</a>
          <button type="submit" class="feedback-form-submit">Submit Feedback</button>
        </div>
      </form>
    </div>
  </div>

  <p class="feedback-note">
    Found an issue? <a href="https://gitlab.com/{{ .Site.Params.gitlabRepo }}/-/blob/{{ .Site.Params.gitlabBranch }}/hugo-site/content/{{ .Language.Lang }}/{{ .File.Path }}?ref_type=heads" target="_blank" rel="noopener">Edit this page on GitLab</a>
  </p>

  {{/* Fallback for I2P/Tor users or when JS is disabled */}}
  <noscript>
    <p class="feedback-darknet-notice">
      Feedback submission requires clearnet access.
      <a href="https://i2p.net{{ .RelPermalink }}#docs-feedback">Submit feedback via clearnet</a>
    </p>
  </noscript>
</div>

<style>
/* Inline feedback form - hidden by default */
.feedback-form-container {
  display: none;
  margin-top: var(--spacing-lg);
}

/* Show form when targeted via #feedback-form */
.feedback-form-container:target {
  display: block;
}

/* Hide buttons when form is shown */
.feedback-form-container:target ~ .docs-feedback-buttons,
#feedback-form:target ~ .docs-feedback-buttons {
  display: none;
}

/* This selector hides buttons when form container is targeted */
.docs-feedback:has(#feedback-form:target) .docs-feedback-buttons {
  display: none;
}

.feedback-form-card {
  background: var(--color-bg);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--spacing-lg);
  text-align: left;
  max-width: 500px;
  margin: 0 auto;
}

.feedback-form-title {
  font-size: 1.25rem;
  margin: 0 0 var(--spacing-sm) 0;
  color: var(--color-text);
}

.feedback-form-description {
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-lg);
  font-size: 0.9375rem;
  line-height: 1.5;
}

.feedback-form-group {
  margin-bottom: var(--spacing-md);
}

.feedback-form-group label {
  display: block;
  font-weight: 500;
  margin-bottom: var(--spacing-xs);
  color: var(--color-text);
}

.feedback-form-group .required {
  color: #dc3545;
}

.feedback-form-group textarea,
.feedback-form-group input[type="email"] {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: 1rem;
  font-family: inherit;
  background: var(--color-bg);
  color: var(--color-text);
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.feedback-form-group textarea {
  min-height: 100px;
  resize: vertical;
}

.feedback-form-group textarea:focus,
.feedback-form-group input[type="email"]:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(102, 16, 242, 0.1);
}

.feedback-form-hint {
  font-size: 0.8125rem;
  color: var(--color-text-muted);
  margin-top: var(--spacing-xs);
}

.feedback-form-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-lg);
}

.feedback-form-cancel {
  padding: 0.75rem 1.25rem;
  background: var(--color-bg-secondary);
  color: var(--color-text);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  text-decoration: none;
  font-weight: 500;
  text-align: center;
  transition: background var(--transition-fast);
}

.feedback-form-cancel:hover {
  background: var(--color-border);
}

.feedback-form-submit {
  flex: 1;
  padding: 0.75rem 1.5rem;
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: var(--radius-md);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background var(--transition-fast);
}

.feedback-form-submit:hover {
  background: var(--color-primary-hover, #520dc2);
}

/* Darknet/noscript fallback notice */
.feedback-darknet-notice {
  font-size: 0.875rem;
  color: var(--color-text-muted);
  margin-top: var(--spacing-md);
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-bg-secondary);
  border-radius: var(--radius-md);
  border: 1px solid var(--color-border);
}

.feedback-darknet-notice a {
  color: var(--color-primary);
  text-decoration: none;
}

.feedback-darknet-notice a:hover {
  text-decoration: underline;
}
</style>

{{/*
  Minimal JavaScript for displaying feedback status from query params.
  This is optional enhancement - core functionality works without JS.
*/}}
<script>
(function() {
  const params = new URLSearchParams(window.location.search);
  const feedback = params.get('feedback');
  const container = document.getElementById('docs-feedback');

  if (!feedback || !container) return;

  // Create status message element
  const msg = document.createElement('div');
  msg.className = 'feedback-message';

  if (feedback === 'success') {
    msg.className += ' feedback-success';
    msg.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg><span>Thanks for your feedback!</span>';
  } else if (feedback === 'already_voted') {
    msg.className += ' feedback-info';
    msg.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 16v-4M12 8h.01" stroke-width="2" stroke-linecap="round"/></svg><span>You\'ve already provided feedback for this page.</span>';
  } else if (feedback === 'error') {
    msg.className += ' feedback-error';
    const errorMsg = params.get('error_msg') || 'Something went wrong. Please try again.';
    msg.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/></svg><span>' + errorMsg + '</span>';
  }

  if (msg.innerHTML) {
    // Hide the buttons and form if success or already voted
    if (feedback === 'success' || feedback === 'already_voted') {
      const buttons = container.querySelector('.docs-feedback-buttons');
      const formContainer = container.querySelector('.feedback-form-container');
      if (buttons) buttons.style.display = 'none';
      if (formContainer) formContainer.style.display = 'none';
    }

    // Insert message after title
    const title = container.querySelector('.docs-feedback-title');
    if (title) {
      title.insertAdjacentElement('afterend', msg);
    }

    // Clean URL (remove query params) without reload
    const cleanUrl = window.location.pathname + window.location.hash;
    if (window.history.replaceState) {
      window.history.replaceState({}, '', cleanUrl);
    }
  }
})();
</script>
