{{ if .Site.Params.poll.enabled }}
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="{{ i18n "poll.close" | default "Close poll" }}">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>{{ i18n "poll.title" | default "Community Poll" }}</h2>
            <p class="modal-subtitle">{{ i18n "poll.subtitle" | default "We'd love to hear from you" }}</p>
        </div>

        <div class="modal-body">
            <!-- Server-rendered poll widget in iframe (no JavaScript required) -->
            <iframe 
                id="poll-iframe"
                data-poll-id="{{ .Site.Params.poll.pollId | default "1" }}"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                {{ i18n "poll.disclaimer" | default "Your vote helps shape the future of I2P." }}
            </p>
        </div>
    </div>
</div>

<!-- Only load poll iframe when modal is opened (URL has #poll) -->
<script>
(function() {
    function loadPollIfNeeded() {
        if (window.location.hash !== '#poll') return;

        const iframe = document.getElementById('poll-iframe');
        if (!iframe || iframe.src) return; // Already loaded

        const hostname = window.location.hostname;
        let apiUrl = 'https://feedback.i2p.net';
        const pollId = iframe.getAttribute('data-poll-id') || '1';

        // Check for I2P (both .i2p and .b32.i2p addresses)
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        }
        // Detect Tor
        else if (hostname.endsWith('.onion')) {
            apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        }

        // Set iframe src only now
        const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
        iframe.src = pollUrl;
    }

    // Check on page load (if URL already has #poll)
    loadPollIfNeeded();

    // Check when hash changes (user clicks poll link)
    window.addEventListener('hashchange', loadPollIfNeeded);
})();
</script>
{{ end }}
