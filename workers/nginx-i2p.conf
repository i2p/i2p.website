# nginx configuration for I2P/Tor mirror of geti2p.net
# Optimized for performance with Accept-Language redirect, gzip, caching, etc.

# ===========================================================================
# NOTE: The 'map' directives below MUST be placed in the http {} block,
# typically in /etc/nginx/nginx.conf or a file included at http level.
# Copy this section to your nginx.conf http block:
# ===========================================================================
# map $cookie_theme $theme_target {
#     default "light";
#     dark    "dark";
# }
#
# # Banner dismiss mapping - check if dismissed_banners cookie contains banner-3
# # Uses underscore in cookie name for nginx $cookie_ variable compatibility
# map $cookie_dismissed_banners $banner_hide_style {
#     default "";
#     "~*banner-3" " style=\"display: none !important;\"";
# }
# ===========================================================================

server {
    listen 80;
    server_name _;  # Adjust for your .i2p or .onion domain

    # Root directory - adjust to your Hugo public output
    root /var/www/html;
    index index.html;

    # Character encoding
    charset utf-8;

    absolute_redirect off;

    # --- Security Headers ---
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # --- Browser Caching ---
    # CSS/JS with fingerprints - long cache
    location ~* \.(css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Images - long cache
    location ~* \.(jpg|jpeg|png|gif|webp|avif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Fonts - long cache
    location ~* \.(woff|woff2|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        access_log off;
    }

    # --- Static assets (serve directly, no language redirect) ---
    location ~ ^/(images|css|js|fonts|assets)/ {
        try_files $uri =404;
    }

    location = /favicon.ico {
        expires 1y;
        access_log off;
        log_not_found off;
    }

    location = /robots.txt {
        expires 1d;
        access_log off;
        log_not_found off;
    }

    location ~ ^/sitemap {
        try_files $uri =404;
    }

    # --- Theme toggle endpoints ---
    location = /set-theme/dark {
        add_header Set-Cookie "theme=dark;path=/;max-age=31536000;SameSite=Lax" always;
        return 302 $http_referer;
    }

    location = /set-theme/light {
        add_header Set-Cookie "theme=light;path=/;max-age=31536000;SameSite=Lax" always;
        return 302 $http_referer;
    }

    # --- Banner dismiss endpoint ---
    # Uses underscore in cookie name for nginx $cookie_ variable compatibility
    location = /api/banner/dismiss {
        set $banner_id "banner-3";
        if ($arg_id) {
            set $banner_id $arg_id;
        }
        add_header Set-Cookie "dismissed_banners=%5B%22$banner_id%22%5D;path=/;max-age=31536000;SameSite=Lax" always;
        set $redirect_to $http_referer;
        if ($redirect_to = "") {
            set $redirect_to "/";
        }
        return 302 $redirect_to;
    }

    # --- Language-prefixed paths with theme and banner rewriting ---
    location ~ ^/(en|es|ko|zh|ru|cs|de|fr|tr|vi|hi|ar|pt)(/.*)?$ {
        add_header Set-Cookie "lang=$1;path=/;max-age=31536000;SameSite=Lax" always;

        sub_filter_once off;
        sub_filter "data-theme=light" "data-theme=$theme_target";
        sub_filter "data-banner-id=banner-3 " "data-banner-id=banner-3$banner_hide_style ";

        try_files $uri $uri/ $uri/index.html =404;
    }

    # --- Root redirect based on language cookie ---
    location = / {
        set $lang "en";
        if ($cookie_lang ~ "^(en|es|ko|zh|ru|cs|de|fr|tr|vi|hi|ar|pt)$") {
            set $lang $cookie_lang;
        }
        return 302 /$lang/;
    }

    # --- Non-prefixed paths redirect to language version ---
    location / {
        set $lang "en";
        if ($cookie_lang ~ "^(en|es|ko|zh|ru|cs|de|fr|tr|vi|hi|ar|pt)$") {
            set $lang $cookie_lang;
        }
        return 302 /$lang$request_uri;
    }

    # --- Error pages ---
    error_page 404 /404.html;
    location = /404.html {
        internal;
    }

    # --- Disable access to hidden files ---
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # --- Logging ---
    access_log /var/log/nginx/i2p-access.log;
    error_log /var/log/nginx/i2p-error.log warn;
}
